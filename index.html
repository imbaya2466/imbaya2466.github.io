<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="..........">
<meta property="og:type" content="website">
<meta property="og:title" content="GGWP">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="GGWP">
<meta property="og:description" content="..........">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GGWP">
<meta name="twitter:description" content="..........">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>GGWP</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GGWP</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/18/android8-0-0源码分析-app启动2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/18/android8-0-0源码分析-app启动2/" itemprop="url">android8-0-0源码分析-app启动2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-18T22:51:39+08:00">
                2018-10-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>继续上篇的app启动，本篇将从zygote接受到消息跟到activity启动。<br>下一篇将着重分析应用进程加载代码与资源的过程，并分析实现应用壳的加载方案。</p>
<p>ActivityStarter是Android 7.0新加入的类，它是加载Activity的控制类，会收集所有的逻辑来决定如何将Intent和Flags转换为Activity，并将Activity和Task以及Stack相关联。<br>参考文：<br><a href="http://duanqz.github.io/2016-10-23-Activity-LaunchProcess-Part2#%E6%A6%82%E8%A7%88" target="_blank" rel="external">http://duanqz.github.io/2016-10-23-Activity-LaunchProcess-Part2#%E6%A6%82%E8%A7%88</a><br>gityuan</p>
<h2 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h2><p><img src="https://i.imgur.com/KO8juQ7.jpg" alt=""></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="1-zygoteServer-runSelectLoop"><a href="#1-zygoteServer-runSelectLoop" class="headerlink" title="1-zygoteServer.runSelectLoop"></a>1-zygoteServer.runSelectLoop</h3><p>这里进入zygote进程<br>zygoteServer.runSelectLoop<br>位于frameworks\base\core\java\com\android\internal\os\ZygoteServer.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * Runs the zygote process&apos;s select loop. Accepts new connections as</div><div class="line"> * they happen, and reads commands from connections one spawn-request&apos;s</div><div class="line"> * worth at a time.</div><div class="line"> *</div><div class="line"> * @throws Zygote.MethodAndArgsCaller in a child process when a main()</div><div class="line"> * should be executed.</div><div class="line"> */</div><div class="line">void runSelectLoop(String abiList) throws Zygote.MethodAndArgsCaller &#123;</div><div class="line">    ArrayList&lt;FileDescriptor&gt; fds = new ArrayList&lt;FileDescriptor&gt;();</div><div class="line">    ArrayList&lt;ZygoteConnection&gt; peers = new ArrayList&lt;ZygoteConnection&gt;();</div><div class="line">	//0号为ServerSocket</div><div class="line">    fds.add(mServerSocket.getFileDescriptor());</div><div class="line">    peers.add(null);</div><div class="line">	//开始fds与peers有东西，fds存的是socket连接字段的文件描述符，peers存ZygoteConnection对象本身其含socket</div><div class="line">    while (true) &#123;</div><div class="line">        StructPollfd[] pollFds = new StructPollfd[fds.size()];</div><div class="line">        for (int i = 0; i &lt; pollFds.length; ++i) &#123;</div><div class="line">            pollFds[i] = new StructPollfd();</div><div class="line">            pollFds[i].fd = fds.get(i);</div><div class="line">            pollFds[i].events = (short) POLLIN;</div><div class="line">        &#125;</div><div class="line">        try &#123;</div><div class="line">            Os.poll(pollFds, -1);  //对socket列表进行poll，0号是serversocket。阻塞在这里</div><div class="line">        &#125; catch (ErrnoException ex) &#123;</div><div class="line">            throw new RuntimeException(&quot;poll failed&quot;, ex);</div><div class="line">        &#125;</div><div class="line">        for (int i = pollFds.length - 1; i &gt;= 0; --i) &#123;</div><div class="line">			//采用I/O多路复用机制，当接收到客户端发出连接请求 或者数据处理请求到来，则往下执行；</div><div class="line">            // 否则进入continue，跳出本次循环。</div><div class="line">            if ((pollFds[i].revents &amp; POLLIN) == 0) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            if (i == 0) &#123;</div><div class="line">				//如果i==0则说明serversocket有消息，也就是获得了新的连接，将其存入fds与peers</div><div class="line">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</div><div class="line">                peers.add(newPeer);</div><div class="line">                fds.add(newPeer.getFileDesciptor());</div><div class="line">            &#125; else &#123;</div><div class="line">				//非0表示非ServerSocket有消息，取出ZygoteConnection对象，通过该对象可以获得消息并处理</div><div class="line">                boolean done = peers.get(i).runOnce(this);//将当前的连接事件取出来执行</div><div class="line">                if (done) &#123;</div><div class="line">                    peers.remove(i);</div><div class="line">                    fds.remove(i);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此时Zygote作为服务端不断监听来自AMS的请求。注释详尽……有点javaNIO服务器的常见用法的感觉…..不过runOnce执行一次就把连接丢掉了。<br>没有连接请求时会进入休眠状态，当有创建新进程的连接请求时，唤醒Zygote进程，创建Socket通道ZygoteConnection，然后执行ZygoteConnection的runOnce()方法。</p>
<h3 id="4-ZygoteConnection-runOnce"><a href="#4-ZygoteConnection-runOnce" class="headerlink" title="4-ZygoteConnection.runOnce"></a>4-ZygoteConnection.runOnce</h3><p>frameworks\base\core\java\com\android\internal\os\ZygoteConnection.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> /**</div><div class="line">  * Reads one start command from the command socket. If successful,</div><div class="line">  * a child is forked and a &#123;@link Zygote.MethodAndArgsCaller&#125;</div><div class="line">  * exception is thrown in that child while in the parent process,</div><div class="line">  * the method returns normally. On failure, the child is not</div><div class="line">  * spawned and messages are printed to the log and stderr. Returns</div><div class="line">  * a boolean status value indicating whether an end-of-file on the command</div><div class="line">  * socket has been encountered.</div><div class="line">  *</div><div class="line">  * @return false if command socket should continue to be read from, or</div><div class="line">  * true if an end-of-file has been encountered.</div><div class="line">  * @throws Zygote.MethodAndArgsCaller trampoline to invoke main()</div><div class="line">  * method in child process</div><div class="line">  */</div><div class="line"> boolean runOnce(ZygoteServer zygoteServer) throws Zygote.MethodAndArgsCaller &#123;</div><div class="line"></div><div class="line">     String args[];</div><div class="line">     Arguments parsedArgs = null;</div><div class="line">     FileDescriptor[] descriptors;</div><div class="line"></div><div class="line">     try &#123;</div><div class="line">         args = readArgumentList();  //获取刚刚发送的参数字串数组 用的是BufferedReader mSocketReader读的</div><div class="line">         descriptors = mSocket.getAncillaryFileDescriptors();</div><div class="line">     &#125; catch (IOException ex) &#123;</div><div class="line">         Log.w(TAG, &quot;IOException on command socket &quot; + ex.getMessage());</div><div class="line">         closeSocket();</div><div class="line">         return true;</div><div class="line">     &#125;</div><div class="line"></div><div class="line"></div><div class="line">     /** the stderr of the most recent request, if avail */</div><div class="line">     PrintStream newStderr = null;</div><div class="line"></div><div class="line">     if (descriptors != null &amp;&amp; descriptors.length &gt;= 3) &#123;</div><div class="line">         newStderr = new PrintStream(</div><div class="line">                 new FileOutputStream(descriptors[2]));</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     int pid = -1;</div><div class="line">     FileDescriptor childPipeFd = null;</div><div class="line">     FileDescriptor serverPipeFd = null;</div><div class="line"></div><div class="line">     try &#123;</div><div class="line">//封装参数</div><div class="line">         parsedArgs = new Arguments(args);</div><div class="line"></div><div class="line">         if (parsedArgs.abiListQuery) &#123;</div><div class="line">             return handleAbiListQuery();</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         if (parsedArgs.preloadDefault) &#123;</div><div class="line">             return handlePreload();</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         if (parsedArgs.preloadPackage != null) &#123;</div><div class="line">             return handlePreloadPackage(parsedArgs.preloadPackage,</div><div class="line">                     parsedArgs.preloadPackageLibs, parsedArgs.preloadPackageCacheKey);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         if (parsedArgs.permittedCapabilities != 0 || parsedArgs.effectiveCapabilities != 0) &#123;</div><div class="line">             throw new ZygoteSecurityException(&quot;Client may not specify capabilities: &quot; +</div><div class="line">                     &quot;permitted=0x&quot; + Long.toHexString(parsedArgs.permittedCapabilities) +</div><div class="line">                     &quot;, effective=0x&quot; + Long.toHexString(parsedArgs.effectiveCapabilities));</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         applyUidSecurityPolicy(parsedArgs, peer);</div><div class="line">         applyInvokeWithSecurityPolicy(parsedArgs, peer);</div><div class="line"></div><div class="line">         applyDebuggerSystemProperty(parsedArgs);</div><div class="line">         applyInvokeWithSystemProperty(parsedArgs);</div><div class="line"></div><div class="line">         int[][] rlimits = null;</div><div class="line"></div><div class="line">         if (parsedArgs.rlimits != null) &#123;</div><div class="line">             rlimits = parsedArgs.rlimits.toArray(intArray2d);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         int[] fdsToIgnore = null;</div><div class="line"></div><div class="line">         if (parsedArgs.invokeWith != null) &#123;</div><div class="line">             FileDescriptor[] pipeFds = Os.pipe2(O_CLOEXEC);</div><div class="line">             childPipeFd = pipeFds[1];</div><div class="line">             serverPipeFd = pipeFds[0];</div><div class="line">             Os.fcntlInt(childPipeFd, F_SETFD, 0);</div><div class="line">             fdsToIgnore = new int[] &#123; childPipeFd.getInt$(), serverPipeFd.getInt$() &#125;;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         /**</div><div class="line">          * In order to avoid leaking descriptors to the Zygote child,</div><div class="line">          * the native code must close the two Zygote socket descriptors</div><div class="line">          * in the child process before it switches from Zygote-root to</div><div class="line">          * the UID and privileges of the application being launched.</div><div class="line">          *</div><div class="line">          * In order to avoid &quot;bad file descriptor&quot; errors when the</div><div class="line">          * two LocalSocket objects are closed, the Posix file</div><div class="line">          * descriptors are released via a dup2() call which closes</div><div class="line">          * the socket and substitutes an open descriptor to /dev/null.</div><div class="line">          */</div><div class="line"></div><div class="line">         int [] fdsToClose = &#123; -1, -1 &#125;;</div><div class="line"></div><div class="line">         FileDescriptor fd = mSocket.getFileDescriptor();</div><div class="line"></div><div class="line">         if (fd != null) &#123;</div><div class="line">             fdsToClose[0] = fd.getInt$();</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         fd = zygoteServer.getServerSocketFileDescriptor();</div><div class="line"></div><div class="line">         if (fd != null) &#123;</div><div class="line">             fdsToClose[1] = fd.getInt$();</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         fd = null;</div><div class="line"></div><div class="line">//创建新进程</div><div class="line">         pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,</div><div class="line">                 parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,</div><div class="line">                 parsedArgs.niceName, fdsToClose, fdsToIgnore, parsedArgs.instructionSet,</div><div class="line">                 parsedArgs.appDataDir);</div><div class="line">     &#125; catch (ErrnoException ex) &#123;</div><div class="line">         logAndPrintError(newStderr, &quot;Exception creating pipe&quot;, ex);</div><div class="line">     &#125; catch (IllegalArgumentException ex) &#123;</div><div class="line">         logAndPrintError(newStderr, &quot;Invalid zygote arguments&quot;, ex);</div><div class="line">     &#125; catch (ZygoteSecurityException ex) &#123;</div><div class="line">         logAndPrintError(newStderr,</div><div class="line">                 &quot;Zygote security policy prevents request: &quot;, ex);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     try &#123;</div><div class="line">         if (pid == 0) &#123;  //pid=0表示子进程</div><div class="line">             // in child</div><div class="line">             zygoteServer.closeServerSocket();</div><div class="line">             IoUtils.closeQuietly(serverPipeFd);</div><div class="line">             serverPipeFd = null;</div><div class="line">             handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</div><div class="line"></div><div class="line">             // should never get here, the child is expected to either</div><div class="line">             // throw Zygote.MethodAndArgsCaller or exec().</div><div class="line">             return true;</div><div class="line">         &#125; else &#123;//父进程</div><div class="line">             // in parent...pid of &lt; 0 means failure</div><div class="line">             IoUtils.closeQuietly(childPipeFd);</div><div class="line">             childPipeFd = null;</div><div class="line">             return handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);</div><div class="line">         &#125;</div><div class="line">     &#125; finally &#123;</div><div class="line">         IoUtils.closeQuietly(childPipeFd);</div><div class="line">         IoUtils.closeQuietly(serverPipeFd);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>forkAndSpecialize底层调用fork创建进程。<br>为子：zygoteServer关闭，调用handleChildProc<br>父：handleParentProc通过socket将pid返回<br>安全措施主要靠uid判断的</p>
<p>forkAndSpecialize内主要有：初始化gc堆的工作, 将线程转换为long型并保存到token， fork()，设置group、limit、uid。设置信号处理函数</p>
<p>Arguments参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">--setuid=</div><div class="line">--setgid=</div><div class="line">--target-sdk-version=</div><div class="line">--enable-debugger</div><div class="line">--enable-safemode</div><div class="line">--enable-checkjni</div><div class="line">--enable-jit</div><div class="line">--generate-debug-info</div><div class="line">--enable-jni-logging</div><div class="line">--enable-assert</div><div class="line">--runtime-args</div><div class="line">--seinfo=</div><div class="line">--capabilities=</div><div class="line">--rlimit=</div><div class="line">--setgroups=</div><div class="line">--invoke-with</div><div class="line">--nice-name=</div><div class="line">--mount-external-default</div><div class="line">--mount-external-read</div><div class="line">--mount-external-write</div><div class="line">--query-abi-list</div><div class="line">--instruction-set=</div><div class="line">--app-data-dir=</div></pre></td></tr></table></figure>
<h3 id="5-handleChildProc"><a href="#5-handleChildProc" class="headerlink" title="5-handleChildProc"></a>5-handleChildProc</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> /**</div><div class="line">  * Handles post-fork setup of child proc, closing sockets as appropriate,</div><div class="line">  * reopen stdio as appropriate, and ultimately throwing MethodAndArgsCaller</div><div class="line">  * if successful or returning if failed.</div><div class="line">  *</div><div class="line">  * @param parsedArgs non-null; zygote args</div><div class="line">  * @param descriptors null-ok; new file descriptors for stdio if available.</div><div class="line">  * @param pipeFd null-ok; pipe for communication back to Zygote.</div><div class="line">  * @param newStderr null-ok; stream to use for stderr until stdio</div><div class="line">  * is reopened.</div><div class="line">  *</div><div class="line">  * @throws Zygote.MethodAndArgsCaller on success to</div><div class="line">  * trampoline to code that invokes static main.</div><div class="line">  */</div><div class="line"> private void handleChildProc(Arguments parsedArgs,</div><div class="line">         FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr)</div><div class="line">         throws Zygote.MethodAndArgsCaller &#123;</div><div class="line">     /**</div><div class="line">      * By the time we get here, the native code has closed the two actual Zygote</div><div class="line">      * socket connections, and substituted /dev/null in their place.  The LocalSocket</div><div class="line">      * objects still need to be closed properly.</div><div class="line">      */</div><div class="line"></div><div class="line">     closeSocket();</div><div class="line">     if (descriptors != null) &#123;</div><div class="line">         try &#123;</div><div class="line">             Os.dup2(descriptors[0], STDIN_FILENO);</div><div class="line">             Os.dup2(descriptors[1], STDOUT_FILENO);</div><div class="line">             Os.dup2(descriptors[2], STDERR_FILENO);</div><div class="line"></div><div class="line">             for (FileDescriptor fd: descriptors) &#123;</div><div class="line">                 IoUtils.closeQuietly(fd);</div><div class="line">             &#125;</div><div class="line">             newStderr = System.err;</div><div class="line">         &#125; catch (ErrnoException ex) &#123;</div><div class="line">             Log.e(TAG, &quot;Error reopening stdio&quot;, ex);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     if (parsedArgs.niceName != null) &#123;</div><div class="line">//设置进程名</div><div class="line">         Process.setArgV0(parsedArgs.niceName);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     // End of the postFork event.</div><div class="line">     Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">     if (parsedArgs.invokeWith != null) &#123;</div><div class="line">         WrapperInit.execApplication(parsedArgs.invokeWith,</div><div class="line">                 parsedArgs.niceName, parsedArgs.targetSdkVersion,</div><div class="line">                 VMRuntime.getCurrentInstructionSet(),</div><div class="line">                 pipeFd, parsedArgs.remainingArgs);</div><div class="line">     &#125; else &#123;</div><div class="line">//通过这里启动</div><div class="line">         ZygoteInit.zygoteInit(parsedArgs.targetSdkVersion,</div><div class="line">                 parsedArgs.remainingArgs, null /* classLoader */);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>关闭连接，之后根据parsedArgs.invokeWith的判断决定用什么执行。<br>有一篇参考：<a href="https://blog.csdn.net/Roland_Sun/article/details/45870677" target="_blank" rel="external">https://blog.csdn.net/Roland_Sun/article/details/45870677</a></p>
<p>区别先理解为快速启动和通过系统命令app_process启动，需要时再来分析</p>
<h3 id="6-ZygoteInit-zygoteInit"><a href="#6-ZygoteInit-zygoteInit" class="headerlink" title="6-ZygoteInit.zygoteInit"></a>6-ZygoteInit.zygoteInit</h3><p>ZygoteInit.zygoteInit<br>frameworks\base\core\java\com\android\internal\os\ZygoteInit.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  /**</div><div class="line">   * The main function called when started through the zygote process. This</div><div class="line">   * could be unified with main(), if the native code in nativeFinishInit()</div><div class="line">   * were rationalized with Zygote startup.&lt;p&gt;</div><div class="line">   *</div><div class="line">   * Current recognized args:</div><div class="line">   * &lt;ul&gt;</div><div class="line">   *   &lt;li&gt; &lt;code&gt; [--] &amp;lt;start class name&amp;gt;  &amp;lt;args&amp;gt;</div><div class="line">   * &lt;/ul&gt;</div><div class="line">   *</div><div class="line">   * @param targetSdkVersion target SDK version</div><div class="line">   * @param argv arg strings</div><div class="line">   */</div><div class="line">  public static final void zygoteInit(int targetSdkVersion, String[] argv,</div><div class="line">          ClassLoader classLoader) throws Zygote.MethodAndArgsCaller &#123;</div><div class="line">      if (RuntimeInit.DEBUG) &#123;</div><div class="line">          Slog.d(RuntimeInit.TAG, &quot;RuntimeInit: Starting application from zygote&quot;);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;ZygoteInit&quot;);</div><div class="line">      RuntimeInit.redirectLogStreams();</div><div class="line"></div><div class="line">      RuntimeInit.commonInit();//通用初始化</div><div class="line">//进程初始化</div><div class="line">      ZygoteInit.nativeZygoteInit();</div><div class="line">      RuntimeInit.applicationInit(targetSdkVersion, argv, classLoader);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>commonInit：设置默认的未捕捉异常处理方法、设置时区、重置log配置、设置默认的HTTP User-agent格式,用于 HttpURLConnection、设置socket的tag，用于网络流量统计。<br>nativeZygoteInit：打开/dev/binder驱动设备、启动Binder线程进入service循环，因此每个进程都有Binder通信机制。</p>
<h3 id="7-RuntimeInit-applicationInit"><a href="#7-RuntimeInit-applicationInit" class="headerlink" title="7-RuntimeInit.applicationInit"></a>7-RuntimeInit.applicationInit</h3><p>frameworks\base\core\java\com\android\internal\os\RuntimeInit.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> protected static void applicationInit(int targetSdkVersion, String[] argv, ClassLoader classLoader)</div><div class="line">         throws Zygote.MethodAndArgsCaller &#123;</div><div class="line">     // If the application calls System.exit(), terminate the process</div><div class="line">     // immediately without running any shutdown hooks.  It is not possible to</div><div class="line">     // shutdown an Android application gracefully.  Among other things, the</div><div class="line">     // Android runtime shutdown hooks close the Binder driver, which can cause</div><div class="line">     // leftover running threads to crash before the process actually exits.</div><div class="line">//true代表应用程序退出时不调用AppRuntime.onExit()，否则会在退出前调用</div><div class="line">     nativeSetExitWithoutCleanup(true);</div><div class="line"></div><div class="line">     // We want to be fairly aggressive about heap utilization, to avoid</div><div class="line">     // holding on to a lot of memory that isn&apos;t needed.</div><div class="line">//设置虚拟机的内存利用率参数值为0.75</div><div class="line">     VMRuntime.getRuntime().setTargetHeapUtilization(0.75f);</div><div class="line">     VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);</div><div class="line"></div><div class="line">     final Arguments args;</div><div class="line">     try &#123;</div><div class="line">         args = new Arguments(argv);</div><div class="line">     &#125; catch (IllegalArgumentException ex) &#123;</div><div class="line">         Slog.e(TAG, ex.getMessage());</div><div class="line">         // let the process exit</div><div class="line">         return;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     // The end of of the RuntimeInit event (see #zygoteInit).</div><div class="line">     Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line"></div><div class="line">     // Remaining arguments are passed to the start class&apos;s static main</div><div class="line">     invokeStaticMain(args.startClass, args.startArgs, classLoader);</div><div class="line"> &#125;</div><div class="line"></div><div class="line">	</div><div class="line">	</div><div class="line">	</div><div class="line"> /**</div><div class="line">  * Invokes a static &quot;main(argv[]) method on class &quot;className&quot;.</div><div class="line">  * Converts various failing exceptions into RuntimeExceptions, with</div><div class="line">  * the assumption that they will then cause the VM instance to exit.</div><div class="line">  *</div><div class="line">  * @param className Fully-qualified class name</div><div class="line">  * @param argv Argument vector for main()</div><div class="line">  * @param classLoader the classLoader to load &#123;@className&#125; with</div><div class="line">  */</div><div class="line"> private static void invokeStaticMain(String className, String[] argv, ClassLoader classLoader)</div><div class="line">         throws Zygote.MethodAndArgsCaller &#123;</div><div class="line">     Class&lt;?&gt; cl;</div><div class="line"></div><div class="line">     try &#123;</div><div class="line">         cl = Class.forName(className, true, classLoader);</div><div class="line">     &#125; catch (ClassNotFoundException ex) &#123;</div><div class="line">         throw new RuntimeException(</div><div class="line">                 &quot;Missing class when invoking static main &quot; + className,</div><div class="line">                 ex);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     Method m;</div><div class="line">     try &#123;</div><div class="line">         m = cl.getMethod(&quot;main&quot;, new Class[] &#123; String[].class &#125;);</div><div class="line">     &#125; catch (NoSuchMethodException ex) &#123;</div><div class="line">         throw new RuntimeException(</div><div class="line">                 &quot;Missing static main on &quot; + className, ex);</div><div class="line">     &#125; catch (SecurityException ex) &#123;</div><div class="line">         throw new RuntimeException(</div><div class="line">                 &quot;Problem getting static main on &quot; + className, ex);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     int modifiers = m.getModifiers();  //此时还在java层，这里是反射</div><div class="line">     if (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;</div><div class="line">         throw new RuntimeException(</div><div class="line">                 &quot;Main method is not public and static on &quot; + className);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     /*</div><div class="line">      * This throw gets caught in ZygoteInit.main(), which responds</div><div class="line">      * by invoking the exception&apos;s run() method. This arrangement</div><div class="line">      * clears up all the stack frames that were required in setting</div><div class="line">      * up the process.</div><div class="line">      */</div><div class="line">     throw new Zygote.MethodAndArgsCaller(m, argv);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>最终抛出Zygote.MethodAndArgsCaller(m, argv)</p>
<p>frameworks\base\core\java\com\android\internal\os\Zygote.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * Helper exception class which holds a method and arguments and</div><div class="line"> * can call them. This is used as part of a trampoline to get rid of</div><div class="line"> * the initial process setup stack frames.</div><div class="line"> */</div><div class="line">public static class MethodAndArgsCaller extends Exception</div><div class="line">        implements Runnable &#123;</div><div class="line">    /** method to call */</div><div class="line">    private final Method mMethod;</div><div class="line"></div><div class="line">    /** argument array */</div><div class="line">    private final String[] mArgs;</div><div class="line"></div><div class="line">    public MethodAndArgsCaller(Method method, String[] args) &#123;</div><div class="line">        mMethod = method;</div><div class="line">        mArgs = args;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void run() &#123;</div><div class="line">        try &#123;</div><div class="line">            mMethod.invoke(null, new Object[] &#123; mArgs &#125;);</div><div class="line">        &#125; catch (IllegalAccessException ex) &#123;</div><div class="line">            throw new RuntimeException(ex);</div><div class="line">        &#125; catch (InvocationTargetException ex) &#123;</div><div class="line">            Throwable cause = ex.getCause();</div><div class="line">            if (cause instanceof RuntimeException) &#123;</div><div class="line">                throw (RuntimeException) cause;</div><div class="line">            &#125; else if (cause instanceof Error) &#123;</div><div class="line">                throw (Error) cause;</div><div class="line">            &#125;</div><div class="line">            throw new RuntimeException(ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MethodAndArgsCaller继承Exception类并实现Runnable接口，这里是个有意思的地方，最终这个MethodAndArgsCaller异常会被ZygoteInit的main函数捕获。<br>java中的函数抛出异常没有被当前函数捕获，当前函数的执行将异常退出，退出该栈。并将这个异常向上传递直到被捕获。</p>
<p>捕获点：<br>frameworks\base\core\java\com\android\internal\os\ZygoteInit.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">   public static void main(String argv[]) &#123;</div><div class="line"></div><div class="line">.....</div><div class="line">       </div><div class="line">           zygoteServer.runSelectLoop(abiList);  //进入选择循环</div><div class="line"></div><div class="line">           zygoteServer.closeServerSocket();</div><div class="line">       &#125; catch (Zygote.MethodAndArgsCaller caller) &#123;</div><div class="line">           caller.run();//执行</div><div class="line">       &#125; catch (Throwable ex) &#123;</div><div class="line">           Log.e(TAG, &quot;System zygote died with exception&quot;, ex);</div><div class="line">           zygoteServer.closeServerSocket();</div><div class="line">           throw ex;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>可见在ZygoteInit的main捕获并执行run<br>这样做的原因是为了保证一个干净的虚拟机栈。该栈最后只剩执行到尾部的ZygoteInit.main之后即可执行ActivityThread.main。<br>透过这点思考出：java的错误机制只不过使另一种函数返回方式，原理为栈的快速回退。快速回逆的时候可以携带对象参数，并且可以对该参数拦截控制栈回退的位置！</p>
<h3 id="10-ActivityThread-main"><a href="#10-ActivityThread-main" class="headerlink" title="10-ActivityThread.main"></a>10-ActivityThread.main</h3><p>捕获执行的run中执行了android.app.ActivityThread.main<br>frameworks\base\core\java\android\app\ActivityThread.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">   public static void main(String[] args) &#123;</div><div class="line">       Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;ActivityThreadMain&quot;);</div><div class="line">       SamplingProfilerIntegration.start();</div><div class="line"></div><div class="line">       // CloseGuard defaults to true and can be quite spammy.  We</div><div class="line">       // disable it here, but selectively enable it later (via</div><div class="line">       // StrictMode) on debug builds, but using DropBox, not logs.</div><div class="line">       CloseGuard.setEnabled(false);</div><div class="line"></div><div class="line">       Environment.initForCurrentUser();</div><div class="line"></div><div class="line">       // Set the reporter for event logging in libcore</div><div class="line">       EventLogger.setReporter(new EventLoggingReporter());</div><div class="line"></div><div class="line">       // Make sure TrustedCertificateStore looks in the right place for CA certificates</div><div class="line">       final File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</div><div class="line">       TrustedCertificateStore.setDefaultUserDirectory(configDir);</div><div class="line"></div><div class="line">       Process.setArgV0(&quot;&lt;pre-initialized&gt;&quot;);</div><div class="line">    //创建主线程looper</div><div class="line">       Looper.prepareMainLooper();</div><div class="line"></div><div class="line">	//创建ActivityThread</div><div class="line">       ActivityThread thread = new ActivityThread();</div><div class="line">	//attach到系统进程</div><div class="line">       thread.attach(false);</div><div class="line">	</div><div class="line">	//创建Handler</div><div class="line">       if (sMainThreadHandler == null) &#123;</div><div class="line">           sMainThreadHandler = thread.getHandler();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">	//这个不执行</div><div class="line">       if (false) &#123;</div><div class="line">           Looper.myLooper().setMessageLogging(new</div><div class="line">                   LogPrinter(Log.DEBUG, &quot;ActivityThread&quot;));</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       //主线程进入循环状态，以后用于启动activity、service</div><div class="line">       Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">       Looper.loop();</div><div class="line"></div><div class="line">       throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">static volatile Handler sMainThreadHandler;  // set once in main()</div><div class="line">final H mH = new H();</div><div class="line">final Handler getHandler() &#123;</div><div class="line">       return mH;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这就是主线程，也就是UI线程。关于Looper需要回顾下android多线程编程：<br>Looper：每个线程的messagequeue管家，调用loop之后进入循环，发现messagequeue中有消息就取出，传递到Handler中执行。<br>MessageQueue：存放handler的消息<br>Message：线程间的消息<br>Handler：处理、发送消息。</p>
<p>frameworks\base\core\java\android\os\Looper.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">static final ThreadLocal&lt;Looper&gt; sThreadLocal = new ThreadLocal&lt;Looper&gt;();</div><div class="line">private static Looper sMainLooper;  // guarded by Looper.class</div><div class="line"></div><div class="line">   public static void prepareMainLooper() &#123;</div><div class="line">       prepare(false);</div><div class="line">       synchronized (Looper.class) &#123;</div><div class="line">           if (sMainLooper != null) &#123;</div><div class="line">               throw new IllegalStateException(&quot;The main Looper has already been prepared.&quot;);</div><div class="line">           &#125;</div><div class="line">           sMainLooper = myLooper();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">private static void prepare(boolean quitAllowed) &#123;</div><div class="line">       if (sThreadLocal.get() != null) &#123;</div><div class="line">           throw new RuntimeException(&quot;Only one Looper may be created per thread&quot;);</div><div class="line">       &#125;</div><div class="line">       sThreadLocal.set(new Looper(quitAllowed));</div><div class="line">   &#125;</div><div class="line">private Looper(boolean quitAllowed) &#123;</div><div class="line">       mQueue = new MessageQueue(quitAllowed);</div><div class="line">       mThread = Thread.currentThread();</div><div class="line">   &#125;</div><div class="line">final MessageQueue mQueue;</div></pre></td></tr></table></figure></p>
<p>一般线程里looper初始化用prepare里面的sThreadLocal是static final的，说明其线程唯一。底层保证其创建于线程私有空间<br>在ActivityThread里的prepareMainLooper中还赋值给了sMainLooper，为该类所有，是进程唯一。主线程looper可以被其它线程直接获取<br>同时创建lopper时会创建与lopper唯一绑定的queue，主线程创建时传入false不允许退出，该对象是属于looper对象的，属于进程空间，可被线程共享，因此用来接收消息。</p>
<p>frameworks\base\core\java\android\os\Handler.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public Handler(Callback callback, boolean async) &#123;</div><div class="line">    if (FIND_POTENTIAL_LEAKS) &#123;</div><div class="line">        final Class&lt;? extends Handler&gt; klass = getClass();</div><div class="line">        if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;</div><div class="line">                (klass.getModifiers() &amp; Modifier.STATIC) == 0) &#123;</div><div class="line">            Log.w(TAG, &quot;The following Handler class should be static or leaks might occur: &quot; +</div><div class="line">                klass.getCanonicalName());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mLooper = Looper.myLooper();</div><div class="line">    if (mLooper == null) &#123;</div><div class="line">        throw new RuntimeException(</div><div class="line">            &quot;Can&apos;t create handler inside thread that has not called Looper.prepare()&quot;);</div><div class="line">    &#125;</div><div class="line">    mQueue = mLooper.mQueue;</div><div class="line">    mCallback = callback;</div><div class="line">    mAsynchronous = async;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>普通的Handler生成方式：构造Handler时绑定该线程的looper，因此所有线程用该handler发送的消息都到了handler创建的线程的处理looper中。<br>ActivityThread的Handler生成方式：直接获取一个该对象唯一的H继承Handler，也就是为lopper绑定了一个已经实现的Handler，该对象与activityThread类绑定，static可被全局找到<br>消息传递的核心是队列，利用了线程共享数据作为消息接发，实现线程通信。</p>
<p>loop<br>frameworks\base\core\java\android\os\Looper.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">   /**</div><div class="line">    * Run the message queue in this thread. Be sure to call</div><div class="line">    * &#123;@link #quit()&#125; to end the loop.</div><div class="line">    */</div><div class="line">   public static void loop() &#123;</div><div class="line">       final Looper me = myLooper();</div><div class="line">       if (me == null) &#123;</div><div class="line">           throw new RuntimeException(&quot;No Looper; Looper.prepare() wasn&apos;t called on this thread.&quot;);</div><div class="line">       &#125;</div><div class="line">	//获取lopper绑定的queue</div><div class="line">       final MessageQueue queue = me.mQueue;</div><div class="line"></div><div class="line">       // Make sure the identity of this thread is that of the local process,</div><div class="line">       // and keep track of what that identity token actually is.</div><div class="line">       Binder.clearCallingIdentity();</div><div class="line">       final long ident = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">       for (;;) &#123;</div><div class="line">           Message msg = queue.next(); // might block  在这里阻塞</div><div class="line">           if (msg == null) &#123;</div><div class="line">               // No message indicates that the message queue is quitting.</div><div class="line">               return;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           // This must be in a local variable, in case a UI event sets the logger</div><div class="line">           final Printer logging = me.mLogging;</div><div class="line">           if (logging != null) &#123;</div><div class="line">               logging.println(&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot; + msg.target + &quot; &quot; +</div><div class="line">                       msg.callback + &quot;: &quot; + msg.what);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           final long slowDispatchThresholdMs = me.mSlowDispatchThresholdMs;</div><div class="line"></div><div class="line">           final long traceTag = me.mTraceTag;</div><div class="line">           if (traceTag != 0 &amp;&amp; Trace.isTagEnabled(traceTag)) &#123;</div><div class="line">               Trace.traceBegin(traceTag, msg.target.getTraceName(msg));</div><div class="line">           &#125;</div><div class="line">           final long start = (slowDispatchThresholdMs == 0) ? 0 : SystemClock.uptimeMillis();</div><div class="line">           final long end;</div><div class="line">           try &#123;</div><div class="line">			//获取msg的handler来处理</div><div class="line">               msg.target.dispatchMessage(msg);</div><div class="line">               end = (slowDispatchThresholdMs == 0) ? 0 : SystemClock.uptimeMillis();</div><div class="line">           &#125; finally &#123;</div><div class="line">               if (traceTag != 0) &#123;</div><div class="line">                   Trace.traceEnd(traceTag);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           if (slowDispatchThresholdMs &gt; 0) &#123;</div><div class="line">               final long time = end - start;</div><div class="line">               if (time &gt; slowDispatchThresholdMs) &#123;</div><div class="line">                   Slog.w(TAG, &quot;Dispatch took &quot; + time + &quot;ms on &quot;</div><div class="line">                           + Thread.currentThread().getName() + &quot;, h=&quot; +</div><div class="line">                           msg.target + &quot; cb=&quot; + msg.callback + &quot; msg=&quot; + msg.what);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           if (logging != null) &#123;</div><div class="line">               logging.println(&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot; + msg.target + &quot; &quot; + msg.callback);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           // Make sure that during the course of dispatching the</div><div class="line">           // identity of the thread wasn&apos;t corrupted.</div><div class="line">           final long newIdent = Binder.clearCallingIdentity();</div><div class="line">           if (ident != newIdent) &#123;</div><div class="line">               Log.wtf(TAG, &quot;Thread identity changed from 0x&quot;</div><div class="line">                       + Long.toHexString(ident) + &quot; to 0x&quot;</div><div class="line">                       + Long.toHexString(newIdent) + &quot; while dispatching to &quot;</div><div class="line">                       + msg.target.getClass().getName() + &quot; &quot;</div><div class="line">                       + msg.callback + &quot; what=&quot; + msg.what);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           msg.recycleUnchecked();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">//frameworks\base\core\java\android\os\Handler.java</div><div class="line">public void dispatchMessage(Message msg) &#123;</div><div class="line">       if (msg.callback != null) &#123;</div><div class="line">           handleCallback(msg);</div><div class="line">       &#125; else &#123;</div><div class="line">           if (mCallback != null) &#123;</div><div class="line">               if (mCallback.handleMessage(msg)) &#123;</div><div class="line">                   return;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           handleMessage(msg);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>looper所在线程为处理线程，此处轮询queue获取msg调用发送它的handler执行dispatchMessage最后执行handleMessage。<br>因为handler创建时绑定线程因此发送时只发送给绑定的线程因此受到的线程执行他的处理方法即可。<br>之后等待AMS的消息………</p>
<h3 id="12-ActivityThread-attach"><a href="#12-ActivityThread-attach" class="headerlink" title="12-ActivityThread.attach"></a>12-ActivityThread.attach</h3><p>frameworks\base\core\java\android\app\ActivityThread.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line">	</div><div class="line">final ApplicationThread mAppThread = new ApplicationThread();</div><div class="line">private static volatile ActivityThread sCurrentActivityThread;</div><div class="line">	</div><div class="line">    private void attach(boolean system) &#123;</div><div class="line">		//保存进程唯一当前主线程</div><div class="line">        sCurrentActivityThread = this;</div><div class="line">        mSystemThread = system; </div><div class="line">		//不是系统线程</div><div class="line">        if (!system) &#123;</div><div class="line">            ViewRootImpl.addFirstDrawHandler(new Runnable() &#123;</div><div class="line">                @Override</div><div class="line">                public void run() &#123;</div><div class="line">                    ensureJitEnabled();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            android.ddm.DdmHandleAppName.setAppName(&quot;&lt;pre-initialized&gt;&quot;,</div><div class="line">                                                    UserHandle.myUserId());</div><div class="line">													</div><div class="line">			//初始化RuntimeInit.mApplicationObject值为作为Binder的ApplicationThread</div><div class="line">            RuntimeInit.setApplicationObject(mAppThread.asBinder());</div><div class="line">            final IActivityManager mgr = ActivityManager.getService();</div><div class="line">            try &#123;</div><div class="line">				</div><div class="line">				</div><div class="line">				//binder调用AMS的方法传递的是IApplicationThread也就是应用进程的binder</div><div class="line">                mgr.attachApplication(mAppThread);</div><div class="line">            &#125; catch (RemoteException ex) &#123;</div><div class="line">                throw ex.rethrowFromSystemServer();</div><div class="line">            &#125;</div><div class="line">            // Watch for getting close to heap limit.</div><div class="line">            BinderInternal.addGcWatcher(new Runnable() &#123;</div><div class="line">                @Override public void run() &#123;</div><div class="line">                    if (!mSomeActivitiesChanged) &#123;</div><div class="line">                        return;</div><div class="line">                    &#125;</div><div class="line">                    Runtime runtime = Runtime.getRuntime();</div><div class="line">                    long dalvikMax = runtime.maxMemory();</div><div class="line">                    long dalvikUsed = runtime.totalMemory() - runtime.freeMemory();</div><div class="line">                    if (dalvikUsed &gt; ((3*dalvikMax)/4)) &#123;</div><div class="line">                        if (DEBUG_MEMORY_TRIM) Slog.d(TAG, &quot;Dalvik max=&quot; + (dalvikMax/1024)</div><div class="line">                                + &quot; total=&quot; + (runtime.totalMemory()/1024)</div><div class="line">                                + &quot; used=&quot; + (dalvikUsed/1024));</div><div class="line">                        mSomeActivitiesChanged = false;</div><div class="line">                        try &#123;</div><div class="line">                            mgr.releaseSomeActivities(mAppThread);</div><div class="line">                        &#125; catch (RemoteException e) &#123;</div><div class="line">                            throw e.rethrowFromSystemServer();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125; else &#123;</div><div class="line">......</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // add dropbox logging to libcore</div><div class="line">        DropBox.setReporter(new DropBoxReporter());</div><div class="line"></div><div class="line">        ViewRootImpl.ConfigChangedCallback configChangedCallback</div><div class="line">                = (Configuration globalConfig) -&gt; &#123;</div><div class="line">            synchronized (mResourcesManager) &#123;</div><div class="line">                // We need to apply this change to the resources immediately, because upon returning</div><div class="line">                // the view hierarchy will be informed about it.</div><div class="line">                if (mResourcesManager.applyConfigurationToResourcesLocked(globalConfig,</div><div class="line">                        null /* compat */)) &#123;</div><div class="line">                    updateLocaleListFromAppContext(mInitialApplication.getApplicationContext(),</div><div class="line">                            mResourcesManager.getConfiguration().getLocales());</div><div class="line"></div><div class="line">                    // This actually changed the resources! Tell everyone about it.</div><div class="line">                    if (mPendingConfiguration == null</div><div class="line">                            || mPendingConfiguration.isOtherSeqNewer(globalConfig)) &#123;</div><div class="line">                        mPendingConfiguration = globalConfig;</div><div class="line">                        sendMessage(H.CONFIGURATION_CHANGED, globalConfig);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        ViewRootImpl.addConfigCallback(configChangedCallback);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	private class ApplicationThread extends IApplicationThread.Stub &#123;</div><div class="line">		......</div><div class="line">	&#125;</div><div class="line">//frameworks\base\core\java\com\android\internal\os\RuntimeInit.java</div><div class="line">	private static IBinder mApplicationObject;</div><div class="line">	public static final void setApplicationObject(IBinder app) &#123;</div><div class="line">        mApplicationObject = app;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>mAppThread是一个ApplicationThread类型的Binder对象，它的作用是用来进行进程间通信的。其继承于IApplicationThread.Stub<br>IActivityManager与IApplicationThread用于应用与服务互相交互，一个位于服务一个位于应用。<br><a href="http://duanqz.github.io/2016-01-29-Activity-IPC" target="_blank" rel="external">http://duanqz.github.io/2016-01-29-Activity-IPC</a><br>注意ApplicationThread运行于Binder线程。</p>
<h3 id="13-AMS-attachApplication"><a href="#13-AMS-attachApplication" class="headerlink" title="13-AMS.attachApplication"></a>13-AMS.attachApplication</h3><p>AMS.attachApplication<br>frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">  @Override</div><div class="line">  public final void attachApplication(IApplicationThread thread) &#123;</div><div class="line">      synchronized (this) &#123;</div><div class="line">          int callingPid = Binder.getCallingPid();//调用者pid</div><div class="line">          final long origId = Binder.clearCallingIdentity();</div><div class="line">          attachApplicationLocked(thread, callingPid);</div><div class="line">          Binder.restoreCallingIdentity(origId);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">	</div><div class="line">	</div><div class="line">  </div><div class="line">  private final boolean attachApplicationLocked(IApplicationThread thread,</div><div class="line">          int pid) &#123;</div><div class="line"></div><div class="line">      // Find the application record that is being attached...  either via</div><div class="line">      // the pid if we are running in multiple processes, or just pull the</div><div class="line">      // next app record if we are emulating process with anonymous threads.</div><div class="line">//根据pid获取ProcessRecord应用信息</div><div class="line">      ProcessRecord app;</div><div class="line">      long startTime = SystemClock.uptimeMillis();</div><div class="line">      if (pid != MY_PID &amp;&amp; pid &gt;= 0) &#123;</div><div class="line">          synchronized (mPidsSelfLocked) &#123;</div><div class="line">              app = mPidsSelfLocked.get(pid);</div><div class="line">          &#125;</div><div class="line">      &#125; else &#123;</div><div class="line">          app = null;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (app == null) &#123;</div><div class="line">          Slog.w(TAG, &quot;No pending application record for pid &quot; + pid</div><div class="line">                  + &quot; (IApplicationThread &quot; + thread + &quot;); dropping process&quot;);</div><div class="line">          EventLog.writeEvent(EventLogTags.AM_DROP_PROCESS, pid);</div><div class="line">          if (pid &gt; 0 &amp;&amp; pid != MY_PID) &#123;</div><div class="line">              killProcessQuiet(pid);</div><div class="line">              //TODO: killProcessGroup(app.info.uid, pid);</div><div class="line">          &#125; else &#123;</div><div class="line">              try &#123;</div><div class="line">                  thread.scheduleExit();</div><div class="line">              &#125; catch (Exception e) &#123;</div><div class="line">                  // Ignore exceptions.</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          return false;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      // If this application record is still attached to a previous</div><div class="line">      // process, clean it up now.</div><div class="line">      if (app.thread != null) &#123;</div><div class="line">	//之前绑过的进程信息清除</div><div class="line">          handleAppDiedLocked(app, true, true);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      // Tell the process all about itself.</div><div class="line"></div><div class="line">      if (DEBUG_ALL) Slog.v(</div><div class="line">              TAG, &quot;Binding process pid &quot; + pid + &quot; to record &quot; + app);</div><div class="line"></div><div class="line">      final String processName = app.processName;</div><div class="line">      try &#123;</div><div class="line">	//注册应用进程的DeathRecipient，当应用进程崩溃时，系统进程可以收到通知</div><div class="line">          AppDeathRecipient adr = new AppDeathRecipient(</div><div class="line">                  app, pid, thread);</div><div class="line">          thread.asBinder().linkToDeath(adr, 0);</div><div class="line">          app.deathRecipient = adr;</div><div class="line">      &#125; catch (RemoteException e) &#123;</div><div class="line">          app.resetPackageList(mProcessStats);</div><div class="line">          startProcessLocked(app, &quot;link fail&quot;, processName);</div><div class="line">          return false;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      EventLog.writeEvent(EventLogTags.AM_PROC_BOUND, app.userId, app.pid, app.processName);</div><div class="line">// 将ProcessRecord对象绑定到应用进程，这是ProcessRecord就变成了“激活”状态</div><div class="line">//给予IApplicationThread</div><div class="line">      app.makeActive(thread, mProcessStats);</div><div class="line">      app.curAdj = app.setAdj = app.verifiedAdj = ProcessList.INVALID_ADJ;</div><div class="line">      app.curSchedGroup = app.setSchedGroup = ProcessList.SCHED_GROUP_DEFAULT;</div><div class="line">      app.forcingToImportant = null;</div><div class="line">      updateProcessForegroundLocked(app, false, false);</div><div class="line">      app.hasShownUi = false;</div><div class="line">      app.debugging = false;</div><div class="line">      app.cached = false;</div><div class="line">      app.killedByAm = false;</div><div class="line">      app.killed = false;</div><div class="line"></div><div class="line"></div><div class="line">      // We carefully use the same state that PackageManager uses for</div><div class="line">      // filtering, since we use this flag to decide if we need to install</div><div class="line">      // providers when user is unlocked later</div><div class="line">      app.unlocked = StorageManager.isUserKeyUnlocked(app.userId);</div><div class="line"></div><div class="line">      mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</div><div class="line"></div><div class="line">//获取应用进程中所有注册的Provider，这需要通过PackageManager来扫描进程所关联的包名，</div><div class="line">//所有静态的Provider信息，即ProviderInfo对象，都会保存到ProcessRecord.pubProviders变量中</div><div class="line">      boolean normalMode = mProcessesReady || isAllowedWhileBooting(app.info);</div><div class="line">      List&lt;ProviderInfo&gt; providers = normalMode ? generateApplicationProvidersLocked(app) : null;</div><div class="line"></div><div class="line">      if (providers != null &amp;&amp; checkAppInLaunchingProvidersLocked(app)) &#123;</div><div class="line">          Message msg = mHandler.obtainMessage(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG);</div><div class="line">          msg.obj = app;</div><div class="line">          mHandler.sendMessageDelayed(msg, CONTENT_PROVIDER_PUBLISH_TIMEOUT);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      checkTime(startTime, &quot;attachApplicationLocked: before bindApplication&quot;);</div><div class="line"></div><div class="line">      if (!normalMode) &#123;</div><div class="line">          Slog.i(TAG, &quot;Launching preboot mode app: &quot; + app);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (DEBUG_ALL) Slog.v(</div><div class="line">          TAG, &quot;New app record &quot; + app</div><div class="line">          + &quot; thread=&quot; + thread.asBinder() + &quot; pid=&quot; + pid);</div><div class="line">      try &#123;</div><div class="line">          int testMode = ApplicationThreadConstants.DEBUG_OFF;</div><div class="line">          if (mDebugApp != null &amp;&amp; mDebugApp.equals(processName)) &#123;</div><div class="line">              testMode = mWaitForDebugger</div><div class="line">                  ? ApplicationThreadConstants.DEBUG_WAIT</div><div class="line">                  : ApplicationThreadConstants.DEBUG_ON;</div><div class="line">              app.debugging = true;</div><div class="line">              if (mDebugTransient) &#123;</div><div class="line">                  mDebugApp = mOrigDebugApp;</div><div class="line">                  mWaitForDebugger = mOrigWaitForDebugger;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          String profileFile = app.instr != null ? app.instr.mProfileFile : null;</div><div class="line">          ParcelFileDescriptor profileFd = null;</div><div class="line">          int samplingInterval = 0;</div><div class="line">          boolean profileAutoStop = false;</div><div class="line">          boolean profileStreamingOutput = false;</div><div class="line">          if (mProfileApp != null &amp;&amp; mProfileApp.equals(processName)) &#123;</div><div class="line">              mProfileProc = app;</div><div class="line">              profileFile = mProfileFile;</div><div class="line">              profileFd = mProfileFd;</div><div class="line">              samplingInterval = mSamplingInterval;</div><div class="line">              profileAutoStop = mAutoStopProfiler;</div><div class="line">              profileStreamingOutput = mStreamingOutput;</div><div class="line">          &#125;</div><div class="line">          boolean enableTrackAllocation = false;</div><div class="line">          if (mTrackAllocationApp != null &amp;&amp; mTrackAllocationApp.equals(processName)) &#123;</div><div class="line">              enableTrackAllocation = true;</div><div class="line">              mTrackAllocationApp = null;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          // If the app is being launched for restore or full backup, set it up specially</div><div class="line">          boolean isRestrictedBackupMode = false;</div><div class="line">          if (mBackupTarget != null &amp;&amp; mBackupAppName.equals(processName)) &#123;</div><div class="line">              isRestrictedBackupMode = mBackupTarget.appInfo.uid &gt;= FIRST_APPLICATION_UID</div><div class="line">                      &amp;&amp; ((mBackupTarget.backupMode == BackupRecord.RESTORE)</div><div class="line">                              || (mBackupTarget.backupMode == BackupRecord.RESTORE_FULL)</div><div class="line">                              || (mBackupTarget.backupMode == BackupRecord.BACKUP_FULL));</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          if (app.instr != null) &#123;</div><div class="line">              notifyPackageUse(app.instr.mClass.getPackageName(),</div><div class="line">                               PackageManager.NOTIFY_PACKAGE_USE_INSTRUMENTATION);</div><div class="line">          &#125;</div><div class="line">          if (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, &quot;Binding proc &quot;</div><div class="line">                  + processName + &quot; with config &quot; + getGlobalConfiguration());</div><div class="line">          ApplicationInfo appInfo = app.instr != null ? app.instr.mTargetInfo : app.info;</div><div class="line">          app.compat = compatibilityInfoForPackageLocked(appInfo);</div><div class="line">          if (profileFd != null) &#123;</div><div class="line">              profileFd = profileFd.dup();</div><div class="line">          &#125;</div><div class="line">          ProfilerInfo profilerInfo = profileFile == null ? null</div><div class="line">                  : new ProfilerInfo(profileFile, profileFd, samplingInterval, profileAutoStop,</div><div class="line">                                     profileStreamingOutput);</div><div class="line"></div><div class="line">          // We deprecated Build.SERIAL and it is not accessible to</div><div class="line">          // apps that target the v2 security sandbox. Since access to</div><div class="line">          // the serial is now behind a permission we push down the value.</div><div class="line">          String buildSerial = Build.UNKNOWN;</div><div class="line">          if (appInfo.targetSandboxVersion != 2) &#123;</div><div class="line">              buildSerial = IDeviceIdentifiersPolicyService.Stub.asInterface(</div><div class="line">                      ServiceManager.getService(Context.DEVICE_IDENTIFIERS_SERVICE))</div><div class="line">                      .getSerial();</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          // Check if this is a secondary process that should be incorporated into some</div><div class="line">          // currently active instrumentation.  (Note we do this AFTER all of the profiling</div><div class="line">          // stuff above because profiling can currently happen only in the primary</div><div class="line">          // instrumentation process.)</div><div class="line">          if (mActiveInstrumentation.size() &gt; 0 &amp;&amp; app.instr == null) &#123;</div><div class="line">              for (int i = mActiveInstrumentation.size() - 1; i &gt;= 0 &amp;&amp; app.instr == null; i--) &#123;</div><div class="line">                  ActiveInstrumentation aInstr = mActiveInstrumentation.get(i);</div><div class="line">                  if (!aInstr.mFinished &amp;&amp; aInstr.mTargetInfo.uid == app.uid) &#123;</div><div class="line">                      if (aInstr.mTargetProcesses.length == 0) &#123;</div><div class="line">                          // This is the wildcard mode, where every process brought up for</div><div class="line">                          // the target instrumentation should be included.</div><div class="line">                          if (aInstr.mTargetInfo.packageName.equals(app.info.packageName)) &#123;</div><div class="line">                              app.instr = aInstr;</div><div class="line">                              aInstr.mRunningProcesses.add(app);</div><div class="line">                          &#125;</div><div class="line">                      &#125; else &#123;</div><div class="line">                          for (String proc : aInstr.mTargetProcesses) &#123;</div><div class="line">                              if (proc.equals(app.processName)) &#123;</div><div class="line">                                  app.instr = aInstr;</div><div class="line">                                  aInstr.mRunningProcesses.add(app);</div><div class="line">                                  break;</div><div class="line">                              &#125;</div><div class="line">                          &#125;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          checkTime(startTime, &quot;attachApplicationLocked: immediately before bindApplication&quot;);</div><div class="line">          mStackSupervisor.mActivityMetricsLogger.notifyBindApplication(app);</div><div class="line">	</div><div class="line">	</div><div class="line">	//将信息传递给应用进程</div><div class="line">          if (app.instr != null) &#123;</div><div class="line">              thread.bindApplication(processName, appInfo, providers,</div><div class="line">                      app.instr.mClass,</div><div class="line">                      profilerInfo, app.instr.mArguments,</div><div class="line">                      app.instr.mWatcher,</div><div class="line">                      app.instr.mUiAutomationConnection, testMode,</div><div class="line">                      mBinderTransactionTrackingEnabled, enableTrackAllocation,</div><div class="line">                      isRestrictedBackupMode || !normalMode, app.persistent,</div><div class="line">                      new Configuration(getGlobalConfiguration()), app.compat,</div><div class="line">                      getCommonServicesLocked(app.isolated),</div><div class="line">                      mCoreSettingsObserver.getCoreSettingsLocked(),</div><div class="line">                      buildSerial);</div><div class="line">          &#125; else &#123;</div><div class="line">              thread.bindApplication(processName, appInfo, providers, null, profilerInfo,</div><div class="line">                      null, null, null, testMode,</div><div class="line">                      mBinderTransactionTrackingEnabled, enableTrackAllocation,</div><div class="line">                      isRestrictedBackupMode || !normalMode, app.persistent,</div><div class="line">                      new Configuration(getGlobalConfiguration()), app.compat,</div><div class="line">                      getCommonServicesLocked(app.isolated),</div><div class="line">                      mCoreSettingsObserver.getCoreSettingsLocked(),</div><div class="line">                      buildSerial);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          checkTime(startTime, &quot;attachApplicationLocked: immediately after bindApplication&quot;);</div><div class="line">          updateLruProcessLocked(app, false, null);</div><div class="line">          checkTime(startTime, &quot;attachApplicationLocked: after updateLruProcessLocked&quot;);</div><div class="line">          app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();</div><div class="line">      &#125; catch (Exception e) &#123;</div><div class="line">          // todo: Yikes!  What should we do?  For now we will try to</div><div class="line">          // start another process, but that could easily get us in</div><div class="line">          // an infinite loop of restarting processes...</div><div class="line">          Slog.wtf(TAG, &quot;Exception thrown during bind of &quot; + app, e);</div><div class="line"></div><div class="line">          app.resetPackageList(mProcessStats);</div><div class="line">          app.unlinkDeathRecipient();</div><div class="line">          startProcessLocked(app, &quot;bind fail&quot;, processName);</div><div class="line">          return false;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      // Remove this record from the list of starting applications.</div><div class="line">      mPersistentStartingProcesses.remove(app);</div><div class="line">      if (DEBUG_PROCESSES &amp;&amp; mProcessesOnHold.contains(app)) Slog.v(TAG_PROCESSES,</div><div class="line">              &quot;Attach application locked removing on hold: &quot; + app);</div><div class="line">      mProcessesOnHold.remove(app);</div><div class="line"></div><div class="line">      boolean badApp = false;</div><div class="line">      boolean didSomething = false;</div><div class="line"></div><div class="line">      // See if the top visible activity is waiting to run in this process...</div><div class="line">      if (normalMode) &#123;</div><div class="line">          try &#123;</div><div class="line">		//调度activity</div><div class="line">              if (mStackSupervisor.attachApplicationLocked(app)) &#123;</div><div class="line">                  didSomething = true;</div><div class="line">              &#125;</div><div class="line">          &#125; catch (Exception e) &#123;</div><div class="line">              Slog.wtf(TAG, &quot;Exception thrown launching activities in &quot; + app, e);</div><div class="line">              badApp = true;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      // Find any services that should be running in this process...</div><div class="line">      if (!badApp) &#123;</div><div class="line">          try &#123;</div><div class="line">		//调度service</div><div class="line">              didSomething |= mServices.attachApplicationLocked(app, processName);</div><div class="line">              checkTime(startTime, &quot;attachApplicationLocked: after mServices.attachApplicationLocked&quot;);</div><div class="line">          &#125; catch (Exception e) &#123;</div><div class="line">              Slog.wtf(TAG, &quot;Exception thrown starting services in &quot; + app, e);</div><div class="line">              badApp = true;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      // Check if a next-broadcast receiver is in this process...</div><div class="line">      if (!badApp &amp;&amp; isPendingBroadcastProcessLocked(pid)) &#123;</div><div class="line">          try &#123;</div><div class="line">		//调度croadcast</div><div class="line">              didSomething |= sendPendingBroadcastsLocked(app);</div><div class="line">              checkTime(startTime, &quot;attachApplicationLocked: after sendPendingBroadcastsLocked&quot;);</div><div class="line">          &#125; catch (Exception e) &#123;</div><div class="line">              // If the app died trying to launch the receiver we declare it &apos;bad&apos;</div><div class="line">              Slog.wtf(TAG, &quot;Exception thrown dispatching broadcasts in &quot; + app, e);</div><div class="line">              badApp = true;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      // Check whether the next backup agent is in this process...</div><div class="line">      if (!badApp &amp;&amp; mBackupTarget != null &amp;&amp; mBackupTarget.app == app) &#123;</div><div class="line">          if (DEBUG_BACKUP) Slog.v(TAG_BACKUP,</div><div class="line">                  &quot;New app is backup target, launching agent for &quot; + app);</div><div class="line">          notifyPackageUse(mBackupTarget.appInfo.packageName,</div><div class="line">                           PackageManager.NOTIFY_PACKAGE_USE_BACKUP);</div><div class="line">          try &#123;</div><div class="line">              thread.scheduleCreateBackupAgent(mBackupTarget.appInfo,</div><div class="line">                      compatibilityInfoForPackageLocked(mBackupTarget.appInfo),</div><div class="line">                      mBackupTarget.backupMode);</div><div class="line">          &#125; catch (Exception e) &#123;</div><div class="line">              Slog.wtf(TAG, &quot;Exception thrown creating backup agent in &quot; + app, e);</div><div class="line">              badApp = true;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (badApp) &#123;</div><div class="line">          app.kill(&quot;error during init&quot;, true);</div><div class="line">          handleAppDiedLocked(app, false, true);</div><div class="line">          return false;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (!didSomething) &#123;</div><div class="line">          updateOomAdjLocked();</div><div class="line">          checkTime(startTime, &quot;attachApplicationLocked: after updateOomAdjLocked&quot;);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      return true;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>通过Binder.getCallingPid()可以获取Binder接口的调用者所在进程的PID，<br>用进程的ApplicationThread对象赋值给ProcessRecord.thread变量，<br>AMS获取启动要启动进程的信息，AMS将要启动的apk信息发给新进程。通过pid确认要发的包，通过IApplicationThread确定进程目标。<br>将信息传递给应用程序以后，就可以进行调度了。这里通过两个标识来记录调度的情况：badApp标识是否调度失败，默认为false，在依次调度Activity、Service和Broadcast的过程中，根据实际的情况，可能将其调整为true，表示调度失败了。一旦调度失败，则需要杀掉应用进程；didSomething表示确有调度发生。</p>
<h3 id="17-bindApplication"><a href="#17-bindApplication" class="headerlink" title="17-bindApplication"></a>17-bindApplication</h3><p>ApplicationThread会在Binder线程中响应这个跨进程调用，进行一些简单的数据封装后，便向主线程抛出一个BIND_APPLICATION消息<br>又回到新进程的ActivityThread收到Binder消息BIND_APPLICATION调用：</p>
<p>frameworks\base\core\java\android\app\ActivityThread.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div></pre></td><td class="code"><pre><div class="line">H.handleMessage:</div><div class="line">               case BIND_APPLICATION:</div><div class="line">                   Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;bindApplication&quot;);</div><div class="line">                   AppBindData data = (AppBindData)msg.obj;</div><div class="line">                   handleBindApplication(data);</div><div class="line">                   Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">                   break;</div><div class="line">				</div><div class="line">				</div><div class="line">				</div><div class="line">   private void handleBindApplication(AppBindData data) &#123;</div><div class="line">	//数据初始化</div><div class="line">       // Register the UI Thread as a sensitive thread to the runtime.</div><div class="line">       VMRuntime.registerSensitiveThread();</div><div class="line">       if (data.trackAllocation) &#123;</div><div class="line">           DdmVmInternal.enableRecentAllocations(true);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       // Note when this process has started.</div><div class="line">       Process.setStartTimes(SystemClock.elapsedRealtime(), SystemClock.uptimeMillis());</div><div class="line"></div><div class="line">       mBoundApplication = data;</div><div class="line">       mConfiguration = new Configuration(data.config);</div><div class="line">       mCompatConfiguration = new Configuration(data.config);</div><div class="line"></div><div class="line">       mProfiler = new Profiler();</div><div class="line">       if (data.initProfilerInfo != null) &#123;</div><div class="line">           mProfiler.profileFile = data.initProfilerInfo.profileFile;</div><div class="line">           mProfiler.profileFd = data.initProfilerInfo.profileFd;</div><div class="line">           mProfiler.samplingInterval = data.initProfilerInfo.samplingInterval;</div><div class="line">           mProfiler.autoStopProfiler = data.initProfilerInfo.autoStopProfiler;</div><div class="line">           mProfiler.streamingOutput = data.initProfilerInfo.streamingOutput;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       // send up app name; do this *before* waiting for debugger</div><div class="line">	//设置进程名</div><div class="line">       Process.setArgV0(data.processName);</div><div class="line">       android.ddm.DdmHandleAppName.setAppName(data.processName,</div><div class="line">                                               UserHandle.myUserId());</div><div class="line">	//进程运行信息设置</div><div class="line">       if (data.persistent) &#123;</div><div class="line">           // Persistent processes on low-memory devices do not get to</div><div class="line">           // use hardware accelerated drawing, since this can add too much</div><div class="line">           // overhead to the process.</div><div class="line">           if (!ActivityManager.isHighEndGfx()) &#123;</div><div class="line">               ThreadedRenderer.disable(false);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       if (mProfiler.profileFd != null) &#123;</div><div class="line">           mProfiler.startProfiling();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       // If the app is Honeycomb MR1 or earlier, switch its AsyncTask</div><div class="line">       // implementation to use the pool executor.  Normally, we use the</div><div class="line">       // serialized executor as the default. This has to happen in the</div><div class="line">       // main thread so the main looper is set right.</div><div class="line">       if (data.appInfo.targetSdkVersion &lt;= android.os.Build.VERSION_CODES.HONEYCOMB_MR1) &#123;</div><div class="line">           AsyncTask.setDefaultExecutor(AsyncTask.THREAD_POOL_EXECUTOR);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       Message.updateCheckRecycle(data.appInfo.targetSdkVersion);</div><div class="line"></div><div class="line">       /*</div><div class="line">        * Before spawning a new process, reset the time zone to be the system time zone.</div><div class="line">        * This needs to be done because the system time zone could have changed after the</div><div class="line">        * the spawning of this process. Without doing this this process would have the incorrect</div><div class="line">        * system time zone.</div><div class="line">        */</div><div class="line">       TimeZone.setDefault(null);</div><div class="line"></div><div class="line">       /*</div><div class="line">        * Set the LocaleList. This may change once we create the App Context.</div><div class="line">        */</div><div class="line">       LocaleList.setDefault(data.config.getLocales());</div><div class="line"></div><div class="line">       synchronized (mResourcesManager) &#123;</div><div class="line">           /*</div><div class="line">            * Update the system configuration since its preloaded and might not</div><div class="line">            * reflect configuration changes. The configuration object passed</div><div class="line">            * in AppBindData can be safely assumed to be up to date</div><div class="line">            */</div><div class="line">           mResourcesManager.applyConfigurationToResourcesLocked(data.config, data.compatInfo);</div><div class="line">           mCurDefaultDisplayDpi = data.config.densityDpi;</div><div class="line"></div><div class="line">           // This calls mResourcesManager so keep it within the synchronized block.</div><div class="line">           applyCompatConfiguration(mCurDefaultDisplayDpi);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">	</div><div class="line">	</div><div class="line">	//获取LoadedApk对象</div><div class="line">       data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);</div><div class="line"></div><div class="line">       /**</div><div class="line">        * Switch this process to density compatibility mode if needed.</div><div class="line">        */</div><div class="line">       if ((data.appInfo.flags&amp;ApplicationInfo.FLAG_SUPPORTS_SCREEN_DENSITIES)</div><div class="line">               == 0) &#123;</div><div class="line">           mDensityCompatMode = true;</div><div class="line">           Bitmap.setDefaultDensity(DisplayMetrics.DENSITY_DEFAULT);</div><div class="line">       &#125;</div><div class="line">       updateDefaultDensity();</div><div class="line"></div><div class="line">       final String use24HourSetting = mCoreSettings.getString(Settings.System.TIME_12_24);</div><div class="line">       Boolean is24Hr = null;</div><div class="line">       if (use24HourSetting != null) &#123;</div><div class="line">           is24Hr = &quot;24&quot;.equals(use24HourSetting) ? Boolean.TRUE : Boolean.FALSE;</div><div class="line">       &#125;</div><div class="line">       // null : use locale default for 12/24 hour formatting,</div><div class="line">       // false : use 12 hour format,</div><div class="line">       // true : use 24 hour format.</div><div class="line">       DateFormat.set24HourTimePref(is24Hr);</div><div class="line"></div><div class="line">       View.mDebugViewAttributes =</div><div class="line">               mCoreSettings.getInt(Settings.Global.DEBUG_VIEW_ATTRIBUTES, 0) != 0;</div><div class="line"></div><div class="line">       /**</div><div class="line">        * For system applications on userdebug/eng builds, log stack</div><div class="line">        * traces of disk and network access to dropbox for analysis.</div><div class="line">        */</div><div class="line">       if ((data.appInfo.flags &amp;</div><div class="line">            (ApplicationInfo.FLAG_SYSTEM |</div><div class="line">             ApplicationInfo.FLAG_UPDATED_SYSTEM_APP)) != 0) &#123;</div><div class="line">           StrictMode.conditionallyEnableDebugLogging();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       /**</div><div class="line">        * For apps targetting Honeycomb or later, we don&apos;t allow network usage</div><div class="line">        * on the main event loop / UI thread. This is what ultimately throws</div><div class="line">        * &#123;@link NetworkOnMainThreadException&#125;.</div><div class="line">        */</div><div class="line">       if (data.appInfo.targetSdkVersion &gt;= Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">           StrictMode.enableDeathOnNetwork();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       /**</div><div class="line">        * For apps targetting N or later, we don&apos;t allow file:// Uri exposure.</div><div class="line">        * This is what ultimately throws &#123;@link FileUriExposedException&#125;.</div><div class="line">        */</div><div class="line">       if (data.appInfo.targetSdkVersion &gt;= Build.VERSION_CODES.N) &#123;</div><div class="line">           StrictMode.enableDeathOnFileUriExposure();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       // We deprecated Build.SERIAL and only apps that target pre NMR1</div><div class="line">       // SDK can see it. Since access to the serial is now behind a</div><div class="line">       // permission we push down the value and here we fix it up</div><div class="line">       // before any app code has been loaded.</div><div class="line">       try &#123;</div><div class="line">           Field field = Build.class.getDeclaredField(&quot;SERIAL&quot;);</div><div class="line">           field.setAccessible(true);</div><div class="line">           field.set(Build.class, data.buildSerial);</div><div class="line">       &#125; catch (NoSuchFieldException | IllegalAccessException e) &#123;</div><div class="line">           /* ignore */</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       if (data.debugMode != ApplicationThreadConstants.DEBUG_OFF) &#123;</div><div class="line">           // XXX should have option to change the port.</div><div class="line">           Debug.changeDebugPort(8100);</div><div class="line">           if (data.debugMode == ApplicationThreadConstants.DEBUG_WAIT) &#123;</div><div class="line">               Slog.w(TAG, &quot;Application &quot; + data.info.getPackageName()</div><div class="line">                     + &quot; is waiting for the debugger on port 8100...&quot;);</div><div class="line"></div><div class="line">               IActivityManager mgr = ActivityManager.getService();</div><div class="line">               try &#123;</div><div class="line">                   mgr.showWaitingForDebugger(mAppThread, true);</div><div class="line">               &#125; catch (RemoteException ex) &#123;</div><div class="line">                   throw ex.rethrowFromSystemServer();</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               Debug.waitForDebugger();</div><div class="line"></div><div class="line">               try &#123;</div><div class="line">                   mgr.showWaitingForDebugger(mAppThread, false);</div><div class="line">               &#125; catch (RemoteException ex) &#123;</div><div class="line">                   throw ex.rethrowFromSystemServer();</div><div class="line">               &#125;</div><div class="line"></div><div class="line">           &#125; else &#123;</div><div class="line">               Slog.w(TAG, &quot;Application &quot; + data.info.getPackageName()</div><div class="line">                     + &quot; can be debugged on port 8100...&quot;);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       // Allow application-generated systrace messages if we&apos;re debuggable.</div><div class="line">       boolean isAppDebuggable = (data.appInfo.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0;</div><div class="line">       Trace.setAppTracingAllowed(isAppDebuggable);</div><div class="line">       if (isAppDebuggable &amp;&amp; data.enableBinderTracking) &#123;</div><div class="line">           Binder.enableTracing();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       /**</div><div class="line">        * Initialize the default http proxy in this process for the reasons we set the time zone.</div><div class="line">        */</div><div class="line">       Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;Setup proxies&quot;);</div><div class="line">       final IBinder b = ServiceManager.getService(Context.CONNECTIVITY_SERVICE);</div><div class="line">       if (b != null) &#123;</div><div class="line">           // In pre-boot mode (doing initial launch to collect password), not</div><div class="line">           // all system is up.  This includes the connectivity service, so don&apos;t</div><div class="line">           // crash if we can&apos;t get it.</div><div class="line">           final IConnectivityManager service = IConnectivityManager.Stub.asInterface(b);</div><div class="line">           try &#123;</div><div class="line">               final ProxyInfo proxyInfo = service.getProxyForNetwork(null);</div><div class="line">               Proxy.setHttpProxySystemProperty(proxyInfo);</div><div class="line">           &#125; catch (RemoteException e) &#123;</div><div class="line">               Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">               throw e.rethrowFromSystemServer();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line"></div><div class="line">       // Instrumentation info affects the class loader, so load it before</div><div class="line">       // setting up the app context.</div><div class="line">       final InstrumentationInfo ii;</div><div class="line">       if (data.instrumentationName != null) &#123;</div><div class="line">           try &#123;</div><div class="line">               ii = new ApplicationPackageManager(null, getPackageManager())</div><div class="line">                       .getInstrumentationInfo(data.instrumentationName, 0);</div><div class="line">           &#125; catch (PackageManager.NameNotFoundException e) &#123;</div><div class="line">               throw new RuntimeException(</div><div class="line">                       &quot;Unable to find instrumentation info for: &quot; + data.instrumentationName);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           mInstrumentationPackageName = ii.packageName;</div><div class="line">           mInstrumentationAppDir = ii.sourceDir;</div><div class="line">           mInstrumentationSplitAppDirs = ii.splitSourceDirs;</div><div class="line">           mInstrumentationLibDir = getInstrumentationLibrary(data.appInfo, ii);</div><div class="line">           mInstrumentedAppDir = data.info.getAppDir();</div><div class="line">           mInstrumentedSplitAppDirs = data.info.getSplitAppDirs();</div><div class="line">           mInstrumentedLibDir = data.info.getLibDir();</div><div class="line">       &#125; else &#123;</div><div class="line">           ii = null;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">	</div><div class="line">	// 创建ContextImpl上下文</div><div class="line">       final ContextImpl appContext = ContextImpl.createAppContext(this, data.info);</div><div class="line">       updateLocaleListFromAppContext(appContext,</div><div class="line">               mResourcesManager.getConfiguration().getLocales());</div><div class="line">	//缓冲目录设置相关</div><div class="line">       if (!Process.isIsolated() &amp;&amp; !&quot;android&quot;.equals(appContext.getPackageName())) &#123;</div><div class="line">           // This cache location probably points at credential-encrypted</div><div class="line">           // storage which may not be accessible yet; assign it anyway instead</div><div class="line">           // of pointing at device-encrypted storage.</div><div class="line">           final File cacheDir = appContext.getCacheDir();</div><div class="line">           if (cacheDir != null) &#123;</div><div class="line">               // Provide a usable directory for temporary files</div><div class="line">               System.setProperty(&quot;java.io.tmpdir&quot;, cacheDir.getAbsolutePath());</div><div class="line">           &#125; else &#123;</div><div class="line">               Log.v(TAG, &quot;Unable to initialize \&quot;java.io.tmpdir\&quot; property &quot;</div><div class="line">                       + &quot;due to missing cache directory&quot;);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           // Setup a location to store generated/compiled graphics code.</div><div class="line">           final Context deviceContext = appContext.createDeviceProtectedStorageContext();</div><div class="line">           final File codeCacheDir = deviceContext.getCodeCacheDir();</div><div class="line">           if (codeCacheDir != null) &#123;</div><div class="line">               setupGraphicsSupport(appContext, codeCacheDir);</div><div class="line">           &#125; else &#123;</div><div class="line">               Log.e(TAG, &quot;Unable to setupGraphicsSupport due to missing code-cache directory&quot;);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">	//进程相关的初始化代码，包含时区、StrictMode、调试模式等相关的设置</div><div class="line">       // If we use profiles, setup the dex reporter to notify package manager</div><div class="line">       // of any relevant dex loads. The idle maintenance job will use the information</div><div class="line">       // reported to optimize the loaded dex files.</div><div class="line">       // Note that we only need one global reporter per app.</div><div class="line">       // Make sure we do this before calling onCreate so that we can capture the</div><div class="line">       // complete application startup.</div><div class="line">       if (SystemProperties.getBoolean(&quot;dalvik.vm.usejitprofiles&quot;, false)) &#123;</div><div class="line">           BaseDexClassLoader.setReporter(DexLoadReporter.getInstance());</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       // Install the Network Security Config Provider. This must happen before the application</div><div class="line">       // code is loaded to prevent issues with instances of TLS objects being created before</div><div class="line">       // the provider is installed.</div><div class="line">       Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;NetworkSecurityConfigProvider.install&quot;);</div><div class="line">       NetworkSecurityConfigProvider.install(appContext);</div><div class="line">       Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line"></div><div class="line">       // 根据情况初始化Intrumentation对象</div><div class="line">       if (ii != null) &#123;</div><div class="line">           final ApplicationInfo instrApp = new ApplicationInfo();</div><div class="line">           ii.copyTo(instrApp);</div><div class="line">           instrApp.initForUser(UserHandle.myUserId());</div><div class="line">           final LoadedApk pi = getPackageInfo(instrApp, data.compatInfo,</div><div class="line">                   appContext.getClassLoader(), false, true, false);</div><div class="line">           final ContextImpl instrContext = ContextImpl.createAppContext(this, pi);</div><div class="line"></div><div class="line">           try &#123;</div><div class="line">               final ClassLoader cl = instrContext.getClassLoader();</div><div class="line">               mInstrumentation = (Instrumentation)</div><div class="line">                   cl.loadClass(data.instrumentationName.getClassName()).newInstance();</div><div class="line">           &#125; catch (Exception e) &#123;</div><div class="line">               throw new RuntimeException(</div><div class="line">                   &quot;Unable to instantiate instrumentation &quot;</div><div class="line">                   + data.instrumentationName + &quot;: &quot; + e.toString(), e);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           final ComponentName component = new ComponentName(ii.packageName, ii.name);</div><div class="line">           mInstrumentation.init(this, instrContext, appContext, component,</div><div class="line">                   data.instrumentationWatcher, data.instrumentationUiAutomationConnection);</div><div class="line"></div><div class="line">           if (mProfiler.profileFile != null &amp;&amp; !ii.handleProfiling</div><div class="line">                   &amp;&amp; mProfiler.profileFd == null) &#123;</div><div class="line">               mProfiler.handlingProfiling = true;</div><div class="line">               final File file = new File(mProfiler.profileFile);</div><div class="line">               file.getParentFile().mkdirs();</div><div class="line">               Debug.startMethodTracing(file.toString(), 8 * 1024 * 1024);</div><div class="line">           &#125;</div><div class="line">       &#125; else &#123;</div><div class="line">           mInstrumentation = new Instrumentation();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       if ((data.appInfo.flags&amp;ApplicationInfo.FLAG_LARGE_HEAP) != 0) &#123;</div><div class="line">           dalvik.system.VMRuntime.getRuntime().clearGrowthLimit();</div><div class="line">       &#125; else &#123;</div><div class="line">           // Small heap, clamp to the current growth limit and let the heap release</div><div class="line">           // pages after the growth limit to the non growth limit capacity. b/18387825</div><div class="line">           dalvik.system.VMRuntime.getRuntime().clampGrowthLimit();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       // Allow disk access during application and provider setup. This could</div><div class="line">       // block processing ordered broadcasts, but later processing would</div><div class="line">       // probably end up doing the same disk access.</div><div class="line">       final StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();</div><div class="line">       try &#123;</div><div class="line">           // If the app is being launched for full backup or restore, bring it up in</div><div class="line">           // a restricted environment with the base application class.</div><div class="line">		//此处data.info是指LoadedApk, 通过反射创建目标应用Application对象----此时应用已加载</div><div class="line">           Application app = data.info.makeApplication(data.restrictedBackupMode, null);</div><div class="line">           mInitialApplication = app;//设置全局Application</div><div class="line"></div><div class="line">           // don&apos;t bring up providers in restricted mode; they may depend on the</div><div class="line">           // app&apos;s custom Application class</div><div class="line">		//装载Providers</div><div class="line">           if (!data.restrictedBackupMode) &#123;</div><div class="line">               if (!ArrayUtils.isEmpty(data.providers)) &#123;</div><div class="line">                   installContentProviders(app, data.providers);</div><div class="line">                   // For process that contains content providers, we want to</div><div class="line">                   // ensure that the JIT is enabled &quot;at some point&quot;.</div><div class="line">                   mH.sendEmptyMessageDelayed(H.ENABLE_JIT, 10*1000);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           // Do this after providers, since instrumentation tests generally start their</div><div class="line">           // test thread at this point, and we don&apos;t want that racing.</div><div class="line">           try &#123;</div><div class="line">               mInstrumentation.onCreate(data.instrumentationArgs);</div><div class="line">           &#125;</div><div class="line">           catch (Exception e) &#123;</div><div class="line">               throw new RuntimeException(</div><div class="line">                   &quot;Exception thrown in onCreate() of &quot;</div><div class="line">                   + data.instrumentationName + &quot;: &quot; + e.toString(), e);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           try &#123;</div><div class="line">			</div><div class="line">			</div><div class="line">			</div><div class="line">			//调用Application.onCreate()函数</div><div class="line">               mInstrumentation.callApplicationOnCreate(app);</div><div class="line">           &#125; catch (Exception e) &#123;</div><div class="line">               if (!mInstrumentation.onException(app, e)) &#123;</div><div class="line">                   throw new RuntimeException(</div><div class="line">                       &quot;Unable to create application &quot; + app.getClass().getName()</div><div class="line">                       + &quot;: &quot; + e.toString(), e);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; finally &#123;</div><div class="line">           StrictMode.setThreadPolicy(savedPolicy);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       // Preload fonts resources</div><div class="line">       FontsContract.setApplicationContextForResources(appContext);</div><div class="line">       try &#123;</div><div class="line">           final ApplicationInfo info =</div><div class="line">                   getPackageManager().getApplicationInfo(</div><div class="line">                           data.appInfo.packageName,</div><div class="line">                           PackageManager.GET_META_DATA /*flags*/,</div><div class="line">                           UserHandle.myUserId());</div><div class="line">           if (info.metaData != null) &#123;</div><div class="line">               final int preloadedFontsResource = info.metaData.getInt(</div><div class="line">                       ApplicationInfo.METADATA_PRELOADED_FONTS, 0);</div><div class="line">               if (preloadedFontsResource != 0) &#123;</div><div class="line">                   data.info.mResources.preloadFonts(preloadedFontsResource);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; catch (RemoteException e) &#123;</div><div class="line">           throw e.rethrowFromSystemServer();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>回调onCreat的部分<br>frameworks\base\core\java\android\app\Instrumentation.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public void callApplicationOnCreate(Application app) &#123;</div><div class="line">    app.onCreate();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>进程得到AMS传来的运行信息，获取相关资源，得到application，此时成为真正的app进程。</p>
<h3 id="16-mStackSupervisor-attachApplicationLocked"><a href="#16-mStackSupervisor-attachApplicationLocked" class="headerlink" title="16-mStackSupervisor.attachApplicationLocked"></a>16-mStackSupervisor.attachApplicationLocked</h3><p>接下来看下他的activity启动<br>mStackSupervisor.attachApplicationLocked(app)<br>frameworks\base\services\core\java\com\android\server\am\ActivityStackSupervisor.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">boolean attachApplicationLocked(ProcessRecord app) throws RemoteException &#123;</div><div class="line">    final String processName = app.processName;</div><div class="line">    boolean didSomething = false;</div><div class="line">    for (int displayNdx = mActivityDisplays.size() - 1; displayNdx &gt;= 0; --displayNdx) &#123;</div><div class="line">        ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</div><div class="line">        for (int stackNdx = stacks.size() - 1; stackNdx &gt;= 0; --stackNdx) &#123;</div><div class="line">            final ActivityStack stack = stacks.get(stackNdx);</div><div class="line">            if (!isFocusedStack(stack)) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            ActivityRecord hr = stack.topRunningActivityLocked();</div><div class="line">            if (hr != null) &#123;</div><div class="line">                if (hr.app == null &amp;&amp; app.uid == hr.info.applicationInfo.uid</div><div class="line">                        &amp;&amp; processName.equals(hr.processName)) &#123;</div><div class="line">                    try &#123;</div><div class="line">                        if (realStartActivityLocked(hr, app, true, true)) &#123;</div><div class="line">                            didSomething = true;</div><div class="line">                        &#125;</div><div class="line">                    &#125; catch (RemoteException e) &#123;</div><div class="line">                        Slog.w(TAG, &quot;Exception in new application when starting activity &quot;</div><div class="line">                              + hr.intent.getComponent().flattenToShortString(), e);</div><div class="line">                        throw e;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if (!didSomething) &#123;</div><div class="line">        ensureActivitiesVisibleLocked(null, 0, !PRESERVE_WINDOWS);</div><div class="line">    &#125;</div><div class="line">    return didSomething;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>遍历寻找所有ActivityStack和TaskRecord，对栈顶的ActivityRecord进行操作。这里其实就是需要启动应用进程中还未启动的Activity。</p>
<p>realStartActivityLocked中：</p>
<ol>
<li>将ProcessRecord和ActivityRecord关联。ActivityRecord对象的app属性，就是ProcessRecord类型</li>
<li>跨进程调用IApplicationThread.scheduleLaunchActivity()，调度启动Activity。很多参数都会通过这个函数传递到应用进程；其中包括含ActivityRecord的Token</li>
<li>调用AS.minimalResumeActivityLocked()来显示Activity。</li>
</ol>
<h3 id="20-handleLaunchActivity"><a href="#20-handleLaunchActivity" class="headerlink" title="20-handleLaunchActivity"></a>20-handleLaunchActivity</h3><p>scheduleLaunchActivity发送LAUNCH_ACTIVITY到ActivityThread.H<br>frameworks\base\core\java\android\app\ActivityThread.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">            case LAUNCH_ACTIVITY: &#123;</div><div class="line">                Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;activityStart&quot;);</div><div class="line">                final ActivityClientRecord r = (ActivityClientRecord) msg.obj;</div><div class="line"></div><div class="line">                r.packageInfo = getPackageInfoNoCheck(</div><div class="line">                        r.activityInfo.applicationInfo, r.compatInfo);</div><div class="line">                handleLaunchActivity(r, null, &quot;LAUNCH_ACTIVITY&quot;);</div><div class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">            &#125; break;</div><div class="line"></div><div class="line"></div><div class="line">private void handleLaunchActivity(ActivityClientRecord r, Intent customIntent, String reason) &#123;</div><div class="line">    // If we are getting ready to gc after going to the background, well</div><div class="line">    // we are back active so skip it.</div><div class="line">    unscheduleGcIdler();</div><div class="line">    mSomeActivitiesChanged = true;</div><div class="line"></div><div class="line">    if (r.profilerInfo != null) &#123;</div><div class="line">        mProfiler.setProfiler(r.profilerInfo);</div><div class="line">        mProfiler.startProfiling();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Make sure we are running with the most recent config.</div><div class="line">    handleConfigurationChanged(null, null);</div><div class="line"></div><div class="line">    if (localLOGV) Slog.v(</div><div class="line">        TAG, &quot;Handling launch of &quot; + r);</div><div class="line"></div><div class="line">    // Initialize before creating the activity</div><div class="line">    WindowManagerGlobal.initialize();</div><div class="line"></div><div class="line">    Activity a = performLaunchActivity(r, customIntent);</div><div class="line"></div><div class="line">    if (a != null) &#123;</div><div class="line">        r.createdConfig = new Configuration(mConfiguration);</div><div class="line">        reportSizeConfigurations(r);</div><div class="line">        Bundle oldState = r.state;</div><div class="line">        handleResumeActivity(r.token, false, r.isForward,</div><div class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</div><div class="line"></div><div class="line">        if (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;</div><div class="line">            // The activity manager actually wants this one to start out paused, because it</div><div class="line">            // needs to be visible but isn&apos;t in the foreground. We accomplish this by going</div><div class="line">            // through the normal startup (because activities expect to go through onResume()</div><div class="line">            // the first time they run, before their window is displayed), and then pausing it.</div><div class="line">            // However, in this case we do -not- need to do the full pause cycle (of freezing</div><div class="line">            // and such) because the activity manager assumes it can just retain the current</div><div class="line">            // state it has.</div><div class="line">            performPauseActivityIfNeeded(r, reason);</div><div class="line"></div><div class="line">            // We need to keep around the original state, in case we need to be created again.</div><div class="line">            // But we only do this for pre-Honeycomb apps, which always save their state when</div><div class="line">            // pausing, so we can not have them save their state when restarting from a paused</div><div class="line">            // state. For HC and later, we want to (and can) let the state be saved as the</div><div class="line">            // normal part of stopping the activity.</div><div class="line">            if (r.isPreHoneycomb()) &#123;</div><div class="line">                r.state = oldState;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        // If there was an error, for any reason, tell the activity manager to stop us.</div><div class="line">        try &#123;</div><div class="line">            ActivityManager.getService()</div><div class="line">                .finishActivity(r.token, Activity.RESULT_CANCELED, null,</div><div class="line">                        Activity.DONT_FINISH_TASK_WITH_ACTIVITY);</div><div class="line">        &#125; catch (RemoteException ex) &#123;</div><div class="line">            throw ex.rethrowFromSystemServer();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>调用ActivityThread.performLaunchActivity()函数，初始化一个Activity，真正干活的是它</li>
<li>调用ActivityThread.handleResumeActivity()来处理Activity进入显示状态时需要完成的操作</li>
</ol>
<p>在performLaunchActivity中：获取activity参数（注册类名的原因、部分信息也都可以通过PackageManager再向系统进程索取），反射创建activity对象，创建activity的context，回调oncreate、onstart等函数。<br>在handleResumeActivity中：调用Activity.onResume()，通知系统进程，Activity已经处于Resumed状态</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>由zygote fork出子进程后，构建activitythrea主线程和applicationThread，前者作为主线程用线程通信looper接受消息处理渲染等操作，后者作为binder线程接受AMS的消息管理应用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/13/android8-0-0源码分析-app启动1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/13/android8-0-0源码分析-app启动1/" itemprop="url">android8-0-0源码分析-app启动1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-13T22:51:22+08:00">
                2018-10-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="前言补充"><a href="#前言补充" class="headerlink" title="前言补充"></a>前言补充</h2><p>当系统决定要在一个新的进程中启动一个Activity或者Service时，ActivityManagerService组件负责通知Zygote创建一个新的进程，然后在这个新的进程中启动这个Activity或者Service。</p>
<p>Android应用程序架构中非常核心的一点：MainActivity不需要知道SubActivity的存在，即它不直接拥有SubActivity的接口，但是它可以通过一个字符串来告诉应用程序框架层，它要启动的Activity的名称是什么，其它的事情就交给应用程序框架层来做，这种模式大大降低了模块间的耦合，利于开发。<br>对于每一个应用程序来说，都有一个ActivityThread来表示应用程序的主进程，而每一个ActivityThread都包含有一个ApplicationThread实例，它是一个Binder对象，负责和其它进程进行通信。</p>
<p>Binder是Android系统进程间通信（IPC）方式之一。</p>
<p>目前linux支持的IPC包括传统的管道，System V IPC，即消息队列/共享内存/信号量，以及socket中只有socket支持Client-Server的通信方式。<br>而Client-Server的通信方式在android系统中被广泛使用，诸如媒体播放，视音频频捕获，到各种让手机更智能的传感器（加速度，方位，温度，光亮度等）都由不同的Server负责管理，应用程序只需做为Client与这些Server建立连接便可以使用这些服务，花很少的时间和精力就能开发出令人眩目的功能。因此需要高效的CS通信。</p>
<p>传输性能方面：socket通用主用于跨网络性能低，消息队列与管道都是二次拷贝，共享性能控制复杂。binder只有一次拷贝。</p>
<p>安全性：传统IPC的接收方无法获得对方进程可靠的UID/PID（用户ID/进程ID），从而无法鉴别对方身份。接入点开放，无法私有通道。</p>
<p>Binder是一个实体位于Server的对象，client使用它的句柄调用其方法<br>Binder模糊了进程边界，淡化了进程间通信过程，整个系统仿佛运行于同一个面向对象的程序之中。形形色色的Binder对象以及星罗棋布的引用仿佛粘接各个应用程序的胶水，这也是Binder在英文里的原意。</p>
<p>Binder的四个角色：Server、Client、ServiceManager、Binder驱动。驱动位于内核空间。与互联网类似：服务器、客户端、域名服务器、路由器</p>
<p><a href="https://blog.csdn.net/universus/article/details/6211589" target="_blank" rel="external">https://blog.csdn.net/universus/article/details/6211589</a></p>
<p>目前知道：可用于进程间通信，大量用于android各层即可。</p>
<p>参考文：<br><a href="http://duanqz.github.io/2016-07-29-Activity-LaunchProcess-Part1#%E6%A6%82%E8%BF%B0" target="_blank" rel="external">http://duanqz.github.io/2016-07-29-Activity-LaunchProcess-Part1#%E6%A6%82%E8%BF%B0</a><br>老罗<br>gityuan</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/10/13/android8-0-0源码分析-app启动1/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/07/android应用层常见安全漏洞/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/07/android应用层常见安全漏洞/" itemprop="url">android应用层常见安全漏洞</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-07T16:11:04+08:00">
                2018-10-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android应用加固/" itemprop="url" rel="index">
                    <span itemprop="name">android应用加固</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>总结下android应用开发中常出现的依靠第三方加固无法解决的代码漏洞问题。这些代码漏洞通常可用自动化检测工具检验。搭建行为检测检验环境也是十分有效的做法。</p>
<p><a href="https://www.zhihu.com/question/22933619/answer/392842386" target="_blank" rel="external">https://www.zhihu.com/question/22933619/answer/392842386</a><br><a href="https://blog.csdn.net/whklhhhh/article/details/79116894" target="_blank" rel="external">https://blog.csdn.net/whklhhhh/article/details/79116894</a></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/10/07/android应用层常见安全漏洞/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/05/android8-0-0源码分析-应用安装2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/05/android8-0-0源码分析-应用安装2/" itemprop="url">android8-0-0源码分析-应用安装2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-05T19:04:40+08:00">
                2018-10-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇介绍第三方apk安装的过程，重点放在dex的优化部分</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/10/05/android8-0-0源码分析-应用安装2/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/05/android8-0-0源码分析-应用安装1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/05/android8-0-0源码分析-应用安装1/" itemprop="url">android8-0-0源码分析-应用安装1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-05T19:04:30+08:00">
                2018-10-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>apk安装分4种方式：</p>
<ol>
<li>系统开机应用安装，安装的是系统应用。</li>
<li>adb安装</li>
<li>应用调用系统应用安装第三方apk包</li>
<li>静默安装</li>
</ol>
<p>在代码里的实现其实就是如下两种：</p>
<ol>
<li>PMS调用scanDirLI扫描安装</li>
<li>直接或间接调用installPackageAsUser安装，这个8.0下其实调用的是另一个函数</li>
</ol>
<p>在本篇我们看下第一种系统启动时的安装流程。下一篇介绍第二种</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/10/05/android8-0-0源码分析-应用安装1/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/28/ddctf-Android第一题-RSA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/28/ddctf-Android第一题-RSA/" itemprop="url">ddctf-Android第一题-RSA</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-28T22:59:02+08:00">
                2018-09-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/" itemprop="url" rel="index">
                    <span itemprop="name">ctf</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>好久没做ctf题了，arm指令都快忘光了…..<br>提起去年太菜没做出的题再分析下。</p>
<p>ida addmap时可以直接把系统库函数全部取出来，放到一个本地文件夹中这样ida即可加载对应的so用于分析。–全部提出system/lib指定目录即可<br>现在的加载so，不落地手动加载是绝杀…….必须读读linker<br>debugger里的watch view可以查看任意形式的目标时时信息，支持c变量表达式。十分好用   比如：(char*)R0</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/09/28/ddctf-Android第一题-RSA/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/27/android8-0-0源码分析-art的启动/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/27/android8-0-0源码分析-art的启动/" itemprop="url">android8-0-0源码分析-art的启动</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-27T21:03:31+08:00">
                2018-09-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>2014年6月25日，Android L-5.0 正式亮相于召开的谷歌I/O大会，Android L 改动幅度较大，谷歌将直接删除Dalvik，代替它的是传闻已久的ART。</p>
<p>安装后：data/data放应用私有数据，data/app放apk、lib、oat(vdex\odex\art 文件魔数为vdex、elf、art)<br>date/dalvik-cache放虚拟机执行码的(vdex\oat\art)</p>
<p>旧的优化叫dexopt,现安装时调用/system/bin/dex2oat（8.1.0下存在）编译</p>
<p>无论是对dex字节码进行优化，还是将dex字节码翻译成本地机器码，最终得到的结果都是保存在相同名称的一个odex文件里面的，但是前者对应的是一个dey文件（表示这是一个优化过的dex），后者对应的是一个oat文件（实际上是一个自定义的elf文件，里面包含的都是本地机器指令）。</p>
<p>应用程序的安装发生在两个时机，第一个时机是系统启动的时候，第二个时机系统启动完成后用户自行安装的时候。在第一个时机中，系统除了会对/system/app和/data/app目录下的所有APK进行dex字节码到本地机器码的翻译之外，还会对/system/framework目录下的APK或者JAR文件，以及这些APK所引用的外部JAR，进行dex字节码到本地机器码的翻译。这些都挂载在存储中了。</p>
<p>在ART中，打包在APK里面的Dex字节码是通过LLVM翻译成本地机器指令的–现在的加固也需要研究这个。</p>
<p>oat结构：<br><img src="https://i.imgur.com/CWhsU0Q.jpg" alt=""><br>加了俩个段oatdata和oatexec，分别用来储存原来打包在APK里面的dex文件和翻译这个dex文件里面的类方法得到本地机器指令。<br>动态段（dymanic section，用于以数组指向动态连接器所需信息，该段在程序头表与节头表中都有指向）中添加了三个符号oatdata、oatexec和oatlastword分别用来描述oatdata和oatexec段加段到内存后的起止地址。<br>在oatdata段中，包含了两个重要的信息，一个信息是原来的classes.dex文件的完整内容，另一个信息引导ART找到classes.dex文件里面的类方法所对应的本地机器指令，这些本地机器指令就保存在oatexec段中。<br>可见oat中含有完整的dex文件。</p>
<p>我们在classes.dex文件中有一个类A，那么当我们知道类A的名字后，就可以通过保存在oatdata段的dex文件得到类A的所有信息，比如它的父类、成员变量和成员函数等。另一方面，类A在oatdata段中有一个对应的OatClass结构体。这个OatClass结构体描述了类A的每一个方法所对应的本地机器指令在oatexec段的位置。也就是说，当我们知道一个类及其某一个方法的名字（签名）之后，就可以通过oatdata段的dex文件内容和OatClass结构体找到其在oatexec段的本地机器指令，这样就可以执行这个类方法了。</p>
<p>art加载运行壳时是加载优化后的oat代码，但壳用classloader加载dex时会为其生成oat文件，可能会破坏处理的dex，hook掉可以运行dex但会慢，所以为了提升速度不会阻止dex优化为oat，也就是说原dex尽力保留了，因此采用大块的native化进行加固！</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/09/27/android8-0-0源码分析-art的启动/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/21/android8-0-0源码分析-zygote的启动/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/21/android8-0-0源码分析-zygote的启动/" itemprop="url">android8.0.0源码分析-zygote的启动</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-21T21:16:17+08:00">
                2018-09-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="前提知识"><a href="#前提知识" class="headerlink" title="前提知识"></a>前提知识</h2><p>PC主板上有一小段程序叫做BIOS，主板加电时它是第一个跑起来的程序。<br>功能：</p>
<ol>
<li>硬件检测   </li>
<li>初始化中断向量、设置寄存器等  </li>
<li>从硬盘的开始扇区读取记录，引导操作系统</li>
</ol>
<p>这个在android中叫Bootloader</p>
<h2 id="系统加载"><a href="#系统加载" class="headerlink" title="系统加载"></a>系统加载</h2><p>首先Android启动三种方式：<br>1.Bootloader交互式启动，此时可刷全部存储空间(和向硬盘中装系统一样、放入正确的路径/分区)<br>2.recover模式，从recovery.img镜像启动系统，可以修改部分存储，更新系统<br>3.Main System，从boot.img镜像启动系统</p>
<p>引导默认从Main System启动</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/09/21/android8-0-0源码分析-zygote的启动/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/dalvik1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/dalvik1/" itemprop="url">dalvik1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T20:01:18+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>基于<a href="https://blog.csdn.net/luoshengyang/article/details/8852432的分析整理。" target="_blank" rel="external">https://blog.csdn.net/luoshengyang/article/details/8852432的分析整理。</a><br>涉及dalvik启动过程，运行过程</p>
<p>目标为搞懂虚拟机native中的本质。现在基本都不用dalvik了，在我的8.0机子下persist.sys.dalvik.vm.lib.2=libart.so 表示用art虚拟机，dalvik已经完全不见踪影。</p>
<h2 id="前提杂记"><a href="#前提杂记" class="headerlink" title="前提杂记"></a>前提杂记</h2><p>linux下分析：<br>vim:<br>:sp可直接分屏，ctrl+w切换分屏，ctrl+w+o只留选中的<br>:/用来搜索  按n下一个、N上一个   光标选中单词shift+*直接搜索该单词</p>
<p>基于栈的虚拟机字节更小，指令所需多；基于寄存器的字节更长，缓存命中小<br>RISC精简指令集操作更原子，CISC复杂指令集操作更大，二者都是栈与寄存器运行结构。</p>
<p>android内部C++代码大量使用智能指针管理对象声明周期，防止内存释放问题。开发使用java自动回收</p>
<p>每个进程都有dalvik实例，每个应用进程由Zygote fork出，Zygote进程是由init进程启动，在系统启动时加载所需。<br>这些被fork出来的Android应用程序进程，一方面是复制了Zygote进程中的虚拟机实例，另一方面是与Zygote进程共享了同一套Java核心库。这样不仅Android应用程序进程的创建过程很快，而且由于所有的Android应用程序进程都共享同一套Java核心库而节省了内存空间。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/09/10/dalvik1/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/09/android系统源码初探/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/09/android系统源码初探/" itemprop="url">android系统源码初探</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-09T23:04:24+08:00">
                2018-08-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>运用gcc的交叉编译形成的多平台。HAL屏蔽硬件细节时也编译了多个平台的，因此可选择生成多平台系统。<br>有几张好的表：<a href="https://www.jianshu.com/p/ad87f687f2fa" target="_blank" rel="external">https://www.jianshu.com/p/ad87f687f2fa</a></p>
<h2 id="学习计划："><a href="#学习计划：" class="headerlink" title="学习计划："></a>学习计划：</h2><ol>
<li>dalivik和art是怎么实现的执行字节码。都有什么功能？</li>
<li>使用dalvik/art动态加载并调用jar/dex/apk - art与dalivik的不同？它又是如何加载dex并执行的。类的加载管理机制对比jvm</li>
<li>使用native加载并调用jar/dex/apk</li>
<li>使用dalvik/art加载并调用so</li>
<li>使用native加载并调用so</li>
<li>app安装过程</li>
<li>app启动过程：从点击图标开始</li>
<li>各种脱壳机的原理（读脱壳机源码）</li>
<li>各加固的原理（分析/脱各加固）</li>
</ol>
<p>以上<strong>先开发出来</strong>，再看源码分析+文章。记录流程与图</p>
<p>看情况阅读….工作量大的暂时不用的跳过，以使用先为主。</p>
<h2 id="阅读环境搭建"><a href="#阅读环境搭建" class="headerlink" title="阅读环境搭建"></a>阅读环境搭建</h2><h3 id="win下"><a href="#win下" class="headerlink" title="win下"></a>win下</h3><ol>
<li>更新win10 到1803。该版本增加了大量linux子系统的支持，之前一直无法在win下阅读源码的原因就是文件名不区分大小写的问题</li>
<li>安装linux子系统。参考：<a href="https://walterlv.com/post/case-sensitive-in-windows-file-system.html" target="_blank" rel="external">https://walterlv.com/post/case-sensitive-in-windows-file-system.html</a></li>
<li>win的c、d盘挂载在linux子系统下的mnt中。找到源码包解压（linux文件系统可区分大小写）</li>
<li>用win的编辑器（Source Insight4.0）加载该工程，若过大失败可以分开目录加载</li>
<li>开启Source Insight4.0的一系列方便选项：options前俩项中。</li>
<li>staruml准备、notpad++准备</li>
<li>开始舒服的阅读…….</li>
</ol>
<h3 id="linux下"><a href="#linux下" class="headerlink" title="linux下"></a>linux下</h3><ol>
<li>同步下源码</li>
<li>vim插件ctrlp等…..</li>
<li>开始不太舒服的阅读……</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/1.png"
               alt="imbaya" />
          <p class="site-author-name" itemprop="name">imbaya</p>
           
              <p class="site-description motion-element" itemprop="description">..........</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">71</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">64</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">imbaya</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":100,"height":200,"hOffset":0,"vOffset":-50},"mobile":{"show":false},"react":{"opacityDefault":1,"opacityOnHover":1},"log":false});</script></body>
</html>
