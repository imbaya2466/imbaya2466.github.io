<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android系统,art," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="前言2014年6月25日，Android L-5.0 正式亮相于召开的谷歌I/O大会，Android L 改动幅度较大，谷歌将直接删除Dalvik，代替它的是传闻已久的ART。 安装后：data/data放应用私有数据，data/app放apk、lib、oat(vdex\odex\art 文件魔数为vdex、elf、art)date/dalvik-cache放虚拟机执行码的(vdex\oat\ar">
<meta name="keywords" content="android系统,art">
<meta property="og:type" content="article">
<meta property="og:title" content="android8-0-0源码分析-art的启动">
<meta property="og:url" content="http://yoursite.com/2018/09/27/android8-0-0源码分析-art的启动/index.html">
<meta property="og:site_name" content="GGWP">
<meta property="og:description" content="前言2014年6月25日，Android L-5.0 正式亮相于召开的谷歌I/O大会，Android L 改动幅度较大，谷歌将直接删除Dalvik，代替它的是传闻已久的ART。 安装后：data/data放应用私有数据，data/app放apk、lib、oat(vdex\odex\art 文件魔数为vdex、elf、art)date/dalvik-cache放虚拟机执行码的(vdex\oat\ar">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.imgur.com/CWhsU0Q.jpg">
<meta property="og:image" content="https://i.imgur.com/vRZYBse.png">
<meta property="og:updated_time" content="2018-09-27T14:33:56.052Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android8-0-0源码分析-art的启动">
<meta name="twitter:description" content="前言2014年6月25日，Android L-5.0 正式亮相于召开的谷歌I/O大会，Android L 改动幅度较大，谷歌将直接删除Dalvik，代替它的是传闻已久的ART。 安装后：data/data放应用私有数据，data/app放apk、lib、oat(vdex\odex\art 文件魔数为vdex、elf、art)date/dalvik-cache放虚拟机执行码的(vdex\oat\ar">
<meta name="twitter:image" content="https://i.imgur.com/CWhsU0Q.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/09/27/android8-0-0源码分析-art的启动/"/>





  <title>android8-0-0源码分析-art的启动 | GGWP</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GGWP</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/27/android8-0-0源码分析-art的启动/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">android8-0-0源码分析-art的启动</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-27T21:03:31+08:00">
                2018-09-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>2014年6月25日，Android L-5.0 正式亮相于召开的谷歌I/O大会，Android L 改动幅度较大，谷歌将直接删除Dalvik，代替它的是传闻已久的ART。</p>
<p>安装后：data/data放应用私有数据，data/app放apk、lib、oat(vdex\odex\art 文件魔数为vdex、elf、art)<br>date/dalvik-cache放虚拟机执行码的(vdex\oat\art)</p>
<p>旧的优化叫dexopt,现安装时调用/system/bin/dex2oat（8.1.0下存在）编译</p>
<p>无论是对dex字节码进行优化，还是将dex字节码翻译成本地机器码，最终得到的结果都是保存在相同名称的一个odex文件里面的，但是前者对应的是一个dey文件（表示这是一个优化过的dex），后者对应的是一个oat文件（实际上是一个自定义的elf文件，里面包含的都是本地机器指令）。</p>
<p>应用程序的安装发生在两个时机，第一个时机是系统启动的时候，第二个时机系统启动完成后用户自行安装的时候。在第一个时机中，系统除了会对/system/app和/data/app目录下的所有APK进行dex字节码到本地机器码的翻译之外，还会对/system/framework目录下的APK或者JAR文件，以及这些APK所引用的外部JAR，进行dex字节码到本地机器码的翻译。这些都挂载在存储中了。</p>
<p>在ART中，打包在APK里面的Dex字节码是通过LLVM翻译成本地机器指令的–现在的加固也需要研究这个。</p>
<p>oat结构：<br><img src="https://i.imgur.com/CWhsU0Q.jpg" alt=""><br>加了俩个段oatdata和oatexec，分别用来储存原来打包在APK里面的dex文件和翻译这个dex文件里面的类方法得到本地机器指令。<br>动态段（dymanic section，用于以数组指向动态连接器所需信息，该段在程序头表与节头表中都有指向）中添加了三个符号oatdata、oatexec和oatlastword分别用来描述oatdata和oatexec段加段到内存后的起止地址。<br>在oatdata段中，包含了两个重要的信息，一个信息是原来的classes.dex文件的完整内容，另一个信息引导ART找到classes.dex文件里面的类方法所对应的本地机器指令，这些本地机器指令就保存在oatexec段中。<br>可见oat中含有完整的dex文件。</p>
<p>我们在classes.dex文件中有一个类A，那么当我们知道类A的名字后，就可以通过保存在oatdata段的dex文件得到类A的所有信息，比如它的父类、成员变量和成员函数等。另一方面，类A在oatdata段中有一个对应的OatClass结构体。这个OatClass结构体描述了类A的每一个方法所对应的本地机器指令在oatexec段的位置。也就是说，当我们知道一个类及其某一个方法的名字（签名）之后，就可以通过oatdata段的dex文件内容和OatClass结构体找到其在oatexec段的本地机器指令，这样就可以执行这个类方法了。</p>
<p>art加载运行壳时是加载优化后的oat代码，但壳用classloader加载dex时会为其生成oat文件，可能会破坏处理的dex，hook掉可以运行dex但会慢，所以为了提升速度不会阻止dex优化为oat，也就是说原dex尽力保留了，因此采用大块的native化进行加固！</p>
<a id="more"></a>
<h2 id="art虚拟机的启动"><a href="#art虚拟机的启动" class="headerlink" title="art虚拟机的启动"></a>art虚拟机的启动</h2><p>先记住一张图…要不然看代码经常会忘了在哪…..<br><img src="https://i.imgur.com/vRZYBse.png" alt=""><br>接下来按着这个图上的标号分析</p>
<h3 id="1-main"><a href="#1-main" class="headerlink" title="1.main"></a>1.main</h3><p>这个就是之前分析过的<a href="http://xn--74q78i15hxv3arigm4e.cn/2018/09/21/android8-0-0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-zygote%E7%9A%84%E5%90%AF%E5%8A%A8/" title="android8.0.0源码分析-zygote的启动" target="_blank" rel="external">http://xn–74q78i15hxv3arigm4e.cn/2018/09/21/android8-0-0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-zygote%E7%9A%84%E5%90%AF%E5%8A%A8/</a><br>中init进程所调用的android启动函数</p>
<h3 id="2-start"><a href="#2-start" class="headerlink" title="2.start"></a>2.start</h3><p>之前的runtime.start</p>
<h3 id="3-jni-invocation-Init"><a href="#3-jni-invocation-Init" class="headerlink" title="3.jni_invocation.Init"></a>3.jni_invocation.Init</h3><p>加载libart.so导出其接口</p>
<h3 id="4-AppRuntime-startVm"><a href="#4-AppRuntime-startVm" class="headerlink" title="4.AppRuntime.startVm"></a>4.AppRuntime.startVm</h3><p>startVm(&amp;mJavaVM, &amp;env, zygote)<br>经过参数设置调用<code>JNI_CreateJavaVM(pJavaVM, pEnv, &amp;initArgs)</code><br><code>JNI_CreateJavaVM</code>就是之前虚拟机导出的三个接口之一</p>
<h3 id="5-6-JNI-CreateJavaVM"><a href="#5-6-JNI-CreateJavaVM" class="headerlink" title="5/6.JNI_CreateJavaVM"></a>5/6.JNI_CreateJavaVM</h3><p>经过一层JniInvocation类内调用后，8.0的实现位于<code>art\runtime\java_vm_ext.cc</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">// JNI Invocation interface.</div><div class="line"></div><div class="line">extern &quot;C&quot; jint JNI_CreateJavaVM(JavaVM** p_vm, JNIEnv** p_env, void* vm_args) &#123;</div><div class="line">  ScopedTrace trace(__FUNCTION__);</div><div class="line">  const JavaVMInitArgs* args = static_cast&lt;JavaVMInitArgs*&gt;(vm_args);//vm_args转换为一个JavaVMInitArgs对象</div><div class="line">  if (JavaVMExt::IsBadJniVersion(args-&gt;version)) &#123;</div><div class="line">    LOG(ERROR) &lt;&lt; &quot;Bad JNI version passed to CreateJavaVM: &quot; &lt;&lt; args-&gt;version;</div><div class="line">    return JNI_EVERSION;</div><div class="line">  &#125;</div><div class="line">  RuntimeOptions options; //按照Key-Value的组织形式保存一个Options向量</div><div class="line">  for (int i = 0; i &lt; args-&gt;nOptions; ++i) &#123;</div><div class="line">    JavaVMOption* option = &amp;args-&gt;options[i];</div><div class="line">    options.push_back(std::make_pair(std::string(option-&gt;optionString), option-&gt;extraInfo));</div><div class="line">  &#125;</div><div class="line">  bool ignore_unrecognized = args-&gt;ignoreUnrecognized;</div><div class="line">  //Runtime静态函数create在进程中创建一个虚拟机，c++对静态属性、函数用类名操作用的是::</div><div class="line">  if (!Runtime::Create(options, ignore_unrecognized)) &#123;</div><div class="line">    return JNI_ERR;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Initialize native loader. This step makes sure we have</div><div class="line">  // everything set up before we start using JNI.</div><div class="line">  android::InitializeNativeLoader();</div><div class="line"></div><div class="line">  Runtime* runtime = Runtime::Current(); //获取当前Runtime，Current：当前</div><div class="line">  bool started = runtime-&gt;Start();//启动虚拟机</div><div class="line">  if (!started) &#123;</div><div class="line">    delete Thread::Current()-&gt;GetJniEnv();</div><div class="line">    delete runtime-&gt;GetJavaVM();</div><div class="line">    LOG(WARNING) &lt;&lt; &quot;CreateJavaVM failed&quot;;</div><div class="line">    return JNI_ERR;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  *p_env = Thread::Current()-&gt;GetJniEnv();</div><div class="line">  *p_vm = runtime-&gt;GetJavaVM();</div><div class="line">  return JNI_OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>作用：</p>
<ol>
<li>参数以key-value形式保存于options向量</li>
<li>用Runtime类的静态成员函数create创建art虚拟机，属于该进程</li>
<li>获取当前Runtime对象实例，并调用start启动</li>
<li>获取JNIEnv与JavaVm返回。</li>
</ol>
<h3 id="7-Runtime-Create"><a href="#7-Runtime-Create" class="headerlink" title="7.Runtime.Create"></a>7.Runtime.Create</h3><p>Runtime::Create(options, ignore_unrecognized)<br>Runtime类的静态成员函数Create<br>在art\runtime\runtime.cc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">bool Runtime::Create(RuntimeArgumentMap&amp;&amp; runtime_options) &#123;</div><div class="line">  // TODO: acquire a static mutex on Runtime to avoid racing.</div><div class="line">  if (Runtime::instance_ != nullptr) &#123;</div><div class="line">    return false;</div><div class="line">  &#125;</div><div class="line">  instance_ = new Runtime;//instance为Runtime单例静态变量，描述art虚拟机实例-进程的</div><div class="line">  Locks::SetClientCallback(IsSafeToCallAbort);</div><div class="line">  if (!instance_-&gt;Init(std::move(runtime_options))) &#123;//初始化instance</div><div class="line">    // TODO: Currently deleting the instance will abort the runtime on destruction. Now This will</div><div class="line">    // leak memory, instead. Fix the destructor. b/19100793.</div><div class="line">    // delete instance_;</div><div class="line">    instance_ = nullptr;</div><div class="line">    return false;</div><div class="line">  &#125;</div><div class="line">  return true;</div><div class="line">&#125;</div><div class="line"></div><div class="line">bool Runtime::Create(const RuntimeOptions&amp; raw_options, bool ignore_unrecognized) &#123;</div><div class="line">  RuntimeArgumentMap runtime_options;//吧设置和忽略无法识别都输入</div><div class="line">  return ParseOptions(raw_options, ignore_unrecognized, &amp;runtime_options) &amp;&amp;</div><div class="line">      Create(std::move(runtime_options));//std::move语句可以将左值变为右值避免拷贝构造</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建唯一的Runtime对象：Runtime::instance_实例，进行初始化。<br>注意该对象属于进程，线程私有空间有限：栈以及系统提供的线程信息区域TLS，代码以及堆是共享的，因此类中指向的全局变量进程唯一。</p>
<p>Runtime构造函数:在art\runtime\runtime.cc   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Runtime::Runtime()</div><div class="line">    : resolution_method_(nullptr),</div><div class="line">      imt_conflict_method_(nullptr),</div><div class="line">      imt_unimplemented_method_(nullptr),</div><div class="line">      instruction_set_(kNone),</div><div class="line">      compiler_callbacks_(nullptr),</div><div class="line">	......</div><div class="line">      zygote_no_threads_(false),</div><div class="line">      cha_(nullptr) &#123;</div><div class="line">  CheckAsmSupportOffsetsAndSizes();</div><div class="line">  std::fill(callee_save_methods_, callee_save_methods_ + arraysize(callee_save_methods_), 0u);</div><div class="line">  interpreter::CheckInterpreterAsmConstants();</div><div class="line">  callbacks_.reset(new RuntimeCallbacks());</div><div class="line">  for (size_t i = 0; i &lt;= static_cast&lt;size_t&gt;(DeoptimizationKind::kLast); ++i) &#123;</div><div class="line">    deoptimization_counts_[i] = 0u;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为基本属性的初始化</p>
<h3 id="8-Runtime-init"><a href="#8-Runtime-init" class="headerlink" title="8.Runtime.init"></a>8.Runtime.init</h3><p>instance_-&gt;Init(std::move(runtime_options))<br>在art\runtime\runtime.cc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">bool Runtime::Init(RuntimeArgumentMap&amp;&amp; runtime_options_in) &#123;</div><div class="line"></div><div class="line">	......</div><div class="line"></div><div class="line">  RuntimeArgumentMap runtime_options(std::move(runtime_options_in));//参数map</div><div class="line">  using Opt = RuntimeArgumentMap;</div><div class="line">  </div><div class="line">  </div><div class="line">  	...... 一堆参数设置</div><div class="line">    boot_class_path_string_ = runtime_options.ReleaseOrDefault(Opt::BootClassPath);//启动类路径</div><div class="line">	image_location_ = runtime_options.GetOrDefault(Opt::Image);;//art所使用image文件</div><div class="line">	compiler_executable_ = runtime_options.ReleaseOrDefault(Opt::Compiler);//art是执行还是编译dex的</div><div class="line">	</div><div class="line"></div><div class="line">  //创建虚拟机堆</div><div class="line">  heap_ = new gc::Heap(runtime_options.GetOrDefault(Opt::MemoryInitialSize),</div><div class="line">                       runtime_options.GetOrDefault(Opt::HeapGrowthLimit),</div><div class="line">                       runtime_options.GetOrDefault(Opt::HeapMinFree),</div><div class="line">                       runtime_options.GetOrDefault(Opt::HeapMaxFree),</div><div class="line">                       runtime_options.GetOrDefault(Opt::HeapTargetUtilization),</div><div class="line">                       runtime_options.GetOrDefault(Opt::ForegroundHeapGrowthMultiplier),</div><div class="line">                       runtime_options.GetOrDefault(Opt::MemoryMaximumSize),</div><div class="line">                       runtime_options.GetOrDefault(Opt::NonMovingSpaceCapacity),</div><div class="line">                       runtime_options.GetOrDefault(Opt::Image),</div><div class="line">                       runtime_options.GetOrDefault(Opt::ImageInstructionSet),</div><div class="line">                       // Override the collector type to CC if the read barrier config.</div><div class="line">                       kUseReadBarrier ? gc::kCollectorTypeCC : xgc_option.collector_type_,</div><div class="line">                       kUseReadBarrier ? BackgroundGcOption(gc::kCollectorTypeCCBackground)</div><div class="line">                                       : runtime_options.GetOrDefault(Opt::BackgroundGc),</div><div class="line">                       runtime_options.GetOrDefault(Opt::LargeObjectSpace),</div><div class="line">                       runtime_options.GetOrDefault(Opt::LargeObjectThreshold),</div><div class="line">                       runtime_options.GetOrDefault(Opt::ParallelGCThreads),</div><div class="line">                       runtime_options.GetOrDefault(Opt::ConcGCThreads),</div><div class="line">                       runtime_options.Exists(Opt::LowMemoryMode),</div><div class="line">                       runtime_options.GetOrDefault(Opt::LongPauseLogThreshold),</div><div class="line">                       runtime_options.GetOrDefault(Opt::LongGCLogThreshold),</div><div class="line">                       runtime_options.Exists(Opt::IgnoreMaxFootprint),</div><div class="line">                       runtime_options.GetOrDefault(Opt::UseTLAB),</div><div class="line">                       xgc_option.verify_pre_gc_heap_,</div><div class="line">                       xgc_option.verify_pre_sweeping_heap_,</div><div class="line">                       xgc_option.verify_post_gc_heap_,</div><div class="line">                       xgc_option.verify_pre_gc_rosalloc_,</div><div class="line">                       xgc_option.verify_pre_sweeping_rosalloc_,</div><div class="line">                       xgc_option.verify_post_gc_rosalloc_,</div><div class="line">                       xgc_option.gcstress_,</div><div class="line">                       xgc_option.measure_,</div><div class="line">                       runtime_options.GetOrDefault(Opt::EnableHSpaceCompactForOOM),</div><div class="line">                       runtime_options.GetOrDefault(Opt::HSpaceCompactForOOMMinIntervalsMs));</div><div class="line"></div><div class="line"></div><div class="line">					   </div><div class="line">	......</div><div class="line"></div><div class="line">  //创建java_vm_实例  </div><div class="line">  java_vm_ = JavaVMExt::Create(this, runtime_options, &amp;error_msg);</div><div class="line"></div><div class="line">  </div><div class="line">	......</div><div class="line">  Thread::Startup();//线程类启动</div><div class="line"></div><div class="line">  // ClassLinker needs an attached thread, but we can&apos;t fully attach a thread without creating</div><div class="line">  // objects. We can&apos;t supply(供应) a thread group yet; it will be fixed later. Since we are the main</div><div class="line">  // thread, we do not get a java peer(同辈).</div><div class="line">  Thread* self = Thread::Attach(&quot;main&quot;, false, nullptr, false);//将当前作为主线程。使当前可以调用jni</div><div class="line"></div><div class="line">	......</div><div class="line"></div><div class="line">  //获取当前的堆，GetContinuousSpaces可以获得堆里面的连续空间列表</div><div class="line">  CHECK_GE(GetHeap()-&gt;GetContinuousSpaces().size(), 1U);</div><div class="line">  //创建ClassLinker对象  加载java类用</div><div class="line">  class_linker_ = new ClassLinker(intern_table_);</div><div class="line"></div><div class="line">	......</div><div class="line">  return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>class<em>linker</em> = new ClassLinker(intern<em>table</em>);</p>
<p>class_linker主要是解析一些系统java类，比如classloader等系统资源load到内存，作为之后加载其他java类的基础，这里只是简单说明下，涉及到art的几个很重要的结构，Class和ArtMethod，DexCache，在boot.oat可执行文件的结构中，每一个Java Class对应一个OatClass，OatClass中保存分别有dex class和本地机器码的地址，在解释执行模式下，每一个方法的调用是通过DexCache来中转的，DexCache，根据method找到指定的ArtMethod，这里class_link主要负责协调管理。</p>
<p>此处实现在分析art运行时再开</p>
<h3 id="9-Heap-Heap"><a href="#9-Heap-Heap" class="headerlink" title="9.Heap.Heap"></a>9.Heap.Heap</h3><p>看一下堆的构造Heap类——art虚拟机的堆<br>位于：art\runtime\gc\heap.cc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">Heap::Heap(size_t initial_size,</div><div class="line">           size_t growth_limit,</div><div class="line">           size_t min_free,</div><div class="line">           size_t max_free,</div><div class="line">           double target_utilization,</div><div class="line">           double foreground_heap_growth_multiplier,</div><div class="line">           size_t capacity,</div><div class="line">           size_t non_moving_space_capacity,</div><div class="line">           const std::string&amp; image_file_name,//虚拟机镜像文件</div><div class="line">           const InstructionSet image_instruction_set,</div><div class="line">           CollectorType foreground_collector_type,</div><div class="line">           CollectorType background_collector_type,</div><div class="line">           space::LargeObjectSpaceType large_object_space_type,</div><div class="line">           size_t large_object_threshold,</div><div class="line">           size_t parallel_gc_threads,</div><div class="line">           size_t conc_gc_threads,</div><div class="line">           bool low_memory_mode,</div><div class="line">           size_t long_pause_log_threshold,</div><div class="line">           size_t long_gc_log_threshold,</div><div class="line">           bool ignore_max_footprint,</div><div class="line">           bool use_tlab,</div><div class="line">           bool verify_pre_gc_heap,</div><div class="line">           bool verify_pre_sweeping_heap,</div><div class="line">           bool verify_post_gc_heap,</div><div class="line">           bool verify_pre_gc_rosalloc,</div><div class="line">           bool verify_pre_sweeping_rosalloc,</div><div class="line">           bool verify_post_gc_rosalloc,</div><div class="line">           bool gc_stress_mode,</div><div class="line">           bool measure_gc_performance,</div><div class="line">           bool use_homogeneous_space_compaction_for_oom,</div><div class="line">           uint64_t min_interval_homogeneous_space_compaction_by_oom)</div><div class="line">    :</div><div class="line">	......</div><div class="line">	  // Load image space(s).    加载镜像空间</div><div class="line">  if (space::ImageSpace::LoadBootImage(image_file_name,</div><div class="line">                                       image_instruction_set,</div><div class="line">                                       &amp;boot_image_spaces_,</div><div class="line">                                       &amp;requested_alloc_space_begin)) &#123;</div><div class="line">    for (auto space : boot_image_spaces_) &#123;</div><div class="line">      AddSpace(space);</div><div class="line">    &#125;</div><div class="line">  &#125;	</div><div class="line">	......</div></pre></td></tr></table></figure>
<p>image_file_name描述image文件路径  默认为/system/framework/arm64/boot.art<br>用space::ImageSpace::LoadBootImage加载到boot_image<em>spaces</em>中，之后用Heap类的成员函数AddSpace加入堆空间<br>注意android7之后被分为多个文件:boot-<packagename>.oat/art，因此这里用for加入。art中的内容为类对象映像，包含了所有framework/base/preloaded-classes文件列出的所有类。这些类会被一次性的载入到内存中，并可以被直接使用</packagename></p>
<p>LoadBootImage在\art\runtime\gc\space\image_space.cc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">bool ImageSpace::LoadBootImage(const std::string&amp; image_file_name,</div><div class="line">                               const InstructionSet image_instruction_set,</div><div class="line">                               std::vector&lt;space::ImageSpace*&gt;* boot_image_spaces,</div><div class="line">                               uint8_t** oat_file_end) &#123;</div><div class="line">  DCHECK(boot_image_spaces != nullptr);</div><div class="line">  DCHECK(boot_image_spaces-&gt;empty());</div><div class="line">  DCHECK(oat_file_end != nullptr);</div><div class="line">  DCHECK_NE(image_instruction_set, InstructionSet::kNone);</div><div class="line"></div><div class="line">  if (image_file_name.empty()) &#123;</div><div class="line">    return false;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // For code reuse, handle this like a work queue.</div><div class="line">  std::vector&lt;std::string&gt; image_file_names;</div><div class="line">  image_file_names.push_back(image_file_name);</div><div class="line"></div><div class="line">  bool error = false;</div><div class="line">  uint8_t* oat_file_end_tmp = *oat_file_end;</div><div class="line"></div><div class="line">  for (size_t index = 0; index &lt; image_file_names.size(); ++index) &#123;</div><div class="line">    std::string&amp; image_name = image_file_names[index];</div><div class="line">    std::string error_msg;</div><div class="line">    std::unique_ptr&lt;space::ImageSpace&gt; boot_image_space_uptr = CreateBootImage(</div><div class="line">        image_name.c_str(),</div><div class="line">        image_instruction_set,</div><div class="line">        index &gt; 0,</div><div class="line">        &amp;error_msg);</div><div class="line">    if (boot_image_space_uptr != nullptr) &#123;</div><div class="line">      space::ImageSpace* boot_image_space = boot_image_space_uptr.release();</div><div class="line">      boot_image_spaces-&gt;push_back(boot_image_space);</div><div class="line">      // Oat files referenced by image files immediately follow them in memory, ensure alloc space</div><div class="line">      // isn&apos;t going to get in the middle</div><div class="line">      uint8_t* oat_file_end_addr = boot_image_space-&gt;GetImageHeader().GetOatFileEnd();</div><div class="line">      CHECK_GT(oat_file_end_addr, boot_image_space-&gt;End());</div><div class="line">      oat_file_end_tmp = AlignUp(oat_file_end_addr, kPageSize);</div><div class="line"></div><div class="line">      if (index == 0) &#123;</div><div class="line">        // If this was the first space, check whether there are more images to load.</div><div class="line">        const OatFile* boot_oat_file = boot_image_space-&gt;GetOatFile();</div><div class="line">        if (boot_oat_file == nullptr) &#123;</div><div class="line">          continue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        const OatHeader&amp; boot_oat_header = boot_oat_file-&gt;GetOatHeader();</div><div class="line">        const char* boot_classpath =</div><div class="line">            boot_oat_header.GetStoreValueByKey(OatHeader::kBootClassPathKey);</div><div class="line">        if (boot_classpath == nullptr) &#123;</div><div class="line">          continue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ExtractMultiImageLocations(image_file_name, boot_classpath, &amp;image_file_names);</div><div class="line">      &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">      error = true;</div><div class="line">      LOG(ERROR) &lt;&lt; &quot;Could not create image space with image file &apos;&quot; &lt;&lt; image_file_name &lt;&lt; &quot;&apos;. &quot;</div><div class="line">          &lt;&lt; &quot;Attempting to fall back to imageless running. Error was: &quot; &lt;&lt; error_msg</div><div class="line">          &lt;&lt; &quot;\nAttempted image: &quot; &lt;&lt; image_name;</div><div class="line">      break;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (error) &#123;</div><div class="line">    // Remove already loaded spaces.</div><div class="line">    for (space::Space* loaded_space : *boot_image_spaces) &#123;</div><div class="line">      delete loaded_space;</div><div class="line">    &#125;</div><div class="line">    boot_image_spaces-&gt;clear();</div><div class="line">    return false;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  *oat_file_end = oat_file_end_tmp;</div><div class="line">  return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>检查：boot.art、dalvik-cache是否存在该镜像文件，没有就创建。最后加载进boot_image_spaces中</p>
<p>Heap::AddSpace<br>位于art\runtime\gc\heap.cc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">void Heap::AddSpace(space::Space* space) &#123;</div><div class="line">  CHECK(space != nullptr);</div><div class="line">  WriterMutexLock mu(Thread::Current(), *Locks::heap_bitmap_lock_);</div><div class="line">  if (space-&gt;IsContinuousSpace()) &#123;//是连续的space</div><div class="line">    DCHECK(!space-&gt;IsDiscontinuousSpace());</div><div class="line">    space::ContinuousSpace* continuous_space = space-&gt;AsContinuousSpace();   //作为连续的空间</div><div class="line">    // Continuous spaces don&apos;t necessarily have bitmaps.</div><div class="line">    accounting::ContinuousSpaceBitmap* live_bitmap = continuous_space-&gt;GetLiveBitmap();</div><div class="line">    accounting::ContinuousSpaceBitmap* mark_bitmap = continuous_space-&gt;GetMarkBitmap();</div><div class="line">    // The region space bitmap is not added since VisitObjects visits the region space objects with</div><div class="line">    // special handling.</div><div class="line">    if (live_bitmap != nullptr &amp;&amp; !space-&gt;IsRegionSpace()) &#123;</div><div class="line">      CHECK(mark_bitmap != nullptr);</div><div class="line">      live_bitmap_-&gt;AddContinuousSpaceBitmap(live_bitmap);</div><div class="line">      mark_bitmap_-&gt;AddContinuousSpaceBitmap(mark_bitmap);</div><div class="line">    &#125;</div><div class="line">    continuous_spaces_.push_back(continuous_space);    //加入堆中的连续空间</div><div class="line">    // Ensure that spaces remain sorted in increasing order of start address.</div><div class="line">    std::sort(continuous_spaces_.begin(), continuous_spaces_.end(),</div><div class="line">              [](const space::ContinuousSpace* a, const space::ContinuousSpace* b) &#123;</div><div class="line">      return a-&gt;Begin() &lt; b-&gt;Begin();</div><div class="line">    &#125;);</div><div class="line">  &#125; else &#123;</div><div class="line">    CHECK(space-&gt;IsDiscontinuousSpace());</div><div class="line">    space::DiscontinuousSpace* discontinuous_space = space-&gt;AsDiscontinuousSpace();</div><div class="line">    live_bitmap_-&gt;AddLargeObjectBitmap(discontinuous_space-&gt;GetLiveBitmap());</div><div class="line">    mark_bitmap_-&gt;AddLargeObjectBitmap(discontinuous_space-&gt;GetMarkBitmap());</div><div class="line">    discontinuous_spaces_.push_back(discontinuous_space);</div><div class="line">  &#125;</div><div class="line">  if (space-&gt;IsAllocSpace()) &#123;  //是否允许分配</div><div class="line">    alloc_spaces_.push_back(space-&gt;AsAllocSpace());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Heap类中分别用成员变量continuous<em>spaces</em>和discontinuous<em>spaces</em>分别保存整个堆中的连续空间和非连续空间，这里讲space加载进heap</p>
<h3 id="10-JavaVMExt-Create"><a href="#10-JavaVMExt-Create" class="headerlink" title="10.JavaVMExt.Create"></a>10.JavaVMExt.Create</h3><p>Runtime::Init的JavaVMExt::Create<br>实现在art\runtime\java_vm_ext.cc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">class JavaVMExt : public JavaVM </div><div class="line">......</div><div class="line"></div><div class="line">// Checking &quot;globals&quot; and &quot;weak_globals&quot; usually requires locks, but we</div><div class="line">// don&apos;t need the locks to check for validity when constructing the</div><div class="line">// object. Use NO_THREAD_SAFETY_ANALYSIS for this.</div><div class="line">std::unique_ptr&lt;JavaVMExt&gt; JavaVMExt::Create(Runtime* runtime,</div><div class="line">                                             const RuntimeArgumentMap&amp; runtime_options,</div><div class="line">                                             std::string* error_msg) NO_THREAD_SAFETY_ANALYSIS &#123;</div><div class="line">  std::unique_ptr&lt;JavaVMExt&gt; java_vm(new JavaVMExt(runtime, runtime_options, error_msg));</div><div class="line">  if (java_vm &amp;&amp; java_vm-&gt;globals_.IsValid() &amp;&amp; java_vm-&gt;weak_globals_.IsValid()) &#123;</div><div class="line">    return java_vm;</div><div class="line">  &#125;</div><div class="line">  return nullptr;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">JavaVMExt::JavaVMExt(Runtime* runtime,</div><div class="line">                     const RuntimeArgumentMap&amp; runtime_options,</div><div class="line">                     std::string* error_msg)</div><div class="line">    : runtime_(runtime),</div><div class="line">      check_jni_abort_hook_(nullptr),</div><div class="line">      check_jni_abort_hook_data_(nullptr),</div><div class="line">      check_jni_(false),  // Initialized properly in the constructor body below.</div><div class="line">      force_copy_(runtime_options.Exists(RuntimeArgumentMap::JniOptsForceCopy)),</div><div class="line">      tracing_enabled_(runtime_options.Exists(RuntimeArgumentMap::JniTrace)</div><div class="line">                       || VLOG_IS_ON(third_party_jni)),</div><div class="line">      trace_(runtime_options.GetOrDefault(RuntimeArgumentMap::JniTrace)),</div><div class="line">      globals_(kGlobalsMax, kGlobal, IndirectReferenceTable::ResizableCapacity::kNo, error_msg),</div><div class="line">      libraries_(new Libraries),</div><div class="line">      unchecked_functions_(&amp;gJniInvokeInterface),</div><div class="line">      weak_globals_(kWeakGlobalsMax,</div><div class="line">                    kWeakGlobal,</div><div class="line">                    IndirectReferenceTable::ResizableCapacity::kNo,</div><div class="line">                    error_msg),</div><div class="line">      allow_accessing_weak_globals_(true),</div><div class="line">      weak_globals_add_condition_(&quot;weak globals add condition&quot;,</div><div class="line">                                  (CHECK(Locks::jni_weak_globals_lock_ != nullptr),</div><div class="line">                                   *Locks::jni_weak_globals_lock_)),</div><div class="line">      env_hooks_() &#123;</div><div class="line">  functions = unchecked_functions_;</div><div class="line">  SetCheckJniEnabled(runtime_options.Exists(RuntimeArgumentMap::CheckJni));</div><div class="line">&#125;</div><div class="line"></div><div class="line">const JNIInvokeInterface gJniInvokeInterface = &#123;</div><div class="line">  nullptr,  // reserved0</div><div class="line">  nullptr,  // reserved1</div><div class="line">  nullptr,  // reserved2</div><div class="line">  JII::DestroyJavaVM,</div><div class="line">  JII::AttachCurrentThread,</div><div class="line">  JII::DetachCurrentThread,</div><div class="line">  JII::GetEnv,</div><div class="line">  JII::AttachCurrentThreadAsDaemon</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>初始化JavaVMExt继承自JavaVM,functions为一函数指针结构体，存有JavaVM的进程相关方法。<br>该对象存有Runtime并唯一。</p>
<h3 id="11-Thread-Startup"><a href="#11-Thread-Startup" class="headerlink" title="11.Thread.Startup"></a>11.Thread.Startup</h3><p>Thread::Startup()<br>在/art/runtime/thread.cc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">void Thread::Startup() &#123;</div><div class="line">  CHECK(!is_started_);</div><div class="line">  is_started_ = true;</div><div class="line">  &#123;</div><div class="line">    // MutexLock to keep annotalysis happy.</div><div class="line">    //</div><div class="line">    // Note we use null for the thread because Thread::Current can</div><div class="line">    // return garbage since (is_started_ == true) and</div><div class="line">    // Thread::pthread_key_self_ is not yet initialized.</div><div class="line">    // This was seen on glibc.</div><div class="line">    MutexLock mu(nullptr, *Locks::thread_suspend_count_lock_);</div><div class="line">    resume_cond_ = new ConditionVariable(&quot;Thread resumption condition variable&quot;,</div><div class="line">                                         *Locks::thread_suspend_count_lock_);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Allocate a TLS slot.</div><div class="line">  CHECK_PTHREAD_CALL(pthread_key_create, (&amp;Thread::pthread_key_self_, Thread::ThreadExitCallback),</div><div class="line">                     &quot;self key&quot;);</div><div class="line"></div><div class="line">  // Double-check the TLS slot allocation.</div><div class="line">  if (pthread_getspecific(pthread_key_self_) != nullptr) &#123;</div><div class="line">    LOG(FATAL) &lt;&lt; &quot;Newly-created pthread TLS slot is not nullptr&quot;;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Thread类是art虚拟机管理线程的类，里面jvm创建与native创建的线程都有表示，是一一对应的。因为jvm的线程调度是由操作系统实现的</p>
<h3 id="12-Thread-Attach"><a href="#12-Thread-Attach" class="headerlink" title="12.Thread.Attach"></a>12.Thread.Attach</h3><p>Thread* self = Thread::Attach(“main”, false, nullptr, false);<br>位于art/runtime/thread.cc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Thread* Thread::Attach(const char* thread_name,</div><div class="line">                       bool as_daemon,   //daemon：守护进程</div><div class="line">                       jobject thread_group,</div><div class="line">                       bool create_peer) &#123;</div><div class="line">  auto create_peer_action = [&amp;](Thread* self) &#123;</div><div class="line">    // If we&apos;re the main thread, ClassLinker won&apos;t be created until after we&apos;re attached,</div><div class="line">    // so that thread needs a two-stage attach. Regular threads don&apos;t need this hack.</div><div class="line">    // In the compiler, all threads need this hack, because no-one&apos;s going to be getting</div><div class="line">    // a native peer!</div><div class="line">	//如果我们在主线程，ClassLinker还没创建，因此我们需要俩步来附上jvm与本地的线程。</div><div class="line">	//规则的线程不需要</div><div class="line">    if (create_peer) &#123;</div><div class="line">      self-&gt;CreatePeer(thread_name, as_daemon, thread_group);</div><div class="line">      if (self-&gt;IsExceptionPending()) &#123;</div><div class="line">        // We cannot keep the exception around, as we&apos;re deleting self. Try to be helpful and log it.</div><div class="line">        &#123;</div><div class="line">          ScopedObjectAccess soa(self);</div><div class="line">          LOG(ERROR) &lt;&lt; &quot;Exception creating thread peer:&quot;;</div><div class="line">          LOG(ERROR) &lt;&lt; self-&gt;GetException()-&gt;Dump();</div><div class="line">          self-&gt;ClearException();</div><div class="line">        &#125;</div><div class="line">        return false;</div><div class="line">      &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">      // These aren&apos;t necessary, but they improve diagnostics for unit tests &amp; command-line tools.</div><div class="line">      if (thread_name != nullptr) &#123;</div><div class="line">        self-&gt;tlsPtr_.name-&gt;assign(thread_name);</div><div class="line">        ::art::SetThreadName(thread_name);</div><div class="line">      &#125; else if (self-&gt;GetJniEnv()-&gt;check_jni) &#123;</div><div class="line">        LOG(WARNING) &lt;&lt; *Thread::Current() &lt;&lt; &quot; attached without supplying a name&quot;;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    return true;</div><div class="line">  &#125;;</div><div class="line">  return Attach(thread_name, as_daemon, create_peer_action);//调用的是下面那个，第三个是一个lambda表达式生成的函数指针</div><div class="line">&#125;</div><div class="line"></div><div class="line">template &lt;typename PeerAction&gt;</div><div class="line">Thread* Thread::Attach(const char* thread_name, bool as_daemon, PeerAction peer_action) &#123;</div><div class="line">  Runtime* runtime = Runtime::Current();</div><div class="line">  if (runtime == nullptr) &#123;</div><div class="line">    LOG(ERROR) &lt;&lt; &quot;Thread attaching to non-existent runtime: &quot; &lt;&lt; thread_name;</div><div class="line">    return nullptr;</div><div class="line">  &#125;</div><div class="line">  Thread* self;</div><div class="line">  &#123;</div><div class="line">    MutexLock mu(nullptr, *Locks::runtime_shutdown_lock_);</div><div class="line">    if (runtime-&gt;IsShuttingDownLocked()) &#123;</div><div class="line">      LOG(WARNING) &lt;&lt; &quot;Thread attaching while runtime is shutting down: &quot; &lt;&lt; thread_name;</div><div class="line">      return nullptr;</div><div class="line">    &#125; else &#123;</div><div class="line">      Runtime::Current()-&gt;StartThreadBirth();</div><div class="line">      self = new Thread(as_daemon);</div><div class="line">      bool init_success = self-&gt;Init(runtime-&gt;GetThreadList(), runtime-&gt;GetJavaVM()); //init线程传入ThreadList和JavaVM</div><div class="line">	  //</div><div class="line">	  </div><div class="line">      Runtime::Current()-&gt;EndThreadBirth();</div><div class="line">      if (!init_success) &#123;</div><div class="line">        delete self;</div><div class="line">        return nullptr;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  self-&gt;InitStringEntryPoints();</div><div class="line"></div><div class="line">  CHECK_NE(self-&gt;GetState(), kRunnable);</div><div class="line">  self-&gt;SetState(kNative);</div><div class="line"></div><div class="line">  // Run the action that is acting on the peer.</div><div class="line">  if (!peer_action(self)) &#123;</div><div class="line">    runtime-&gt;GetThreadList()-&gt;Unregister(self);</div><div class="line">    // Unregister deletes self, no need to do this here.</div><div class="line">    return nullptr;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  </div><div class="line">  </div><div class="line"></div><div class="line">  if (VLOG_IS_ON(threads)) &#123;</div><div class="line">    if (thread_name != nullptr) &#123;</div><div class="line">      VLOG(threads) &lt;&lt; &quot;Attaching thread &quot; &lt;&lt; thread_name;</div><div class="line">    &#125; else &#123;</div><div class="line">      VLOG(threads) &lt;&lt; &quot;Attaching unnamed thread.&quot;;</div><div class="line">    &#125;</div><div class="line">    ScopedObjectAccess soa(self);</div><div class="line">    self-&gt;Dump(LOG_STREAM(INFO));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  &#123;</div><div class="line">    ScopedObjectAccess soa(self);</div><div class="line">    runtime-&gt;GetRuntimeCallbacks()-&gt;ThreadStart(self);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建Thread实例，调用init函数，传入该进程的ThreadList和JavaVM。<br>同时在init中创建该线程的JNIEnvExt对象。<br>JNIEnvExt类的构造函数将父类JNIEnv的成员变量functions初始化为全局变量gJniNativeInterface。也就是说，JNI函数表实际是由全局变量gJniNativeInterface来描述的。其中均是jni的静态函数。</p>
<h3 id="16-Runtime-Start"><a href="#16-Runtime-Start" class="headerlink" title="16.Runtime.Start"></a>16.Runtime.Start</h3><p>  bool started = runtime-&gt;Start();//启动虚拟机<br>art\runtime\runtime.cc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line">bool Runtime::Start() &#123;</div><div class="line">......</div><div class="line">  Thread* self = Thread::Current();</div><div class="line"></div><div class="line">  self-&gt;TransitionFromRunnableToSuspended(kNative);</div><div class="line"></div><div class="line">  started_ = true;</div><div class="line"></div><div class="line">  if (!IsImageDex2OatEnabled() || !GetHeap()-&gt;HasBootImageSpace()) &#123;</div><div class="line">    ScopedObjectAccess soa(self);</div><div class="line">    StackHandleScope&lt;2&gt; hs(soa.Self());</div><div class="line"></div><div class="line">    auto class_class(hs.NewHandle&lt;mirror::Class&gt;(mirror::Class::GetJavaLangClass()));</div><div class="line">    auto field_class(hs.NewHandle&lt;mirror::Class&gt;(mirror::Field::StaticClass()));</div><div class="line"></div><div class="line">    class_linker_-&gt;EnsureInitialized(soa.Self(), class_class, true, true);</div><div class="line">    // Field class is needed for register_java_net_InetAddress in libcore, b/28153851.</div><div class="line">    class_linker_-&gt;EnsureInitialized(soa.Self(), field_class, true, true);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // InitNativeMethods needs to be after started_ so that the classes</div><div class="line">  // it touches will have methods linked to the oat file if necessary.</div><div class="line">  &#123;</div><div class="line">    ScopedTrace trace2(&quot;InitNativeMethods&quot;);</div><div class="line">    InitNativeMethods();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Initialize well known thread group values that may be accessed threads while attaching.</div><div class="line">  InitThreadGroups(self);</div><div class="line"></div><div class="line">  Thread::FinishStartup();</div><div class="line"></div><div class="line">  // Create the JIT either if we have to use JIT compilation or save profiling info. This is</div><div class="line">  // done after FinishStartup as the JIT pool needs Java thread peers, which require the main</div><div class="line">  // ThreadGroup to exist.</div><div class="line">  //</div><div class="line">  // TODO(calin): We use the JIT class as a proxy for JIT compilation and for</div><div class="line">  // recoding profiles. Maybe we should consider changing the name to be more clear it&apos;s</div><div class="line">  // not only about compiling. b/28295073.</div><div class="line">  if (jit_options_-&gt;UseJitCompilation() || jit_options_-&gt;GetSaveProfilingInfo()) &#123;</div><div class="line">    std::string error_msg;</div><div class="line">    if (!IsZygote()) &#123;</div><div class="line">    // If we are the zygote then we need to wait until after forking to create the code cache</div><div class="line">    // due to SELinux restrictions on r/w/x memory regions.</div><div class="line">      CreateJit();</div><div class="line">    &#125; else if (jit_options_-&gt;UseJitCompilation()) &#123;</div><div class="line">      if (!jit::Jit::LoadCompilerLibrary(&amp;error_msg)) &#123;</div><div class="line">        // Try to load compiler pre zygote to reduce PSS. b/27744947</div><div class="line">        LOG(WARNING) &lt;&lt; &quot;Failed to load JIT compiler with error &quot; &lt;&lt; error_msg;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Send the start phase event. We have to wait till here as this is when the main thread peer</div><div class="line">  // has just been generated, important root clinits have been run and JNI is completely functional.</div><div class="line">  &#123;</div><div class="line">    ScopedObjectAccess soa(self);</div><div class="line">    callbacks_-&gt;NextRuntimePhase(RuntimePhaseCallback::RuntimePhase::kStart);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  system_class_loader_ = CreateSystemClassLoader(this);</div><div class="line"></div><div class="line">  if (!is_zygote_) &#123;</div><div class="line">    if (is_native_bridge_loaded_) &#123;</div><div class="line">      PreInitializeNativeBridge(&quot;.&quot;);</div><div class="line">    &#125;</div><div class="line">    NativeBridgeAction action = force_native_bridge_</div><div class="line">        ? NativeBridgeAction::kInitialize</div><div class="line">        : NativeBridgeAction::kUnload;</div><div class="line">    InitNonZygoteOrPostFork(self-&gt;GetJniEnv(),</div><div class="line">                            /* is_system_server */ false,</div><div class="line">                            action,</div><div class="line">                            GetInstructionSetString(kRuntimeISA));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Send the initialized phase event. Send it before starting daemons, as otherwise</div><div class="line">  // sending thread events becomes complicated.</div><div class="line">  &#123;</div><div class="line">    ScopedObjectAccess soa(self);</div><div class="line">    callbacks_-&gt;NextRuntimePhase(RuntimePhaseCallback::RuntimePhase::kInit);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  StartDaemonThreads();</div><div class="line"></div><div class="line">  &#123;</div><div class="line">    ScopedObjectAccess soa(self);</div><div class="line">    self-&gt;GetJniEnv()-&gt;locals.AssertEmpty();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  VLOG(startup) &lt;&lt; &quot;Runtime::Start exiting&quot;;</div><div class="line">  finished_starting_ = true;</div><div class="line"></div><div class="line">  if (trace_config_.get() != nullptr &amp;&amp; trace_config_-&gt;trace_file != &quot;&quot;) &#123;</div><div class="line">    ScopedThreadStateChange tsc(self, kWaitingForMethodTracingStart);</div><div class="line">    Trace::Start(trace_config_-&gt;trace_file.c_str(),</div><div class="line">                 -1,</div><div class="line">                 static_cast&lt;int&gt;(trace_config_-&gt;trace_file_size),</div><div class="line">                 0,</div><div class="line">                 trace_config_-&gt;trace_output_mode,</div><div class="line">                 trace_config_-&gt;trace_mode,</div><div class="line">                 0);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>初始化基本类class_class ，即java.lang.Class类，这是最基础的类；</li>
<li>InitNativeMethods(): 将java.lang下面最基础的类的JNI接口进行初始化；</li>
<li>InitZygote：这是zygote程序在调用时，需要做的事情。app_main.cpp文件不仅是zygote的主程序，也是安卓的am命令行的主程序，故此这里做了区分；</li>
<li>StartDemonThreads，调用java.lang.Daemons.start，启动一组线程，它们的作用是，执行GC、调用finalize方法、 处理ReferenceQueue等一系列工作。</li>
</ol>
<h3 id="17-AndroidRuntime-startReg"><a href="#17-AndroidRuntime-startReg" class="headerlink" title="17.AndroidRuntime.startReg"></a>17.AndroidRuntime.startReg</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">/*static*/ int AndroidRuntime::startReg(JNIEnv* env)</div><div class="line">&#123;</div><div class="line">    ATRACE_NAME(&quot;RegisterAndroidNatives&quot;);</div><div class="line">    /*</div><div class="line">     * This hook causes all future threads created in this process to be</div><div class="line">     * attached to the JavaVM.  (This needs to go away in favor of JNI</div><div class="line">     * Attach calls.)</div><div class="line">     */</div><div class="line">    androidSetCreateThreadFunc((android_create_thread_fn) javaCreateThreadEtc);</div><div class="line"></div><div class="line">    ALOGV(&quot;--- registering native functions ---\n&quot;);</div><div class="line"></div><div class="line">    /*</div><div class="line">     * Every &quot;register&quot; function calls one or more things that return</div><div class="line">     * a local reference (e.g. FindClass).  Because we haven&apos;t really</div><div class="line">     * started the VM yet, they&apos;re all getting stored in the base frame</div><div class="line">     * and never released.  Use Push/Pop to manage the storage.</div><div class="line">     */</div><div class="line">    env-&gt;PushLocalFrame(200);</div><div class="line"></div><div class="line">    if (register_jni_procs(gRegJNI, NELEM(gRegJNI), env) &lt; 0) &#123;</div><div class="line">        env-&gt;PopLocalFrame(NULL);</div><div class="line">        return -1;</div><div class="line">    &#125;</div><div class="line">    env-&gt;PopLocalFrame(NULL);</div><div class="line"></div><div class="line">    //createJavaThread(&quot;fubar&quot;, quickTest, (void*) &quot;hello&quot;);</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注册android系统依赖的本地jni方法</p>
<h3 id="18-jni方法"><a href="#18-jni方法" class="headerlink" title="18.jni方法"></a>18.jni方法</h3><p>调用之前注册好的本地方法</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>基本启动过程如上….由于老罗的版本有些久远…art的c++源码庞大复杂…..经过一段时间的摸索仍在雾中。art加载执行部分无法自行分析懂，因此接下来从apk安装、运行角度分析。让逆向相关流程更为明确。<br>老罗的分析：<a href="https://blog.csdn.net/luoshengyang/article/details/39256813" target="_blank" rel="external">https://blog.csdn.net/luoshengyang/article/details/39256813</a><br>虚拟机本质还是一个c++程序。它解释自定义的执行文件格式。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android系统/" rel="tag"># android系统</a>
          
            <a href="/tags/art/" rel="tag"># art</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/21/android8-0-0源码分析-zygote的启动/" rel="next" title="android8.0.0源码分析-zygote的启动">
                <i class="fa fa-chevron-left"></i> android8.0.0源码分析-zygote的启动
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/28/ddctf-Android第一题-RSA/" rel="prev" title="ddctf-Android第一题-RSA">
                ddctf-Android第一题-RSA <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/1.png"
               alt="imbaya" />
          <p class="site-author-name" itemprop="name">imbaya</p>
           
              <p class="site-description motion-element" itemprop="description">..........</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">95</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">76</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#art虚拟机的启动"><span class="nav-number">2.</span> <span class="nav-text">art虚拟机的启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-main"><span class="nav-number">2.1.</span> <span class="nav-text">1.main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-start"><span class="nav-number">2.2.</span> <span class="nav-text">2.start</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-jni-invocation-Init"><span class="nav-number">2.3.</span> <span class="nav-text">3.jni_invocation.Init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-AppRuntime-startVm"><span class="nav-number">2.4.</span> <span class="nav-text">4.AppRuntime.startVm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-JNI-CreateJavaVM"><span class="nav-number">2.5.</span> <span class="nav-text">5/6.JNI_CreateJavaVM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-Runtime-Create"><span class="nav-number">2.6.</span> <span class="nav-text">7.Runtime.Create</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-Runtime-init"><span class="nav-number">2.7.</span> <span class="nav-text">8.Runtime.init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-Heap-Heap"><span class="nav-number">2.8.</span> <span class="nav-text">9.Heap.Heap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-JavaVMExt-Create"><span class="nav-number">2.9.</span> <span class="nav-text">10.JavaVMExt.Create</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-Thread-Startup"><span class="nav-number">2.10.</span> <span class="nav-text">11.Thread.Startup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-Thread-Attach"><span class="nav-number">2.11.</span> <span class="nav-text">12.Thread.Attach</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-Runtime-Start"><span class="nav-number">2.12.</span> <span class="nav-text">16.Runtime.Start</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-AndroidRuntime-startReg"><span class="nav-number">2.13.</span> <span class="nav-text">17.AndroidRuntime.startReg</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18-jni方法"><span class="nav-number">2.14.</span> <span class="nav-text">18.jni方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后记"><span class="nav-number">3.</span> <span class="nav-text">后记</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">imbaya</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":100,"height":200,"hOffset":0,"vOffset":-50},"mobile":{"show":false},"react":{"opacityDefault":1,"opacityOnHover":1},"log":false});</script></body>
</html>
