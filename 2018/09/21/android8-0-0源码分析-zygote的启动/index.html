<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android系统,zygote," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="前提知识PC主板上有一小段程序叫做BIOS，主板加电时它是第一个跑起来的程序。功能：  硬件检测    初始化中断向量、设置寄存器等   从硬盘的开始扇区读取记录，引导操作系统  这个在android中叫Bootloader 系统加载首先Android启动三种方式：1.Bootloader交互式启动，此时可刷全部存储空间(和向硬盘中装系统一样、放入正确的路径/分区)2.recover模式，从rec">
<meta name="keywords" content="android系统,zygote">
<meta property="og:type" content="article">
<meta property="og:title" content="android8.0.0源码分析-zygote的启动">
<meta property="og:url" content="http://yoursite.com/2018/09/21/android8-0-0源码分析-zygote的启动/index.html">
<meta property="og:site_name" content="GGWP">
<meta property="og:description" content="前提知识PC主板上有一小段程序叫做BIOS，主板加电时它是第一个跑起来的程序。功能：  硬件检测    初始化中断向量、设置寄存器等   从硬盘的开始扇区读取记录，引导操作系统  这个在android中叫Bootloader 系统加载首先Android启动三种方式：1.Bootloader交互式启动，此时可刷全部存储空间(和向硬盘中装系统一样、放入正确的路径/分区)2.recover模式，从rec">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.imgur.com/Xyppuv7.png">
<meta property="og:updated_time" content="2018-10-21T08:06:59.206Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android8.0.0源码分析-zygote的启动">
<meta name="twitter:description" content="前提知识PC主板上有一小段程序叫做BIOS，主板加电时它是第一个跑起来的程序。功能：  硬件检测    初始化中断向量、设置寄存器等   从硬盘的开始扇区读取记录，引导操作系统  这个在android中叫Bootloader 系统加载首先Android启动三种方式：1.Bootloader交互式启动，此时可刷全部存储空间(和向硬盘中装系统一样、放入正确的路径/分区)2.recover模式，从rec">
<meta name="twitter:image" content="https://i.imgur.com/Xyppuv7.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/09/21/android8-0-0源码分析-zygote的启动/"/>





  <title>android8.0.0源码分析-zygote的启动 | GGWP</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GGWP</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/21/android8-0-0源码分析-zygote的启动/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">android8.0.0源码分析-zygote的启动</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-21T21:16:17+08:00">
                2018-09-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前提知识"><a href="#前提知识" class="headerlink" title="前提知识"></a>前提知识</h2><p>PC主板上有一小段程序叫做BIOS，主板加电时它是第一个跑起来的程序。<br>功能：</p>
<ol>
<li>硬件检测   </li>
<li>初始化中断向量、设置寄存器等  </li>
<li>从硬盘的开始扇区读取记录，引导操作系统</li>
</ol>
<p>这个在android中叫Bootloader</p>
<h2 id="系统加载"><a href="#系统加载" class="headerlink" title="系统加载"></a>系统加载</h2><p>首先Android启动三种方式：<br>1.Bootloader交互式启动，此时可刷全部存储空间(和向硬盘中装系统一样、放入正确的路径/分区)<br>2.recover模式，从recovery.img镜像启动系统，可以修改部分存储，更新系统<br>3.Main System，从boot.img镜像启动系统</p>
<p>引导默认从Main System启动</p>
<a id="more"></a>
<h2 id="系统启动"><a href="#系统启动" class="headerlink" title="系统启动"></a>系统启动</h2><p>此时linux系统启动，设置缓存、被保护存储器、计划列表，加载驱动等系统任务。创建基本的程序运行环境，启动init进程。<br>android在init进程中启动/init.rc脚本来启动android系统<br>里面有一句import /init.${ro.zygote}.rc<br>在default.prop中定义ro.zygote=zygote64_32</p>
<p>/init.zygote64_32.rc中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote</div><div class="line">    class main</div><div class="line">    priority -20</div><div class="line">    user root</div><div class="line">    group root readproc</div><div class="line">    socket zygote stream 660 root system    socket关键字表示这个zygote进程需要一个名称为&quot;zygote&quot;的socket资源</div><div class="line">    onrestart write /sys/android_power/request_state wake</div><div class="line">    onrestart write /sys/power/state on</div><div class="line">    onrestart restart audioserver           系列onrestart关键字表示这个zygote进程重启时需要执行的命令。</div><div class="line">    onrestart restart cameraserver</div><div class="line">    onrestart restart media</div><div class="line">    onrestart restart netd</div><div class="line">    onrestart restart wificond</div><div class="line">    writepid /dev/cpuset/foreground/tasks</div><div class="line"></div><div class="line">service zygote_secondary /system/bin/app_process32 -Xzygote /system/bin --zygote --socket-name=zygote_secondary --enable-lazy-preload</div><div class="line">    class main</div><div class="line">    priority -20</div><div class="line">    user root</div><div class="line">    group root readproc</div><div class="line">    socket zygote_secondary stream 660 root system</div><div class="line">    onrestart restart zygote</div><div class="line">    writepid /dev/cpuset/foreground/tasks</div></pre></td></tr></table></figure></p>
<p>创建名为zygote的进程，这个zygote进程要执行的程序是/system/bin/app_process64后面都是参数。<br>可见我的nexus_6p 8.1.0是启动/system/bin/app_process64来启动Zygote进程的。</p>
<h2 id="android启动zygote"><a href="#android启动zygote" class="headerlink" title="android启动zygote"></a>android启动zygote</h2><p>时序图：<br><img src="https://i.imgur.com/Xyppuv7.png" alt=""></p>
<h3 id="app-main-cpp"><a href="#app-main-cpp" class="headerlink" title="app_main.cpp"></a>app_main.cpp</h3><p>/system/bin/app_process64的源码位于frameworks\base\cmds\app_process\app_main.cpp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div></pre></td><td class="code"><pre><div class="line">求参数块的大小</div><div class="line">static size_t computeArgBlockSize(int argc, char* const argv[]) &#123;</div><div class="line"></div><div class="line">    uintptr_t start = reinterpret_cast&lt;uintptr_t&gt;(argv[0]);</div><div class="line">    uintptr_t end = reinterpret_cast&lt;uintptr_t&gt;(argv[argc - 1]);</div><div class="line">    end += strlen(argv[argc - 1]) + 1;</div><div class="line">    return (end - start);</div><div class="line">&#125;</div><div class="line">......</div><div class="line">int main(int argc, char* const argv[])</div><div class="line">&#123;</div><div class="line"></div><div class="line">	.......</div><div class="line">	                    第一个参数的位置 ，参数块大小</div><div class="line">    AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));//在栈中构建AppRuntime对象</div><div class="line">    // Process command line arguments</div><div class="line">    // ignore argv[0]  忽略0号</div><div class="line">    argc--;</div><div class="line">    argv++;</div><div class="line"></div><div class="line"></div><div class="line">    const char* spaced_commands[] = &#123; &quot;-cp&quot;, &quot;-classpath&quot; &#125;;</div><div class="line">    // Allow &quot;spaced commands&quot; to be succeeded by exactly 1 argument (regardless of -s).</div><div class="line">    bool known_command = false;</div><div class="line"></div><div class="line">    int i;</div><div class="line">    for (i = 0; i &lt; argc; i++) &#123;</div><div class="line">        if (known_command == true) &#123;</div><div class="line">          runtime.addOption(strdup(argv[i])); </div><div class="line">          ALOGV(&quot;app_process main add known option &apos;%s&apos;&quot;, argv[i]);</div><div class="line">          known_command = false;</div><div class="line">          continue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        for (int j = 0;</div><div class="line">             j &lt; static_cast&lt;int&gt;(sizeof(spaced_commands) / sizeof(spaced_commands[0]));</div><div class="line">             ++j) &#123;</div><div class="line">          if (strcmp(argv[i], spaced_commands[j]) == 0) &#123;</div><div class="line">            known_command = true;</div><div class="line">            ALOGV(&quot;app_process main found known command &apos;%s&apos;&quot;, argv[i]);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (argv[i][0] != &apos;-&apos;) &#123;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        if (argv[i][1] == &apos;-&apos; &amp;&amp; argv[i][2] == 0) &#123;</div><div class="line">            ++i; // Skip --.</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        runtime.addOption(strdup(argv[i]));//向一开始构造的AppRuntime中加参数设置strdup是c中的字符串拷贝</div><div class="line">        ALOGV(&quot;app_process main add option &apos;%s&apos;&quot;, argv[i]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Parse runtime arguments.  Stop at first unrecognized option.</div><div class="line">    bool zygote = false;</div><div class="line">    bool startSystemServer = false;</div><div class="line">    bool application = false;</div><div class="line">    String8 niceName;</div><div class="line">    String8 className;</div><div class="line"></div><div class="line">    ++i;  // Skip unused &quot;parent dir&quot; argument.</div><div class="line">    while (i &lt; argc) &#123;</div><div class="line">        const char* arg = argv[i++];</div><div class="line">        if (strcmp(arg, &quot;--zygote&quot;) == 0) &#123;  //</div><div class="line">            zygote = true;</div><div class="line">            niceName = ZYGOTE_NICE_NAME;</div><div class="line">        &#125; else if (strcmp(arg, &quot;--start-system-server&quot;) == 0) &#123;</div><div class="line">            startSystemServer = true;</div><div class="line">        &#125; else if (strcmp(arg, &quot;--application&quot;) == 0) &#123;</div><div class="line">            application = true;</div><div class="line">        &#125; else if (strncmp(arg, &quot;--nice-name=&quot;, 12) == 0) &#123;</div><div class="line">            niceName.setTo(arg + 12);</div><div class="line">        &#125; else if (strncmp(arg, &quot;--&quot;, 2) != 0) &#123;</div><div class="line">            className.setTo(arg);</div><div class="line">            break;</div><div class="line">        &#125; else &#123;</div><div class="line">            --i;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">	//配置runtime.start参数</div><div class="line">    Vector&lt;String8&gt; args;  </div><div class="line">    if (!className.isEmpty()) &#123;</div><div class="line">        // We&apos;re not in zygote mode, the only argument we need to pass</div><div class="line">        // to RuntimeInit is the application argument.</div><div class="line">        //</div><div class="line">        // The Remainder of args get passed to startup class main(). Make</div><div class="line">        // copies of them before we overwrite them with the process name.</div><div class="line">        args.add(application ? String8(&quot;application&quot;) : String8(&quot;tool&quot;));</div><div class="line">        runtime.setClassNameAndArgs(className, argc - i, argv + i);</div><div class="line"></div><div class="line">        if (!LOG_NDEBUG) &#123;</div><div class="line">          String8 restOfArgs;</div><div class="line">          char* const* argv_new = argv + i;</div><div class="line">          int argc_new = argc - i;</div><div class="line">          for (int k = 0; k &lt; argc_new; ++k) &#123;</div><div class="line">            restOfArgs.append(&quot;\&quot;&quot;);</div><div class="line">            restOfArgs.append(argv_new[k]);</div><div class="line">            restOfArgs.append(&quot;\&quot; &quot;);</div><div class="line">          &#125;</div><div class="line">          ALOGV(&quot;Class name = %s, args = %s&quot;, className.string(), restOfArgs.string());</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        // We&apos;re in zygote mode.</div><div class="line">        maybeCreateDalvikCache();</div><div class="line"></div><div class="line">        if (startSystemServer) &#123;</div><div class="line">            args.add(String8(&quot;start-system-server&quot;)); //启动SystemServer组件</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        char prop[PROP_VALUE_MAX];</div><div class="line">        if (property_get(ABI_LIST_PROPERTY, prop, NULL) == 0) &#123;</div><div class="line">            LOG_ALWAYS_FATAL(&quot;app_process: Unable to determine ABI list from property %s.&quot;,</div><div class="line">                ABI_LIST_PROPERTY);</div><div class="line">            return 11;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String8 abiFlag(&quot;--abi-list=&quot;);</div><div class="line">        abiFlag.append(prop);</div><div class="line">        args.add(abiFlag);</div><div class="line"></div><div class="line">        // In zygote mode, pass all remaining arguments to the zygote</div><div class="line">        // main() method.</div><div class="line">        for (; i &lt; argc; ++i) &#123;</div><div class="line">            args.add(String8(argv[i]));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!niceName.isEmpty()) &#123;</div><div class="line">        runtime.setArgv0(niceName.string(), true /* setProcName */);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	//调用runtime.start</div><div class="line">    if (zygote) &#123;</div><div class="line">        runtime.start(&quot;com.android.internal.os.ZygoteInit&quot;, args, zygote);</div><div class="line">    &#125; else if (className) &#123;</div><div class="line">        runtime.start(&quot;com.android.internal.os.RuntimeInit&quot;, args, zygote);</div><div class="line">    &#125; else &#123;</div><div class="line">        fprintf(stderr, &quot;Error: no class name or --zygote supplied.\n&quot;);</div><div class="line">        app_usage();</div><div class="line">        LOG_ALWAYS_FATAL(&quot;app_process: no class name or --zygote supplied.&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要干了：</p>
<ol>
<li>处理分发各参数</li>
<li>创建AppRuntime对象</li>
<li>runtime.start(“com.android.internal.os.ZygoteInit”, args, zygote);参：类名，设置，true</li>
</ol>
<h3 id="AppRuntime"><a href="#AppRuntime" class="headerlink" title="AppRuntime"></a>AppRuntime</h3><p>定义于frameworks\base\cmds\app_process\app_main.cpp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">class AppRuntime : public AndroidRuntime</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    AppRuntime(char* argBlockStart, const size_t argBlockLength)</div><div class="line">        : AndroidRuntime(argBlockStart, argBlockLength)</div><div class="line">        , mClass(NULL)//调用父、赋值属性的简写</div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	//将自己的   mClassName; mArgs; 设置</div><div class="line">    void setClassNameAndArgs(const String8&amp; className, int argc, char * const *argv) &#123;</div><div class="line">        mClassName = className;</div><div class="line">        for (int i = 0; i &lt; argc; ++i) &#123;</div><div class="line">             mArgs.add(String8(argv[i]));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	virtual为虚函数供子类重写</div><div class="line">    virtual void onVmCreated(JNIEnv* env)</div><div class="line">    &#123;</div><div class="line">		......</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    virtual void onStarted()</div><div class="line">    &#123;</div><div class="line">		......</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    virtual void onZygoteInit()</div><div class="line">    &#123;</div><div class="line">		......</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    virtual void onExit(int code)</div><div class="line">    &#123;</div><div class="line">		......</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    String8 mClassName;</div><div class="line">    Vector&lt;String8&gt; mArgs;</div><div class="line">    jclass mClass;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>为AndroidRuntime类的子类，构造中调用父，本身无start方法</p>
<p>AndroidRuntime类定义于frameworks\base\core\jni\AndroidRuntime.cpp<br>首先看下构造方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">......</div><div class="line">static AndroidRuntime* gCurRuntime = NULL;</div><div class="line">......</div><div class="line">AndroidRuntime::AndroidRuntime(char* argBlockStart, const size_t argBlockLength) :</div><div class="line">        mExitWithoutCleanup(false),</div><div class="line">        mArgBlockStart(argBlockStart),</div><div class="line">        mArgBlockLength(argBlockLength)</div><div class="line">&#123;</div><div class="line">    SkGraphics::Init();</div><div class="line">    // There is also a global font cache, but its budget is specified by</div><div class="line">    // SK_DEFAULT_FONT_CACHE_COUNT_LIMIT and SK_DEFAULT_FONT_CACHE_LIMIT.</div><div class="line"></div><div class="line">    // Pre-allocate enough space to hold a fair number of options.</div><div class="line">    mOptions.setCapacity(20);</div><div class="line"></div><div class="line">    assert(gCurRuntime == NULL);        // one per process断言肯定是unll true没事</div><div class="line">    gCurRuntime = this;  //一个进程只有一个该类实例。</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为全局静态变量gCurRuntime赋值，该AndroidRuntime一个进程只会有一个。<br>注意构建函数的俩个参数：第一个为程序名的地址，但是在进程初始堆栈中argv[0]指向的正是初始栈的参数字串统一存储区域一开始的位置（由运行库传给main）<br>第二个参数为参数块大小。因此可以命名为 mArgBlockStart作为所有参数存于全局。</p>
<p>runtime.start(“com.android.internal.os.ZygoteInit”, args, zygote);执行的是AndroidRuntime类的start方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">void AndroidRuntime::start(const char* className, const Vector&lt;String8&gt;&amp; options, bool zygote)</div><div class="line">&#123;</div><div class="line">    ALOGD(&quot;&gt;&gt;&gt;&gt;&gt;&gt; START %s uid %d &lt;&lt;&lt;&lt;&lt;&lt;\n&quot;,</div><div class="line">            className != NULL ? className : &quot;(unknown)&quot;, getuid());</div><div class="line"></div><div class="line">    static const String8 startSystemServer(&quot;start-system-server&quot;);</div><div class="line"></div><div class="line">    /*</div><div class="line">     * &apos;startSystemServer == true&apos; means runtime is obsolete and not run from</div><div class="line">     * init.rc anymore, so we print out the boot start event here.</div><div class="line">     */</div><div class="line">    for (size_t i = 0; i &lt; options.size(); ++i) &#123;</div><div class="line">        if (options[i] == startSystemServer) &#123;</div><div class="line">           /* track our progress through the boot sequence */</div><div class="line">           const int LOG_BOOT_PROGRESS_START = 3000;</div><div class="line">           LOG_EVENT_LONG(LOG_BOOT_PROGRESS_START,  ns2ms(systemTime(SYSTEM_TIME_MONOTONIC)));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    const char* rootDir = getenv(&quot;ANDROID_ROOT&quot;);</div><div class="line">    if (rootDir == NULL) &#123;</div><div class="line">        rootDir = &quot;/system&quot;;</div><div class="line">        if (!hasDir(&quot;/system&quot;)) &#123;</div><div class="line">            LOG_FATAL(&quot;No root directory specified, and /android does not exist.&quot;);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        setenv(&quot;ANDROID_ROOT&quot;, rootDir, 1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //const char* kernelHack = getenv(&quot;LD_ASSUME_KERNEL&quot;);</div><div class="line">    //ALOGD(&quot;Found LD_ASSUME_KERNEL=&apos;%s&apos;\n&quot;, kernelHack);</div><div class="line"></div><div class="line">    /* start the virtual machine */</div><div class="line">    JniInvocation jni_invocation;</div><div class="line">    jni_invocation.Init(NULL);    加载libart.so 导出artvm接口   </div><div class="line">    JNIEnv* env;</div><div class="line">    if (startVm(&amp;mJavaVM, &amp;env, zygote) != 0) &#123;   //启动vm虚拟机</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    onVmCreated(env); //AppRuntime是this的类型，所以执行的是AppRuntime的onVmCreate。</div><div class="line"></div><div class="line">    /*</div><div class="line">     * Register android functions.</div><div class="line">     */</div><div class="line">    if (startReg(env) &lt; 0) &#123;    //注册jni方法</div><div class="line">        ALOGE(&quot;Unable to register all android natives\n&quot;);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /*</div><div class="line">     * We want to call main() with a String array with arguments in it.</div><div class="line">     * At present we have two arguments, the class name and an option string.</div><div class="line">     * Create an array to hold them.</div><div class="line">     */</div><div class="line">    jclass stringClass;</div><div class="line">    jobjectArray strArray;</div><div class="line">    jstring classNameStr;</div><div class="line"></div><div class="line">    stringClass = env-&gt;FindClass(&quot;java/lang/String&quot;);</div><div class="line">    assert(stringClass != NULL);</div><div class="line">    strArray = env-&gt;NewObjectArray(options.size() + 1, stringClass, NULL);</div><div class="line">    assert(strArray != NULL);</div><div class="line">    classNameStr = env-&gt;NewStringUTF(className);</div><div class="line">    assert(classNameStr != NULL);</div><div class="line">    env-&gt;SetObjectArrayElement(strArray, 0, classNameStr);</div><div class="line"></div><div class="line">    for (size_t i = 0; i &lt; options.size(); ++i) &#123;</div><div class="line">        jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).string());</div><div class="line">        assert(optionsStr != NULL);</div><div class="line">        env-&gt;SetObjectArrayElement(strArray, i + 1, optionsStr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /*</div><div class="line">     * Start VM.  This thread becomes the main thread of the VM, and will</div><div class="line">     * not return until the VM exits.</div><div class="line">     */</div><div class="line">    char* slashClassName = toSlashClassName(className);</div><div class="line">    jclass startClass = env-&gt;FindClass(slashClassName);</div><div class="line">    if (startClass == NULL) &#123;</div><div class="line">        ALOGE(&quot;JavaVM unable to locate class &apos;%s&apos;\n&quot;, slashClassName);</div><div class="line">        /* keep going */</div><div class="line">    &#125; else &#123;</div><div class="line">        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, &quot;main&quot;,</div><div class="line">            &quot;([Ljava/lang/String;)V&quot;);</div><div class="line">        if (startMeth == NULL) &#123;</div><div class="line">            ALOGE(&quot;JavaVM unable to find main() in &apos;%s&apos;\n&quot;, className);</div><div class="line">            /* keep going */</div><div class="line">        &#125; else &#123;</div><div class="line">            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);   //调用com.android.internal.os.ZygoteInit的main</div><div class="line"></div><div class="line">#if 0</div><div class="line">            if (env-&gt;ExceptionCheck())</div><div class="line">                threadExitUncaughtException(env);</div><div class="line">#endif</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    free(slashClassName);</div><div class="line"></div><div class="line">    ALOGD(&quot;Shutting down VM\n&quot;);</div><div class="line">    if (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</div><div class="line">        ALOGW(&quot;Warning: unable to detach main thread\n&quot;);</div><div class="line">    if (mJavaVM-&gt;DestroyJavaVM() != 0)</div><div class="line">        ALOGW(&quot;Warning: VM did not shut down cleanly\n&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Dalvik虚拟机和ART虚拟机都实现了三个用来抽象Java虚拟机的接口：</p>
<ol>
<li>JNI_GetDefaultJavaVMInitArgs – 获取虚拟机的默认初始化参数</li>
<li>JNI_CreateJavaVM – 在进程中创建虚拟机实例  这里创建javavm与javaenv给予该进程虚拟机</li>
<li>JNI_GetCreatedJavaVMs – 获取进程中创建的虚拟机实例</li>
</ol>
<p>art通过替换libdvm.so为libart.so，开放公共接口，从而替换虚拟机，安装时dex-&gt;oat       </p>
<p>libnativehelper/JniInvocation.cpp中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">bool JniInvocation::Init(const char* library)</div><div class="line">dlopen加载libart.so  </div><div class="line"> FindSymbol三个接口存储为指针    </div><div class="line">libart.so由属性persist.sys.dalvik.vm.lib定</div><div class="line"></div><div class="line"></div><div class="line">extern &quot;C&quot; jint JNI_CreateJavaVM(JavaVM** p_vm, JNIEnv** p_env, void* vm_args) &#123;</div><div class="line">  return JniInvocation::GetJniInvocation().JNI_CreateJavaVM(p_vm, p_env, vm_args);</div><div class="line">&#125;</div><div class="line">获取之前创建的对象，调用其方法</div><div class="line">jint JniInvocation::JNI_CreateJavaVM(JavaVM** p_vm, JNIEnv** p_env, void* vm_args) &#123;</div><div class="line">  return JNI_CreateJavaVM_(p_vm, p_env, vm_args);</div><div class="line">&#125;</div><div class="line">继续调用存储好的指针</div></pre></td></tr></table></figure>
<p>AndroidRuntime::start的过程：参：执行的java类com.android.internal.os.ZygoteInit，设置，true 。返回void</p>
<ol>
<li>jni_invocation.Init(NULL);加载libart.so，导出虚拟机接口</li>
<li>startVm(&amp;mJavaVM, &amp;env, zygote)启动虚拟机，参：全局静态量JavaVM<em>类型的地址，该函数内变量JNIEnv</em>类型的地址，true。返回0成功</li>
<li>startReg(env)注册jni方法，参：函数内变量JNIEnv*类型的地址。返回&gt;=0表成功</li>
<li>env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);通过jni调用com.android.internal.os.ZygoteInit的main。参：jclass类型的类对象，main方法id，参数数组</li>
</ol>
<p>之后进入java层。</p>
<h3 id="ZygoteInit"><a href="#ZygoteInit" class="headerlink" title="ZygoteInit"></a>ZygoteInit</h3><p>位于frameworks\base\core\java\com\android\internal\os\ZygoteInit.java<br>参数为设置选选项<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public static void main(String argv[]) &#123;</div><div class="line">    ZygoteServer zygoteServer = new ZygoteServer(); //ZygoteServer服务对象</div><div class="line"></div><div class="line">    // Mark zygote start. This ensures that thread creation will throw</div><div class="line">    // an error.</div><div class="line">    ZygoteHooks.startZygoteNoThreadCreation();</div><div class="line"></div><div class="line">    // Zygote goes into its own process group.</div><div class="line">    try &#123;</div><div class="line">        Os.setpgid(0, 0);</div><div class="line">    &#125; catch (ErrnoException ex) &#123;</div><div class="line">        throw new RuntimeException(&quot;Failed to setpgid(0,0)&quot;, ex);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    try &#123;</div><div class="line">        // Report Zygote start time to tron unless it is a runtime restart</div><div class="line">        if (!&quot;1&quot;.equals(SystemProperties.get(&quot;sys.boot_completed&quot;))) &#123;</div><div class="line">            MetricsLogger.histogram(null, &quot;boot_zygote_init&quot;,</div><div class="line">                    (int) SystemClock.elapsedRealtime());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String bootTimeTag = Process.is64Bit() ? &quot;Zygote64Timing&quot; : &quot;Zygote32Timing&quot;;</div><div class="line">        BootTimingsTraceLog bootTimingsTraceLog = new BootTimingsTraceLog(bootTimeTag,</div><div class="line">                Trace.TRACE_TAG_DALVIK);</div><div class="line">        bootTimingsTraceLog.traceBegin(&quot;ZygoteInit&quot;);</div><div class="line">        RuntimeInit.enableDdms();</div><div class="line">        // Start profiling the zygote initialization.</div><div class="line">        SamplingProfilerIntegration.start();</div><div class="line"></div><div class="line">        boolean startSystemServer = false;</div><div class="line">        String socketName = &quot;zygote&quot;;</div><div class="line">        String abiList = null;</div><div class="line">        boolean enableLazyPreload = false;</div><div class="line">        for (int i = 1; i &lt; argv.length; i++) &#123;</div><div class="line">            if (&quot;start-system-server&quot;.equals(argv[i])) &#123;</div><div class="line">                startSystemServer = true;</div><div class="line">            &#125; else if (&quot;--enable-lazy-preload&quot;.equals(argv[i])) &#123;</div><div class="line">                enableLazyPreload = true;</div><div class="line">            &#125; else if (argv[i].startsWith(ABI_LIST_ARG)) &#123;</div><div class="line">                abiList = argv[i].substring(ABI_LIST_ARG.length());</div><div class="line">            &#125; else if (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</div><div class="line">                socketName = argv[i].substring(SOCKET_NAME_ARG.length());</div><div class="line">            &#125; else &#123;</div><div class="line">                throw new RuntimeException(&quot;Unknown command line argument: &quot; + argv[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (abiList == null) &#123;</div><div class="line">            throw new RuntimeException(&quot;No ABI list supplied.&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        zygoteServer.registerServerSocket(socketName);//ZygoteServer注册socket名字为zygote</div><div class="line">        // In some configurations, we avoid preloading resources and classes eagerly.</div><div class="line">        // In such cases, we will preload things prior to our first fork.</div><div class="line">        if (!enableLazyPreload) &#123;</div><div class="line">            bootTimingsTraceLog.traceBegin(&quot;ZygotePreload&quot;);</div><div class="line">            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</div><div class="line">                SystemClock.uptimeMillis());</div><div class="line">            preload(bootTimingsTraceLog);</div><div class="line">            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</div><div class="line">                SystemClock.uptimeMillis());</div><div class="line">            bootTimingsTraceLog.traceEnd(); // ZygotePreload</div><div class="line">        &#125; else &#123;</div><div class="line">            Zygote.resetNicePriority();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Finish profiling the zygote initialization.</div><div class="line">        SamplingProfilerIntegration.writeZygoteSnapshot();</div><div class="line"></div><div class="line">        // Do an initial gc to clean up after startup</div><div class="line">        bootTimingsTraceLog.traceBegin(&quot;PostZygoteInitGC&quot;);</div><div class="line">        gcAndFinalize();</div><div class="line">        bootTimingsTraceLog.traceEnd(); // PostZygoteInitGC</div><div class="line"></div><div class="line">        bootTimingsTraceLog.traceEnd(); // ZygoteInit</div><div class="line">        // Disable tracing so that forked processes do not inherit stale tracing tags from</div><div class="line">        // Zygote.</div><div class="line">        Trace.setTracingEnabled(false);</div><div class="line"></div><div class="line">        // Zygote process unmounts root storage spaces.</div><div class="line">        Zygote.nativeUnmountStorageOnInit();</div><div class="line"></div><div class="line">        // Set seccomp policy</div><div class="line">        Seccomp.setPolicy();</div><div class="line"></div><div class="line">        ZygoteHooks.stopZygoteNoThreadCreation();</div><div class="line"></div><div class="line">        if (startSystemServer) &#123;</div><div class="line">            startSystemServer(abiList, socketName, zygoteServer); //开启系统服务，SystemServer由Zygote fork生成的，是zygote孵化出的第一个进程</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Log.i(TAG, &quot;Accepting command socket connections&quot;);</div><div class="line">        zygoteServer.runSelectLoop(abiList);  //进入选择循环</div><div class="line"></div><div class="line">        zygoteServer.closeServerSocket();</div><div class="line">    &#125; catch (Zygote.MethodAndArgsCaller caller) &#123;</div><div class="line">        caller.run();</div><div class="line">    &#125; catch (Throwable ex) &#123;</div><div class="line">        Log.e(TAG, &quot;System zygote died with exception&quot;, ex);</div><div class="line">        zygoteServer.closeServerSocket();</div><div class="line">        throw ex;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ZygoteInit.main的主要任务：</p>
<ol>
<li>构造ZygoteServer对象</li>
<li>zygoteServer.registerServerSocket(socketName);//ZygoteServer注册socket名字为zygote</li>
<li>startSystemServer(abiList, socketName, zygoteServer);开启系统服务，第一个子进程。参：abilist，zy注册的socketName，zy开启的socketName对象。</li>
<li>zygoteServer.runSelectLoop(abiList);进入选择循环，参为abilist</li>
</ol>
<h3 id="zygoteServer"><a href="#zygoteServer" class="headerlink" title="zygoteServer"></a>zygoteServer</h3><p>位于frameworks\base\core\java\com\android\internal\os\ZygoteServer.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * Runs the zygote process&apos;s select loop. Accepts new connections as</div><div class="line"> * they happen, and reads commands from connections one spawn-request&apos;s</div><div class="line"> * worth at a time.</div><div class="line"> *</div><div class="line"> * @throws Zygote.MethodAndArgsCaller in a child process when a main()</div><div class="line"> * should be executed.</div><div class="line"> */</div><div class="line">void runSelectLoop(String abiList) throws Zygote.MethodAndArgsCaller &#123;</div><div class="line">    ArrayList&lt;FileDescriptor&gt; fds = new ArrayList&lt;FileDescriptor&gt;();</div><div class="line">    ArrayList&lt;ZygoteConnection&gt; peers = new ArrayList&lt;ZygoteConnection&gt;();</div><div class="line"></div><div class="line">    fds.add(mServerSocket.getFileDescriptor());</div><div class="line">    peers.add(null);</div><div class="line"></div><div class="line">    while (true) &#123;</div><div class="line">        StructPollfd[] pollFds = new StructPollfd[fds.size()];</div><div class="line">        for (int i = 0; i &lt; pollFds.length; ++i) &#123;</div><div class="line">            pollFds[i] = new StructPollfd();</div><div class="line">            pollFds[i].fd = fds.get(i);</div><div class="line">            pollFds[i].events = (short) POLLIN;</div><div class="line">        &#125;</div><div class="line">        try &#123;</div><div class="line">            Os.poll(pollFds, -1);</div><div class="line">        &#125; catch (ErrnoException ex) &#123;</div><div class="line">            throw new RuntimeException(&quot;poll failed&quot;, ex);</div><div class="line">        &#125;</div><div class="line">        for (int i = pollFds.length - 1; i &gt;= 0; --i) &#123;</div><div class="line">            if ((pollFds[i].revents &amp; POLLIN) == 0) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            if (i == 0) &#123;</div><div class="line">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</div><div class="line">                peers.add(newPeer);</div><div class="line">                fds.add(newPeer.getFileDesciptor());</div><div class="line">            &#125; else &#123;</div><div class="line">                boolean done = peers.get(i).runOnce(this);//将当前的连接事件取出来执行</div><div class="line">                if (done) &#123;</div><div class="line">                    peers.remove(i);</div><div class="line">                    fds.remove(i);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>该函数进入循环模式监听处理消息</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>init启动zygote进程，期间进行了native库加载、初始化jni环境、初始化bootclassloader、加载framework等操作，最后jni调用启动zygote。<br>zygote在java层主要做了俩件事：</p>
<ol>
<li>startSystemServer进程，该进程运行SystemServer服务，其启动WMS、PMS、AMS等众多系统服务</li>
<li>进入loop监听socket，听从SystemServer发送的消息进行分裂。</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android系统/" rel="tag"># android系统</a>
          
            <a href="/tags/zygote/" rel="tag"># zygote</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/10/dalvik1/" rel="next" title="dalvik1">
                <i class="fa fa-chevron-left"></i> dalvik1
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/27/android8-0-0源码分析-art的启动/" rel="prev" title="android8-0-0源码分析-art的启动">
                android8-0-0源码分析-art的启动 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/1.png"
               alt="imbaya" />
          <p class="site-author-name" itemprop="name">imbaya</p>
           
              <p class="site-description motion-element" itemprop="description">..........</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">90</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">76</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前提知识"><span class="nav-number">1.</span> <span class="nav-text">前提知识</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统加载"><span class="nav-number">2.</span> <span class="nav-text">系统加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统启动"><span class="nav-number">3.</span> <span class="nav-text">系统启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#android启动zygote"><span class="nav-number">4.</span> <span class="nav-text">android启动zygote</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#app-main-cpp"><span class="nav-number">4.1.</span> <span class="nav-text">app_main.cpp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AppRuntime"><span class="nav-number">4.2.</span> <span class="nav-text">AppRuntime</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZygoteInit"><span class="nav-number">4.3.</span> <span class="nav-text">ZygoteInit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zygoteServer"><span class="nav-number">4.4.</span> <span class="nav-text">zygoteServer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">imbaya</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":100,"height":200,"hOffset":0,"vOffset":-50},"mobile":{"show":false},"react":{"opacityDefault":1,"opacityOnHover":1},"log":false});</script></body>
</html>
