<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android系统,classloader," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="前言本篇开始分析classloader。 参考：https://blog.csdn.net/itachi85/article/details/78088701https://blog.csdn.net/itachi85/article/details/78276837?utm_source=blogxgwz0http://gityuan.com/2017/03/19/android-classlo">
<meta name="keywords" content="android系统,classloader">
<meta property="og:type" content="article">
<meta property="og:title" content="android8-0-0源码分析-classloader1">
<meta property="og:url" content="http://yoursite.com/2018/10/21/android8-0-0源码分析-classloader1/index.html">
<meta property="og:site_name" content="GGWP">
<meta property="og:description" content="前言本篇开始分析classloader。 参考：https://blog.csdn.net/itachi85/article/details/78088701https://blog.csdn.net/itachi85/article/details/78276837?utm_source=blogxgwz0http://gityuan.com/2017/03/19/android-classlo">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.imgur.com/Snnsa4W.jpg">
<meta property="og:image" content="https://i.imgur.com/ua21akv.jpg">
<meta property="og:updated_time" content="2018-10-24T12:01:56.660Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android8-0-0源码分析-classloader1">
<meta name="twitter:description" content="前言本篇开始分析classloader。 参考：https://blog.csdn.net/itachi85/article/details/78088701https://blog.csdn.net/itachi85/article/details/78276837?utm_source=blogxgwz0http://gityuan.com/2017/03/19/android-classlo">
<meta name="twitter:image" content="https://i.imgur.com/Snnsa4W.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/10/21/android8-0-0源码分析-classloader1/"/>





  <title>android8-0-0源码分析-classloader1 | GGWP</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GGWP</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/21/android8-0-0源码分析-classloader1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">android8-0-0源码分析-classloader1</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-21T21:37:54+08:00">
                2018-10-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇开始分析classloader。</p>
<p>参考：<br><a href="https://blog.csdn.net/itachi85/article/details/78088701" target="_blank" rel="external">https://blog.csdn.net/itachi85/article/details/78088701</a><br><a href="https://blog.csdn.net/itachi85/article/details/78276837?utm_source=blogxgwz0" target="_blank" rel="external">https://blog.csdn.net/itachi85/article/details/78276837?utm_source=blogxgwz0</a><br><a href="http://gityuan.com/2017/03/19/android-classloader/" target="_blank" rel="external">http://gityuan.com/2017/03/19/android-classloader/</a><br><a href="https://www.jianshu.com/p/2f9b1d8be88d" target="_blank" rel="external">https://www.jianshu.com/p/2f9b1d8be88d</a><br><a href="https://www.jianshu.com/p/3912c05d257e" target="_blank" rel="external">https://www.jianshu.com/p/3912c05d257e</a><br><a href="https://www.jianshu.com/p/20dcfcf27004" target="_blank" rel="external">https://www.jianshu.com/p/20dcfcf27004</a><br><a href="https://www.jianshu.com/p/b89d0b03e82c" target="_blank" rel="external">https://www.jianshu.com/p/b89d0b03e82c</a><br><a href="http://liwenkun.me/2016/11/11/android-load-class-dynamically/" target="_blank" rel="external">http://liwenkun.me/2016/11/11/android-load-class-dynamically/</a></p>
<h2 id="jvm"><a href="#jvm" class="headerlink" title="jvm"></a>jvm</h2><p>先从java虚拟机的类加载器讲起。以后再补java虚拟机的规范。</p>
<p>java虚拟机的系统加载器有：</p>
<p>Bootstrap ClassLoader（引导类加载器）<br>用C/C++代码实现的加载器，用于加载指定的JDK的核心类库，比如java.lang.、java.uti.等这些系统类。它用来加载以下目录中的类库：<br>$JAVA_HOME/jre/lib目录<br>-Xbootclasspath参数指定的目录<br>Java虚拟机的启动就是通过引导类加载器创建一个初始类来完成的。由于类加载器是使用平台相关的底层C/C++语言实现的， 所以该加载器不能被Java代码访问到。但是我们可以查询某个类是否被引导类加载器加载过。</p>
<p>Extensions ClassLoader（拓展类加载器）<br>用于加载 Java 的拓展类 ，用来提供除了系统类之外的额外功能。它用来加载以下目录中的类库：<br>加载$JAVA_HOME/jre/lib/ext目录<br>系统属性java.ext.dir所指定的目录。</p>
<p>Application ClassLoader（应用程序类加载器）<br>又称作System ClassLoader(系统类加载器)，这是因为这个类加载器可以通过ClassLoader的getSystemClassLoader方法获取到。它用来加载以下目录中的类库：<br>当前应用程序Classpath目录<br>系统属性java.class.path指定的目录</p>
<p>用户自定义加载器，则是通过继承 java.lang.ClassLoader类的方式来实现自己的类加载器。<br>除了 Bootstrap ClassLoader，Extensions ClassLoader和App ClassLoader也继承了java.lang.ClassLoader类。</p>
<p>类加载器查找Class所采用的是双亲委托模式，所谓双亲委托模式就是首先判断该Class是否已经加载，如果没有则不是自身去查找而是委托给父加载器进行查找，这样依次的进行递归，直到委托到最顶层的Bootstrap ClassLoader，如果Bootstrap ClassLoader找到了该Class，就会直接返回，如果没找到，则继续依次向下查找，如果还没找到则最后会交由自身去查找。<br>其父都是创建时存储的。</p>
<p>采取双亲委托模式主要有两点好处： </p>
<ol>
<li>避免重复加载，如果已经加载过一次Class，就不需要再次加载，而是先从缓存中直接读取。 </li>
<li>更加安全，如果不使用双亲委托模式，就可以自定义一个String类来替代系统的String类，这显然会造成安全隐患，采用双亲委托模式会使得系统的String类在Java虚拟机启动时就被加载，也就无法自定义String类来替代系统的String类，除非我们修改 类加载器搜索类的默认算法。还有一点，只有两个类名一致并且被同一个类加载器加载的类，Java虚拟机才会认为它们是同一个类，想要骗过Java虚拟机显然不会那么容易。</li>
</ol>
<a id="more"></a>
<h2 id="android中的classloader"><a href="#android中的classloader" class="headerlink" title="android中的classloader"></a>android中的classloader</h2><p><img src="https://i.imgur.com/Snnsa4W.jpg" alt=""><br>PathClassLoader: 主要用于系统和app的类加载器,其中optimizedDirectory为null, 采用默认目录/data/dalvik-cache/<br>DexClassLoader: 可以从包含classes.dex的jar或者apk中，加载类的类加载器, 可用于执行动态加载,但必须是app私有可写目录来缓存odex文件. 能够加载系统没有安装的apk或者jar文件， 因此很多插件化方案都是采用DexClassLoader;<br>BaseDexClassLoader: 比较基础的类加载器, PathClassLoader和DexClassLoader都只是在构造函数上对其简单封装而已.<br>BootClassLoader: 作为父类的类构造器.</p>
<p>还有几个提供的相关类：</p>
<ol>
<li>ClassLoader是一个抽象类，其中定义了ClassLoader的主要功能。BootClassLoader是它的内部类。</li>
<li>SecureClassLoader类和JDK8中的SecureClassLoader类的代码是一样的，它继承了抽象类ClassLoader。SecureClassLoader并不是ClassLoader的实现类，而是拓展了ClassLoader类加入了权限方面的功能，加强了ClassLoader的安全性。</li>
<li>URLClassLoader类和JDK8中的URLClassLoader类的代码是一样的，它继承自SecureClassLoader，用来通过URl路径从jar文件和文件夹中加载类和资源。</li>
<li>InMemoryDexClassLoader是Android8.0新增的类加载器，继承自BaseDexClassLoader，用于加载内存中的dex文件。</li>
<li>BaseDexClassLoader继承自ClassLoader，是抽象类ClassLoader的具体实现类，PathClassLoader和DexClassLoader都继承它。</li>
</ol>
<h3 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h3><p>ClassLoader：<br>libcore\ojluni\src\main\java\java\lang\ClassLoader.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">public abstract class ClassLoader &#123;</div><div class="line">	</div><div class="line">    protected ClassLoader(ClassLoader parent) &#123;</div><div class="line">        this(checkCreateClassLoader(), parent);</div><div class="line">    &#125;</div><div class="line">	private ClassLoader(Void unused, ClassLoader parent) &#123;</div><div class="line">        this.parent = parent;</div><div class="line">    &#125;</div><div class="line">	protected ClassLoader() &#123;</div><div class="line">        this(checkCreateClassLoader(), getSystemClassLoader());</div><div class="line">    &#125;</div><div class="line">	@CallerSensitive</div><div class="line">    public static ClassLoader getSystemClassLoader() &#123;</div><div class="line">        return SystemClassLoader.loader;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">	</div><div class="line"></div><div class="line"></div><div class="line">    static private class SystemClassLoader &#123;</div><div class="line">        public static ClassLoader loader = ClassLoader.createSystemClassLoader();</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">	</div><div class="line">	private static ClassLoader createSystemClassLoader() &#123;</div><div class="line">		//获取默认的path</div><div class="line">        String classPath = System.getProperty(&quot;java.class.path&quot;, &quot;.&quot;);</div><div class="line">        String librarySearchPath = System.getProperty(&quot;java.library.path&quot;, &quot;&quot;);</div><div class="line">		//构造了一个PathClassLoader，父用BootClassLoader</div><div class="line">        return new PathClassLoader(classPath, librarySearchPath, BootClassLoader.getInstance());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="BootClassLoader"><a href="#BootClassLoader" class="headerlink" title="BootClassLoader"></a>BootClassLoader</h3><p>Android系统启动时会使用BootClassLoader来预加载常用类，与Java中的BootClassLoader不同，它并不是由C/C++代码实现，而是由Java实现的<br>libcore\ojluni\src\main\java\java\lang\ClassLoader.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">class BootClassLoader extends ClassLoader &#123;</div><div class="line"></div><div class="line">    private static BootClassLoader instance;</div><div class="line"></div><div class="line">    @FindBugsSuppressWarnings(&quot;DP_CREATE_CLASSLOADER_INSIDE_DO_PRIVILEGED&quot;)</div><div class="line">    public static synchronized BootClassLoader getInstance() &#123;</div><div class="line">        if (instance == null) &#123;</div><div class="line">            instance = new BootClassLoader();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return instance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public BootClassLoader() &#123;</div><div class="line">        super(null);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123;</div><div class="line">        return Class.classForName(name, false, null);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected URL findResource(String name) &#123;</div><div class="line">        return VMClassLoader.getResource(name);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @SuppressWarnings(&quot;unused&quot;)</div><div class="line">    @Override</div><div class="line">    protected Enumeration&lt;URL&gt; findResources(String resName) throws IOException &#123;</div><div class="line">        return Collections.enumeration(VMClassLoader.getResources(resName));</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected Package getPackage(String name) &#123;</div><div class="line">        if (name != null &amp;&amp; !name.isEmpty()) &#123;</div><div class="line">            synchronized (this) &#123;</div><div class="line">                Package pack = super.getPackage(name);</div><div class="line"></div><div class="line">                if (pack == null) &#123;</div><div class="line">                    pack = definePackage(name, &quot;Unknown&quot;, &quot;0.0&quot;, &quot;Unknown&quot;, &quot;Unknown&quot;, &quot;0.0&quot;,</div><div class="line">                            &quot;Unknown&quot;, null);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                return pack;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public URL getResource(String resName) &#123;</div><div class="line">        return findResource(resName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected Class&lt;?&gt; loadClass(String className, boolean resolve)</div><div class="line">           throws ClassNotFoundException &#123;</div><div class="line">        Class&lt;?&gt; clazz = findLoadedClass(className);</div><div class="line"></div><div class="line">        if (clazz == null) &#123;</div><div class="line">            clazz = findClass(className);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return clazz;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Enumeration&lt;URL&gt; getResources(String resName) throws IOException &#123;</div><div class="line">        return findResources(resName);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>BootClassLoader是ClassLoader的内部类，并继承自ClassLoader。BootClassLoader是一个单例类，需要注意的是BootClassLoader的访问修饰符是默认的，只有在同一个包中才可以访问，因此我们在应用程序中是无法直接调用的。</p>
<h3 id="PathClassLoader"><a href="#PathClassLoader" class="headerlink" title="PathClassLoader"></a>PathClassLoader</h3><p>Android系统使用PathClassLoader来加载系统类和应用程序的类，如果是加载非系统应用程序类，则会加载data/app/目录下的dex文件以及包含dex的apk文件或jar文件.<br>libcore\dalvik\src\main\java\dalvik\system\PathClassLoader.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public class PathClassLoader extends BaseDexClassLoader &#123;</div><div class="line"></div><div class="line">    public PathClassLoader(String dexPath, ClassLoader parent) &#123;</div><div class="line">        super(dexPath, null, null, parent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public PathClassLoader(String dexPath, String librarySearchPath, ClassLoader parent) &#123;</div><div class="line">        super(dexPath, null, librarySearchPath, parent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>dexPath：dex文件以及包含dex的apk文件或jar文件的路径集合，多个路径用文件分隔符分隔，默认文件分隔符为‘：’。<br>librarySearchPath：包含 C/C++ 库的路径集合，多个路径用文件分隔符分隔分割，可以为null。<br>parent：ClassLoader的parent。</p>
<h3 id="DexClassLoader"><a href="#DexClassLoader" class="headerlink" title="DexClassLoader"></a>DexClassLoader</h3><p>DexClassLoader可以加载dex文件以及包含dex的apk文件或jar文件，也支持从SD卡进行加载，这也就意味着DexClassLoader可以在应用未安装的情况下加载dex相关文件。<br>libcore\dalvik\src\main\java\dalvik\system\DexClassLoader.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">public class DexClassLoader extends BaseDexClassLoader &#123;</div><div class="line">    /**</div><div class="line">     * Creates a &#123;@code DexClassLoader&#125; that finds interpreted and native</div><div class="line">     * code.  Interpreted classes are found in a set of DEX files contained</div><div class="line">     * in Jar or APK files.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;The path lists are separated using the character specified by the</div><div class="line">     * &#123;@code path.separator&#125; system property, which defaults to &#123;@code :&#125;.</div><div class="line">     *</div><div class="line">     * @param dexPath the list of jar/apk files containing classes and</div><div class="line">     *     resources, delimited by &#123;@code File.pathSeparator&#125;, which</div><div class="line">     *     defaults to &#123;@code &quot;:&quot;&#125; on Android</div><div class="line">     * @param optimizedDirectory directory where optimized dex files</div><div class="line">     *     should be written; must not be &#123;@code null&#125;</div><div class="line">     * @param librarySearchPath the list of directories containing native</div><div class="line">     *     libraries, delimited by &#123;@code File.pathSeparator&#125;; may be</div><div class="line">     *     &#123;@code null&#125;</div><div class="line">     * @param parent the parent class loader</div><div class="line">     */</div><div class="line">    public DexClassLoader(String dexPath, String optimizedDirectory,</div><div class="line">            String librarySearchPath, ClassLoader parent) &#123;</div><div class="line">        super(dexPath, new File(optimizedDirectory), librarySearchPath, parent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>DexClassLoader构造方法的参数要比PathClassLoader多一个optimizedDirectory参数,该参数表示dex的优化存储odex的路径，PathClassLoader默认路径为/data/dalvik-cache</p>
<h3 id="BaseDexClassLoader"><a href="#BaseDexClassLoader" class="headerlink" title="BaseDexClassLoader"></a>BaseDexClassLoader</h3><p>BaseDexClassLoader<br>libcore\dalvik\src\main\java\dalvik\system\BaseDexClassLoader.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * Base class for common functionality between various dex-based</div><div class="line"> * &#123;@link ClassLoader&#125; implementations.</div><div class="line"> */</div><div class="line">public class BaseDexClassLoader extends ClassLoader &#123;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Hook for customizing how dex files loads are reported.</div><div class="line">     *</div><div class="line">     * This enables the framework to monitor the use of dex files. The</div><div class="line">     * goal is to simplify the mechanism for optimizing foreign dex files and</div><div class="line">     * enable further optimizations of secondary dex files.</div><div class="line">     *</div><div class="line">     * The reporting happens only when new instances of BaseDexClassLoader</div><div class="line">     * are constructed and will be active only after this field is set with</div><div class="line">     * &#123;@link BaseDexClassLoader#setReporter&#125;.</div><div class="line">     */</div><div class="line">    /* @NonNull */ private static volatile Reporter reporter = null;</div><div class="line"></div><div class="line">    private final DexPathList pathList;</div><div class="line"></div><div class="line">	//optimizedDirectory已经弃用</div><div class="line">    public BaseDexClassLoader(String dexPath, File optimizedDirectory,</div><div class="line">            String librarySearchPath, ClassLoader parent) &#123;</div><div class="line">        super(parent);</div><div class="line">        this.pathList = new DexPathList(this, dexPath, librarySearchPath, null);</div><div class="line"></div><div class="line">        if (reporter != null) &#123;</div><div class="line">            reporter.report(this.pathList.getDexPaths());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    public BaseDexClassLoader(ByteBuffer[] dexFiles, ClassLoader parent) &#123;</div><div class="line">        // TODO We should support giving this a library search path maybe.</div><div class="line">        super(parent);</div><div class="line">        this.pathList = new DexPathList(this, dexFiles);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>path生成pathList，pathList是每次BaseDexClassLoader创建都会创建。代表加载的所有文件与目录</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p><img src="https://i.imgur.com/ua21akv.jpg" alt=""></p>
<h3 id="2-DexPathList"><a href="#2-DexPathList" class="headerlink" title="2-DexPathList"></a>2-DexPathList</h3><p>DexPathList<br>libcore\dalvik\src\main\java\dalvik\system\DexPathList.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line">    /**</div><div class="line">     * List of dex/resource (class path) elements.</div><div class="line">     * Should be called pathElements, but the Facebook app uses reflection</div><div class="line">     * to modify &apos;dexElements&apos; (http://b/7726934).</div><div class="line">     */</div><div class="line">    private Element[] dexElements;</div><div class="line">    /** class definition context */</div><div class="line">    private final ClassLoader definingContext;</div><div class="line">    /** List of native library path elements. */</div><div class="line">    private final NativeLibraryElement[] nativeLibraryPathElements;</div><div class="line">    /**</div><div class="line">     * Constructs an instance.</div><div class="line">     *</div><div class="line">     * @param definingContext the context in which any as-yet unresolved</div><div class="line">     * classes should be defined</div><div class="line">     * @param dexPath list of dex/resource path elements, separated by</div><div class="line">     * &#123;@code File.pathSeparator&#125;</div><div class="line">     * @param librarySearchPath list of native library directory path elements,</div><div class="line">     * separated by &#123;@code File.pathSeparator&#125;</div><div class="line">     * @param optimizedDirectory directory where optimized &#123;@code .dex&#125; files</div><div class="line">     * should be found and written to, or &#123;@code null&#125; to use the default</div><div class="line">     * system directory for same</div><div class="line">     */</div><div class="line">	 //optimizedDirectory为null</div><div class="line">    public DexPathList(ClassLoader definingContext, String dexPath,</div><div class="line">            String librarySearchPath, File optimizedDirectory) &#123;</div><div class="line"></div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">        this.definingContext = definingContext;</div><div class="line"></div><div class="line">        ArrayList&lt;IOException&gt; suppressedExceptions = new ArrayList&lt;IOException&gt;();</div><div class="line">        // save dexPath for BaseDexClassLoader</div><div class="line">		////记录所有的dexFile文件</div><div class="line">        this.dexElements = makeDexElements(splitDexPath(dexPath), optimizedDirectory,</div><div class="line">                                           suppressedExceptions, definingContext);</div><div class="line"></div><div class="line">        // Native libraries may exist in both the system and</div><div class="line">        // application library paths, and we use this search order:</div><div class="line">        //</div><div class="line">        //   1. This class loader&apos;s library path for application libraries (librarySearchPath):</div><div class="line">        //   1.1. Native library directories</div><div class="line">        //   1.2. Path to libraries in apk-files</div><div class="line">        //   2. The VM&apos;s library path from the system property for system libraries</div><div class="line">        //      also known as java.library.path</div><div class="line">        //</div><div class="line">        // This order was reversed prior to Gingerbread; see http://b/2933456.</div><div class="line">		//app目录的native库</div><div class="line">        this.nativeLibraryDirectories = splitPaths(librarySearchPath, false);</div><div class="line">		////系统目录的native库</div><div class="line">        this.systemNativeLibraryDirectories =</div><div class="line">                splitPaths(System.getProperty(&quot;java.library.path&quot;), true);</div><div class="line">        List&lt;File&gt; allNativeLibraryDirectories = new ArrayList&lt;&gt;(nativeLibraryDirectories);</div><div class="line">        allNativeLibraryDirectories.addAll(systemNativeLibraryDirectories);</div><div class="line">		//记录所有的Native动态库</div><div class="line">        this.nativeLibraryPathElements = makePathElements(allNativeLibraryDirectories);</div><div class="line"></div><div class="line">        if (suppressedExceptions.size() &gt; 0) &#123;</div><div class="line">            this.dexElementsSuppressedExceptions =</div><div class="line">                suppressedExceptions.toArray(new IOException[suppressedExceptions.size()]);</div><div class="line">        &#125; else &#123;</div><div class="line">            dexElementsSuppressedExceptions = null;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	</div><div class="line">	public DexPathList(ClassLoader definingContext, ByteBuffer[] dexFiles) &#123;</div><div class="line">        if (definingContext == null) &#123;</div><div class="line">            throw new NullPointerException(&quot;definingContext == null&quot;);</div><div class="line">        &#125;</div><div class="line">        if (dexFiles == null) &#123;</div><div class="line">            throw new NullPointerException(&quot;dexFiles == null&quot;);</div><div class="line">        &#125;</div><div class="line">        if (Arrays.stream(dexFiles).anyMatch(v -&gt; v == null)) &#123;</div><div class="line">            throw new NullPointerException(&quot;dexFiles contains a null Buffer!&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        this.definingContext = definingContext;</div><div class="line">        // TODO It might be useful to let in-memory dex-paths have native libraries.</div><div class="line">        this.nativeLibraryDirectories = Collections.emptyList();</div><div class="line">        this.systemNativeLibraryDirectories =</div><div class="line">                splitPaths(System.getProperty(&quot;java.library.path&quot;), true);</div><div class="line">        this.nativeLibraryPathElements = makePathElements(this.systemNativeLibraryDirectories);</div><div class="line"></div><div class="line">        ArrayList&lt;IOException&gt; suppressedExceptions = new ArrayList&lt;IOException&gt;();</div><div class="line">        this.dexElements = makeInMemoryDexElements(dexFiles, suppressedExceptions);</div><div class="line">        if (suppressedExceptions.size() &gt; 0) &#123;</div><div class="line">            this.dexElementsSuppressedExceptions =</div><div class="line">                    suppressedExceptions.toArray(new IOException[suppressedExceptions.size()]);</div><div class="line">        &#125; else &#123;</div><div class="line">            dexElementsSuppressedExceptions = null;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>收集：<br>dexElements: 记录所有的dexFile文件/目录<br>nativeLibraryPathElements: 记录所有的Native动态库, 包括app目录的native库和系统目录的native库</p>
<p>有一个问题，什么时候从apk、jar中解压的？DexClassLoader的说明中说了可以是压缩包的，虽然我试的时候失败了</p>
<h3 id="3-makeDexElements"><a href="#3-makeDexElements" class="headerlink" title="3-makeDexElements"></a>3-makeDexElements</h3><p>makeDexElements<br>libcore\dalvik\src\main\java\dalvik\system\DexPathList.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">   /**</div><div class="line">    * Makes an array of dex/resource path elements, one per element of</div><div class="line">    * the given array.</div><div class="line">    */</div><div class="line">   private static Element[] makeDexElements(List&lt;File&gt; files, File optimizedDirectory,</div><div class="line">           List&lt;IOException&gt; suppressedExceptions, ClassLoader loader) &#123;</div><div class="line">     Element[] elements = new Element[files.size()];</div><div class="line">     int elementsPos = 0;</div><div class="line">     /*</div><div class="line">      * Open all files and load the (direct or contained) dex files up front.</div><div class="line">      */</div><div class="line">     for (File file : files) &#123;</div><div class="line">         if (file.isDirectory()) &#123;</div><div class="line">             // We support directories for looking up resources. Looking up resources in</div><div class="line">             // directories is useful for running libcore tests.</div><div class="line">             elements[elementsPos++] = new Element(file);</div><div class="line">         &#125; else if (file.isFile()) &#123;</div><div class="line">             String name = file.getName();</div><div class="line"></div><div class="line">             if (name.endsWith(DEX_SUFFIX)) &#123;//.dex</div><div class="line">                 // Raw dex file (not inside a zip/jar). </div><div class="line">			  //这句注释的意思可能是返回的dex是从zip取到内存中的</div><div class="line">                 try &#123;</div><div class="line">                     DexFile dex = loadDexFile(file, optimizedDirectory, loader, elements);</div><div class="line">                     if (dex != null) &#123;</div><div class="line">                         elements[elementsPos++] = new Element(dex, null);</div><div class="line">                     &#125;</div><div class="line">                 &#125; catch (IOException suppressed) &#123;</div><div class="line">                     System.logE(&quot;Unable to load dex file: &quot; + file, suppressed);</div><div class="line">                     suppressedExceptions.add(suppressed);</div><div class="line">                 &#125;</div><div class="line">             &#125; else &#123;//不是以.dex结尾</div><div class="line">                 DexFile dex = null;</div><div class="line">                 try &#123;</div><div class="line">                     dex = loadDexFile(file, optimizedDirectory, loader, elements);</div><div class="line">                 &#125; catch (IOException suppressed) &#123;</div><div class="line">                     /*</div><div class="line">                      * IOException might get thrown &quot;legitimately&quot; by the DexFile constructor if</div><div class="line">                      * the zip file turns out to be resource-only (that is, no classes.dex file</div><div class="line">                      * in it).</div><div class="line">                      * Let dex == null and hang on to the exception to add to the tea-leaves for</div><div class="line">                      * when findClass returns null.</div><div class="line">                      */</div><div class="line">                     suppressedExceptions.add(suppressed);</div><div class="line">                 &#125;</div><div class="line"></div><div class="line">                 if (dex == null) &#123;</div><div class="line">                     elements[elementsPos++] = new Element(file);</div><div class="line">                 &#125; else &#123;</div><div class="line">                     elements[elementsPos++] = new Element(dex, file);</div><div class="line">                 &#125;</div><div class="line">             &#125;</div><div class="line">         &#125; else &#123;</div><div class="line">             System.logW(&quot;ClassLoader referenced unknown path: &quot; + file);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">     if (elementsPos != elements.length) &#123;</div><div class="line">         elements = Arrays.copyOf(elements, elementsPos);</div><div class="line">     &#125;</div><div class="line">     return elements;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">   /**</div><div class="line">    * Element of the dex/resource path. Note: should be called DexElement, but apps reflect on</div><div class="line">    * this.</div><div class="line">    */</div><div class="line">   /*package*/ static class Element &#123;</div><div class="line">       /**</div><div class="line">        * A file denoting a zip file (in case of a resource jar or a dex jar), or a directory</div><div class="line">        * (only when dexFile is null).</div><div class="line">        */</div><div class="line">       private final File path;</div><div class="line"></div><div class="line">       private final DexFile dexFile;</div><div class="line"></div><div class="line">       private ClassPathURLStreamHandler urlHandler;</div><div class="line">       private boolean initialized;</div><div class="line"></div><div class="line">       /**</div><div class="line">        * Element encapsulates a dex file. This may be a plain dex file (in which case dexZipPath</div><div class="line">        * should be null), or a jar (in which case dexZipPath should denote the zip file).</div><div class="line">        */</div><div class="line">       public Element(DexFile dexFile, File dexZipPath) &#123;</div><div class="line">           this.dexFile = dexFile;</div><div class="line">           this.path = dexZipPath;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       public Element(DexFile dexFile) &#123;</div><div class="line">           this.dexFile = dexFile;</div><div class="line">           this.path = null;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       public Element(File path) &#123;</div><div class="line">         this.path = path;</div><div class="line">         this.dexFile = null;</div><div class="line">       &#125;	</div><div class="line">.......</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Element对象表示目录或着DexFile对象。makeDexElements通过解析传过来的目录列表将其下对象挨个纳入Element，对于文件调用loadDexFile加载成内存DexFile对象。<br>值得注意的是是不是.dex结尾都会调用loadDexFile。</p>
<h3 id="4-loadDexFile"><a href="#4-loadDexFile" class="headerlink" title="4-loadDexFile"></a>4-loadDexFile</h3><p>loadDexFile<br>libcore\dalvik\src\main\java\dalvik\system\DexPathList.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//optimizedDirectory为null</div><div class="line">    private static DexFile loadDexFile(File file, File optimizedDirectory, ClassLoader loader,</div><div class="line">                                       Element[] elements)</div><div class="line">            throws IOException &#123;</div><div class="line">        if (optimizedDirectory == null) &#123;</div><div class="line">            return new DexFile(file, loader, elements);</div><div class="line">        &#125; else &#123;</div><div class="line">            String optimizedPath = optimizedPathFor(file, optimizedDirectory);</div><div class="line">            return DexFile.loadDex(file.getPath(), optimizedPath, 0, loader, elements);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>构建DexFile返回</p>
<h3 id="5-DexFile"><a href="#5-DexFile" class="headerlink" title="5-DexFile"></a>5-DexFile</h3><p>DexFile<br>libcore\dalvik\src\main\java\dalvik\system\DexFile.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"> /**</div><div class="line">  * If close is called, mCookie becomes null but the internal cookie is preserved if the close</div><div class="line">  * failed so that we can free resources in the finalizer.</div><div class="line">  */</div><div class="line">   private Object mCookie;</div><div class="line">   private Object mInternalCookie;</div><div class="line">   private final String mFileName;</div><div class="line">   /*</div><div class="line">    * Private version with class loader argument.</div><div class="line">    *</div><div class="line">    * @param file</div><div class="line">    *            the File object referencing the actual DEX file</div><div class="line">    * @param loader</div><div class="line">    *            the class loader object creating the DEX file object</div><div class="line">    * @param elements</div><div class="line">    *            the temporary dex path list elements from DexPathList.makeElements</div><div class="line">    */</div><div class="line">   DexFile(File file, ClassLoader loader, DexPathList.Element[] elements)</div><div class="line">           throws IOException &#123;</div><div class="line">       this(file.getPath(), loader, elements);</div><div class="line">   &#125;</div><div class="line">/*</div><div class="line">    * Private version with class loader argument.</div><div class="line">    *</div><div class="line">    * @param fileName</div><div class="line">    *            the filename of the DEX file</div><div class="line">    * @param loader</div><div class="line">    *            the class loader creating the DEX file object</div><div class="line">    * @param elements</div><div class="line">    *            the temporary dex path list elements from DexPathList.makeElements</div><div class="line">    */</div><div class="line">   DexFile(String fileName, ClassLoader loader, DexPathList.Element[] elements) throws IOException &#123;</div><div class="line">       mCookie = openDexFile(fileName, null, 0, loader, elements);</div><div class="line">       mInternalCookie = mCookie;</div><div class="line">       mFileName = fileName;</div><div class="line">       //System.out.println(&quot;DEX FILE cookie is &quot; + mCookie + &quot; fileName=&quot; + fileName);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">/*</div><div class="line">    * Open a DEX file.  The value returned is a magic VM cookie.  On</div><div class="line">    * failure, an IOException is thrown.</div><div class="line">    */</div><div class="line">   private static Object openDexFile(String sourceName, String outputName, int flags,</div><div class="line">           ClassLoader loader, DexPathList.Element[] elements) throws IOException &#123;</div><div class="line">       // Use absolute paths to enable the use of relative paths when testing on host.</div><div class="line">       return openDexFileNative(new File(sourceName).getAbsolutePath(),</div><div class="line">                                (outputName == null)</div><div class="line">                                    ? null</div><div class="line">                                    : new File(outputName).getAbsolutePath(),</div><div class="line">                                flags,</div><div class="line">                                loader,</div><div class="line">                                elements);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>可见DexFile代表的就是一个dex文件加载到内存中。参数：</p>
<ol>
<li>dex文件的绝对路径</li>
<li>outputName：null  </li>
<li>flags：0</li>
<li>ClassLoader就是加载器this</li>
<li>DexPathList.Element[]要创建的文件/目录节点数组</li>
</ol>
<h3 id="7-openDexFileNative"><a href="#7-openDexFileNative" class="headerlink" title="7-openDexFileNative"></a>7-openDexFileNative</h3><p>我们还是跟进native接着看<br>openDexFileNative<br>D:\androidwsp\android8.0.0_r1\android-8.0.0_r1\art\runtime\native\dalvik_system_DexFile.cc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">// TODO(calin): clean up the unused parameters (here and in libcore).</div><div class="line">//ATTRIBUTE_UNUSED：属性不使用</div><div class="line">static jobject DexFile_openDexFileNative(JNIEnv* env,</div><div class="line">                                         jclass,</div><div class="line">                                         jstring javaSourceName,</div><div class="line">                                         jstring javaOutputName ATTRIBUTE_UNUSED,</div><div class="line">                                         jint flags ATTRIBUTE_UNUSED,</div><div class="line">                                         jobject class_loader,</div><div class="line">                                         jobjectArray dex_elements) &#123;</div><div class="line">  ScopedUtfChars sourceName(env, javaSourceName);//名字转化类</div><div class="line">  if (sourceName.c_str() == nullptr) &#123;</div><div class="line">    return 0;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  Runtime* const runtime = Runtime::Current();</div><div class="line">  ClassLinker* linker = runtime-&gt;GetClassLinker();</div><div class="line">  std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt; dex_files;</div><div class="line">  std::vector&lt;std::string&gt; error_msgs;</div><div class="line">  const OatFile* oat_file = nullptr;</div><div class="line"></div><div class="line">  dex_files = runtime-&gt;GetOatFileManager().OpenDexFilesFromOat(sourceName.c_str(),</div><div class="line">                                                               class_loader,</div><div class="line">                                                               dex_elements,</div><div class="line">                                                               /*out*/ &amp;oat_file,</div><div class="line">                                                               /*out*/ &amp;error_msgs);</div><div class="line"></div><div class="line">	//这里不空，所以执行</div><div class="line">  if (!dex_files.empty()) &#123;</div><div class="line">	  //将dex_files/oat_file转成jlongArray返回</div><div class="line">    jlongArray array = ConvertDexFilesToJavaArray(env, oat_file, dex_files); </div><div class="line">    if (array == nullptr) &#123;</div><div class="line">      ScopedObjectAccess soa(env);</div><div class="line">      for (auto&amp; dex_file : dex_files) &#123;</div><div class="line">        if (linker-&gt;IsDexFileRegistered(soa.Self(), *dex_file)) &#123;</div><div class="line">          dex_file.release();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    return array;</div><div class="line">  &#125; else &#123;</div><div class="line">    ScopedObjectAccess soa(env);</div><div class="line">    CHECK(!error_msgs.empty());</div><div class="line">    // The most important message is at the end. So set up nesting by going forward, which will</div><div class="line">    // wrap the existing exception as a cause for the following one.</div><div class="line">    auto it = error_msgs.begin();</div><div class="line">    auto itEnd = error_msgs.end();</div><div class="line">    for ( ; it != itEnd; ++it) &#123;</div><div class="line">      ThrowWrappedIOException(&quot;%s&quot;, it-&gt;c_str());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return nullptr;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>参：</p>
<ol>
<li>文件名的c字串模式</li>
<li>jobject的class_loader</li>
<li>jobjectArray的dex_elements</li>
<li>出：OatFile指针</li>
<li>字串向量error_msgs</li>
</ol>
<h3 id="10-ConvertDexFilesToJavaArray"><a href="#10-ConvertDexFilesToJavaArray" class="headerlink" title="10-ConvertDexFilesToJavaArray"></a>10-ConvertDexFilesToJavaArray</h3><p>ConvertDexFilesToJavaArray<br>返回给mCookie，oat与dex结构如何转化的：<br>art\runtime\native\dalvik_system_DexFile.cc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">static jlongArray ConvertDexFilesToJavaArray(JNIEnv* env,</div><div class="line">                                             const OatFile* oat_file,</div><div class="line">                                             std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt;&amp; vec) &#123;</div><div class="line">  // Add one for the oat file.</div><div class="line">  jlongArray long_array = env-&gt;NewLongArray(static_cast&lt;jsize&gt;(kDexFileIndexStart + vec.size()));</div><div class="line">  if (env-&gt;ExceptionCheck() == JNI_TRUE) &#123;</div><div class="line">    return nullptr;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  jboolean is_long_data_copied;</div><div class="line">  jlong* long_data = env-&gt;GetLongArrayElements(long_array, &amp;is_long_data_copied);</div><div class="line">  if (env-&gt;ExceptionCheck() == JNI_TRUE) &#123;</div><div class="line">    return nullptr;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  long_data[kOatFileIndex] = reinterpret_cast&lt;uintptr_t&gt;(oat_file);</div><div class="line">  for (size_t i = 0; i &lt; vec.size(); ++i) &#123;</div><div class="line">    long_data[kDexFileIndexStart + i] = reinterpret_cast&lt;uintptr_t&gt;(vec[i].get());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  env-&gt;ReleaseLongArrayElements(long_array, long_data, 0);</div><div class="line">  if (env-&gt;ExceptionCheck() == JNI_TRUE) &#123;</div><div class="line">    return nullptr;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Now release all the unique_ptrs.</div><div class="line">  for (auto&amp; dex_file : vec) &#123;</div><div class="line">    dex_file.release();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  return long_array;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="8-OpenDexFilesFromOat"><a href="#8-OpenDexFilesFromOat" class="headerlink" title="8-OpenDexFilesFromOat"></a>8-OpenDexFilesFromOat</h3><p>OpenDexFilesFromOat<br>art\runtime\oat_file_manager.cc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt; OatFileManager::OpenDexFilesFromOat(</div><div class="line">    const char* dex_location,</div><div class="line">    jobject class_loader,</div><div class="line">    jobjectArray dex_elements,</div><div class="line">    const OatFile** out_oat_file,</div><div class="line">    std::vector&lt;std::string&gt;* error_msgs) &#123;</div><div class="line">  ScopedTrace trace(__FUNCTION__);</div><div class="line">  CHECK(dex_location != nullptr);</div><div class="line">  CHECK(error_msgs != nullptr);</div><div class="line"></div><div class="line">  // Verify we aren&apos;t holding the mutator lock, which could starve GC if we</div><div class="line">  // have to generate or relocate an oat file.</div><div class="line">  Thread* const self = Thread::Current();</div><div class="line">  Locks::mutator_lock_-&gt;AssertNotHeld(self);</div><div class="line">  Runtime* const runtime = Runtime::Current();</div><div class="line"> //初始化oat_file_assistant</div><div class="line">  OatFileAssistant oat_file_assistant(dex_location,</div><div class="line">                                      kRuntimeISA,</div><div class="line">                                      !runtime-&gt;IsAotCompiler());</div><div class="line"></div><div class="line">  // Lock the target oat location to avoid races generating and loading the</div><div class="line">  // oat file.</div><div class="line">  std::string error_msg;</div><div class="line">  if (!oat_file_assistant.Lock(/*out*/&amp;error_msg)) &#123;</div><div class="line">    // Don&apos;t worry too much if this fails. If it does fail, it&apos;s unlikely we</div><div class="line">    // can generate an oat file anyway.</div><div class="line">    VLOG(class_linker) &lt;&lt; &quot;OatFileAssistant::Lock: &quot; &lt;&lt; error_msg;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  const OatFile* source_oat_file = nullptr;</div><div class="line"></div><div class="line">  </div><div class="line">  //dex文件是否已经oat化</div><div class="line">  if (!oat_file_assistant.IsUpToDate()) &#123;</div><div class="line">    // Update the oat file on disk if we can, based on the --compiler-filter</div><div class="line">    // option derived from the current runtime options.</div><div class="line">    // This may fail, but that&apos;s okay. Best effort is all that matters here.</div><div class="line">	//MakeUpToDate执行了dex文件的优化工作，即利用dex文件生成oat文件</div><div class="line">    switch (oat_file_assistant.MakeUpToDate(/*profile_changed*/false, /*out*/ &amp;error_msg)) &#123;</div><div class="line">      case OatFileAssistant::kUpdateFailed:</div><div class="line">        LOG(WARNING) &lt;&lt; error_msg;</div><div class="line">        break;</div><div class="line"></div><div class="line">      case OatFileAssistant::kUpdateNotAttempted:</div><div class="line">        // Avoid spamming the logs if we decided not to attempt making the oat</div><div class="line">        // file up to date.</div><div class="line">        VLOG(oat) &lt;&lt; error_msg;</div><div class="line">        break;</div><div class="line"></div><div class="line">      case OatFileAssistant::kUpdateSucceeded:</div><div class="line">        // Nothing to do.</div><div class="line">        break;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Get the oat file on disk.</div><div class="line">  //从磁盘获取oat文件，返回</div><div class="line">  //oat_file_assistant.GetBestOatFile().release() 获取oat对象</div><div class="line">  std::unique_ptr&lt;const OatFile&gt; oat_file(oat_file_assistant.GetBestOatFile().release());</div><div class="line"></div><div class="line">  if (oat_file != nullptr) &#123;</div><div class="line">    // Take the file only if it has no collisions, or we must take it because of preopting.</div><div class="line">    bool accept_oat_file =</div><div class="line">        !HasCollisions(oat_file.get(), class_loader, dex_elements, /*out*/ &amp;error_msg);</div><div class="line">    if (!accept_oat_file) &#123;</div><div class="line">      // Failed the collision check. Print warning.</div><div class="line">      if (Runtime::Current()-&gt;IsDexFileFallbackEnabled()) &#123;</div><div class="line">        if (!oat_file_assistant.HasOriginalDexFiles()) &#123;</div><div class="line">          // We need to fallback but don&apos;t have original dex files. We have to</div><div class="line">          // fallback to opening the existing oat file. This is potentially</div><div class="line">          // unsafe so we warn about it.</div><div class="line">          accept_oat_file = true;</div><div class="line"></div><div class="line">          LOG(WARNING) &lt;&lt; &quot;Dex location &quot; &lt;&lt; dex_location &lt;&lt; &quot; does not seem to include dex file. &quot;</div><div class="line">                       &lt;&lt; &quot;Allow oat file use. This is potentially dangerous.&quot;;</div><div class="line">        &#125; else &#123;</div><div class="line">          // We have to fallback and found original dex files - extract them from an APK.</div><div class="line">          // Also warn about this operation because it&apos;s potentially wasteful.</div><div class="line">          LOG(WARNING) &lt;&lt; &quot;Found duplicate classes, falling back to extracting from APK : &quot;</div><div class="line">                       &lt;&lt; dex_location;</div><div class="line">          LOG(WARNING) &lt;&lt; &quot;NOTE: This wastes RAM and hurts startup performance.&quot;;</div><div class="line">        &#125;</div><div class="line">      &#125; else &#123;</div><div class="line">        // TODO: We should remove this. The fact that we&apos;re here implies -Xno-dex-file-fallback</div><div class="line">        // was set, which means that we should never fallback. If we don&apos;t have original dex</div><div class="line">        // files, we should just fail resolution as the flag intended.</div><div class="line">        if (!oat_file_assistant.HasOriginalDexFiles()) &#123;</div><div class="line">          accept_oat_file = true;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        LOG(WARNING) &lt;&lt; &quot;Found duplicate classes, dex-file-fallback disabled, will be failing to &quot;</div><div class="line">                        &quot; load classes for &quot; &lt;&lt; dex_location;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      LOG(WARNING) &lt;&lt; error_msg;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (accept_oat_file) &#123;</div><div class="line">      VLOG(class_linker) &lt;&lt; &quot;Registering &quot; &lt;&lt; oat_file-&gt;GetLocation();</div><div class="line">      source_oat_file = RegisterOatFile(std::move(oat_file));</div><div class="line">	  //出oatfile</div><div class="line">      *out_oat_file = source_oat_file;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt; dex_files;</div><div class="line"></div><div class="line">  // Load the dex files from the oat file.</div><div class="line">  //从oat文件中加载dex文件，返回</div><div class="line">  if (source_oat_file != nullptr) &#123;</div><div class="line">    bool added_image_space = false;</div><div class="line">    if (source_oat_file-&gt;IsExecutable()) &#123;</div><div class="line">      std::unique_ptr&lt;gc::space::ImageSpace&gt; image_space =</div><div class="line">          kEnableAppImage ? oat_file_assistant.OpenImageSpace(source_oat_file) : nullptr;</div><div class="line">      if (image_space != nullptr) &#123;</div><div class="line">        ScopedObjectAccess soa(self);</div><div class="line">        StackHandleScope&lt;1&gt; hs(self);</div><div class="line">        Handle&lt;mirror::ClassLoader&gt; h_loader(</div><div class="line">            hs.NewHandle(soa.Decode&lt;mirror::ClassLoader&gt;(class_loader)));</div><div class="line">        // Can not load app image without class loader.</div><div class="line">        if (h_loader != nullptr) &#123;</div><div class="line">          std::string temp_error_msg;</div><div class="line">          // Add image space has a race condition since other threads could be reading from the</div><div class="line">          // spaces array.</div><div class="line">          &#123;</div><div class="line">            ScopedThreadSuspension sts(self, kSuspended);</div><div class="line">            gc::ScopedGCCriticalSection gcs(self,</div><div class="line">                                            gc::kGcCauseAddRemoveAppImageSpace,</div><div class="line">                                            gc::kCollectorTypeAddRemoveAppImageSpace);</div><div class="line">            ScopedSuspendAll ssa(&quot;Add image space&quot;);</div><div class="line">            runtime-&gt;GetHeap()-&gt;AddSpace(image_space.get());</div><div class="line">          &#125;</div><div class="line">          &#123;</div><div class="line">            ScopedTrace trace2(StringPrintf(&quot;Adding image space for location %s&quot;, dex_location));</div><div class="line">            added_image_space = runtime-&gt;GetClassLinker()-&gt;AddImageSpace(image_space.get(),</div><div class="line">                                                                         h_loader,</div><div class="line">                                                                         dex_elements,</div><div class="line">                                                                         dex_location,</div><div class="line">                                                                         /*out*/&amp;dex_files,</div><div class="line">                                                                         /*out*/&amp;temp_error_msg);</div><div class="line">          &#125;</div><div class="line">          if (added_image_space) &#123;</div><div class="line">            // Successfully added image space to heap, release the map so that it does not get</div><div class="line">            // freed.</div><div class="line">            image_space.release();</div><div class="line">          &#125; else &#123;</div><div class="line">            LOG(INFO) &lt;&lt; &quot;Failed to add image file &quot; &lt;&lt; temp_error_msg;</div><div class="line">            dex_files.clear();</div><div class="line">            &#123;</div><div class="line">              ScopedThreadSuspension sts(self, kSuspended);</div><div class="line">              gc::ScopedGCCriticalSection gcs(self,</div><div class="line">                                              gc::kGcCauseAddRemoveAppImageSpace,</div><div class="line">                                              gc::kCollectorTypeAddRemoveAppImageSpace);</div><div class="line">              ScopedSuspendAll ssa(&quot;Remove image space&quot;);</div><div class="line">              runtime-&gt;GetHeap()-&gt;RemoveSpace(image_space.get());</div><div class="line">            &#125;</div><div class="line">            // Non-fatal, don&apos;t update error_msg.</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    if (!added_image_space) &#123;</div><div class="line">      DCHECK(dex_files.empty());</div><div class="line">      dex_files = oat_file_assistant.LoadDexFiles(*source_oat_file, dex_location);</div><div class="line">    &#125;</div><div class="line">    if (dex_files.empty()) &#123;</div><div class="line">      error_msgs-&gt;push_back(&quot;Failed to open dex files from &quot; + source_oat_file-&gt;GetLocation());</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Fall back to running out of the original dex file if we couldn&apos;t load any</div><div class="line">  // dex_files from the oat file.</div><div class="line">  //如果oat文件生成失败会返回原始的dex文件</div><div class="line">  if (dex_files.empty()) &#123;</div><div class="line">    if (oat_file_assistant.HasOriginalDexFiles()) &#123;</div><div class="line">      if (Runtime::Current()-&gt;IsDexFileFallbackEnabled()) &#123;</div><div class="line">        static constexpr bool kVerifyChecksum = true;</div><div class="line">        if (!DexFile::Open(</div><div class="line">            dex_location, dex_location, kVerifyChecksum, /*out*/ &amp;error_msg, &amp;dex_files)) &#123;</div><div class="line">          LOG(WARNING) &lt;&lt; error_msg;</div><div class="line">          error_msgs-&gt;push_back(&quot;Failed to open dex files from &quot; + std::string(dex_location)</div><div class="line">                                + &quot; because: &quot; + error_msg);</div><div class="line">        &#125;</div><div class="line">      &#125; else &#123;</div><div class="line">        error_msgs-&gt;push_back(&quot;Fallback mode disabled, skipping dex files.&quot;);</div><div class="line">      &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">      error_msgs-&gt;push_back(&quot;No original dex files found for dex location &quot;</div><div class="line">          + std::string(dex_location));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  return dex_files;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将dex_location生成OatFileAssistant(助手)，查看是否为oat文件，决定dex到oat文件的优化，之后从磁盘中读取oat到内存，从oat中读取dex，并返回oat与dex。<br>值的注意的是如果hook了execv函数阻止oat文件的生成，最终会调用DexFile::Open方法来直接加载原始的DEX文件。</p>
<h3 id="9-OatFileAssistant"><a href="#9-OatFileAssistant" class="headerlink" title="9-OatFileAssistant"></a>9-OatFileAssistant</h3><p>OatFileAssistant<br>art\runtime\oat_file_assistant.cc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">OatFileAssistant::OatFileAssistant(const char* dex_location,</div><div class="line">                                   const InstructionSet isa,</div><div class="line">                                   bool load_executable)</div><div class="line">    : isa_(isa),</div><div class="line">      load_executable_(load_executable),</div><div class="line">      odex_(this, /*is_oat_location*/ false),</div><div class="line">      oat_(this, /*is_oat_location*/ true) &#123;</div><div class="line">  CHECK(dex_location != nullptr) &lt;&lt; &quot;OatFileAssistant: null dex location&quot;;</div><div class="line"></div><div class="line">  // Try to get the realpath for the dex location.</div><div class="line">  //</div><div class="line">  // This is OK with respect to dalvik cache naming scheme because we never</div><div class="line">  // generate oat files starting from symlinks which go into dalvik cache.</div><div class="line">  // (recall that the oat files in dalvik cache are encoded by replacing &apos;/&apos;</div><div class="line">  // with &apos;@&apos; in the path).</div><div class="line">  // The boot image oat files (which are symlinked in dalvik-cache) are not</div><div class="line">  // loaded via the oat file assistant.</div><div class="line">  //</div><div class="line">  // The only case when the dex location may resolve to a different path</div><div class="line">  // is for secondary dex files (e.g. /data/user/0 symlinks to /data/data and</div><div class="line">  // the app is free to create its own internal layout). Related to this it is</div><div class="line">  // worthwhile to mention that installd resolves the secondary dex location</div><div class="line">  // before calling dex2oat.</div><div class="line">  UniqueCPtr&lt;const char[]&gt; dex_location_real(realpath(dex_location, nullptr));</div><div class="line">  if (dex_location_real != nullptr) &#123;</div><div class="line">	  //获取dex的位置</div><div class="line">    dex_location_.assign(dex_location_real.get());</div><div class="line">  &#125; else &#123;</div><div class="line">    // If we can&apos;t get the realpath of the location there&apos;s not much point in trying to move on.</div><div class="line">    PLOG(ERROR) &lt;&lt; &quot;Could not get the realpath of dex_location &quot; &lt;&lt; dex_location;</div><div class="line">    return;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (load_executable_ &amp;&amp; isa != kRuntimeISA) &#123;</div><div class="line">    LOG(WARNING) &lt;&lt; &quot;OatFileAssistant: Load executable specified, &quot;</div><div class="line">      &lt;&lt; &quot;but isa is not kRuntimeISA. Will not attempt to load executable.&quot;;</div><div class="line">    load_executable_ = false;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Get the odex filename.</div><div class="line">  //   location = /foo/bar/baz.jar</div><div class="line">  //   odex_location = /foo/bar/oat/&lt;isa&gt;/baz.odex</div><div class="line">  std::string error_msg;</div><div class="line">  std::string odex_file_name;</div><div class="line">  if (DexLocationToOdexFilename(dex_location_, isa_, &amp;odex_file_name, &amp;error_msg)) &#123;</div><div class="line">    odex_.Reset(odex_file_name);</div><div class="line">  &#125; else &#123;</div><div class="line">    LOG(WARNING) &lt;&lt; &quot;Failed to determine odex file name: &quot; &lt;&lt; error_msg;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Get the oat filename.</div><div class="line">  std::string oat_file_name;</div><div class="line">  if (DexLocationToOatFilename(dex_location_, isa_, &amp;oat_file_name, &amp;error_msg)) &#123;</div><div class="line">    oat_.Reset(oat_file_name);</div><div class="line">  &#125; else &#123;</div><div class="line">    LOG(WARNING) &lt;&lt; &quot;Failed to determine oat file name for dex location &quot;</div><div class="line">        &lt;&lt; dex_location_ &lt;&lt; &quot;: &quot; &lt;&lt; error_msg;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Check if the dex directory is writable.</div><div class="line">  // This will be needed in most uses of OatFileAssistant and so it&apos;s OK to</div><div class="line">  // compute it eagerly. (the only use which will not make use of it is</div><div class="line">  // OatFileAssistant::GetStatusDump())</div><div class="line">  size_t pos = dex_location_.rfind(&apos;/&apos;);</div><div class="line">  if (pos == std::string::npos) &#123;</div><div class="line">    LOG(WARNING) &lt;&lt; &quot;Failed to determine dex file parent directory: &quot; &lt;&lt; dex_location_;</div><div class="line">  &#125; else &#123;</div><div class="line">    std::string parent = dex_location_.substr(0, pos);</div><div class="line">    if (access(parent.c_str(), W_OK) == 0) &#123;</div><div class="line">      dex_parent_writable_ = true;</div><div class="line">    &#125; else &#123;</div><div class="line">      VLOG(oat) &lt;&lt; &quot;Dex parent of &quot; &lt;&lt; dex_location_ &lt;&lt; &quot; is not writable: &quot; &lt;&lt; strerror(errno);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代表文件对象，在构造中通过dex路径获取了odex和oat的路径</p>
<h3 id="11-IsUpToDate"><a href="#11-IsUpToDate" class="headerlink" title="11-IsUpToDate"></a>11-IsUpToDate</h3><p>IsUpToDate<br>art\runtime\oat_file_assistant.cc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">bool OatFileAssistant::IsUpToDate() &#123;</div><div class="line">	//OatFileInfo的Status</div><div class="line">  return GetBestInfo().Status() == kOatUpToDate;</div><div class="line">&#125;</div><div class="line"></div><div class="line">OatFileAssistant::OatStatus OatFileAssistant::OatFileInfo::Status() &#123;</div><div class="line">  if (!status_attempted_) &#123;</div><div class="line">    status_attempted_ = true;</div><div class="line">	</div><div class="line">    const OatFile* file = GetFile();//??????</div><div class="line">	//file==null才执行，猜测为不是OatFile返回null</div><div class="line">    if (file == nullptr) &#123;</div><div class="line">      // Check to see if there is a vdex file we can make use of.</div><div class="line">      std::string error_msg;</div><div class="line">      std::string vdex_filename = GetVdexFilename(filename_);</div><div class="line">      std::unique_ptr&lt;VdexFile&gt; vdex = VdexFile::Open(vdex_filename,</div><div class="line">                                                      /*writeable*/false,</div><div class="line">                                                      /*low_4gb*/false,</div><div class="line">                                                      /*unquicken*/false,</div><div class="line">                                                      &amp;error_msg);</div><div class="line">		//是vdex</div><div class="line">      if (vdex == nullptr) &#123;</div><div class="line">        status_ = kOatCannotOpen;</div><div class="line">        VLOG(oat) &lt;&lt; &quot;unable to open vdex file &quot; &lt;&lt; vdex_filename &lt;&lt; &quot;: &quot; &lt;&lt; error_msg;</div><div class="line">      &#125; else &#123;</div><div class="line">        if (oat_file_assistant_-&gt;DexChecksumUpToDate(*vdex, &amp;error_msg)) &#123;</div><div class="line">          // The vdex file does not contain enough information to determine</div><div class="line">          // whether it is up to date with respect to the boot image, so we</div><div class="line">          // assume it is out of date.</div><div class="line">          VLOG(oat) &lt;&lt; error_msg;</div><div class="line">          status_ = kOatBootImageOutOfDate;</div><div class="line">        &#125; else &#123;</div><div class="line">          status_ = kOatDexOutOfDate;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">		//继续检查是不是其它的file</div><div class="line">      status_ = oat_file_assistant_-&gt;GivenOatFileStatus(*file);</div><div class="line">      VLOG(oat) &lt;&lt; file-&gt;GetLocation() &lt;&lt; &quot; is &quot; &lt;&lt; status_</div><div class="line">          &lt;&lt; &quot; with filter &quot; &lt;&lt; file-&gt;GetCompilerFilter();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  return status_;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果返回值==kOatUpToDate就表示优化过了，kOatUpToDate定义在一个enum，用于表示文件的状态。IsUpToDate中，Status检测(状态)</p>
<p>这里检测过程之后还比较长，先留下等用到再看。</p>
<h3 id="13-MakeUpToDate"><a href="#13-MakeUpToDate" class="headerlink" title="13-MakeUpToDate"></a>13-MakeUpToDate</h3><p>接下来看MakeUpToDate<br>art\runtime\oat_file_assistant.cc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">OatFileAssistant::ResultOfAttemptToUpdate</div><div class="line">OatFileAssistant::MakeUpToDate(bool profile_changed, std::string* error_msg) &#123;</div><div class="line">  CompilerFilter::Filter target;</div><div class="line">  if (!GetRuntimeCompilerFilterOption(&amp;target, error_msg)) &#123;</div><div class="line">    return kUpdateNotAttempted;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  OatFileInfo&amp; info = GetBestInfo();</div><div class="line">  //GetDexOptNeeded()方法再次确认是否需要oat优化</div><div class="line">  switch (info.GetDexOptNeeded(target, profile_changed)) &#123;</div><div class="line">    case kNoDexOptNeeded:</div><div class="line">      return kUpdateSucceeded;</div><div class="line"></div><div class="line">    // TODO: For now, don&apos;t bother with all the different ways we can call</div><div class="line">    // dex2oat to generate the oat file. Always generate the oat file as if it</div><div class="line">    // were kDex2OatFromScratch.</div><div class="line">    case kDex2OatFromScratch:</div><div class="line">    case kDex2OatForBootImage:</div><div class="line">    case kDex2OatForRelocation:</div><div class="line">    case kDex2OatForFilter:</div><div class="line">      return GenerateOatFileNoChecks(info, target, error_msg);</div><div class="line">  &#125;</div><div class="line">  UNREACHABLE();</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">OatFileAssistant::ResultOfAttemptToUpdate OatFileAssistant::GenerateOatFileNoChecks(</div><div class="line">      OatFileAssistant::OatFileInfo&amp; info, CompilerFilter::Filter filter, std::string* error_msg) &#123;</div><div class="line">  CHECK(error_msg != nullptr);</div><div class="line">	</div><div class="line">  Runtime* runtime = Runtime::Current();</div><div class="line">  //检查是否开启了允许优化</div><div class="line">  if (!runtime-&gt;IsDex2OatEnabled()) &#123;</div><div class="line">    *error_msg = &quot;Generation of oat file for dex location &quot; + dex_location_</div><div class="line">      + &quot; not attempted because dex2oat is disabled.&quot;;</div><div class="line">    return kUpdateNotAttempted;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  </div><div class="line">  //获取优化后的oat文件路径</div><div class="line">  if (info.Filename() == nullptr) &#123;</div><div class="line">    *error_msg = &quot;Generation of oat file for dex location &quot; + dex_location_</div><div class="line">      + &quot; not attempted because the oat file name could not be determined.&quot;;</div><div class="line">    return kUpdateNotAttempted;</div><div class="line">  &#125;</div><div class="line">  const std::string&amp; oat_file_name = *info.Filename();</div><div class="line">  const std::string&amp; vdex_file_name = GetVdexFilename(oat_file_name);</div><div class="line"></div><div class="line">  // dex2oat ignores missing dex files and doesn&apos;t report an error.</div><div class="line">  // Check explicitly here so we can detect the error properly.</div><div class="line">  // TODO: Why does dex2oat behave that way?</div><div class="line">  struct stat dex_path_stat;</div><div class="line">  if (TEMP_FAILURE_RETRY(stat(dex_location_.c_str(), &amp;dex_path_stat)) != 0) &#123;</div><div class="line">    *error_msg = &quot;Could not access dex location &quot; + dex_location_ + &quot;:&quot; + strerror(errno);</div><div class="line">    return kUpdateNotAttempted;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // If this is the odex location, we need to create the odex file layout (../oat/isa/..)</div><div class="line">  if (!info.IsOatLocation()) &#123;</div><div class="line">    if (!PrepareOdexDirectories(dex_location_, oat_file_name, isa_, error_msg)) &#123;</div><div class="line">      return kUpdateNotAttempted;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Set the permissions for the oat and the vdex files.</div><div class="line">  // The user always gets read and write while the group and others propagate</div><div class="line">  // the reading access of the original dex file.</div><div class="line">  mode_t file_mode = S_IRUSR | S_IWUSR |</div><div class="line">      (dex_path_stat.st_mode &amp; S_IRGRP) |</div><div class="line">      (dex_path_stat.st_mode &amp; S_IROTH);</div><div class="line"></div><div class="line">  std::unique_ptr&lt;File&gt; vdex_file(OS::CreateEmptyFile(vdex_file_name.c_str()));</div><div class="line">  if (vdex_file.get() == nullptr) &#123;</div><div class="line">    *error_msg = &quot;Generation of oat file &quot; + oat_file_name</div><div class="line">      + &quot; not attempted because the vdex file &quot; + vdex_file_name</div><div class="line">      + &quot; could not be opened.&quot;;</div><div class="line">    return kUpdateNotAttempted;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (fchmod(vdex_file-&gt;Fd(), file_mode) != 0) &#123;</div><div class="line">    *error_msg = &quot;Generation of oat file &quot; + oat_file_name</div><div class="line">      + &quot; not attempted because the vdex file &quot; + vdex_file_name</div><div class="line">      + &quot; could not be made world readable.&quot;;</div><div class="line">    return kUpdateNotAttempted;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  std::unique_ptr&lt;File&gt; oat_file(OS::CreateEmptyFile(oat_file_name.c_str()));</div><div class="line">  if (oat_file.get() == nullptr) &#123;</div><div class="line">    *error_msg = &quot;Generation of oat file &quot; + oat_file_name</div><div class="line">      + &quot; not attempted because the oat file could not be created.&quot;;</div><div class="line">    return kUpdateNotAttempted;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line">  //设置存放oat文件地址的可写权限</div><div class="line">  if (fchmod(oat_file-&gt;Fd(), file_mode) != 0) &#123;</div><div class="line">    *error_msg = &quot;Generation of oat file &quot; + oat_file_name</div><div class="line">      + &quot; not attempted because the oat file could not be made world readable.&quot;;</div><div class="line">    oat_file-&gt;Erase();</div><div class="line">    return kUpdateNotAttempted;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  </div><div class="line">  //配置参数  这个vdex待了解</div><div class="line">  std::vector&lt;std::string&gt; args;</div><div class="line">  args.push_back(&quot;--dex-file=&quot; + dex_location_);</div><div class="line">  args.push_back(&quot;--output-vdex-fd=&quot; + std::to_string(vdex_file-&gt;Fd()));</div><div class="line">  args.push_back(&quot;--oat-fd=&quot; + std::to_string(oat_file-&gt;Fd()));</div><div class="line">  args.push_back(&quot;--oat-location=&quot; + oat_file_name);</div><div class="line">  args.push_back(&quot;--compiler-filter=&quot; + CompilerFilter::NameOfFilter(filter));</div><div class="line"></div><div class="line">  //执行dex到oat的优化，</div><div class="line">  if (!Dex2Oat(args, error_msg)) &#123;</div><div class="line">    // Manually delete the oat and vdex files. This ensures there is no garbage</div><div class="line">    // left over if the process unexpectedly died.</div><div class="line">    vdex_file-&gt;Erase();</div><div class="line">    unlink(vdex_file_name.c_str());</div><div class="line">    oat_file-&gt;Erase();</div><div class="line">    unlink(oat_file_name.c_str());</div><div class="line">    return kUpdateFailed;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (vdex_file-&gt;FlushCloseOrErase() != 0) &#123;</div><div class="line">    *error_msg = &quot;Unable to close vdex file &quot; + vdex_file_name;</div><div class="line">    unlink(vdex_file_name.c_str());</div><div class="line">    return kUpdateFailed;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (oat_file-&gt;FlushCloseOrErase() != 0) &#123;</div><div class="line">    *error_msg = &quot;Unable to close oat file &quot; + oat_file_name;</div><div class="line">    unlink(oat_file_name.c_str());</div><div class="line">    return kUpdateFailed;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Mark that the odex file has changed and we should try to reload.</div><div class="line">  //更新文件信息，此时oat可以获取了</div><div class="line">  info.Reset();</div><div class="line">  return kUpdateSucceeded;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>获取、设置路径，执行优化</p>
<p>info.Filename()<br>art\runtime\oat_file_assistant.cc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//？？？？？？？？？</div><div class="line">const std::string* OatFileAssistant::OatFileInfo::Filename() &#123;</div><div class="line">  return filename_provided_ ? &amp;filename_ : nullptr;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="15-Dex2Oat"><a href="#15-Dex2Oat" class="headerlink" title="15-Dex2Oat"></a>15-Dex2Oat</h3><p>Dex2Oat<br>art\runtime\oat_file_assistant.cc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">bool OatFileAssistant::Dex2Oat(const std::vector&lt;std::string&gt;&amp; args,</div><div class="line">                               std::string* error_msg) &#123;</div><div class="line">  Runtime* runtime = Runtime::Current();</div><div class="line">  std::string image_location = ImageLocation();</div><div class="line">  if (image_location.empty()) &#123;</div><div class="line">    *error_msg = &quot;No image location found for Dex2Oat.&quot;;</div><div class="line">    return false;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  std::vector&lt;std::string&gt; argv;</div><div class="line">  argv.push_back(runtime-&gt;GetCompilerExecutable());</div><div class="line">  argv.push_back(&quot;--runtime-arg&quot;);</div><div class="line">  argv.push_back(&quot;-classpath&quot;);</div><div class="line">  argv.push_back(&quot;--runtime-arg&quot;);</div><div class="line">  std::string class_path = runtime-&gt;GetClassPathString();</div><div class="line">  if (class_path == &quot;&quot;) &#123;</div><div class="line">    class_path = OatFile::kSpecialSharedLibrary;</div><div class="line">  &#125;</div><div class="line">  argv.push_back(class_path);</div><div class="line">  if (runtime-&gt;IsJavaDebuggable()) &#123;</div><div class="line">    argv.push_back(&quot;--debuggable&quot;);</div><div class="line">  &#125;</div><div class="line">  runtime-&gt;AddCurrentRuntimeFeaturesAsDex2OatArguments(&amp;argv);</div><div class="line"></div><div class="line">  if (!runtime-&gt;IsVerificationEnabled()) &#123;</div><div class="line">    argv.push_back(&quot;--compiler-filter=verify-none&quot;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (runtime-&gt;MustRelocateIfPossible()) &#123;</div><div class="line">    argv.push_back(&quot;--runtime-arg&quot;);</div><div class="line">    argv.push_back(&quot;-Xrelocate&quot;);</div><div class="line">  &#125; else &#123;</div><div class="line">    argv.push_back(&quot;--runtime-arg&quot;);</div><div class="line">    argv.push_back(&quot;-Xnorelocate&quot;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (!kIsTargetBuild) &#123;</div><div class="line">    argv.push_back(&quot;--host&quot;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  argv.push_back(&quot;--boot-image=&quot; + image_location);</div><div class="line"></div><div class="line">  std::vector&lt;std::string&gt; compiler_options = runtime-&gt;GetCompilerOptions();</div><div class="line">  argv.insert(argv.end(), compiler_options.begin(), compiler_options.end());</div><div class="line"></div><div class="line">  argv.insert(argv.end(), args.begin(), args.end());</div><div class="line"></div><div class="line">  std::string command_line(android::base::Join(argv, &apos; &apos;));</div><div class="line">  return Exec(argv, error_msg);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">//art\runtime\runtime.cc</div><div class="line">std::string Runtime::GetCompilerExecutable() const &#123;</div><div class="line">  if (!compiler_executable_.empty()) &#123;</div><div class="line">    return compiler_executable_;</div><div class="line">  &#125;</div><div class="line">  std::string compiler_executable(GetAndroidRoot());</div><div class="line">  compiler_executable += (kIsDebugBuild ? &quot;/bin/dex2oatd&quot; : &quot;/bin/dex2oat&quot;);</div><div class="line">  return compiler_executable;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>进一步添加参数，调用Exec,其中参数第一项是/bin/dex2oat。</p>
<h3 id="16-Exec"><a href="#16-Exec" class="headerlink" title="16-Exec"></a>16-Exec</h3><p>Exec<br>art\runtime\exec_utils.cc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">bool Exec(std::vector&lt;std::string&gt;&amp; arg_vector, std::string* error_msg) &#123;</div><div class="line">  int status = ExecAndReturnCode(arg_vector, error_msg);</div><div class="line">  if (status != 0) &#123;</div><div class="line">    const std::string command_line(android::base::Join(arg_vector, &apos; &apos;));</div><div class="line">    *error_msg = StringPrintf(&quot;Failed execv(%s) because non-0 exit status&quot;,</div><div class="line">                              command_line.c_str());</div><div class="line">    return false;</div><div class="line">  &#125;</div><div class="line">  return true;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int ExecAndReturnCode(std::vector&lt;std::string&gt;&amp; arg_vector, std::string* error_msg) &#123;</div><div class="line">  const std::string command_line(android::base::Join(arg_vector, &apos; &apos;));</div><div class="line">  CHECK_GE(arg_vector.size(), 1U) &lt;&lt; command_line;</div><div class="line"></div><div class="line">  // Convert the args to char pointers.</div><div class="line">  const char* program = arg_vector[0].c_str();</div><div class="line">  std::vector&lt;char*&gt; args;</div><div class="line">  for (size_t i = 0; i &lt; arg_vector.size(); ++i) &#123;</div><div class="line">    const std::string&amp; arg = arg_vector[i];</div><div class="line">    char* arg_str = const_cast&lt;char*&gt;(arg.c_str());</div><div class="line">    CHECK(arg_str != nullptr) &lt;&lt; i;</div><div class="line">    args.push_back(arg_str);</div><div class="line">  &#125;</div><div class="line">  args.push_back(nullptr);</div><div class="line"></div><div class="line">  // fork and exec</div><div class="line">  pid_t pid = fork();</div><div class="line">  if (pid == 0) &#123;</div><div class="line">    // no allocation allowed between fork and exec</div><div class="line"></div><div class="line">    // change process groups, so we don&apos;t get reaped by ProcessManager</div><div class="line">    setpgid(0, 0);</div><div class="line"></div><div class="line">    // (b/30160149): protect subprocesses from modifications to LD_LIBRARY_PATH, etc.</div><div class="line">    // Use the snapshot of the environment from the time the runtime was created.</div><div class="line">    char** envp = (Runtime::Current() == nullptr) ? nullptr : Runtime::Current()-&gt;GetEnvSnapshot();</div><div class="line">    if (envp == nullptr) &#123;</div><div class="line">      execv(program, &amp;args[0]);</div><div class="line">    &#125; else &#123;</div><div class="line">		//子进程运行</div><div class="line">      execve(program, &amp;args[0], envp);</div><div class="line">    &#125;</div><div class="line">    PLOG(ERROR) &lt;&lt; &quot;Failed to execve(&quot; &lt;&lt; command_line &lt;&lt; &quot;)&quot;;</div><div class="line">    // _exit to avoid atexit handlers in child.</div><div class="line">    _exit(1);</div><div class="line">  &#125; else &#123;</div><div class="line">    if (pid == -1) &#123;</div><div class="line">      *error_msg = StringPrintf(&quot;Failed to execv(%s) because fork failed: %s&quot;,</div><div class="line">                                command_line.c_str(), strerror(errno));</div><div class="line">      return -1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // wait for subprocess to finish</div><div class="line">	//等待子进程结束</div><div class="line">    int status = -1;</div><div class="line">    pid_t got_pid = TEMP_FAILURE_RETRY(waitpid(pid, &amp;status, 0));</div><div class="line">    if (got_pid != pid) &#123;</div><div class="line">      *error_msg = StringPrintf(&quot;Failed after fork for execv(%s) because waitpid failed: &quot;</div><div class="line">                                &quot;wanted %d, got %d: %s&quot;,</div><div class="line">                                command_line.c_str(), pid, got_pid, strerror(errno));</div><div class="line">      return -1;</div><div class="line">    &#125;</div><div class="line">    if (WIFEXITED(status)) &#123;</div><div class="line">      return WEXITSTATUS(status);</div><div class="line">    &#125;</div><div class="line">    return -1;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>fork出子进程，子进程调用dex2oat执行优化，父进程等待子结束。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android系统/" rel="tag"># android系统</a>
          
            <a href="/tags/classloader/" rel="tag"># classloader</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/21/android8-0-0源码分析-app启动3/" rel="next" title="android8-0-0源码分析-app启动3">
                <i class="fa fa-chevron-left"></i> android8-0-0源码分析-app启动3
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/10/30/apk自动化加固1/" rel="prev" title="apk自动化加固1">
                apk自动化加固1 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/1.png"
               alt="imbaya" />
          <p class="site-author-name" itemprop="name">imbaya</p>
           
              <p class="site-description motion-element" itemprop="description">..........</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">76</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">69</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#jvm"><span class="nav-number">2.</span> <span class="nav-text">jvm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#android中的classloader"><span class="nav-number">3.</span> <span class="nav-text">android中的classloader</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ClassLoader"><span class="nav-number">3.1.</span> <span class="nav-text">ClassLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BootClassLoader"><span class="nav-number">3.2.</span> <span class="nav-text">BootClassLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PathClassLoader"><span class="nav-number">3.3.</span> <span class="nav-text">PathClassLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DexClassLoader"><span class="nav-number">3.4.</span> <span class="nav-text">DexClassLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BaseDexClassLoader"><span class="nav-number">3.5.</span> <span class="nav-text">BaseDexClassLoader</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码分析"><span class="nav-number">4.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-DexPathList"><span class="nav-number">4.1.</span> <span class="nav-text">2-DexPathList</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-makeDexElements"><span class="nav-number">4.2.</span> <span class="nav-text">3-makeDexElements</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-loadDexFile"><span class="nav-number">4.3.</span> <span class="nav-text">4-loadDexFile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-DexFile"><span class="nav-number">4.4.</span> <span class="nav-text">5-DexFile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-openDexFileNative"><span class="nav-number">4.5.</span> <span class="nav-text">7-openDexFileNative</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-ConvertDexFilesToJavaArray"><span class="nav-number">4.6.</span> <span class="nav-text">10-ConvertDexFilesToJavaArray</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-OpenDexFilesFromOat"><span class="nav-number">4.7.</span> <span class="nav-text">8-OpenDexFilesFromOat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-OatFileAssistant"><span class="nav-number">4.8.</span> <span class="nav-text">9-OatFileAssistant</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-IsUpToDate"><span class="nav-number">4.9.</span> <span class="nav-text">11-IsUpToDate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-MakeUpToDate"><span class="nav-number">4.10.</span> <span class="nav-text">13-MakeUpToDate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-Dex2Oat"><span class="nav-number">4.11.</span> <span class="nav-text">15-Dex2Oat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-Exec"><span class="nav-number">4.12.</span> <span class="nav-text">16-Exec</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">imbaya</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":100,"height":200,"hOffset":0,"vOffset":-50},"mobile":{"show":false},"react":{"opacityDefault":1,"opacityOnHover":1},"log":false});</script></body>
</html>
