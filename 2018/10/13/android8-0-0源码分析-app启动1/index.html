<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android系统,app启动," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="前言补充当系统决定要在一个新的进程中启动一个Activity或者Service时，ActivityManagerService组件负责通知Zygote创建一个新的进程，然后在这个新的进程中启动这个Activity或者Service。 Android应用程序架构中非常核心的一点：MainActivity不需要知道SubActivity的存在，即它不直接拥有SubActivity的接口，但是它可以通过">
<meta name="keywords" content="android系统,app启动">
<meta property="og:type" content="article">
<meta property="og:title" content="android8-0-0源码分析-app启动1">
<meta property="og:url" content="http://yoursite.com/2018/10/13/android8-0-0源码分析-app启动1/index.html">
<meta property="og:site_name" content="GGWP">
<meta property="og:description" content="前言补充当系统决定要在一个新的进程中启动一个Activity或者Service时，ActivityManagerService组件负责通知Zygote创建一个新的进程，然后在这个新的进程中启动这个Activity或者Service。 Android应用程序架构中非常核心的一点：MainActivity不需要知道SubActivity的存在，即它不直接拥有SubActivity的接口，但是它可以通过">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.imgur.com/fNDlj1N.jpg">
<meta property="og:updated_time" content="2018-10-18T16:42:46.669Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android8-0-0源码分析-app启动1">
<meta name="twitter:description" content="前言补充当系统决定要在一个新的进程中启动一个Activity或者Service时，ActivityManagerService组件负责通知Zygote创建一个新的进程，然后在这个新的进程中启动这个Activity或者Service。 Android应用程序架构中非常核心的一点：MainActivity不需要知道SubActivity的存在，即它不直接拥有SubActivity的接口，但是它可以通过">
<meta name="twitter:image" content="https://i.imgur.com/fNDlj1N.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/10/13/android8-0-0源码分析-app启动1/"/>





  <title>android8-0-0源码分析-app启动1 | GGWP</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GGWP</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/13/android8-0-0源码分析-app启动1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">android8-0-0源码分析-app启动1</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-13T22:51:22+08:00">
                2018-10-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言补充"><a href="#前言补充" class="headerlink" title="前言补充"></a>前言补充</h2><p>当系统决定要在一个新的进程中启动一个Activity或者Service时，ActivityManagerService组件负责通知Zygote创建一个新的进程，然后在这个新的进程中启动这个Activity或者Service。</p>
<p>Android应用程序架构中非常核心的一点：MainActivity不需要知道SubActivity的存在，即它不直接拥有SubActivity的接口，但是它可以通过一个字符串来告诉应用程序框架层，它要启动的Activity的名称是什么，其它的事情就交给应用程序框架层来做，这种模式大大降低了模块间的耦合，利于开发。<br>对于每一个应用程序来说，都有一个ActivityThread来表示应用程序的主进程，而每一个ActivityThread都包含有一个ApplicationThread实例，它是一个Binder对象，负责和其它进程进行通信。</p>
<p>Binder是Android系统进程间通信（IPC）方式之一。</p>
<p>目前linux支持的IPC包括传统的管道，System V IPC，即消息队列/共享内存/信号量，以及socket中只有socket支持Client-Server的通信方式。<br>而Client-Server的通信方式在android系统中被广泛使用，诸如媒体播放，视音频频捕获，到各种让手机更智能的传感器（加速度，方位，温度，光亮度等）都由不同的Server负责管理，应用程序只需做为Client与这些Server建立连接便可以使用这些服务，花很少的时间和精力就能开发出令人眩目的功能。因此需要高效的CS通信。</p>
<p>传输性能方面：socket通用主用于跨网络性能低，消息队列与管道都是二次拷贝，共享性能控制复杂。binder只有一次拷贝。</p>
<p>安全性：传统IPC的接收方无法获得对方进程可靠的UID/PID（用户ID/进程ID），从而无法鉴别对方身份。接入点开放，无法私有通道。</p>
<p>Binder是一个实体位于Server的对象，client使用它的句柄调用其方法<br>Binder模糊了进程边界，淡化了进程间通信过程，整个系统仿佛运行于同一个面向对象的程序之中。形形色色的Binder对象以及星罗棋布的引用仿佛粘接各个应用程序的胶水，这也是Binder在英文里的原意。</p>
<p>Binder的四个角色：Server、Client、ServiceManager、Binder驱动。驱动位于内核空间。与互联网类似：服务器、客户端、域名服务器、路由器</p>
<p><a href="https://blog.csdn.net/universus/article/details/6211589" target="_blank" rel="external">https://blog.csdn.net/universus/article/details/6211589</a></p>
<p>目前知道：可用于进程间通信，大量用于android各层即可。</p>
<p>参考文：<br><a href="http://duanqz.github.io/2016-07-29-Activity-LaunchProcess-Part1#%E6%A6%82%E8%BF%B0" target="_blank" rel="external">http://duanqz.github.io/2016-07-29-Activity-LaunchProcess-Part1#%E6%A6%82%E8%BF%B0</a><br>老罗<br>gityuan</p>
<p>不得不说<a href="http://duanqz.github.io/" target="_blank" rel="external">http://duanqz.github.io/</a> 这位大佬的博客写的太详细了而且版本很新……接下来尽量都看完<br><a id="more"></a></p>
<h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p>一张图：<br><img src="https://i.imgur.com/fNDlj1N.jpg" alt=""></p>
<p>启动部分涉及4个进程：发起进程、system_server进程、Zygote进程、新建进程。<br>本篇我们先看启动部分的前俩个进程的工作，值得注意的是各安装的应用都会有自己的信息记录在AMS中，启动的Task也由其间接管理，对于将要启动的app，它会首先将其信息放入栈中再去执行进程的启动任务。</p>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><h3 id="1-Launcher3"><a href="#1-Launcher3" class="headerlink" title="1-Launcher3"></a>1-Launcher3</h3><p>点击屏幕最后会调用到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">public boolean startActivitySafely(View v, Intent intent, ItemInfo item) &#123;</div><div class="line">    ...</div><div class="line">    // Only launch using the new animation if the shortcut has not opted out (this is a</div><div class="line">    // private contract between launcher and may be ignored in the future).</div><div class="line">    boolean useLaunchAnimation = (v != null) &amp;&amp;</div><div class="line">            !intent.hasExtra(INTENT_EXTRA_IGNORE_LAUNCH_ANIMATION);</div><div class="line">    Bundle optsBundle = useLaunchAnimation ? getActivityLaunchOptions(v) : null;</div><div class="line">    UserHandle user = item == null ? null : item.user;</div><div class="line">    // Prepare intent</div><div class="line">    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">    if (v != null) &#123;</div><div class="line">        intent.setSourceBounds(getViewBounds(v));</div><div class="line">    &#125;</div><div class="line">    try &#123;</div><div class="line">        if (Utilities.ATLEAST_MARSHMALLOW</div><div class="line">                &amp;&amp; (item instanceof ShortcutInfo)</div><div class="line">                &amp;&amp; (item.itemType == Favorites.ITEM_TYPE_SHORTCUT</div><div class="line">                 || item.itemType == Favorites.ITEM_TYPE_DEEP_SHORTCUT)</div><div class="line">                &amp;&amp; !((ShortcutInfo) item).isPromise()) &#123;</div><div class="line">            // Shortcuts need some special checks due to legacy reasons.</div><div class="line">            startShortcutIntentSafely(intent, optsBundle, item);</div><div class="line">        &#125; else if (user == null || user.equals(Process.myUserHandle())) &#123;</div><div class="line">            // Could be launching some bookkeeping activity</div><div class="line">            startActivity(intent, optsBundle);</div><div class="line">        &#125; else &#123;</div><div class="line">            LauncherAppsCompat.getInstance(this).startActivityForProfile(</div><div class="line">                    intent.getComponent(), user, intent.getSourceBounds(), optsBundle);</div><div class="line">        &#125;</div><div class="line">        return true;</div><div class="line">    &#125; catch (ActivityNotFoundException|SecurityException e) &#123;</div><div class="line">        Toast.makeText(this, R.string.activity_not_found, Toast.LENGTH_SHORT).show();</div><div class="line">        Log.e(TAG, &quot;Unable to launch. tag=&quot; + item + &quot; intent=&quot; + intent, e);</div><div class="line">    &#125;</div><div class="line">    return false;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Activity的样式：</div><div class="line">        &lt;activity</div><div class="line">            android:name=&quot;.firstActivity&quot;</div><div class="line">            android:label=&quot;1&quot;&gt;</div><div class="line">            &lt;intent-filter&gt;</div><div class="line">                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</div><div class="line"></div><div class="line">                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;</div><div class="line">            &lt;/intent-filter&gt;</div><div class="line">        &lt;/activity&gt;</div></pre></td></tr></table></figure></p>
<p>可见它是在一个新的TASK中启动intent。<br>启动activity的规则为activity可以规定多个action与多个category。隐式启动activity发送的intent也可以指定一个action与多个category，当有activity匹配了intent的一个action与全部category时即可响应该意图。<br>ACTION-MAIN标识该Activity为入口，CATEGORY-LAUNCHER设置该组件为在当前应用程序启动器中优先级最高的Activity，通常为入口ACTION_MAIN配合使用。这俩个保证该组件导出可被其它启动。为系统规定所识别。<br>获取方式为：View-&gt;ItemInfo -&gt;PromiseAppInfo </p>
<p>最后执行的是startActivity<br>此时还是应用之中。Activity的方法</p>
<p>Activity.startActivity<br>android-8.0.0_r1\frameworks\base\core\java\android\app\Activity.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void startActivity(Intent intent, @Nullable Bundle options) &#123;</div><div class="line">    if (options != null) &#123;</div><div class="line">        startActivityForResult(intent, -1, options);</div><div class="line">    &#125; else &#123;</div><div class="line">        // Note we want to go through this call for compatibility with</div><div class="line">        // applications that may have overridden the method.</div><div class="line">        startActivityForResult(intent, -1);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-startActivityForResult"><a href="#2-startActivityForResult" class="headerlink" title="2-startActivityForResult"></a>2-startActivityForResult</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public void startActivityForResult(@RequiresPermission Intent intent, int requestCode,</div><div class="line">        @Nullable Bundle options) &#123;</div><div class="line">    if (mParent == null) &#123;</div><div class="line">        options = transferSpringboardActivityOptions(options);</div><div class="line">        Instrumentation.ActivityResult ar =</div><div class="line">            mInstrumentation.execStartActivity(</div><div class="line">                this, mMainThread.getApplicationThread(), mToken, this,</div><div class="line">                intent, requestCode, options);</div><div class="line">        if (ar != null) &#123;</div><div class="line">            mMainThread.sendActivityResult(</div><div class="line">                mToken, mEmbeddedID, requestCode, ar.getResultCode(),</div><div class="line">                ar.getResultData());</div><div class="line">        &#125;</div><div class="line">        if (requestCode &gt;= 0) &#123;</div><div class="line">            // If this start is requesting a result, we can avoid making</div><div class="line">            // the activity visible until the result is received.  Setting</div><div class="line">            // this code during onCreate(Bundle savedInstanceState) or onResume() will keep the</div><div class="line">            // activity hidden during this time, to avoid flickering.</div><div class="line">            // This can only be done when a result is requested because</div><div class="line">            // that guarantees we will get information back when the</div><div class="line">            // activity is finished, no matter what happens to it.</div><div class="line">            mStartedActivity = true;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        cancelInputsAndStartExitTransition(options);</div><div class="line">        // TODO Consider clearing/flushing other event sources and events for child windows.</div><div class="line">    &#125; else &#123;</div><div class="line">        if (options != null) &#123;</div><div class="line">            mParent.startActivityFromChild(this, intent, requestCode, options);</div><div class="line">        &#125; else &#123;</div><div class="line">            // Note we want to go through this method for compatibility with</div><div class="line">            // existing applications that may have overridden it.</div><div class="line">            mParent.startActivityFromChild(this, intent, requestCode);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用mInstrumentation.execStartActivity，Intrumentation成员变量用来监控程序和系统的交互<br>这里通过mMainThread.getApplicationThread获得它里面的ApplicationThread成员变量，它是一个Binder对象，负责与其它进程通信。<br>mMainThread是ActivityThread类型的，代表应用程序的主线程。<br>ActivityThread与ApplicationThread分别是同应用进程的不同线程。</p>
<h3 id="3-execStartActivity"><a href="#3-execStartActivity" class="headerlink" title="3-execStartActivity"></a>3-execStartActivity</h3><p>Instrumentation.execStartActivity<br>frameworks\base\core\java\android\app\Instrumentation.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> public ActivityResult execStartActivity(</div><div class="line">         Context who, IBinder contextThread, IBinder token, Activity target,</div><div class="line">         Intent intent, int requestCode, Bundle options) &#123;</div><div class="line">     IApplicationThread whoThread = (IApplicationThread) contextThread;</div><div class="line">     Uri referrer = target != null ? target.onProvideReferrer() : null;</div><div class="line">     if (referrer != null) &#123;</div><div class="line">         intent.putExtra(Intent.EXTRA_REFERRER, referrer);</div><div class="line">     &#125;</div><div class="line">     if (mActivityMonitors != null) &#123;</div><div class="line">         synchronized (mSync) &#123;</div><div class="line">             final int N = mActivityMonitors.size();</div><div class="line">             for (int i=0; i&lt;N; i++) &#123;</div><div class="line">                 final ActivityMonitor am = mActivityMonitors.get(i);</div><div class="line">                 ActivityResult result = null;</div><div class="line">                 if (am.ignoreMatchingSpecificIntents()) &#123;</div><div class="line">                     result = am.onStartActivity(intent);</div><div class="line">                 &#125;</div><div class="line">                 if (result != null) &#123;</div><div class="line">                     am.mHits++;</div><div class="line">                     return result;</div><div class="line">                 &#125; else if (am.match(who, null, intent)) &#123;</div><div class="line">                     am.mHits++;</div><div class="line">                     if (am.isBlocking()) &#123;</div><div class="line">                         return requestCode &gt;= 0 ? am.getResult() : null;</div><div class="line">                     &#125;</div><div class="line">                     break;</div><div class="line">                 &#125;</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">     try &#123;</div><div class="line">         intent.migrateExtraStreamToClipData();</div><div class="line">         intent.prepareToLeaveProcess(who);</div><div class="line">//AMS远程调用</div><div class="line">         int result = ActivityManager.getService()</div><div class="line">             .startActivity(whoThread, who.getBasePackageName(), intent,</div><div class="line">                     intent.resolveTypeIfNeeded(who.getContentResolver()),</div><div class="line">                     token, target != null ? target.mEmbeddedID : null,</div><div class="line">                     requestCode, 0, null, options);</div><div class="line">         checkStartActivityResult(result, intent);</div><div class="line">     &#125; catch (RemoteException e) &#123;</div><div class="line">         throw new RuntimeException(&quot;Failure from system&quot;, e);</div><div class="line">     &#125;</div><div class="line">     return null;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>ActivityManager.getService()拿到的是IActivityManager，IActivityManager是一个aidl文件<br>ActivityManagerService存在于system_server进程，ActivityManagerService继承自IActivityManager.Stub成为远程调用服务，所以上面ActivityManager.getService().startActivity调用的其实是ActivityManagerService里面的方法</p>
<p>注意这里是aidl跨进程调用。<br>关于aidl……我的理解就是android中的RPC方案：android进程间CS通信常用Binder，RPC远程调用除了传输问题还有接口定义问题，aidl就是用来定义RPC接口的。<br>这样就可以实现仿佛自我调用般的RPC远程调用。</p>
<h3 id="4、5-startActivity、startActivityAsUser"><a href="#4、5-startActivity、startActivityAsUser" class="headerlink" title="4、5-startActivity、startActivityAsUser"></a>4、5-startActivity、startActivityAsUser</h3><p>ActivityManagerService存在于system_server进程<br>frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public final int startActivity(IApplicationThread caller, String callingPackage,</div><div class="line">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode,</div><div class="line">        int startFlags, ProfilerInfo profilerInfo, Bundle bOptions) &#123;</div><div class="line">    return startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</div><div class="line">            resultWho, requestCode, startFlags, profilerInfo, bOptions,</div><div class="line">            UserHandle.getCallingUserId());</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line">public final int startActivityAsUser(IApplicationThread caller, String callingPackage,</div><div class="line">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode,</div><div class="line">        int startFlags, ProfilerInfo profilerInfo, Bundle bOptions, int userId) &#123;</div><div class="line">    enforceNotIsolatedCaller(&quot;startActivity&quot;);</div><div class="line">    userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</div><div class="line">            userId, false, ALLOW_FULL_ONLY, &quot;startActivity&quot;, null);</div><div class="line">    // TODO: Switch to user app stacks here.</div><div class="line">    return mActivityStarter.startActivityMayWait(caller, -1, callingPackage, intent,</div><div class="line">            resolvedType, null, null, resultTo, resultWho, requestCode, startFlags,</div><div class="line">            profilerInfo, null, null, bOptions, false, userId, null, null,</div><div class="line">            &quot;startActivityAsUser&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>mActivityStarter为ActivityStarter类型的对象，该方法中取得userId调用其startActivityMayWait</p>
<p>接下来<br>ActivityStarter.java<br>–&gt;startActivityMayWait<br>–&gt;startActivityLocked<br>–&gt;startActivity<br>–&gt;startActivity<br>–&gt;startActivityUnchecked</p>
<h3 id="6-startActivityMayWait"><a href="#6-startActivityMayWait" class="headerlink" title="6-startActivityMayWait"></a>6-startActivityMayWait</h3><p>ActivityStarter<br>frameworks\base\services\core\java\com\android\server\am\ActivityStarter.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    final int startActivityMayWait(IApplicationThread caller, int callingUid,</div><div class="line">            String callingPackage, Intent intent, String resolvedType,</div><div class="line">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">            IBinder resultTo, String resultWho, int requestCode, int startFlags,</div><div class="line">            ProfilerInfo profilerInfo, WaitResult outResult,</div><div class="line">            Configuration globalConfig, Bundle bOptions, boolean ignoreTargetSecurity, int userId,</div><div class="line">            IActivityContainer iContainer, TaskRecord inTask, String reason) &#123;</div><div class="line">...</div><div class="line">     </div><div class="line"></div><div class="line"> </div><div class="line">        // Don&apos;t modify the client&apos;s object!</div><div class="line">        intent = new Intent(intent);</div><div class="line">...</div><div class="line"></div><div class="line">        ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId);</div><div class="line">...</div><div class="line">        // Collect information about the target of the Intent.</div><div class="line">        ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);</div><div class="line"></div><div class="line">...</div><div class="line">        synchronized (mService) &#123;</div><div class="line">            if (container != null &amp;&amp; container.mParentActivity != null &amp;&amp;</div><div class="line">                    container.mParentActivity.state != RESUMED) &#123;</div><div class="line">                // Cannot start a child activity if the parent is not resumed.</div><div class="line">                return ActivityManager.START_CANCELED;</div><div class="line">            &#125;</div><div class="line">            final int realCallingPid = Binder.getCallingPid();</div><div class="line">            final int realCallingUid = Binder.getCallingUid();</div><div class="line">            int callingPid;</div><div class="line">            if (callingUid &gt;= 0) &#123;</div><div class="line">                callingPid = -1;</div><div class="line">            &#125; else if (caller == null) &#123;</div><div class="line">                callingPid = realCallingPid;</div><div class="line">                callingUid = realCallingUid;</div><div class="line">            &#125; else &#123;</div><div class="line">                callingPid = callingUid = -1;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">            final ActivityRecord[] outRecord = new ActivityRecord[1];</div><div class="line">            int res = startActivityLocked(caller, intent, ephemeralIntent, resolvedType,</div><div class="line">                    aInfo, rInfo, voiceSession, voiceInteractor,</div><div class="line">                    resultTo, resultWho, requestCode, callingPid,</div><div class="line">                    callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</div><div class="line">                    options, ignoreTargetSecurity, componentSpecified, outRecord, container,</div><div class="line">                    inTask, reason);</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  </div><div class="line">            return res;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>aInfo为应用信息</p>
<h3 id="7、8-startActivityLocked、startActivity"><a href="#7、8-startActivityLocked、startActivity" class="headerlink" title="7、8-startActivityLocked、startActivity"></a>7、8-startActivityLocked、startActivity</h3><p>startActivityLocked ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">    int startActivityLocked(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</div><div class="line">            String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</div><div class="line">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">            IBinder resultTo, String resultWho, int requestCode, int callingPid, int callingUid,</div><div class="line">            String callingPackage, int realCallingPid, int realCallingUid, int startFlags,</div><div class="line">            ActivityOptions options, boolean ignoreTargetSecurity, boolean componentSpecified,</div><div class="line">            ActivityRecord[] outActivity, ActivityStackSupervisor.ActivityContainer container,</div><div class="line">            TaskRecord inTask, String reason) &#123;</div><div class="line"></div><div class="line">        if (TextUtils.isEmpty(reason)) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;Need to specify a reason.&quot;);</div><div class="line">        &#125;</div><div class="line">        mLastStartReason = reason;</div><div class="line">        mLastStartActivityTimeMs = System.currentTimeMillis();</div><div class="line">        mLastStartActivityRecord[0] = null;</div><div class="line"></div><div class="line">        mLastStartActivityResult = startActivity(caller, intent, ephemeralIntent, resolvedType,</div><div class="line">                aInfo, rInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode,</div><div class="line">                callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</div><div class="line">                options, ignoreTargetSecurity, componentSpecified, mLastStartActivityRecord,</div><div class="line">                container, inTask);</div><div class="line"></div><div class="line">        if (outActivity != null) &#123;</div><div class="line">            // mLastStartActivityRecord[0] is set in the call to startActivity above.</div><div class="line">            outActivity[0] = mLastStartActivityRecord[0];</div><div class="line">        &#125;</div><div class="line">        return mLastStartActivityResult;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	</div><div class="line">	</div><div class="line">    /** DO NOT call this method directly. Use &#123;@link #startActivityLocked&#125; instead. */</div><div class="line">    private int startActivity(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</div><div class="line">            String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</div><div class="line">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">            IBinder resultTo, String resultWho, int requestCode, int callingPid, int callingUid,</div><div class="line">            String callingPackage, int realCallingPid, int realCallingUid, int startFlags,</div><div class="line">            ActivityOptions options, boolean ignoreTargetSecurity, boolean componentSpecified,</div><div class="line">            ActivityRecord[] outActivity, ActivityStackSupervisor.ActivityContainer container,</div><div class="line">            TaskRecord inTask) &#123;</div><div class="line">        int err = ActivityManager.START_SUCCESS;</div><div class="line">        // Pull the optional Ephemeral Installer-only bundle out of the options early.</div><div class="line">        final Bundle verificationBundle</div><div class="line">                = options != null ? options.popAppVerificationBundle() : null;</div><div class="line"></div><div class="line">        ProcessRecord callerApp = null;</div><div class="line">        if (caller != null) &#123;</div><div class="line">            callerApp = mService.getRecordForAppLocked(caller);</div><div class="line">            if (callerApp != null) &#123;</div><div class="line">                callingPid = callerApp.pid;</div><div class="line">                callingUid = callerApp.info.uid;</div><div class="line">            &#125; else &#123;</div><div class="line">...</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">...</div><div class="line">        ActivityRecord sourceRecord = null;</div><div class="line">        ActivityRecord resultRecord = null;</div><div class="line">        if (resultTo != null) &#123;</div><div class="line">            sourceRecord = mSupervisor.isInAnyStackLocked(resultTo);</div><div class="line">            if (DEBUG_RESULTS) Slog.v(TAG_RESULTS,</div><div class="line">                    &quot;Will send result to &quot; + resultTo + &quot; &quot; + sourceRecord);</div><div class="line">            if (sourceRecord != null) &#123;</div><div class="line">                if (requestCode &gt;= 0 &amp;&amp; !sourceRecord.finishing) &#123;</div><div class="line">                    resultRecord = sourceRecord;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final int launchFlags = intent.getFlags();</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">...		</div><div class="line">//，创建即将要启动的Activity的相关信息，并保存在r变量中</div><div class="line">        ActivityRecord r = new ActivityRecord(mService, callerApp, callingPid, callingUid,</div><div class="line">                callingPackage, intent, resolvedType, aInfo, mService.getGlobalConfiguration(),</div><div class="line">                resultRecord, resultWho, requestCode, componentSpecified, voiceSession != null,</div><div class="line">                mSupervisor, container, options, sourceRecord);</div><div class="line"></div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">        return startActivity(r, sourceRecord, voiceSession, voiceInteractor, startFlags, true,</div><div class="line">                options, inTask, outActivity);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>r中是要启动的Activity相关信息。<br>resultTo是Launcher这个Activity里面的一个Binder对象，通过它可以获得Launcher这个Activity的相关信息。callerApp也是Launcher的信息。</p>
<h3 id="9、10-startActivityUnchecked"><a href="#9、10-startActivityUnchecked" class="headerlink" title="9、10-startActivityUnchecked"></a>9、10-startActivityUnchecked</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  private int startActivity(final ActivityRecord r, ActivityRecord sourceRecord,</div><div class="line">          IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">          int startFlags, boolean doResume, ActivityOptions options, TaskRecord inTask,</div><div class="line">          ActivityRecord[] outActivity) &#123;</div><div class="line">      int result = START_CANCELED;</div><div class="line">      try &#123;</div><div class="line">          mService.mWindowManager.deferSurfaceLayout();</div><div class="line">          result = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor,</div><div class="line">                  startFlags, doResume, options, inTask, outActivity);</div><div class="line">      &#125; finally &#123;</div><div class="line">          // If we are not able to proceed, disassociate the activity from the task. Leaving an</div><div class="line">          // activity in an incomplete state can lead to issues, such as performing operations</div><div class="line">          // without a window container.</div><div class="line">          if (!ActivityManager.isStartResultSuccessful(result)</div><div class="line">                  &amp;&amp; mStartActivity.getTask() != null) &#123;</div><div class="line">              mStartActivity.getTask().removeActivity(mStartActivity);</div><div class="line">          &#125;</div><div class="line">          mService.mWindowManager.continueSurfaceLayout();</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      postStartActivityProcessing(r, result, mSupervisor.getLastStack().mStackId,  mSourceRecord,</div><div class="line">              mTargetStack);</div><div class="line"></div><div class="line">      return result;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">	</div><div class="line">	</div><div class="line">	</div><div class="line"></div><div class="line">  // Note: This method should only be called from &#123;@link startActivity&#125;.</div><div class="line">  private int startActivityUnchecked(final ActivityRecord r, ActivityRecord sourceRecord,</div><div class="line">          IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">          int startFlags, boolean doResume, ActivityOptions options, TaskRecord inTask,</div><div class="line">          ActivityRecord[] outActivity) &#123;</div><div class="line"></div><div class="line">      setInitialState(r, options, inTask, doResume, startFlags, sourceRecord, voiceSession,</div><div class="line">              voiceInteractor);</div><div class="line"></div><div class="line">      computeLaunchingTaskFlags();</div><div class="line"></div><div class="line">      computeSourceStack();</div><div class="line"></div><div class="line">      mIntent.setFlags(mLaunchFlags);</div><div class="line"></div><div class="line">      ActivityRecord reusedActivity = getReusableIntentActivity();</div><div class="line"></div><div class="line">      final int preferredLaunchStackId =</div><div class="line">              (mOptions != null) ? mOptions.getLaunchStackId() : INVALID_STACK_ID;</div><div class="line">      final int preferredLaunchDisplayId =</div><div class="line">              (mOptions != null) ? mOptions.getLaunchDisplayId() : DEFAULT_DISPLAY;</div><div class="line"></div><div class="line">      if (reusedActivity != null) &#123;</div><div class="line">          // When the flags NEW_TASK and CLEAR_TASK are set, then the task gets reused but</div><div class="line">          // still needs to be a lock task mode violation since the task gets cleared out and</div><div class="line">          // the device would otherwise leave the locked task.</div><div class="line">          if (mSupervisor.isLockTaskModeViolation(reusedActivity.getTask(),</div><div class="line">                  (mLaunchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</div><div class="line">                          == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))) &#123;</div><div class="line">              mSupervisor.showLockTaskToast();</div><div class="line">              Slog.e(TAG, &quot;startActivityUnchecked: Attempt to violate Lock Task Mode&quot;);</div><div class="line">              return START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          if (mStartActivity.getTask() == null) &#123;</div><div class="line">              mStartActivity.setTask(reusedActivity.getTask());</div><div class="line">          &#125;</div><div class="line">          if (reusedActivity.getTask().intent == null) &#123;</div><div class="line">              // This task was started because of movement of the activity based on affinity...</div><div class="line">              // Now that we are actually launching it, we can assign the base intent.</div><div class="line">              reusedActivity.getTask().setIntent(mStartActivity);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          // This code path leads to delivering a new intent, we want to make sure we schedule it</div><div class="line">          // as the first operation, in case the activity will be resumed as a result of later</div><div class="line">          // operations.</div><div class="line">          if ((mLaunchFlags &amp; FLAG_ACTIVITY_CLEAR_TOP) != 0</div><div class="line">                  || isDocumentLaunchesIntoExisting(mLaunchFlags)</div><div class="line">                  || mLaunchSingleInstance || mLaunchSingleTask) &#123;</div><div class="line">              final TaskRecord task = reusedActivity.getTask();</div><div class="line"></div><div class="line">              // In this situation we want to remove all activities from the task up to the one</div><div class="line">              // being started. In most cases this means we are resetting the task to its initial</div><div class="line">              // state.</div><div class="line">              final ActivityRecord top = task.performClearTaskForReuseLocked(mStartActivity,</div><div class="line">                      mLaunchFlags);</div><div class="line"></div><div class="line">              // The above code can remove &#123;@code reusedActivity&#125; from the task, leading to the</div><div class="line">              // the &#123;@code ActivityRecord&#125; removing its reference to the &#123;@code TaskRecord&#125;. The</div><div class="line">              // task reference is needed in the call below to</div><div class="line">              // &#123;@link setTargetStackAndMoveToFrontIfNeeded&#125;.</div><div class="line">              if (reusedActivity.getTask() == null) &#123;</div><div class="line">                  reusedActivity.setTask(task);</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              if (top != null) &#123;</div><div class="line">                  if (top.frontOfTask) &#123;</div><div class="line">                      // Activity aliases may mean we use different intents for the top activity,</div><div class="line">                      // so make sure the task now has the identity of the new intent.</div><div class="line">                      top.getTask().setIntent(mStartActivity);</div><div class="line">                  &#125;</div><div class="line">                  ActivityStack.logStartActivity(AM_NEW_INTENT, mStartActivity, top.getTask());</div><div class="line">                  top.deliverNewIntentLocked(mCallingUid, mStartActivity.intent,</div><div class="line">                          mStartActivity.launchedFromPackage);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          sendPowerHintForLaunchStartIfNeeded(false /* forceSend */);</div><div class="line"></div><div class="line">          reusedActivity = setTargetStackAndMoveToFrontIfNeeded(reusedActivity);</div><div class="line"></div><div class="line">          final ActivityRecord outResult =</div><div class="line">                  outActivity != null &amp;&amp; outActivity.length &gt; 0 ? outActivity[0] : null;</div><div class="line"></div><div class="line">          // When there is a reused activity and the current result is a trampoline activity,</div><div class="line">          // set the reused activity as the result.</div><div class="line">          if (outResult != null &amp;&amp; (outResult.finishing || outResult.noDisplay)) &#123;</div><div class="line">              outActivity[0] = reusedActivity;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          if ((mStartFlags &amp; START_FLAG_ONLY_IF_NEEDED) != 0) &#123;</div><div class="line">              // We don&apos;t need to start a new activity, and the client said not to do anything</div><div class="line">              // if that is the case, so this is it!  And for paranoia, make sure we have</div><div class="line">              // correctly resumed the top activity.</div><div class="line">              resumeTargetStackIfNeeded();</div><div class="line">              return START_RETURN_INTENT_TO_CALLER;</div><div class="line">          &#125;</div><div class="line">          setTaskFromIntentActivity(reusedActivity);</div><div class="line"></div><div class="line">          if (!mAddingToTask &amp;&amp; mReuseTask == null) &#123;</div><div class="line">              // We didn&apos;t do anything...  but it was needed (a.k.a., client don&apos;t use that</div><div class="line">              // intent!)  And for paranoia, make sure we have correctly resumed the top activity.</div><div class="line">              resumeTargetStackIfNeeded();</div><div class="line">              if (outActivity != null &amp;&amp; outActivity.length &gt; 0) &#123;</div><div class="line">                  outActivity[0] = reusedActivity;</div><div class="line">              &#125;</div><div class="line">              return START_TASK_TO_FRONT;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (mStartActivity.packageName == null) &#123;</div><div class="line">          final ActivityStack sourceStack = mStartActivity.resultTo != null</div><div class="line">                  ? mStartActivity.resultTo.getStack() : null;</div><div class="line">          if (sourceStack != null) &#123;</div><div class="line">              sourceStack.sendActivityResultLocked(-1 /* callingUid */, mStartActivity.resultTo,</div><div class="line">                      mStartActivity.resultWho, mStartActivity.requestCode, RESULT_CANCELED,</div><div class="line">                      null /* data */);</div><div class="line">          &#125;</div><div class="line">          ActivityOptions.abort(mOptions);</div><div class="line">          return START_CLASS_NOT_FOUND;</div><div class="line">      &#125;</div><div class="line"></div><div class="line"></div><div class="line">//如果堆栈栈顶就是要启动的Activity，不会重复启动</div><div class="line">      // If the activity being launched is the same as the one currently at the top, then</div><div class="line">      // we need to check if it should only be launched once.</div><div class="line">      final ActivityStack topStack = mSupervisor.mFocusedStack;</div><div class="line">      final ActivityRecord topFocused = topStack.topActivity();</div><div class="line">      final ActivityRecord top = topStack.topRunningNonDelayedActivityLocked(mNotTop);</div><div class="line">      final boolean dontStart = top != null &amp;&amp; mStartActivity.resultTo == null</div><div class="line">              &amp;&amp; top.realActivity.equals(mStartActivity.realActivity)</div><div class="line">              &amp;&amp; top.userId == mStartActivity.userId</div><div class="line">              &amp;&amp; top.app != null &amp;&amp; top.app.thread != null</div><div class="line">              &amp;&amp; ((mLaunchFlags &amp; FLAG_ACTIVITY_SINGLE_TOP) != 0</div><div class="line">              || mLaunchSingleTop || mLaunchSingleTask);</div><div class="line">      if (dontStart) &#123;</div><div class="line">          ActivityStack.logStartActivity(AM_NEW_INTENT, top, top.getTask());</div><div class="line">          // For paranoia, make sure we have correctly resumed the top activity.</div><div class="line">          topStack.mLastPausedActivity = null;</div><div class="line">          if (mDoResume) &#123;</div><div class="line">              mSupervisor.resumeFocusedStackTopActivityLocked();</div><div class="line">          &#125;</div><div class="line">          ActivityOptions.abort(mOptions);</div><div class="line">          if ((mStartFlags &amp; START_FLAG_ONLY_IF_NEEDED) != 0) &#123;</div><div class="line">              // We don&apos;t need to start a new activity, and the client said not to do</div><div class="line">              // anything if that is the case, so this is it!</div><div class="line">              return START_RETURN_INTENT_TO_CALLER;</div><div class="line">          &#125;</div><div class="line">          top.deliverNewIntentLocked(</div><div class="line">                  mCallingUid, mStartActivity.intent, mStartActivity.launchedFromPackage);</div><div class="line"></div><div class="line">          // Don&apos;t use mStartActivity.task to show the toast. We&apos;re not starting a new activity</div><div class="line">          // but reusing &apos;top&apos;. Fields in mStartActivity may not be fully initialized.</div><div class="line">          mSupervisor.handleNonResizableTaskIfNeeded(top.getTask(), preferredLaunchStackId,</div><div class="line">                  preferredLaunchDisplayId, topStack.mStackId);</div><div class="line"></div><div class="line">          return START_DELIVERED_TO_TOP;</div><div class="line">      &#125;</div><div class="line"></div><div class="line"></div><div class="line">//是否在新栈</div><div class="line">      boolean newTask = false;</div><div class="line">      final TaskRecord taskToAffiliate = (mLaunchTaskBehind &amp;&amp; mSourceRecord != null)</div><div class="line">              ? mSourceRecord.getTask() : null;</div><div class="line"></div><div class="line">      // Should this be considered a new task?</div><div class="line">      int result = START_SUCCESS;</div><div class="line">      if (mStartActivity.resultTo == null &amp;&amp; mInTask == null &amp;&amp; !mAddingToTask</div><div class="line">              &amp;&amp; (mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != 0) &#123;</div><div class="line">          newTask = true;</div><div class="line">          result = setTaskFromReuseOrCreateNewTask(</div><div class="line">                  taskToAffiliate, preferredLaunchStackId, topStack);</div><div class="line">      &#125; else if (mSourceRecord != null) &#123;</div><div class="line">          result = setTaskFromSourceRecord();</div><div class="line">      &#125; else if (mInTask != null) &#123;</div><div class="line">          result = setTaskFromInTask();</div><div class="line">      &#125; else &#123;</div><div class="line">          // This not being started from an existing activity, and not part of a new task...</div><div class="line">          // just put it in the top task, though these days this case should never happen.</div><div class="line">          setTaskToCurrentTopOrCreateNewTask();</div><div class="line">      &#125;</div><div class="line">      if (result != START_SUCCESS) &#123;</div><div class="line">          return result;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      mService.grantUriPermissionFromIntentLocked(mCallingUid, mStartActivity.packageName,</div><div class="line">              mIntent, mStartActivity.getUriPermissionsLocked(), mStartActivity.userId);</div><div class="line">      mService.grantEphemeralAccessLocked(mStartActivity.userId, mIntent,</div><div class="line">              mStartActivity.appInfo.uid, UserHandle.getAppId(mCallingUid));</div><div class="line">      if (mSourceRecord != null) &#123;</div><div class="line">          mStartActivity.getTask().setTaskToReturnTo(mSourceRecord);</div><div class="line">      &#125;</div><div class="line">      if (newTask) &#123;</div><div class="line">          EventLog.writeEvent(</div><div class="line">                  EventLogTags.AM_CREATE_TASK, mStartActivity.userId,</div><div class="line">                  mStartActivity.getTask().taskId);</div><div class="line">      &#125;</div><div class="line">      ActivityStack.logStartActivity(</div><div class="line">              EventLogTags.AM_CREATE_ACTIVITY, mStartActivity, mStartActivity.getTask());</div><div class="line">      mTargetStack.mLastPausedActivity = null;</div><div class="line"></div><div class="line">      sendPowerHintForLaunchStartIfNeeded(false /* forceSend */);</div><div class="line"></div><div class="line">//停止其它Activity</div><div class="line">      mTargetStack.startActivityLocked(mStartActivity, topFocused, newTask, mKeepCurTransition,</div><div class="line">              mOptions);</div><div class="line">      if (mDoResume) &#123;</div><div class="line">          final ActivityRecord topTaskActivity =</div><div class="line">                  mStartActivity.getTask().topRunningActivityLocked();</div><div class="line">          if (!mTargetStack.isFocusable()</div><div class="line">                  || (topTaskActivity != null &amp;&amp; topTaskActivity.mTaskOverlay</div><div class="line">                  &amp;&amp; mStartActivity != topTaskActivity)) &#123;</div><div class="line">              // If the activity is not focusable, we can&apos;t resume it, but still would like to</div><div class="line">              // make sure it becomes visible as it starts (this will also trigger entry</div><div class="line">              // animation). An example of this are PIP activities.</div><div class="line">              // Also, we don&apos;t want to resume activities in a task that currently has an overlay</div><div class="line">              // as the starting activity just needs to be in the visible paused state until the</div><div class="line">              // over is removed.</div><div class="line">              mTargetStack.ensureActivitiesVisibleLocked(null, 0, !PRESERVE_WINDOWS);</div><div class="line">              // Go ahead and tell window manager to execute app transition for this activity</div><div class="line">              // since the app transition will not be triggered through the resume channel.</div><div class="line">              mWindowManager.executeAppTransition();</div><div class="line">          &#125; else &#123;</div><div class="line">              // If the target stack was not previously focusable (previous top running activity</div><div class="line">              // on that stack was not visible) then any prior calls to move the stack to the</div><div class="line">              // will not update the focused stack.  If starting the new activity now allows the</div><div class="line">              // task stack to be focusable, then ensure that we now update the focused stack</div><div class="line">              // accordingly.</div><div class="line">              if (mTargetStack.isFocusable() &amp;&amp; !mSupervisor.isFocusedStack(mTargetStack)) &#123;</div><div class="line">                  mTargetStack.moveToFront(&quot;startActivityUnchecked&quot;);</div><div class="line">              &#125;</div><div class="line">              mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,</div><div class="line">                      mOptions);</div><div class="line">          &#125;</div><div class="line">      &#125; else &#123;</div><div class="line">          mTargetStack.addRecentActivityLocked(mStartActivity);</div><div class="line">      &#125;</div><div class="line">      mSupervisor.updateUserStackLocked(mStartActivity.userId, mTargetStack);</div><div class="line"></div><div class="line">      mSupervisor.handleNonResizableTaskIfNeeded(mStartActivity.getTask(), preferredLaunchStackId,</div><div class="line">              preferredLaunchDisplayId, mTargetStack.mStackId);</div><div class="line"></div><div class="line">      return START_SUCCESS;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>该方法中获取activity的启动模式，activity的栈管理。若app未启动，在本方法中入栈并记录。<br>startActivityLocked 内切换界面，通知活动界面执行Paused<br>根据是否需要新栈创建新栈。调用resumeFocusedStackTopActivityLocked激活顶端的要启动的activity</p>
<h3 id="11-resumeFocusedStackTopActivityLocked"><a href="#11-resumeFocusedStackTopActivityLocked" class="headerlink" title="11-resumeFocusedStackTopActivityLocked"></a>11-resumeFocusedStackTopActivityLocked</h3><p>ActivityStackSupervisor.java<br>–&gt;resumeFocusedStackTopActivityLocked</p>
<p>frameworks\base\services\core\java\com\android\server\am\ActivityStackSupervisor.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">boolean resumeFocusedStackTopActivityLocked(</div><div class="line">        ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions) &#123;</div><div class="line">    if (targetStack != null &amp;&amp; isFocusedStack(targetStack)) &#123;</div><div class="line">        return targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</div><div class="line">    &#125;</div><div class="line">    final ActivityRecord r = mFocusedStack.topRunningActivityLocked();</div><div class="line">    if (r == null || r.state != RESUMED) &#123;</div><div class="line">        mFocusedStack.resumeTopActivityUncheckedLocked(null, null);</div><div class="line">    &#125; else if (r.state == RESUMED) &#123;</div><div class="line">        // Kick off any lingering app transitions form the MoveTaskToFront operation.</div><div class="line">        mFocusedStack.executeAppTransition(targetOptions);</div><div class="line">    &#125;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="12、13-ActivityStack"><a href="#12、13-ActivityStack" class="headerlink" title="12、13-ActivityStack"></a>12、13-ActivityStack</h3><p>ActivityStack.java<br>–&gt;resumeTopActivityUncheckedLocked<br>–&gt;resumeTopActivityInnerLocked</p>
<p>frameworks\base\services\core\java\com\android\server\am\ActivityStack.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">    boolean resumeTopActivityUncheckedLocked(ActivityRecord prev, ActivityOptions options) &#123;</div><div class="line">        if (mStackSupervisor.inResumeTopActivity) &#123;</div><div class="line">            // Don&apos;t even start recursing.</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        boolean result = false;</div><div class="line">        try &#123;</div><div class="line">            // Protect against recursion.</div><div class="line">            mStackSupervisor.inResumeTopActivity = true;</div><div class="line">            result = resumeTopActivityInnerLocked(prev, options);</div><div class="line">        &#125; finally &#123;</div><div class="line">            mStackSupervisor.inResumeTopActivity = false;</div><div class="line">        &#125;</div><div class="line">        // When resuming the top activity, it may be necessary to pause the top activity (for</div><div class="line">        // example, returning to the lock screen. We suppress the normal pause logic in</div><div class="line">        // &#123;@link #resumeTopActivityUncheckedLocked&#125;, since the top activity is resumed at the end.</div><div class="line">        // We call the &#123;@link ActivityStackSupervisor#checkReadyForSleepLocked&#125; again here to ensure</div><div class="line">        // any necessary pause logic occurs.</div><div class="line">        mStackSupervisor.checkReadyForSleepLocked();</div><div class="line"></div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line"></div><div class="line">    private boolean resumeTopActivityInnerLocked(ActivityRecord prev, ActivityOptions options) &#123;</div><div class="line">        if (!mService.mBooting &amp;&amp; !mService.mBooted) &#123;</div><div class="line">            // Not ready yet!</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Find the next top-most activity to resume in this stack that is not finishing and is</div><div class="line">        // focusable. If it is not focusable, we will fall into the case below to resume the</div><div class="line">        // top activity in the next focusable task.</div><div class="line">        final ActivityRecord next = topRunningActivityLocked(true /* focusableOnly */);</div><div class="line"></div><div class="line">        final boolean hasRunningActivity = next != null;</div><div class="line"></div><div class="line">        final ActivityRecord parent = mActivityContainer.mParentActivity;</div><div class="line">        final boolean isParentNotResumed = parent != null &amp;&amp; parent.state != ActivityState.RESUMED;</div><div class="line">        if (hasRunningActivity</div><div class="line">                &amp;&amp; (isParentNotResumed || !mActivityContainer.isAttachedLocked())) &#123;</div><div class="line">            // Do not resume this stack if its parent is not resumed.</div><div class="line">            // TODO: If in a loop, make sure that parent stack resumeTopActivity is called 1st.</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mStackSupervisor.cancelInitializingActivities();</div><div class="line"></div><div class="line">        // Remember how we&apos;ll process this pause/resume situation, and ensure</div><div class="line">        // that the state is reset however we wind up proceeding.</div><div class="line">        final boolean userLeaving = mStackSupervisor.mUserLeaving;</div><div class="line">        mStackSupervisor.mUserLeaving = false;</div><div class="line"></div><div class="line">        if (!hasRunningActivity) &#123;</div><div class="line">            // There are no activities left in the stack, let&apos;s look somewhere else.</div><div class="line">            return resumeTopActivityInNextFocusableStack(prev, options, &quot;noMoreActivities&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        next.delayedResume = false;</div><div class="line"></div><div class="line">        // If the top activity is the resumed one, nothing to do.</div><div class="line">        if (mResumedActivity == next &amp;&amp; next.state == ActivityState.RESUMED &amp;&amp;</div><div class="line">                    mStackSupervisor.allResumedActivitiesComplete()) &#123;</div><div class="line">......</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final TaskRecord nextTask = next.getTask();</div><div class="line">        final TaskRecord prevTask = prev != null ? prev.getTask() : null;</div><div class="line">        if (prevTask != null &amp;&amp; prevTask.getStack() == this &amp;&amp;</div><div class="line">                prevTask.isOverHomeStack() &amp;&amp; prev.finishing &amp;&amp; prev.frontOfTask) &#123;</div><div class="line">            if (DEBUG_STACK)  mStackSupervisor.validateTopActivitiesLocked();</div><div class="line">            if (prevTask == nextTask) &#123;</div><div class="line">                prevTask.setFrontOfTask();</div><div class="line">            &#125; else if (prevTask != topTask()) &#123;</div><div class="line">                // This task is going away but it was supposed to return to the home stack.</div><div class="line">                // Now the task above it has to return to the home task instead.</div><div class="line">                final int taskNdx = mTaskHistory.indexOf(prevTask) + 1;</div><div class="line">                mTaskHistory.get(taskNdx).setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">            &#125; else if (!isOnHomeDisplay()) &#123;</div><div class="line">                return false;</div><div class="line">            &#125; else if (!isHomeStack())&#123;</div><div class="line">                if (DEBUG_STATES) Slog.d(TAG_STATES,</div><div class="line">                        &quot;resumeTopActivityLocked: Launching home next&quot;);</div><div class="line">                return isOnHomeDisplay() &amp;&amp;</div><div class="line">                        mStackSupervisor.resumeHomeStackTask(prev, &quot;prevFinished&quot;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // If we are sleeping, and there is no resumed activity, and the top</div><div class="line">        // activity is paused, well that is the state we want.</div><div class="line">        if (mService.isSleepingOrShuttingDownLocked()</div><div class="line">                &amp;&amp; mLastPausedActivity == next</div><div class="line">                &amp;&amp; mStackSupervisor.allPausedActivitiesComplete()) &#123;</div><div class="line">            // Make sure we have executed any pending transitions, since there</div><div class="line">            // should be nothing left to do at this point.</div><div class="line">            executeAppTransition(options);</div><div class="line">            if (DEBUG_STATES) Slog.d(TAG_STATES,</div><div class="line">                    &quot;resumeTopActivityLocked: Going to sleep and all paused&quot;);</div><div class="line">            if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Make sure that the user who owns this activity is started.  If not,</div><div class="line">        // we will just leave it as is because someone should be bringing</div><div class="line">        // another user&apos;s activities to the top of the stack.</div><div class="line">        if (!mService.mUserController.hasStartedUserState(next.userId)) &#123;</div><div class="line">            Slog.w(TAG, &quot;Skipping resume of top activity &quot; + next</div><div class="line">                    + &quot;: user &quot; + next.userId + &quot; is stopped&quot;);</div><div class="line">            if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // The activity may be waiting for stop, but that is no longer</div><div class="line">        // appropriate for it.</div><div class="line">        mStackSupervisor.mStoppingActivities.remove(next);</div><div class="line">        mStackSupervisor.mGoingToSleepActivities.remove(next);</div><div class="line">        next.sleeping = false;</div><div class="line">        mStackSupervisor.mActivitiesWaitingForVisibleActivity.remove(next);</div><div class="line"></div><div class="line">        if (DEBUG_SWITCH) Slog.v(TAG_SWITCH, &quot;Resuming &quot; + next);</div><div class="line"></div><div class="line">        // If we are currently pausing an activity, then don&apos;t do anything until that is done.</div><div class="line">        if (!mStackSupervisor.allPausedActivitiesComplete()) &#123;</div><div class="line">            if (DEBUG_SWITCH || DEBUG_PAUSE || DEBUG_STATES) Slog.v(TAG_PAUSE,</div><div class="line">                    &quot;resumeTopActivityLocked: Skip resume: some activity pausing.&quot;);</div><div class="line">            if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mStackSupervisor.setLaunchSource(next.info.applicationInfo.uid);</div><div class="line"></div><div class="line">        boolean lastResumedCanPip = false;</div><div class="line">        final ActivityStack lastFocusedStack = mStackSupervisor.getLastStack();</div><div class="line">        if (lastFocusedStack != null &amp;&amp; lastFocusedStack != this) &#123;</div><div class="line">            // So, why aren&apos;t we using prev here??? See the param comment on the method. prev doesn&apos;t</div><div class="line">            // represent the last resumed activity. However, the last focus stack does if it isn&apos;t null.</div><div class="line">            final ActivityRecord lastResumed = lastFocusedStack.mResumedActivity;</div><div class="line">            lastResumedCanPip = lastResumed != null &amp;&amp; lastResumed.checkEnterPictureInPictureState(</div><div class="line">                    &quot;resumeTopActivity&quot;, true /* noThrow */, userLeaving /* beforeStopping */);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">        // If the most recent activity was noHistory but was only stopped rather</div><div class="line">        // than stopped+finished because the device went to sleep, we need to make</div><div class="line">        // sure to finish it as we&apos;re making a new activity topmost.</div><div class="line">        if (mService.isSleepingLocked() &amp;&amp; mLastNoHistoryActivity != null &amp;&amp;</div><div class="line">                !mLastNoHistoryActivity.finishing) &#123;</div><div class="line">            if (DEBUG_STATES) Slog.d(TAG_STATES,</div><div class="line">                    &quot;no-history finish of &quot; + mLastNoHistoryActivity + &quot; on new resume&quot;);</div><div class="line">            requestFinishActivityLocked(mLastNoHistoryActivity.appToken, Activity.RESULT_CANCELED,</div><div class="line">                    null, &quot;resume-no-history&quot;, false);</div><div class="line">            mLastNoHistoryActivity = null;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (prev != null &amp;&amp; prev != next) &#123;</div><div class="line">            if (!mStackSupervisor.mActivitiesWaitingForVisibleActivity.contains(prev)</div><div class="line">                    &amp;&amp; next != null &amp;&amp; !next.nowVisible) &#123;</div><div class="line">                mStackSupervisor.mActivitiesWaitingForVisibleActivity.add(prev);</div><div class="line">                if (DEBUG_SWITCH) Slog.v(TAG_SWITCH,</div><div class="line">                        &quot;Resuming top, waiting visible to hide: &quot; + prev);</div><div class="line">            &#125; else &#123;</div><div class="line"></div><div class="line">                if (prev.finishing) &#123;</div><div class="line">                    prev.setVisibility(false);</div><div class="line">                    if (DEBUG_SWITCH) Slog.v(TAG_SWITCH,</div><div class="line">                            &quot;Not waiting for visible to hide: &quot; + prev + &quot;, waitingVisible=&quot;</div><div class="line">                            + mStackSupervisor.mActivitiesWaitingForVisibleActivity.contains(prev)</div><div class="line">                            + &quot;, nowVisible=&quot; + next.nowVisible);</div><div class="line">                &#125; else &#123;</div><div class="line">                    if (DEBUG_SWITCH) Slog.v(TAG_SWITCH,</div><div class="line">                            &quot;Previous already visible but still waiting to hide: &quot; + prev</div><div class="line">                            + &quot;, waitingVisible=&quot;</div><div class="line">                            + mStackSupervisor.mActivitiesWaitingForVisibleActivity.contains(prev)</div><div class="line">                            + &quot;, nowVisible=&quot; + next.nowVisible);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Launching this app&apos;s activity, make sure the app is no longer</div><div class="line">        // considered stopped.</div><div class="line">        try &#123;</div><div class="line">            AppGlobals.getPackageManager().setPackageStoppedState(</div><div class="line">                    next.packageName, false, next.userId); /* TODO: Verify if correct userid */</div><div class="line">        &#125; catch (RemoteException e1) &#123;</div><div class="line">        &#125; catch (IllegalArgumentException e) &#123;</div><div class="line">            Slog.w(TAG, &quot;Failed trying to unstop package &quot;</div><div class="line">                    + next.packageName + &quot;: &quot; + e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">        ActivityStack lastStack = mStackSupervisor.getLastStack();</div><div class="line">        if (next.app != null &amp;&amp; next.app.thread != null) &#123;</div><div class="line"> .....</div><div class="line">        &#125; else &#123;</div><div class="line">            // Whoops, need to restart this activity!</div><div class="line">            if (!next.hasBeenLaunched) &#123;</div><div class="line">                next.hasBeenLaunched = true;</div><div class="line">            &#125; else &#123;</div><div class="line">                if (SHOW_APP_STARTING_PREVIEW) &#123;</div><div class="line">                    next.showStartingWindow(null /* prev */, false /* newTask */,</div><div class="line">                            false /* taskSwich */);</div><div class="line">                &#125;</div><div class="line">                if (DEBUG_SWITCH) Slog.v(TAG_SWITCH, &quot;Restarting: &quot; + next);</div><div class="line">            &#125;</div><div class="line">            if (DEBUG_STATES) Slog.d(TAG_STATES, &quot;resumeTopActivityLocked: Restarting &quot; + next);</div><div class="line">            mStackSupervisor.startSpecificActivityLocked(next, true, true);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</div><div class="line">        return true;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>当前在堆栈顶端的Activity为我们即将要启动的MainActivity，这里通过调用topRunningActivityLocked将它取回来，保存在next变量中。之前最后一个Resumed状态的Activity，即Launcher，到了这里已经处于Paused状态了，因此，mResumedActivity为null。最后一个处于Paused状态的Activity为Launcher，因此，这里的mLastPausedActivity就为Launcher。前面我们为MainActivity创建了ActivityRecord后，它的app域一直保持为null。</p>
<h3 id="14-startSpecificActivityLocked"><a href="#14-startSpecificActivityLocked" class="headerlink" title="14-startSpecificActivityLocked"></a>14-startSpecificActivityLocked</h3><p>ActivityStackSupervisor.java<br>–&gt;startSpecificActivityLocked<br>frameworks\base\services\core\java\com\android\server\am\ActivityStackSupervisor.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  void startSpecificActivityLocked(ActivityRecord r,</div><div class="line">          boolean andResume, boolean checkConfig) &#123;</div><div class="line">      // 这个app的进程是否已经启动过</div><div class="line">      ProcessRecord app = mService.getProcessRecordLocked(r.processName,</div><div class="line">              r.info.applicationInfo.uid, true);</div><div class="line"></div><div class="line">      r.getStack().setLaunchTime(r);</div><div class="line"></div><div class="line">//已经存在，直接运行</div><div class="line">      if (app != null &amp;&amp; app.thread != null) &#123;</div><div class="line">          try &#123;</div><div class="line">              if ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == 0</div><div class="line">                      || !&quot;android&quot;.equals(r.info.packageName)) &#123;</div><div class="line">                  // Don&apos;t add this if it is a platform component that is marked</div><div class="line">                  // to run in multiple processes, because this is actually</div><div class="line">                  // part of the framework so doesn&apos;t make sense to track as a</div><div class="line">                  // separate apk in the process.</div><div class="line">                  app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode,</div><div class="line">                          mService.mProcessStats);</div><div class="line">              &#125;</div><div class="line">              realStartActivityLocked(r, app, andResume, checkConfig);</div><div class="line">              return;</div><div class="line">          &#125; catch (RemoteException e) &#123;</div><div class="line">              Slog.w(TAG, &quot;Exception when starting activity &quot;</div><div class="line">                      + r.intent.getComponent().flattenToShortString(), e);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          // If a dead object exception was thrown -- fall through to</div><div class="line">          // restart the application.</div><div class="line">      &#125;</div><div class="line"></div><div class="line">//开进程启动</div><div class="line">      mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0,</div><div class="line">              &quot;activity&quot;, r.intent.getComponent(), false, false, true);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>第一次启动时<br>ProcessRecord app = mService.getProcessRecordLocked(r.processName,r.info.applicationInfo.uid, true);<br>为null。<br>在Activity应用程序中的AndroidManifest.xml配置文件中，我们没有指定Application标签的process属性，系统就会默认使用package的名称。每一个应用程序都有自己的uid，因此，这里uid + process的组合就可以为每一个应用程序创建一个ProcessRecord。当然，我们可以配置两个应用程序具有相同的uid和package，或者在AndroidManifest.xml配置文件的application标签或者activity标签中显式指定相同的process属性值，这样，不同的应用程序也可以在同一个进程中启动。</p>
<h3 id="15、16、17-startProcessLocked"><a href="#15、16、17-startProcessLocked" class="headerlink" title="15、16、17-startProcessLocked"></a>15、16、17-startProcessLocked</h3><p>frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java<br>ActivityManagerService.startProcessLocked</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  final ProcessRecord startProcessLocked(String processName,</div><div class="line">          ApplicationInfo info, boolean knownToBeDead, int intentFlags,</div><div class="line">          String hostingType, ComponentName hostingName, boolean allowWhileBooting,</div><div class="line">          boolean isolated, boolean keepIfLarge) &#123;</div><div class="line">      return startProcessLocked(processName, info, knownToBeDead, intentFlags, hostingType,</div><div class="line">              hostingName, allowWhileBooting, isolated, 0 /* isolatedUid */, keepIfLarge,</div><div class="line">              null /* ABI override */, null /* entryPoint */, null /* entryPointArgs */,</div><div class="line">              null /* crashHandler */);</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  final ProcessRecord startProcessLocked(String processName, ApplicationInfo info,</div><div class="line">          boolean knownToBeDead, int intentFlags, String hostingType, ComponentName hostingName,</div><div class="line">          boolean allowWhileBooting, boolean isolated, int isolatedUid, boolean keepIfLarge,</div><div class="line">          String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler) &#123;</div><div class="line">      long startTime = SystemClock.elapsedRealtime();</div><div class="line">      ProcessRecord app;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">      checkTime(startTime, &quot;startProcess: stepping in to startProcess&quot;);</div><div class="line">      startProcessLocked(</div><div class="line">              app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs);</div><div class="line">      checkTime(startTime, &quot;startProcess: done starting proc!&quot;);</div><div class="line">      return (app.pid != 0) ? app : null;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">	</div><div class="line">  private final void startProcessLocked(ProcessRecord app, String hostingType,</div><div class="line">          String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs) &#123;</div><div class="line">      long startTime = SystemClock.elapsedRealtime();</div><div class="line">      if (app.pid &gt; 0 &amp;&amp; app.pid != MY_PID) &#123;</div><div class="line">          checkTime(startTime, &quot;startProcess: removing from pids map&quot;);</div><div class="line">          synchronized (mPidsSelfLocked) &#123;</div><div class="line">              mPidsSelfLocked.remove(app.pid);</div><div class="line">              mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</div><div class="line">          &#125;</div><div class="line">          checkTime(startTime, &quot;startProcess: done removing from pids map&quot;);</div><div class="line">          app.setPid(0);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (DEBUG_PROCESSES &amp;&amp; mProcessesOnHold.contains(app)) Slog.v(TAG_PROCESSES,</div><div class="line">              &quot;startProcessLocked removing on hold: &quot; + app);</div><div class="line">      mProcessesOnHold.remove(app);</div><div class="line"></div><div class="line">      checkTime(startTime, &quot;startProcess: starting to update cpu stats&quot;);</div><div class="line">      updateCpuStats();</div><div class="line">      checkTime(startTime, &quot;startProcess: done updating cpu stats&quot;);</div><div class="line"></div><div class="line">      try &#123;</div><div class="line">          try &#123;</div><div class="line">              final int userId = UserHandle.getUserId(app.uid);</div><div class="line">              AppGlobals.getPackageManager().checkPackageStartable(app.info.packageName, userId);</div><div class="line">          &#125; catch (RemoteException e) &#123;</div><div class="line">              throw e.rethrowAsRuntimeException();</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          int uid = app.uid;</div><div class="line">          int[] gids = null;</div><div class="line">          int mountExternal = Zygote.MOUNT_EXTERNAL_NONE;</div><div class="line">          if (!app.isolated) &#123;</div><div class="line">              int[] permGids = null;</div><div class="line">              try &#123;</div><div class="line">                  checkTime(startTime, &quot;startProcess: getting gids from package manager&quot;);</div><div class="line">                  final IPackageManager pm = AppGlobals.getPackageManager();</div><div class="line">                  permGids = pm.getPackageGids(app.info.packageName,</div><div class="line">                          MATCH_DEBUG_TRIAGED_MISSING, app.userId);</div><div class="line">                  StorageManagerInternal storageManagerInternal = LocalServices.getService(</div><div class="line">                          StorageManagerInternal.class);</div><div class="line">                  mountExternal = storageManagerInternal.getExternalStorageMountMode(uid,</div><div class="line">                          app.info.packageName);</div><div class="line">              &#125; catch (RemoteException e) &#123;</div><div class="line">                  throw e.rethrowAsRuntimeException();</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              /*</div><div class="line">               * Add shared application and profile GIDs so applications can share some</div><div class="line">               * resources like shared libraries and access user-wide resources</div><div class="line">               */</div><div class="line">              if (ArrayUtils.isEmpty(permGids)) &#123;</div><div class="line">                  gids = new int[3];</div><div class="line">              &#125; else &#123;</div><div class="line">                  gids = new int[permGids.length + 3];</div><div class="line">                  System.arraycopy(permGids, 0, gids, 3, permGids.length);</div><div class="line">              &#125;</div><div class="line">              gids[0] = UserHandle.getSharedAppGid(UserHandle.getAppId(uid));</div><div class="line">              gids[1] = UserHandle.getCacheAppGid(UserHandle.getAppId(uid));</div><div class="line">              gids[2] = UserHandle.getUserGid(UserHandle.getUserId(uid));</div><div class="line">          &#125;</div><div class="line">          checkTime(startTime, &quot;startProcess: building args&quot;);</div><div class="line">          if (mFactoryTest != FactoryTest.FACTORY_TEST_OFF) &#123;</div><div class="line">              if (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL</div><div class="line">                      &amp;&amp; mTopComponent != null</div><div class="line">                      &amp;&amp; app.processName.equals(mTopComponent.getPackageName())) &#123;</div><div class="line">                  uid = 0;</div><div class="line">              &#125;</div><div class="line">              if (mFactoryTest == FactoryTest.FACTORY_TEST_HIGH_LEVEL</div><div class="line">                      &amp;&amp; (app.info.flags&amp;ApplicationInfo.FLAG_FACTORY_TEST) != 0) &#123;</div><div class="line">                  uid = 0;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">	</div><div class="line">	</div><div class="line">	//调试权限</div><div class="line">          int debugFlags = 0;</div><div class="line">          if ((app.info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0) &#123;</div><div class="line">              debugFlags |= Zygote.DEBUG_ENABLE_JDWP;</div><div class="line">              debugFlags |= Zygote.DEBUG_JAVA_DEBUGGABLE;</div><div class="line">              // Also turn on CheckJNI for debuggable apps. It&apos;s quite</div><div class="line">              // awkward to turn on otherwise.</div><div class="line">              debugFlags |= Zygote.DEBUG_ENABLE_CHECKJNI;</div><div class="line">          &#125;</div><div class="line">          // Run the app in safe mode if its manifest requests so or the</div><div class="line">          // system is booted in safe mode.</div><div class="line">          if ((app.info.flags &amp; ApplicationInfo.FLAG_VM_SAFE_MODE) != 0 ||</div><div class="line">              mSafeMode == true) &#123;</div><div class="line">              debugFlags |= Zygote.DEBUG_ENABLE_SAFEMODE;</div><div class="line">          &#125;</div><div class="line">          if (&quot;1&quot;.equals(SystemProperties.get(&quot;debug.checkjni&quot;))) &#123;</div><div class="line">              debugFlags |= Zygote.DEBUG_ENABLE_CHECKJNI;</div><div class="line">          &#125;</div><div class="line">          String genDebugInfoProperty = SystemProperties.get(&quot;debug.generate-debug-info&quot;);</div><div class="line">          if (&quot;true&quot;.equals(genDebugInfoProperty)) &#123;</div><div class="line">              debugFlags |= Zygote.DEBUG_GENERATE_DEBUG_INFO;</div><div class="line">          &#125;</div><div class="line">          if (&quot;1&quot;.equals(SystemProperties.get(&quot;debug.jni.logging&quot;))) &#123;</div><div class="line">              debugFlags |= Zygote.DEBUG_ENABLE_JNI_LOGGING;</div><div class="line">          &#125;</div><div class="line">          if (&quot;1&quot;.equals(SystemProperties.get(&quot;debug.assert&quot;))) &#123;</div><div class="line">              debugFlags |= Zygote.DEBUG_ENABLE_ASSERT;</div><div class="line">          &#125;</div><div class="line">          if (mNativeDebuggingApp != null &amp;&amp; mNativeDebuggingApp.equals(app.processName)) &#123;</div><div class="line">              // Enable all debug flags required by the native debugger.</div><div class="line">              debugFlags |= Zygote.DEBUG_ALWAYS_JIT;          // Don&apos;t interpret anything</div><div class="line">              debugFlags |= Zygote.DEBUG_GENERATE_DEBUG_INFO; // Generate debug info</div><div class="line">              debugFlags |= Zygote.DEBUG_NATIVE_DEBUGGABLE;   // Disbale optimizations</div><div class="line">              mNativeDebuggingApp = null;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          String invokeWith = null;</div><div class="line">          if ((app.info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0) &#123;</div><div class="line">              // Debuggable apps may include a wrapper script with their library directory.</div><div class="line">              String wrapperFileName = app.info.nativeLibraryDir + &quot;/wrap.sh&quot;;</div><div class="line">              StrictMode.ThreadPolicy oldPolicy = StrictMode.allowThreadDiskReads();</div><div class="line">              try &#123;</div><div class="line">                  if (new File(wrapperFileName).exists()) &#123;</div><div class="line">                      invokeWith = &quot;/system/bin/logwrapper &quot; + wrapperFileName;</div><div class="line">                  &#125;</div><div class="line">              &#125; finally &#123;</div><div class="line">                  StrictMode.setThreadPolicy(oldPolicy);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          String requiredAbi = (abiOverride != null) ? abiOverride : app.info.primaryCpuAbi;</div><div class="line">          if (requiredAbi == null) &#123;</div><div class="line">              requiredAbi = Build.SUPPORTED_ABIS[0];</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          String instructionSet = null;</div><div class="line">          if (app.info.primaryCpuAbi != null) &#123;</div><div class="line">              instructionSet = VMRuntime.getInstructionSet(app.info.primaryCpuAbi);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          app.gids = gids;</div><div class="line">          app.requiredAbi = requiredAbi;</div><div class="line">          app.instructionSet = instructionSet;</div><div class="line"></div><div class="line">          // the per-user SELinux context must be set</div><div class="line">          if (TextUtils.isEmpty(app.info.seInfoUser)) &#123;</div><div class="line">              Slog.wtf(TAG, &quot;SELinux tag not defined&quot;,</div><div class="line">                      new IllegalStateException(&quot;SELinux tag not defined for &quot;</div><div class="line">                      + app.info.packageName + &quot; (uid &quot; + app.uid + &quot;)&quot;));</div><div class="line">          &#125;</div><div class="line">          final String seInfo = app.info.seInfo</div><div class="line">                  + (TextUtils.isEmpty(app.info.seInfoUser) ? &quot;&quot; : app.info.seInfoUser);</div><div class="line">          // Start the process.  It will either succeed and return a result containing</div><div class="line">          // the PID of the new process, or else throw a RuntimeException.</div><div class="line">          boolean isActivityProcess = (entryPoint == null);</div><div class="line">	</div><div class="line">	//入口点</div><div class="line">          if (entryPoint == null) entryPoint = &quot;android.app.ActivityThread&quot;;</div><div class="line">          Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;Start proc: &quot; +</div><div class="line">                  app.processName);</div><div class="line">          checkTime(startTime, &quot;startProcess: asking zygote to start proc&quot;);</div><div class="line">          ProcessStartResult startResult;</div><div class="line">          if (hostingType.equals(&quot;webview_service&quot;)) &#123;</div><div class="line">              startResult = startWebView(entryPoint,</div><div class="line">                      app.processName, uid, uid, gids, debugFlags, mountExternal,</div><div class="line">                      app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</div><div class="line">                      app.info.dataDir, null, entryPointArgs);</div><div class="line">          &#125; else &#123;</div><div class="line">		</div><div class="line">		//进程开启</div><div class="line">              startResult = Process.start(entryPoint,</div><div class="line">                      app.processName, uid, uid, gids, debugFlags, mountExternal,</div><div class="line">                      app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</div><div class="line">                      app.info.dataDir, invokeWith, entryPointArgs);</div><div class="line">          &#125;</div><div class="line">          checkTime(startTime, &quot;startProcess: returned from zygote!&quot;);</div><div class="line">          Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line"></div><div class="line">          mBatteryStatsService.noteProcessStart(app.processName, app.info.uid);</div><div class="line">          checkTime(startTime, &quot;startProcess: done updating battery stats&quot;);</div><div class="line"></div><div class="line">          EventLog.writeEvent(EventLogTags.AM_PROC_START,</div><div class="line">                  UserHandle.getUserId(uid), startResult.pid, uid,</div><div class="line">                  app.processName, hostingType,</div><div class="line">                  hostingNameStr != null ? hostingNameStr : &quot;&quot;);</div><div class="line"></div><div class="line">          try &#123;</div><div class="line">              AppGlobals.getPackageManager().logAppProcessStartIfNeeded(app.processName, app.uid,</div><div class="line">                      seInfo, app.info.sourceDir, startResult.pid);</div><div class="line">          &#125; catch (RemoteException ex) &#123;</div><div class="line">              // Ignore</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          if (app.persistent) &#123;</div><div class="line">              Watchdog.getInstance().processStarted(app.processName, startResult.pid);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          checkTime(startTime, &quot;startProcess: building log message&quot;);</div><div class="line">          StringBuilder buf = mStringBuilder;</div><div class="line">          buf.setLength(0);</div><div class="line">          buf.append(&quot;Start proc &quot;);</div><div class="line">          buf.append(startResult.pid);</div><div class="line">          buf.append(&apos;:&apos;);</div><div class="line">          buf.append(app.processName);</div><div class="line">          buf.append(&apos;/&apos;);</div><div class="line">          UserHandle.formatUid(buf, uid);</div><div class="line">          if (!isActivityProcess) &#123;</div><div class="line">              buf.append(&quot; [&quot;);</div><div class="line">              buf.append(entryPoint);</div><div class="line">              buf.append(&quot;]&quot;);</div><div class="line">          &#125;</div><div class="line">          buf.append(&quot; for &quot;);</div><div class="line">          buf.append(hostingType);</div><div class="line">          if (hostingNameStr != null) &#123;</div><div class="line">              buf.append(&quot; &quot;);</div><div class="line">              buf.append(hostingNameStr);</div><div class="line">          &#125;</div><div class="line">          Slog.i(TAG, buf.toString());</div><div class="line">          app.setPid(startResult.pid);</div><div class="line">          app.usingWrapper = startResult.usingWrapper;</div><div class="line">          app.removed = false;</div><div class="line">          app.killed = false;</div><div class="line">          app.killedByAm = false;</div><div class="line">          checkTime(startTime, &quot;startProcess: starting to update pids map&quot;);</div><div class="line">          ProcessRecord oldApp;</div><div class="line">          synchronized (mPidsSelfLocked) &#123;</div><div class="line">              oldApp = mPidsSelfLocked.get(startResult.pid);</div><div class="line">          &#125;</div><div class="line">          // If there is already an app occupying that pid that hasn&apos;t been cleaned up</div><div class="line">          if (oldApp != null &amp;&amp; !app.isolated) &#123;</div><div class="line">              // Clean up anything relating to this pid first</div><div class="line">              Slog.w(TAG, &quot;Reusing pid &quot; + startResult.pid</div><div class="line">                      + &quot; while app is still mapped to it&quot;);</div><div class="line">              cleanUpApplicationRecordLocked(oldApp, false, false, -1,</div><div class="line">                      true /*replacingPid*/);</div><div class="line">          &#125;</div><div class="line">          synchronized (mPidsSelfLocked) &#123;</div><div class="line">              this.mPidsSelfLocked.put(startResult.pid, app);</div><div class="line">              if (isActivityProcess) &#123;</div><div class="line">                  Message msg = mHandler.obtainMessage(PROC_START_TIMEOUT_MSG);</div><div class="line">                  msg.obj = app;</div><div class="line">                  mHandler.sendMessageDelayed(msg, startResult.usingWrapper</div><div class="line">                          ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          checkTime(startTime, &quot;startProcess: done updating pids map&quot;);</div><div class="line">      &#125; catch (RuntimeException e) &#123;</div><div class="line">          Slog.e(TAG, &quot;Failure starting process &quot; + app.processName, e);</div><div class="line"></div><div class="line">          // Something went very wrong while trying to start this process; one</div><div class="line">          // common case is when the package is frozen due to an active</div><div class="line">          // upgrade. To recover, clean up any active bookkeeping related to</div><div class="line">          // starting this process. (We already invoked this method once when</div><div class="line">          // the package was initially frozen through KILL_APPLICATION_MSG, so</div><div class="line">          // it doesn&apos;t hurt to use it again.)</div><div class="line">          forceStopPackageLocked(app.info.packageName, UserHandle.getAppId(app.uid), false,</div><div class="line">                  false, true, false, false, UserHandle.getUserId(app.userId), &quot;start failure&quot;);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>三个startProcessLocked方法，最后一个设置进程属性，entryPoint表示入口方法android.app.ActivityThread。Process.start开始进程。</p>
<h3 id="18-start"><a href="#18-start" class="headerlink" title="18-start"></a>18-start</h3><p>Process.start<br>frameworks\base\core\java\android\os\Process.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"> * @param processClass The class to use as the process&apos;s main entry</div><div class="line"> *                     point.</div><div class="line"> * @param niceName A more readable name to use for the process.</div><div class="line"> * @param uid The user-id under which the process will run.</div><div class="line"> * @param gid The group-id under which the process will run.</div><div class="line"> * @param gids Additional group-ids associated with the process.</div><div class="line"> * @param debugFlags Additional flags.</div><div class="line"> * @param targetSdkVersion The target SDK version for the app.</div><div class="line"> * @param seInfo null-ok SELinux information for the new process.</div><div class="line"> * @param abi non-null the ABI this app should be started with.</div><div class="line"> * @param instructionSet null-ok the instruction set to use.</div><div class="line"> * @param appDataDir null-ok the data directory of the app.</div><div class="line"> * @param invokeWith null-ok the command to invoke with.</div><div class="line"> * @param zygoteArgs Additional arguments to supply to the zygote process.</div><div class="line"> * </div><div class="line"> * @return An object that describes the result of the attempt to start the process.</div><div class="line"> * @throws RuntimeException on fatal start failure</div><div class="line"> * </div><div class="line"> * &#123;@hide&#125;</div><div class="line"> */</div><div class="line">public static final ProcessStartResult start(final String processClass,</div><div class="line">                              final String niceName,</div><div class="line">                              int uid, int gid, int[] gids,</div><div class="line">                              int debugFlags, int mountExternal,</div><div class="line">                              int targetSdkVersion,</div><div class="line">                              String seInfo,</div><div class="line">                              String abi,</div><div class="line">                              String instructionSet,</div><div class="line">                              String appDataDir,</div><div class="line">                              String invokeWith,</div><div class="line">                              String[] zygoteArgs) &#123;</div><div class="line">    return zygoteProcess.start(processClass, niceName, uid, gid, gids,</div><div class="line">                debugFlags, mountExternal, targetSdkVersion, seInfo,</div><div class="line">                abi, instructionSet, appDataDir, invokeWith, zygoteArgs);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>zygoteProcess进程是final static的，可见其唯一性，调用其产生进程。<br>此时还在server</p>
<h3 id="19、20-start、startViaZygote"><a href="#19、20-start、startViaZygote" class="headerlink" title="19、20-start、startViaZygote"></a>19、20-start、startViaZygote</h3><p>ZygoteProcess.start<br>frameworks\base\core\java\android\os\ZygoteProcess.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">    /**</div><div class="line">     * Start a new process.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;If processes are enabled, a new process is created and the</div><div class="line">     * static main() function of a &lt;var&gt;processClass&lt;/var&gt; is executed there.</div><div class="line">     * The process will continue running after this function returns.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;If processes are not enabled, a new thread in the caller&apos;s</div><div class="line">     * process is created and main() of &lt;var&gt;processClass&lt;/var&gt; called there.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;The niceName parameter, if not an empty string, is a custom name to</div><div class="line">     * give to the process instead of using processClass.  This allows you to</div><div class="line">     * make easily identifyable processes even if you are using the same base</div><div class="line">     * &lt;var&gt;processClass&lt;/var&gt; to start them.</div><div class="line">     *</div><div class="line">     * When invokeWith is not null, the process will be started as a fresh app</div><div class="line">     * and not a zygote fork. Note that this is only allowed for uid 0 or when</div><div class="line">     * debugFlags contains DEBUG_ENABLE_DEBUGGER.</div><div class="line">     *</div><div class="line">     * @param processClass The class to use as the process&apos;s main entry</div><div class="line">     *                     point.</div><div class="line">     * @param niceName A more readable name to use for the process.</div><div class="line">     * @param uid The user-id under which the process will run.</div><div class="line">     * @param gid The group-id under which the process will run.</div><div class="line">     * @param gids Additional group-ids associated with the process.</div><div class="line">     * @param debugFlags Additional flags.</div><div class="line">     * @param targetSdkVersion The target SDK version for the app.</div><div class="line">     * @param seInfo null-ok SELinux information for the new process.</div><div class="line">     * @param abi non-null the ABI this app should be started with.</div><div class="line">     * @param instructionSet null-ok the instruction set to use.</div><div class="line">     * @param appDataDir null-ok the data directory of the app.</div><div class="line">     * @param invokeWith null-ok the command to invoke with.</div><div class="line">     * @param zygoteArgs Additional arguments to supply to the zygote process.</div><div class="line">     *</div><div class="line">     * @return An object that describes the result of the attempt to start the process.</div><div class="line">     * @throws RuntimeException on fatal start failure</div><div class="line">     */</div><div class="line">    public final Process.ProcessStartResult start(final String processClass,</div><div class="line">                                                  final String niceName,</div><div class="line">                                                  int uid, int gid, int[] gids,</div><div class="line">                                                  int debugFlags, int mountExternal,</div><div class="line">                                                  int targetSdkVersion,</div><div class="line">                                                  String seInfo,</div><div class="line">                                                  String abi,</div><div class="line">                                                  String instructionSet,</div><div class="line">                                                  String appDataDir,</div><div class="line">                                                  String invokeWith,</div><div class="line">                                                  String[] zygoteArgs) &#123;</div><div class="line">        try &#123;</div><div class="line">            return startViaZygote(processClass, niceName, uid, gid, gids,</div><div class="line">                    debugFlags, mountExternal, targetSdkVersion, seInfo,</div><div class="line">                    abi, instructionSet, appDataDir, invokeWith, zygoteArgs);</div><div class="line">        &#125; catch (ZygoteStartFailedEx ex) &#123;</div><div class="line">            Log.e(LOG_TAG,</div><div class="line">                    &quot;Starting VM process through Zygote failed&quot;);</div><div class="line">            throw new RuntimeException(</div><div class="line">                    &quot;Starting VM process through Zygote failed&quot;, ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	</div><div class="line">	</div><div class="line">    /**</div><div class="line">     * Starts a new process via the zygote mechanism.</div><div class="line">     *</div><div class="line">     * @param processClass Class name whose static main() to run</div><div class="line">     * @param niceName &apos;nice&apos; process name to appear in ps</div><div class="line">     * @param uid a POSIX uid that the new process should setuid() to</div><div class="line">     * @param gid a POSIX gid that the new process shuold setgid() to</div><div class="line">     * @param gids null-ok; a list of supplementary group IDs that the</div><div class="line">     * new process should setgroup() to.</div><div class="line">     * @param debugFlags Additional flags.</div><div class="line">     * @param targetSdkVersion The target SDK version for the app.</div><div class="line">     * @param seInfo null-ok SELinux information for the new process.</div><div class="line">     * @param abi the ABI the process should use.</div><div class="line">     * @param instructionSet null-ok the instruction set to use.</div><div class="line">     * @param appDataDir null-ok the data directory of the app.</div><div class="line">     * @param extraArgs Additional arguments to supply to the zygote process.</div><div class="line">     * @return An object that describes the result of the attempt to start the process.</div><div class="line">     * @throws ZygoteStartFailedEx if process start failed for any reason</div><div class="line">     */</div><div class="line">    private Process.ProcessStartResult startViaZygote(final String processClass,</div><div class="line">                                                      final String niceName,</div><div class="line">                                                      final int uid, final int gid,</div><div class="line">                                                      final int[] gids,</div><div class="line">                                                      int debugFlags, int mountExternal,</div><div class="line">                                                      int targetSdkVersion,</div><div class="line">                                                      String seInfo,</div><div class="line">                                                      String abi,</div><div class="line">                                                      String instructionSet,</div><div class="line">                                                      String appDataDir,</div><div class="line">                                                      String invokeWith,</div><div class="line">                                                      String[] extraArgs)</div><div class="line">                                                      throws ZygoteStartFailedEx &#123;</div><div class="line">        ArrayList&lt;String&gt; argsForZygote = new ArrayList&lt;String&gt;();</div><div class="line"></div><div class="line">        // --runtime-args, --setuid=, --setgid=,</div><div class="line">        // and --setgroups= must go first</div><div class="line">        argsForZygote.add(&quot;--runtime-args&quot;);</div><div class="line">        argsForZygote.add(&quot;--setuid=&quot; + uid);</div><div class="line">        argsForZygote.add(&quot;--setgid=&quot; + gid);</div><div class="line">        if ((debugFlags &amp; Zygote.DEBUG_ENABLE_JNI_LOGGING) != 0) &#123;</div><div class="line">            argsForZygote.add(&quot;--enable-jni-logging&quot;);</div><div class="line">        &#125;</div><div class="line">        if ((debugFlags &amp; Zygote.DEBUG_ENABLE_SAFEMODE) != 0) &#123;</div><div class="line">            argsForZygote.add(&quot;--enable-safemode&quot;);</div><div class="line">        &#125;</div><div class="line">        if ((debugFlags &amp; Zygote.DEBUG_ENABLE_JDWP) != 0) &#123;</div><div class="line">            argsForZygote.add(&quot;--enable-jdwp&quot;);</div><div class="line">        &#125;</div><div class="line">        if ((debugFlags &amp; Zygote.DEBUG_ENABLE_CHECKJNI) != 0) &#123;</div><div class="line">            argsForZygote.add(&quot;--enable-checkjni&quot;);</div><div class="line">        &#125;</div><div class="line">        if ((debugFlags &amp; Zygote.DEBUG_GENERATE_DEBUG_INFO) != 0) &#123;</div><div class="line">            argsForZygote.add(&quot;--generate-debug-info&quot;);</div><div class="line">        &#125;</div><div class="line">        if ((debugFlags &amp; Zygote.DEBUG_ALWAYS_JIT) != 0) &#123;</div><div class="line">            argsForZygote.add(&quot;--always-jit&quot;);</div><div class="line">        &#125;</div><div class="line">        if ((debugFlags &amp; Zygote.DEBUG_NATIVE_DEBUGGABLE) != 0) &#123;</div><div class="line">            argsForZygote.add(&quot;--native-debuggable&quot;);</div><div class="line">        &#125;</div><div class="line">        if ((debugFlags &amp; Zygote.DEBUG_JAVA_DEBUGGABLE) != 0) &#123;</div><div class="line">            argsForZygote.add(&quot;--java-debuggable&quot;);</div><div class="line">        &#125;</div><div class="line">        if ((debugFlags &amp; Zygote.DEBUG_ENABLE_ASSERT) != 0) &#123;</div><div class="line">            argsForZygote.add(&quot;--enable-assert&quot;);</div><div class="line">        &#125;</div><div class="line">        if (mountExternal == Zygote.MOUNT_EXTERNAL_DEFAULT) &#123;</div><div class="line">            argsForZygote.add(&quot;--mount-external-default&quot;);</div><div class="line">        &#125; else if (mountExternal == Zygote.MOUNT_EXTERNAL_READ) &#123;</div><div class="line">            argsForZygote.add(&quot;--mount-external-read&quot;);</div><div class="line">        &#125; else if (mountExternal == Zygote.MOUNT_EXTERNAL_WRITE) &#123;</div><div class="line">            argsForZygote.add(&quot;--mount-external-write&quot;);</div><div class="line">        &#125;</div><div class="line">        argsForZygote.add(&quot;--target-sdk-version=&quot; + targetSdkVersion);</div><div class="line"></div><div class="line">        // --setgroups is a comma-separated list</div><div class="line">        if (gids != null &amp;&amp; gids.length &gt; 0) &#123;</div><div class="line">            StringBuilder sb = new StringBuilder();</div><div class="line">            sb.append(&quot;--setgroups=&quot;);</div><div class="line"></div><div class="line">            int sz = gids.length;</div><div class="line">            for (int i = 0; i &lt; sz; i++) &#123;</div><div class="line">                if (i != 0) &#123;</div><div class="line">                    sb.append(&apos;,&apos;);</div><div class="line">                &#125;</div><div class="line">                sb.append(gids[i]);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            argsForZygote.add(sb.toString());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (niceName != null) &#123;</div><div class="line">            argsForZygote.add(&quot;--nice-name=&quot; + niceName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (seInfo != null) &#123;</div><div class="line">            argsForZygote.add(&quot;--seinfo=&quot; + seInfo);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (instructionSet != null) &#123;</div><div class="line">            argsForZygote.add(&quot;--instruction-set=&quot; + instructionSet);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (appDataDir != null) &#123;</div><div class="line">            argsForZygote.add(&quot;--app-data-dir=&quot; + appDataDir);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (invokeWith != null) &#123;</div><div class="line">            argsForZygote.add(&quot;--invoke-with&quot;);</div><div class="line">            argsForZygote.add(invokeWith);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        argsForZygote.add(processClass);</div><div class="line"></div><div class="line">        if (extraArgs != null) &#123;</div><div class="line">            for (String arg : extraArgs) &#123;</div><div class="line">                argsForZygote.add(arg);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        synchronized(mLock) &#123;</div><div class="line">            return zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    /**</div><div class="line">     * Tries to open socket to Zygote process if not already open. If</div><div class="line">     * already open, does nothing.  May block and retry.  Requires that mLock be held.</div><div class="line">     */</div><div class="line">    @GuardedBy(&quot;mLock&quot;)</div><div class="line">    private ZygoteState openZygoteSocketIfNeeded(String abi) throws ZygoteStartFailedEx &#123;</div><div class="line">        Preconditions.checkState(Thread.holdsLock(mLock), &quot;ZygoteProcess lock not held&quot;);</div><div class="line"></div><div class="line">        if (primaryZygoteState == null || primaryZygoteState.isClosed()) &#123;</div><div class="line">            try &#123;</div><div class="line">                primaryZygoteState = ZygoteState.connect(mSocket);</div><div class="line">            &#125; catch (IOException ioe) &#123;</div><div class="line">                throw new ZygoteStartFailedEx(&quot;Error connecting to primary zygote&quot;, ioe);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (primaryZygoteState.matches(abi)) &#123;</div><div class="line">            return primaryZygoteState;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // The primary zygote didn&apos;t match. Try the secondary.</div><div class="line">        if (secondaryZygoteState == null || secondaryZygoteState.isClosed()) &#123;</div><div class="line">            try &#123;</div><div class="line">                secondaryZygoteState = ZygoteState.connect(mSecondarySocket);</div><div class="line">            &#125; catch (IOException ioe) &#123;</div><div class="line">                throw new ZygoteStartFailedEx(&quot;Error connecting to secondary zygote&quot;, ioe);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (secondaryZygoteState.matches(abi)) &#123;</div><div class="line">            return secondaryZygoteState;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        throw new ZygoteStartFailedEx(&quot;Unsupported zygote ABI: &quot; + abi);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> * The state of the connection to the primary zygote.</div><div class="line"> */</div><div class="line">private ZygoteState primaryZygoteState;</div><div class="line"></div><div class="line">/**</div><div class="line"> * The state of the connection to the secondary zygote.</div><div class="line"> */</div><div class="line">private ZygoteState secondaryZygoteState;</div></pre></td></tr></table></figure>
<p>设置参数。ZygoteState一共有俩个，都是与zygote通信用的，openZygoteSocketIfNeeded内尝试连接zygote返回ZygoteState。为socket连接</p>
<h3 id="21-zygoteSendArgsAndGetResult"><a href="#21-zygoteSendArgsAndGetResult" class="headerlink" title="21-zygoteSendArgsAndGetResult"></a>21-zygoteSendArgsAndGetResult</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  /**</div><div class="line">   * Sends an argument list to the zygote process, which starts a new child</div><div class="line">   * and returns the child&apos;s pid. Please note: the present implementation</div><div class="line">   * replaces newlines in the argument list with spaces.</div><div class="line">   *</div><div class="line"></div><div class="line">   * @throws ZygoteStartFailedEx if process start failed for any reason</div><div class="line">   */</div><div class="line">//发送参数表给zygote进程，返回新的进程pid</div><div class="line">  @GuardedBy(&quot;mLock&quot;)</div><div class="line">  private static Process.ProcessStartResult zygoteSendArgsAndGetResult(</div><div class="line">          ZygoteState zygoteState, ArrayList&lt;String&gt; args)</div><div class="line">          throws ZygoteStartFailedEx &#123;</div><div class="line">      try &#123;</div><div class="line">          // Throw early if any of the arguments are malformed. This means we can</div><div class="line">          // avoid writing a partial response to the zygote.</div><div class="line">          int sz = args.size();</div><div class="line">          for (int i = 0; i &lt; sz; i++) &#123;</div><div class="line">              if (args.get(i).indexOf(&apos;\n&apos;) &gt;= 0) &#123;</div><div class="line">                  throw new ZygoteStartFailedEx(&quot;embedded newlines not allowed&quot;);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          /**</div><div class="line">           * See com.android.internal.os.SystemZygoteInit.readArgumentList()</div><div class="line">           * Presently the wire format to the zygote process is:</div><div class="line">           * a) a count of arguments (argc, in essence)</div><div class="line">           * b) a number of newline-separated argument strings equal to count</div><div class="line">           *</div><div class="line">           * After the zygote process reads these it will write the pid of</div><div class="line">           * the child or -1 on failure, followed by boolean to</div><div class="line">           * indicate whether a wrapper process was used.</div><div class="line">           */</div><div class="line">          final BufferedWriter writer = zygoteState.writer;</div><div class="line">          final DataInputStream inputStream = zygoteState.inputStream;</div><div class="line"></div><div class="line">          writer.write(Integer.toString(args.size()));</div><div class="line">          writer.newLine();</div><div class="line"></div><div class="line">          for (int i = 0; i &lt; sz; i++) &#123;</div><div class="line">              String arg = args.get(i);</div><div class="line">              writer.write(arg);</div><div class="line">              writer.newLine();</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          writer.flush();</div><div class="line"></div><div class="line">          // Should there be a timeout on this?</div><div class="line">          Process.ProcessStartResult result = new Process.ProcessStartResult();</div><div class="line"></div><div class="line">          // Always read the entire result from the input stream to avoid leaving</div><div class="line">          // bytes in the stream for future process starts to accidentally stumble</div><div class="line">          // upon.</div><div class="line">	  //等待socket服务端（即zygote）返回新创建的进程pid</div><div class="line">          result.pid = inputStream.readInt();</div><div class="line">          result.usingWrapper = inputStream.readBoolean();</div><div class="line"></div><div class="line">          if (result.pid &lt; 0) &#123;</div><div class="line">              throw new ZygoteStartFailedEx(&quot;fork() failed&quot;);</div><div class="line">          &#125;</div><div class="line">          return result;</div><div class="line">      &#125; catch (IOException ex) &#123;</div><div class="line">          zygoteState.close();</div><div class="line">          throw new ZygoteStartFailedEx(ex);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>开启对zygote的写与读，发送args。注意此时还在AMS进程</p>
<p>这里就与之前android系统启动的文章相接了。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>这部分主要完成了以下几个工作：</p>
<ol>
<li>Launcher通过Binder进程间通信机制通知ActivityManagerService，它要启动一个Activity；</li>
<li>ActivityManagerService通过Binder进程间通信机制通知Launcher进入Paused状态–10中的startActivityLocked</li>
<li>暂停成功后通过Task管理保存新应用信息并向zygote发送消息进行分裂新进程。</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android系统/" rel="tag"># android系统</a>
          
            <a href="/tags/app启动/" rel="tag"># app启动</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/07/android应用层常见安全漏洞/" rel="next" title="android应用层常见安全漏洞">
                <i class="fa fa-chevron-left"></i> android应用层常见安全漏洞
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/10/18/android8-0-0源码分析-app启动2/" rel="prev" title="android8-0-0源码分析-app启动2">
                android8-0-0源码分析-app启动2 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/1.png"
               alt="imbaya" />
          <p class="site-author-name" itemprop="name">imbaya</p>
           
              <p class="site-description motion-element" itemprop="description">..........</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">101</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">77</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言补充"><span class="nav-number">1.</span> <span class="nav-text">前言补充</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#概览"><span class="nav-number">2.</span> <span class="nav-text">概览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开始"><span class="nav-number">3.</span> <span class="nav-text">开始</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Launcher3"><span class="nav-number">3.1.</span> <span class="nav-text">1-Launcher3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-startActivityForResult"><span class="nav-number">3.2.</span> <span class="nav-text">2-startActivityForResult</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-execStartActivity"><span class="nav-number">3.3.</span> <span class="nav-text">3-execStartActivity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4、5-startActivity、startActivityAsUser"><span class="nav-number">3.4.</span> <span class="nav-text">4、5-startActivity、startActivityAsUser</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-startActivityMayWait"><span class="nav-number">3.5.</span> <span class="nav-text">6-startActivityMayWait</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7、8-startActivityLocked、startActivity"><span class="nav-number">3.6.</span> <span class="nav-text">7、8-startActivityLocked、startActivity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9、10-startActivityUnchecked"><span class="nav-number">3.7.</span> <span class="nav-text">9、10-startActivityUnchecked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-resumeFocusedStackTopActivityLocked"><span class="nav-number">3.8.</span> <span class="nav-text">11-resumeFocusedStackTopActivityLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12、13-ActivityStack"><span class="nav-number">3.9.</span> <span class="nav-text">12、13-ActivityStack</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-startSpecificActivityLocked"><span class="nav-number">3.10.</span> <span class="nav-text">14-startSpecificActivityLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15、16、17-startProcessLocked"><span class="nav-number">3.11.</span> <span class="nav-text">15、16、17-startProcessLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18-start"><span class="nav-number">3.12.</span> <span class="nav-text">18-start</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#19、20-start、startViaZygote"><span class="nav-number">3.13.</span> <span class="nav-text">19、20-start、startViaZygote</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#21-zygoteSendArgsAndGetResult"><span class="nav-number">3.14.</span> <span class="nav-text">21-zygoteSendArgsAndGetResult</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后记"><span class="nav-number">4.</span> <span class="nav-text">后记</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">imbaya</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":100,"height":200,"hOffset":0,"vOffset":-50},"mobile":{"show":false},"react":{"opacityDefault":1,"opacityOnHover":1},"log":false});</script></body>
</html>
