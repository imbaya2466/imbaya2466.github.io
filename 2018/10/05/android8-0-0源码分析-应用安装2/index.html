<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android系统,apk安装," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="前言本篇介绍第三方apk安装的过程，重点放在dex的优化部分">
<meta name="keywords" content="android系统,apk安装">
<meta property="og:type" content="article">
<meta property="og:title" content="android8-0-0源码分析-应用安装2">
<meta property="og:url" content="http://yoursite.com/2018/10/05/android8-0-0源码分析-应用安装2/index.html">
<meta property="og:site_name" content="GGWP">
<meta property="og:description" content="前言本篇介绍第三方apk安装的过程，重点放在dex的优化部分">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.imgur.com/KKWNrEs.jpg">
<meta property="og:updated_time" content="2018-10-05T14:11:29.955Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android8-0-0源码分析-应用安装2">
<meta name="twitter:description" content="前言本篇介绍第三方apk安装的过程，重点放在dex的优化部分">
<meta name="twitter:image" content="https://i.imgur.com/KKWNrEs.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/10/05/android8-0-0源码分析-应用安装2/"/>





  <title>android8-0-0源码分析-应用安装2 | GGWP</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GGWP</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/05/android8-0-0源码分析-应用安装2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">android8-0-0源码分析-应用安装2</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-05T19:04:40+08:00">
                2018-10-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇介绍第三方apk安装的过程，重点放在dex的优化部分</p>
<a id="more"></a>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>uml图：<br><img src="https://i.imgur.com/KKWNrEs.jpg" alt=""></p>
<h3 id="1-触发安装部分"><a href="#1-触发安装部分" class="headerlink" title="1.触发安装部分"></a>1.触发安装部分</h3><p>启动代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Intent intent = new Intent(Intent.ACTION_VIEW);</div><div class="line">//设置intent的数据类型是应用程序application  </div><div class="line">intent.setDataAndType(Uri.parse(&quot;file://&quot; + apkfile.toString()), &quot;application/vnd.android.package-archive&quot;);</div><div class="line">//为这个新apk开启一个新的activity栈  </div><div class="line">intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">//开始安装  </div><div class="line">startActivity(intent);</div></pre></td></tr></table></figure>
<p>启动packageinstaller应用：InstallStart-Activity-&gt;PackageInstallerActivity-Activity-&gt;InstallInstalling-Activity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div></pre></td><td class="code"><pre><div class="line">public class InstallInstalling extends Activity &#123;</div><div class="line">    private static final String LOG_TAG = InstallInstalling.class.getSimpleName();</div><div class="line"></div><div class="line">    private static final String SESSION_ID = &quot;com.android.packageinstaller.SESSION_ID&quot;;</div><div class="line">    private static final String INSTALL_ID = &quot;com.android.packageinstaller.INSTALL_ID&quot;;</div><div class="line"></div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void onCreate(@Nullable Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line"></div><div class="line">        setContentView(R.layout.install_installing);</div><div class="line"></div><div class="line">        ApplicationInfo appInfo = getIntent()</div><div class="line">                .getParcelableExtra(PackageUtil.INTENT_ATTR_APPLICATION_INFO);</div><div class="line">        mPackageURI = getIntent().getData();</div><div class="line"></div><div class="line">        if (&quot;package&quot;.equals(mPackageURI.getScheme())) &#123;//查看是否是package路径Uri，发现明显不是</div><div class="line">            try &#123;</div><div class="line">                getPackageManager().installExistingPackage(appInfo.packageName);</div><div class="line">                launchSuccess();</div><div class="line">            &#125; catch (PackageManager.NameNotFoundException e) &#123;</div><div class="line">                launchFailure(PackageManager.INSTALL_FAILED_INTERNAL_ERROR, null);</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            final File sourceFile = new File(mPackageURI.getPath());</div><div class="line">            PackageUtil.initSnippetForNewApp(this, PackageUtil.getAppSnippet(this, appInfo,</div><div class="line">                    sourceFile), R.id.app_snippet);</div><div class="line"></div><div class="line">            if (savedInstanceState != null) &#123; //为null</div><div class="line">                mSessionId = savedInstanceState.getInt(SESSION_ID);</div><div class="line">                mInstallId = savedInstanceState.getInt(INSTALL_ID);</div><div class="line"></div><div class="line">                // Reregister for result; might instantly call back if result was delivered while</div><div class="line">                // activity was destroyed</div><div class="line">                try &#123;</div><div class="line">                    InstallEventReceiver.addObserver(this, mInstallId,</div><div class="line">                            this::launchFinishBasedOnResult);</div><div class="line">                &#125; catch (EventResultPersister.OutOfIdsException e) &#123;</div><div class="line">                    // Does not happen</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                PackageInstaller.SessionParams params = new PackageInstaller.SessionParams(</div><div class="line">                        PackageInstaller.SessionParams.MODE_FULL_INSTALL);</div><div class="line">                params.referrerUri = getIntent().getParcelableExtra(Intent.EXTRA_REFERRER);</div><div class="line">                params.originatingUri = getIntent()</div><div class="line">                        .getParcelableExtra(Intent.EXTRA_ORIGINATING_URI);</div><div class="line">                params.originatingUid = getIntent().getIntExtra(Intent.EXTRA_ORIGINATING_UID,</div><div class="line">                        UID_UNKNOWN);</div><div class="line"></div><div class="line">                File file = new File(mPackageURI.getPath());</div><div class="line">                try &#123;</div><div class="line">                    PackageParser.PackageLite pkg = PackageParser.parsePackageLite(file, 0);</div><div class="line">                    params.setAppPackageName(pkg.packageName);</div><div class="line">                    params.setInstallLocation(pkg.installLocation);</div><div class="line">                    params.setSize(</div><div class="line">                            PackageHelper.calculateInstalledSize(pkg, false, params.abiOverride));</div><div class="line">                &#125; catch (PackageParser.PackageParserException e) &#123;</div><div class="line">                    Log.e(LOG_TAG, &quot;Cannot parse package &quot; + file + &quot;. Assuming defaults.&quot;);</div><div class="line">                    Log.e(LOG_TAG,</div><div class="line">                            &quot;Cannot calculate installed size &quot; + file + &quot;. Try only apk size.&quot;);</div><div class="line">                    params.setSize(file.length());</div><div class="line">                &#125; catch (IOException e) &#123;</div><div class="line">                    Log.e(LOG_TAG,</div><div class="line">                            &quot;Cannot calculate installed size &quot; + file + &quot;. Try only apk size.&quot;);</div><div class="line">                    params.setSize(file.length());</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                try &#123;</div><div class="line">                    mInstallId = InstallEventReceiver</div><div class="line">                            .addObserver(this, EventResultPersister.GENERATE_NEW_ID,</div><div class="line">                                    this::launchFinishBasedOnResult);</div><div class="line">                &#125; catch (EventResultPersister.OutOfIdsException e) &#123;</div><div class="line">                    launchFailure(PackageManager.INSTALL_FAILED_INTERNAL_ERROR, null);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                try &#123;//在PackageInstaller创建用于通信的session，关于创建Seeion过程这里不再做叙述</div><div class="line">                    mSessionId = getPackageManager().getPackageInstaller().createSession(params);</div><div class="line">                &#125; catch (IOException e) &#123;</div><div class="line">                    launchFailure(PackageManager.INSTALL_FAILED_INTERNAL_ERROR, null);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mCancelButton = (Button) findViewById(R.id.cancel_button);</div><div class="line"></div><div class="line">            mCancelButton.setOnClickListener(view -&gt; &#123;</div><div class="line">                if (mInstallingTask != null) &#123;</div><div class="line">                    mInstallingTask.cancel(true);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if (mSessionId &gt; 0) &#123;</div><div class="line">                    getPackageManager().getPackageInstaller().abandonSession(mSessionId);</div><div class="line">                    mSessionId = 0;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                setResult(RESULT_CANCELED);</div><div class="line">                finish();</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            mSessionCallback = new InstallSessionCallback();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void onResume() &#123;</div><div class="line">        super.onResume();</div><div class="line"></div><div class="line">        // This is the first onResume in a single life of the activity</div><div class="line">        if (mInstallingTask == null) &#123;</div><div class="line">            PackageInstaller installer = getPackageManager().getPackageInstaller(); //获取PackageInstaller</div><div class="line">            PackageInstaller.SessionInfo sessionInfo = installer.getSessionInfo(mSessionId);//根据在onCreate中创建的SeesionID获取相应session信息</div><div class="line"></div><div class="line">            if (sessionInfo != null &amp;&amp; !sessionInfo.isActive()) &#123;</div><div class="line">                mInstallingTask = new InstallingAsyncTask(); //创建异步任务</div><div class="line">                mInstallingTask.execute(); //执行异步任务</div><div class="line">            &#125; else &#123;</div><div class="line">                // we will receive a broadcast when the install is finished</div><div class="line">                mCancelButton.setEnabled(false);</div><div class="line">                setFinishOnTouchOutside(false);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private final class InstallingAsyncTask extends AsyncTask&lt;Void, Void,</div><div class="line">                PackageInstaller.Session&gt; &#123;</div><div class="line">        volatile boolean isDone;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        protected PackageInstaller.Session doInBackground(Void... params) &#123;</div><div class="line">            PackageInstaller.Session session;</div><div class="line">            try &#123;//根据SessionId打开PackageInstaller端Session</div><div class="line">                session = getPackageManager().getPackageInstaller().openSession(mSessionId);</div><div class="line">            &#125; catch (IOException e) &#123;</div><div class="line">                return null;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            session.setStagingProgress(0);</div><div class="line"></div><div class="line">            try &#123;</div><div class="line">                File file = new File(mPackageURI.getPath());//获取APK安装包</div><div class="line"></div><div class="line">                try (InputStream in = new FileInputStream(file)) &#123;</div><div class="line">                    long sizeBytes = file.length();</div><div class="line">                    try (OutputStream out = session</div><div class="line">                            .openWrite(&quot;PackageInstaller&quot;, 0, sizeBytes)) &#123;</div><div class="line">                        byte[] buffer = new byte[1024 * 1024];</div><div class="line">                        while (true) &#123;//读取APK，并通过Session传递APK安装包</div><div class="line">                            int numRead = in.read(buffer);</div><div class="line"></div><div class="line">                            if (numRead == -1) &#123;</div><div class="line">                                session.fsync(out);</div><div class="line">                                break;</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            if (isCancelled()) &#123;</div><div class="line">                                session.close();</div><div class="line">                                break;</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            out.write(buffer, 0, numRead);</div><div class="line">                            if (sizeBytes &gt; 0) &#123;</div><div class="line">                                float fraction = ((float) numRead / (float) sizeBytes);</div><div class="line">                                session.addProgress(fraction);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                return session;</div><div class="line">            &#125; catch (IOException | SecurityException e) &#123;</div><div class="line">                Log.e(LOG_TAG, &quot;Could not write package&quot;, e);</div><div class="line"></div><div class="line">                session.close();</div><div class="line"></div><div class="line">                return null;</div><div class="line">            &#125; finally &#123;</div><div class="line">                synchronized (this) &#123;</div><div class="line">                    isDone = true;</div><div class="line">                    notifyAll();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        protected void onPostExecute(PackageInstaller.Session session) &#123;</div><div class="line">            if (session != null) &#123;</div><div class="line">                Intent broadcastIntent = new Intent(BROADCAST_ACTION);</div><div class="line">                broadcastIntent.setFlags(Intent.FLAG_RECEIVER_FOREGROUND);</div><div class="line">                broadcastIntent.setPackage(</div><div class="line">                        getPackageManager().getPermissionControllerPackageName());</div><div class="line">                broadcastIntent.putExtra(EventResultPersister.EXTRA_ID, mInstallId);</div><div class="line"></div><div class="line">                PendingIntent pendingIntent = PendingIntent.getBroadcast(</div><div class="line">                        InstallInstalling.this,</div><div class="line">                        mInstallId,</div><div class="line">                        broadcastIntent,</div><div class="line">                        PendingIntent.FLAG_UPDATE_CURRENT);</div><div class="line"></div><div class="line">                session.commit(pendingIntent.getIntentSender());//托付给PackageInstaller.Session</div><div class="line">                mCancelButton.setEnabled(false);</div><div class="line">                setFinishOnTouchOutside(false);</div><div class="line">            &#125; else &#123;</div><div class="line">                getPackageManager().getPackageInstaller().abandonSession(mSessionId);</div><div class="line"></div><div class="line">                if (!isCancelled()) &#123;</div><div class="line">                    launchFailure(PackageManager.INSTALL_FAILED_INVALID_APK, null);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>获取PackageManager，然后获取其中的PackageInstaller对象</li>
<li>在PackageInstaller中创建用于传输APK安装包以及安装信息的Session，并返回SessionId</li>
<li>创建异步任务，并在异步任务中根据之前返回的SessionId打开PackageInstaller端Session</li>
<li>通过Session将APK安装包以及相关信息传递</li>
<li>在异步任务中onPostExecute方法中执行session.commit(pendingIntent.getIntentSender())</li>
</ol>
<p>PackageInstaller.Session是记录安装信息的，保证可以继续安装。</p>
<p>调用到PackageInstallerSession的commit。<br>mHandler.obtainMessage(MSG_COMMIT).sendToTarget();<br>commitLocked();</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">private void commitLocked()</div><div class="line">        throws PackageManagerException &#123;</div><div class="line">    if (mDestroyed) &#123;</div><div class="line">        throw new PackageManagerException(INSTALL_FAILED_INTERNAL_ERROR, &quot;Session destroyed&quot;);</div><div class="line">    &#125;</div><div class="line">    if (!mSealed) &#123;</div><div class="line">        throw new PackageManagerException(INSTALL_FAILED_INTERNAL_ERROR, &quot;Session not sealed&quot;);</div><div class="line">    &#125;</div><div class="line">    Preconditions.checkNotNull(mPackageName);</div><div class="line">    Preconditions.checkNotNull(mSignatures);</div><div class="line">    Preconditions.checkNotNull(mResolvedBaseFile);</div><div class="line">   .....</div><div class="line">    mRelinquished = true;</div><div class="line">    mPm.installStage(mPackageName, stageDir, stageCid, localObserver, params,</div><div class="line">            mInstallerPackageName, mInstallerUid, user, mCertificates);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>mPm.installStage(mPackageName, stageDir, stageCid, localObserver, params,mInstallerPackageName, mInstallerUid, user, mCertificates);</p>
<h3 id="4-installStage"><a href="#4-installStage" class="headerlink" title="4.installStage"></a>4.installStage</h3><p>PackageManagerServices开始</p>
<p>frameworks\base\services\core\java\com\android\server\pm\PackageManagerService.java</p>
<p>PackageManagerServices.installStage：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">void installStage(String packageName, File stagedDir, String stagedCid,</div><div class="line">        IPackageInstallObserver2 observer, PackageInstaller.SessionParams sessionParams,</div><div class="line">        String installerPackageName, int installerUid, UserHandle user,</div><div class="line">        Certificate[][] certificates) &#123;</div><div class="line">    if (DEBUG_EPHEMERAL) &#123;</div><div class="line">        if ((sessionParams.installFlags &amp; PackageManager.INSTALL_INSTANT_APP) != 0) &#123;</div><div class="line">            Slog.d(TAG, &quot;Ephemeral install of &quot; + packageName);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    final VerificationInfo verificationInfo = new VerificationInfo(</div><div class="line">            sessionParams.originatingUri, sessionParams.referrerUri,</div><div class="line">            sessionParams.originatingUid, installerUid);</div><div class="line"></div><div class="line">    final OriginInfo origin;</div><div class="line">    if (stagedDir != null) &#123;</div><div class="line">        origin = OriginInfo.fromStagedFile(stagedDir);</div><div class="line">    &#125; else &#123;</div><div class="line">        origin = OriginInfo.fromStagedContainer(stagedCid);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    final Message msg = mHandler.obtainMessage(INIT_COPY);</div><div class="line">    final int installReason = fixUpInstallReason(installerPackageName, installerUid,</div><div class="line">            sessionParams.installReason);</div><div class="line">    final InstallParams params = new InstallParams(origin, null, observer,</div><div class="line">            sessionParams.installFlags, installerPackageName, sessionParams.volumeUuid,</div><div class="line">            verificationInfo, user, sessionParams.abiOverride,</div><div class="line">            sessionParams.grantedRuntimePermissions, certificates, installReason);</div><div class="line">    params.setTraceMethod(&quot;installStage&quot;).setTraceCookie(System.identityHashCode(params));</div><div class="line">    msg.obj = params;</div><div class="line"></div><div class="line">    Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, &quot;installStage&quot;,</div><div class="line">            System.identityHashCode(msg.obj));</div><div class="line">    Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, &quot;queueInstall&quot;,</div><div class="line">            System.identityHashCode(msg.obj));</div><div class="line"></div><div class="line">    mHandler.sendMessage(msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>发送INIT_COPY消息</p>
<h3 id="5-INIT-COPY"><a href="#5-INIT-COPY" class="headerlink" title="5.INIT_COPY"></a>5.INIT_COPY</h3><p>PackageManagerServices.PackageHandler.doHandleMessage：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">     void doHandleMessage(Message msg) &#123;</div><div class="line">         switch (msg.what) &#123;</div><div class="line">             case INIT_COPY: &#123;</div><div class="line">                 HandlerParams params = (HandlerParams) msg.obj;</div><div class="line">                 int idx = mPendingInstalls.size();</div><div class="line">                 if (DEBUG_INSTALL) Slog.i(TAG, &quot;init_copy idx=&quot; + idx + &quot;: &quot; + params);</div><div class="line">                 // If a bind was already initiated we dont really</div><div class="line">                 // need to do anything. The pending install</div><div class="line">                 // will be processed later on.</div><div class="line">                 if (!mBound) &#123;</div><div class="line">                     Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, &quot;bindingMCS&quot;,</div><div class="line">                             System.identityHashCode(mHandler));</div><div class="line">                     // If this is the only one pending we might</div><div class="line">                     // have to bind to the service again.</div><div class="line">			//连接服务</div><div class="line">                     if (!connectToService()) &#123;</div><div class="line">                         Slog.e(TAG, &quot;Failed to bind to media container service&quot;);</div><div class="line">                         params.serviceError();</div><div class="line">                         Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, &quot;bindingMCS&quot;,</div><div class="line">                                 System.identityHashCode(mHandler));</div><div class="line">                         if (params.traceMethod != null) &#123;</div><div class="line">                             Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, params.traceMethod,</div><div class="line">                                     params.traceCookie);</div><div class="line">                         &#125;</div><div class="line">                         return;</div><div class="line">                     &#125; else &#123;</div><div class="line">                         // Once we bind to the service, the first</div><div class="line">                         // pending request will be processed.</div><div class="line">                         mPendingInstalls.add(idx, params);</div><div class="line">                     &#125;</div><div class="line">                 &#125; else &#123;</div><div class="line">                     mPendingInstalls.add(idx, params);</div><div class="line">                     // Already bound to the service. Just make</div><div class="line">                     // sure we trigger off processing the first request.</div><div class="line">                     if (idx == 0) &#123;</div><div class="line">                         mHandler.sendEmptyMessage(MCS_BOUND);</div><div class="line">                     &#125;</div><div class="line">                 &#125;</div><div class="line">                 break;</div><div class="line">             &#125;</div><div class="line">	</div><div class="line">......</div></pre></td></tr></table></figure>
<p>最后发送了一个MCS_BOUND</p>
<h3 id="6-MCS-BOUND"><a href="#6-MCS-BOUND" class="headerlink" title="6.MCS_BOUND"></a>6.MCS_BOUND</h3><p>PackageManagerServices.PackageHandler.doHandleMessage：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">case MCS_BOUND: &#123;</div><div class="line">    if (DEBUG_INSTALL) Slog.i(TAG, &quot;mcs_bound&quot;);</div><div class="line">    if (msg.obj != null) &#123;</div><div class="line">        mContainerService = (IMediaContainerService) msg.obj;</div><div class="line">        Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, &quot;bindingMCS&quot;,</div><div class="line">                System.identityHashCode(mHandler));</div><div class="line">    &#125;</div><div class="line">    if (mContainerService == null) &#123;</div><div class="line">        if (!mBound) &#123;</div><div class="line">            // Something seriously wrong since we are not bound and we are not</div><div class="line">            // waiting for connection. Bail out.</div><div class="line">            Slog.e(TAG, &quot;Cannot bind to media container service&quot;);</div><div class="line">            for (HandlerParams params : mPendingInstalls) &#123;</div><div class="line">                // Indicate service bind error</div><div class="line">                params.serviceError();</div><div class="line">                Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, &quot;queueInstall&quot;,</div><div class="line">                        System.identityHashCode(params));</div><div class="line">                if (params.traceMethod != null) &#123;</div><div class="line">                    Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER,</div><div class="line">                            params.traceMethod, params.traceCookie);</div><div class="line">                &#125;</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">            mPendingInstalls.clear();</div><div class="line">        &#125; else &#123;</div><div class="line">            Slog.w(TAG, &quot;Waiting to connect to media container service&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125; else if (mPendingInstalls.size() &gt; 0) &#123;</div><div class="line">        HandlerParams params = mPendingInstalls.get(0);</div><div class="line">        if (params != null) &#123;</div><div class="line">            Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, &quot;queueInstall&quot;,</div><div class="line">                    System.identityHashCode(params));</div><div class="line">            Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, &quot;startCopy&quot;);</div><div class="line">            if (params.startCopy()) &#123;</div><div class="line">                // We are done...  look for more work or to</div><div class="line">                // go idle.</div><div class="line">                if (DEBUG_SD_INSTALL) Log.i(TAG,</div><div class="line">                        &quot;Checking for more work or unbind...&quot;);</div><div class="line">                // Delete pending install</div><div class="line">                if (mPendingInstalls.size() &gt; 0) &#123;</div><div class="line">                    mPendingInstalls.remove(0);</div><div class="line">                &#125;</div><div class="line">                if (mPendingInstalls.size() == 0) &#123;</div><div class="line">                    if (mBound) &#123;</div><div class="line">                        if (DEBUG_SD_INSTALL) Log.i(TAG,</div><div class="line">                                &quot;Posting delayed MCS_UNBIND&quot;);</div><div class="line">                        removeMessages(MCS_UNBIND);</div><div class="line">                        Message ubmsg = obtainMessage(MCS_UNBIND);</div><div class="line">                        // Unbind after a little delay, to avoid</div><div class="line">                        // continual thrashing.</div><div class="line">                        sendMessageDelayed(ubmsg, 10000);</div><div class="line">                    &#125;</div><div class="line">                &#125; else &#123;</div><div class="line">                    // There are more pending requests in queue.</div><div class="line">                    // Just post MCS_BOUND message to trigger processing</div><div class="line">                    // of next pending install.</div><div class="line">                    if (DEBUG_SD_INSTALL) Log.i(TAG,</div><div class="line">                            &quot;Posting MCS_BOUND for next work&quot;);</div><div class="line">                    mHandler.sendEmptyMessage(MCS_BOUND);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        // Should never happen ideally.</div><div class="line">        Slog.w(TAG, &quot;Empty queue&quot;);</div><div class="line">    &#125;</div><div class="line">    break;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="7-startCopy"><a href="#7-startCopy" class="headerlink" title="7.startCopy"></a>7.startCopy</h3><p>PackageManagerServices.HandlerParams.startCopy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">final boolean startCopy() &#123;</div><div class="line">    boolean res;</div><div class="line">    try &#123;</div><div class="line">        if (DEBUG_INSTALL) Slog.i(TAG, &quot;startCopy &quot; + mUser + &quot;: &quot; + this);</div><div class="line"></div><div class="line">        if (++mRetries &gt; MAX_RETRIES) &#123;</div><div class="line">            Slog.w(TAG, &quot;Failed to invoke remote methods on default container service. Giving up&quot;);</div><div class="line">            mHandler.sendEmptyMessage(MCS_GIVE_UP);</div><div class="line">            handleServiceError();</div><div class="line">            return false;</div><div class="line">        &#125; else &#123;</div><div class="line">            handleStartCopy();</div><div class="line">            res = true;</div><div class="line">        &#125;</div><div class="line">    &#125; catch (RemoteException e) &#123;</div><div class="line">        if (DEBUG_INSTALL) Slog.i(TAG, &quot;Posting install MCS_RECONNECT&quot;);</div><div class="line">        mHandler.sendEmptyMessage(MCS_RECONNECT);</div><div class="line">        res = false;</div><div class="line">    &#125;</div><div class="line">    handleReturnCode();</div><div class="line">    return res;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重点俩步操作handleStartCopy与handleReturnCode。</p>
<h3 id="8-handleStartCopy"><a href="#8-handleStartCopy" class="headerlink" title="8.handleStartCopy"></a>8.handleStartCopy</h3><p>PackageManagerServices.InstallParams.handleStartCopy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">     /*</div><div class="line">      * Invoke remote method to get package information and install</div><div class="line">      * location values. Override install location based on default</div><div class="line">      * policy if needed and then create install arguments based</div><div class="line">      * on the install location.</div><div class="line">      */</div><div class="line">     public void handleStartCopy() throws RemoteException &#123;</div><div class="line">         int ret = PackageManager.INSTALL_SUCCEEDED;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">         final boolean onSd = (installFlags &amp; PackageManager.INSTALL_EXTERNAL) != 0;</div><div class="line">         final boolean onInt = (installFlags &amp; PackageManager.INSTALL_INTERNAL) != 0;</div><div class="line">         final boolean ephemeral = (installFlags &amp; PackageManager.INSTALL_INSTANT_APP) != 0;</div><div class="line">         PackageInfoLite pkgLite = null;</div><div class="line"></div><div class="line">         if (onInt &amp;&amp; onSd) &#123;</div><div class="line">             // Check if both bits are set.</div><div class="line">             Slog.w(TAG, &quot;Conflicting flags specified for installing on both internal and external&quot;);</div><div class="line">             ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</div><div class="line">         &#125; else if (onSd &amp;&amp; ephemeral) &#123;</div><div class="line">             Slog.w(TAG,  &quot;Conflicting flags specified for installing ephemeral on external&quot;);</div><div class="line">             ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</div><div class="line">         &#125; else &#123;</div><div class="line">             pkgLite = mContainerService.getMinimalPackageInfo(origin.resolvedPath, installFlags,</div><div class="line">                     packageAbiOverride);</div><div class="line"></div><div class="line">             if (DEBUG_EPHEMERAL &amp;&amp; ephemeral) &#123;</div><div class="line">                 Slog.v(TAG, &quot;pkgLite for install: &quot; + pkgLite);</div><div class="line">             &#125;</div><div class="line"></div><div class="line">             /*</div><div class="line">              * If we have too little free space, try to free cache</div><div class="line">              * before giving up.</div><div class="line">              */</div><div class="line">             if (!origin.staged &amp;&amp; pkgLite.recommendedInstallLocation</div><div class="line">                     == PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE) &#123;</div><div class="line">                 // TODO: focus freeing disk space on the target device</div><div class="line">                 final StorageManager storage = StorageManager.from(mContext);</div><div class="line">                 final long lowThreshold = storage.getStorageLowBytes(</div><div class="line">                         Environment.getDataDirectory());</div><div class="line"></div><div class="line">                 final long sizeBytes = mContainerService.calculateInstalledSize(</div><div class="line">                         origin.resolvedPath, isForwardLocked(), packageAbiOverride);</div><div class="line"></div><div class="line">                 try &#123;</div><div class="line">                     mInstaller.freeCache(null, sizeBytes + lowThreshold, 0, 0);</div><div class="line">                     pkgLite = mContainerService.getMinimalPackageInfo(origin.resolvedPath,</div><div class="line">                             installFlags, packageAbiOverride);</div><div class="line">                 &#125; catch (InstallerException e) &#123;</div><div class="line">                     Slog.w(TAG, &quot;Failed to free cache&quot;, e);</div><div class="line">                 &#125;</div><div class="line"></div><div class="line">                 /*</div><div class="line">                  * The cache free must have deleted the file we</div><div class="line">                  * downloaded to install.</div><div class="line">                  *</div><div class="line">                  * TODO: fix the &quot;freeCache&quot; call to not delete</div><div class="line">                  *       the file we care about.</div><div class="line">                  */</div><div class="line">                 if (pkgLite.recommendedInstallLocation</div><div class="line">                         == PackageHelper.RECOMMEND_FAILED_INVALID_URI) &#123;</div><div class="line">                     pkgLite.recommendedInstallLocation</div><div class="line">                         = PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE;</div><div class="line">                 &#125;</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">                 /*</div><div class="line">                  * No package verification is enabled, so immediately start</div><div class="line">                  * the remote call to initiate copy using temporary file.</div><div class="line">                  */</div><div class="line">                 ret = args.copyApk(mContainerService, true);</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         mRet = ret;</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<p>handleStartCopy的核心是copyApk,其他的都是些存储空间检查,权限检查等等安全校验。</p>
<h3 id="9-handleReturnCode"><a href="#9-handleReturnCode" class="headerlink" title="9.handleReturnCode"></a>9.handleReturnCode</h3><p>PackageManagerServices.InstallParams.handleReturnCode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">void handleReturnCode() &#123;</div><div class="line">    // If mArgs is null, then MCS couldn&apos;t be reached. When it</div><div class="line">    // reconnects, it will try again to install. At that point, this</div><div class="line">    // will succeed.</div><div class="line">    if (mArgs != null) &#123;</div><div class="line">        processPendingInstall(mArgs, mRet);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调回PackageManagerServices</p>
<h3 id="10-processPendingInstall"><a href="#10-processPendingInstall" class="headerlink" title="10.processPendingInstall"></a>10.processPendingInstall</h3><p>PackageManagerServices.processPendingInstall</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">private void processPendingInstall(final InstallArgs args, final int currentStatus) &#123;</div><div class="line">    // Queue up an async operation since the package installation may take a little while.</div><div class="line">    mHandler.post(new Runnable() &#123;</div><div class="line">        public void run() &#123;</div><div class="line">            mHandler.removeCallbacks(this);</div><div class="line">             // Result object to be returned</div><div class="line">            PackageInstalledInfo res = new PackageInstalledInfo();</div><div class="line">            res.setReturnCode(currentStatus);</div><div class="line">            res.uid = -1;</div><div class="line">            res.pkg = null;</div><div class="line">            res.removedInfo = null;</div><div class="line">            if (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</div><div class="line">                args.doPreInstall(res.returnCode);//删除安装残留文件</div><div class="line">                synchronized (mInstallLock) &#123;</div><div class="line">                    installPackageTracedLI(args, res);//安装apk</div><div class="line">                &#125;</div><div class="line">                args.doPostInstall(res.returnCode, res.uid);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // A restore should be performed at this point if (a) the install</div><div class="line">            // succeeded, (b) the operation is not an update, and (c) the new</div><div class="line">            // package has not opted out of backup participation.</div><div class="line">            final boolean update = res.removedInfo != null</div><div class="line">                    &amp;&amp; res.removedInfo.removedPackage != null;</div><div class="line">            final int flags = (res.pkg == null) ? 0 : res.pkg.applicationInfo.flags;</div><div class="line">            boolean doRestore = !update</div><div class="line">                    &amp;&amp; ((flags &amp; ApplicationInfo.FLAG_ALLOW_BACKUP) != 0);</div><div class="line"></div><div class="line">            // Set up the post-install work request bookkeeping.  This will be used</div><div class="line">            // and cleaned up by the post-install event handling regardless of whether</div><div class="line">            // there&apos;s a restore pass performed.  Token values are &gt;= 1.</div><div class="line">            int token;</div><div class="line">            if (mNextInstallToken &lt; 0) mNextInstallToken = 1;</div><div class="line">            token = mNextInstallToken++;</div><div class="line"></div><div class="line">            PostInstallData data = new PostInstallData(args, res);</div><div class="line">            mRunningInstalls.put(token, data);</div><div class="line">            if (DEBUG_INSTALL) Log.v(TAG, &quot;+ starting restore round-trip &quot; + token);</div><div class="line"></div><div class="line">            if (res.returnCode == PackageManager.INSTALL_SUCCEEDED &amp;&amp; doRestore) &#123;</div><div class="line">                // Pass responsibility to the Backup Manager.  It will perform a</div><div class="line">                // restore if appropriate, then pass responsibility back to the</div><div class="line">                // Package Manager to run the post-install observer callbacks</div><div class="line">                // and broadcasts.</div><div class="line">                IBackupManager bm = IBackupManager.Stub.asInterface(</div><div class="line">                        ServiceManager.getService(Context.BACKUP_SERVICE));</div><div class="line">                if (bm != null) &#123;</div><div class="line">                    if (DEBUG_INSTALL) Log.v(TAG, &quot;token &quot; + token</div><div class="line">                            + &quot; to BM for possible restore&quot;);</div><div class="line">                    Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, &quot;restore&quot;, token);</div><div class="line">                    try &#123;</div><div class="line">                        // TODO: http://b/22388012</div><div class="line">                        if (bm.isBackupServiceActive(UserHandle.USER_SYSTEM)) &#123;</div><div class="line">                            bm.restoreAtInstall(res.pkg.applicationInfo.packageName, token);//完成安装</div><div class="line">                        &#125; else &#123;</div><div class="line">                            doRestore = false;</div><div class="line">                        &#125;</div><div class="line">                    &#125; catch (RemoteException e) &#123;</div><div class="line">                        // can&apos;t happen; the backup manager is local</div><div class="line">                    &#125; catch (Exception e) &#123;</div><div class="line">                        Slog.e(TAG, &quot;Exception trying to enqueue restore&quot;, e);</div><div class="line">                        doRestore = false;</div><div class="line">                    &#125;</div><div class="line">                &#125; else &#123;</div><div class="line">                    Slog.e(TAG, &quot;Backup Manager not found!&quot;);</div><div class="line">                    doRestore = false;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (!doRestore) &#123;</div><div class="line">                // No restore possible, or the Backup Manager was mysteriously not</div><div class="line">                // available -- just fire the post-install work request directly.</div><div class="line">                if (DEBUG_INSTALL) Log.v(TAG, &quot;No restore - queue post-install for &quot; + token);</div><div class="line"></div><div class="line">                Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, &quot;postInstall&quot;, token);</div><div class="line"></div><div class="line">                Message msg = mHandler.obtainMessage(POST_INSTALL, token, 0);</div><div class="line">                mHandler.sendMessage(msg);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用installPackageTracedLI<br>最后发送POST_INSTALL消息表示安装成功。</p>
<h3 id="11-installPackageTracedLI"><a href="#11-installPackageTracedLI" class="headerlink" title="11.installPackageTracedLI"></a>11.installPackageTracedLI</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div></pre></td><td class="code"><pre><div class="line">  private void installPackageTracedLI(InstallArgs args, PackageInstalledInfo res) &#123;</div><div class="line">      try &#123;</div><div class="line">          Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, &quot;installPackage&quot;);</div><div class="line">          installPackageLI(args, res);</div><div class="line">      &#125; finally &#123;</div><div class="line">          Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">	</div><div class="line">	</div><div class="line">  private void installPackageLI(InstallArgs args, PackageInstalledInfo res) &#123;</div><div class="line"></div><div class="line">	</div><div class="line">......</div><div class="line"></div><div class="line"></div><div class="line">      if (args.move != null) &#123;</div><div class="line">          // We did an in-place move, so dex is ready to roll</div><div class="line">          scanFlags |= SCAN_NO_DEX;</div><div class="line">          scanFlags |= SCAN_MOVE;</div><div class="line"></div><div class="line">          synchronized (mPackages) &#123;</div><div class="line">              final PackageSetting ps = mSettings.mPackages.get(pkgName);</div><div class="line">              if (ps == null) &#123;</div><div class="line">                  res.setError(INSTALL_FAILED_INTERNAL_ERROR,</div><div class="line">                          &quot;Missing settings for moved package &quot; + pkgName);</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              // We moved the entire application as-is, so bring over the</div><div class="line">              // previously derived ABI information.</div><div class="line">              pkg.applicationInfo.primaryCpuAbi = ps.primaryCpuAbiString;</div><div class="line">              pkg.applicationInfo.secondaryCpuAbi = ps.secondaryCpuAbiString;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">      &#125; else if (!forwardLocked &amp;&amp; !pkg.applicationInfo.isExternalAsec()) &#123;</div><div class="line">          // Enable SCAN_NO_DEX flag to skip dexopt at a later stage</div><div class="line">          scanFlags |= SCAN_NO_DEX;</div><div class="line"></div><div class="line">          try &#123;</div><div class="line">              String abiOverride = (TextUtils.isEmpty(pkg.cpuAbiOverride) ?</div><div class="line">                  args.abiOverride : pkg.cpuAbiOverride);</div><div class="line">              final boolean extractNativeLibs = !pkg.isLibrary();</div><div class="line">              derivePackageAbi(pkg, new File(pkg.codePath), abiOverride,</div><div class="line">                      extractNativeLibs, mAppLib32InstallDir);</div><div class="line">          &#125; catch (PackageManagerException pme) &#123;</div><div class="line">              Slog.e(TAG, &quot;Error deriving application ABI&quot;, pme);</div><div class="line">              res.setError(INSTALL_FAILED_INTERNAL_ERROR, &quot;Error deriving application ABI&quot;);</div><div class="line">              return;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          // Shared libraries for the package need to be updated.</div><div class="line">          synchronized (mPackages) &#123;</div><div class="line">              try &#123;</div><div class="line">                  updateSharedLibrariesLPr(pkg, null);</div><div class="line">              &#125; catch (PackageManagerException e) &#123;</div><div class="line">                  Slog.e(TAG, &quot;updateAllSharedLibrariesLPw failed: &quot; + e.getMessage());</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          // dexopt can take some time to complete, so, for instant apps, we skip this</div><div class="line">          // step during installation. Instead, we&apos;ll take extra time the first time the</div><div class="line">          // instant app starts. It&apos;s preferred to do it this way to provide continuous</div><div class="line">          // progress to the user instead of mysteriously blocking somewhere in the</div><div class="line">          // middle of running an instant app. The default behaviour can be overridden</div><div class="line">          // via gservices.</div><div class="line">          if (!instantApp || Global.getInt(</div><div class="line">                      mContext.getContentResolver(), Global.INSTANT_APP_DEXOPT_ENABLED, 0) != 0) &#123;</div><div class="line">              Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, &quot;dexopt&quot;);</div><div class="line">              // Do not run PackageDexOptimizer through the local performDexOpt</div><div class="line">              // method because `pkg` may not be in `mPackages` yet.</div><div class="line">              //</div><div class="line">              // Also, don&apos;t fail application installs if the dexopt step fails.</div><div class="line">		//dexopt操作！！！！！！！！！！！！！！！！！！</div><div class="line">              mPackageDexOptimizer.performDexOpt(pkg, pkg.usesLibraryFiles,</div><div class="line">                      null /* instructionSets */, false /* checkProfiles */,</div><div class="line">                      getCompilerFilterForReason(REASON_INSTALL),</div><div class="line">                      getOrCreateCompilerPackageStats(pkg),</div><div class="line">                      mDexManager.isUsedByOtherApps(pkg.packageName));</div><div class="line">              Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          // Notify BackgroundDexOptService that the package has been changed.</div><div class="line">          // If this is an update of a package which used to fail to compile,</div><div class="line">          // BDOS will remove it from its blacklist.</div><div class="line">          // TODO: Layering violation</div><div class="line">          BackgroundDexOptService.notifyPackageChanged(pkg.packageName);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (!args.doRename(res.returnCode, pkg, oldCodePath)) &#123;</div><div class="line">          res.setError(INSTALL_FAILED_INSUFFICIENT_STORAGE, &quot;Failed rename&quot;);</div><div class="line">          return;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      startIntentFilterVerifications(args.user.getIdentifier(), replace, pkg);</div><div class="line"></div><div class="line">      try (PackageFreezer freezer = freezePackageForInstall(pkgName, installFlags,</div><div class="line">              &quot;installPackageLI&quot;)) &#123;</div><div class="line">          if (replace) &#123;</div><div class="line">              if (pkg.applicationInfo.isStaticSharedLibrary()) &#123;</div><div class="line">                  // Static libs have a synthetic package name containing the version</div><div class="line">                  // and cannot be updated as an update would get a new package name,</div><div class="line">                  // unless this is the exact same version code which is useful for</div><div class="line">                  // development.</div><div class="line">                  PackageParser.Package existingPkg = mPackages.get(pkg.packageName);</div><div class="line">                  if (existingPkg != null &amp;&amp; existingPkg.mVersionCode != pkg.mVersionCode) &#123;</div><div class="line">                      res.setError(INSTALL_FAILED_DUPLICATE_PACKAGE, &quot;Packages declaring &quot;</div><div class="line">                              + &quot;static-shared libs cannot be updated&quot;);</div><div class="line">                      return;</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">		//更新已经存在的packages</div><div class="line">              replacePackageLIF(pkg, parseFlags, scanFlags | SCAN_REPLACING, args.user,</div><div class="line">                      installerPackageName, res, args.installReason);</div><div class="line">          &#125; else &#123;</div><div class="line">		//安装新的packages</div><div class="line">              installNewPackageLIF(pkg, parseFlags, scanFlags | SCAN_DELETE_DATA_ON_FAILURES,</div><div class="line">                      args.user, installerPackageName, volumeUuid, res, args.installReason);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      synchronized (mPackages) &#123;</div><div class="line">          final PackageSetting ps = mSettings.mPackages.get(pkgName);</div><div class="line">          if (ps != null) &#123;</div><div class="line">              res.newUsers = ps.queryInstalledUsers(sUserManager.getUserIds(), true);</div><div class="line">              ps.setUpdateAvailable(false /*updateAvailable*/);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          final int childCount = (pkg.childPackages != null) ? pkg.childPackages.size() : 0;</div><div class="line">          for (int i = 0; i &lt; childCount; i++) &#123;</div><div class="line">              PackageParser.Package childPkg = pkg.childPackages.get(i);</div><div class="line">              PackageInstalledInfo childRes = res.addedChildPackages.get(childPkg.packageName);</div><div class="line">              PackageSetting childPs = mSettings.getPackageLPr(childPkg.packageName);</div><div class="line">              if (childPs != null) &#123;</div><div class="line">                  childRes.newUsers = childPs.queryInstalledUsers(</div><div class="line">                          sUserManager.getUserIds(), true);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          if (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</div><div class="line">              updateSequenceNumberLP(ps, res.newUsers);</div><div class="line">              updateInstantAppInstallerLocked(pkgName);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>installPackageTracedLI方法将apk进行解析，然后进行dex到opt文件操作，之后安装apk<br>这个方法先是解析了package包,然后做了大量签名和权限校验的工作。</p>
<h3 id="12-installNewPackageLIF"><a href="#12-installNewPackageLIF" class="headerlink" title="12.installNewPackageLIF"></a>12.installNewPackageLIF</h3><p>PackageManagerServices.installNewPackageLIF：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/*</div><div class="line"> * Install a non-existing package.</div><div class="line"> */</div><div class="line">private void installNewPackageLIF(PackageParser.Package pkg, final int policyFlags,</div><div class="line">        int scanFlags, UserHandle user, String installerPackageName, String volumeUuid,</div><div class="line">        PackageInstalledInfo res, int installReason) &#123;</div><div class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, &quot;installNewPackage&quot;);</div><div class="line"></div><div class="line">    // Remember this for later, in case we need to rollback this install</div><div class="line">    String pkgName = pkg.packageName;</div><div class="line"></div><div class="line">    if (DEBUG_INSTALL) Slog.d(TAG, &quot;installNewPackageLI: &quot; + pkg);</div><div class="line"></div><div class="line">    synchronized(mPackages) &#123;</div><div class="line">        final String renamedPackage = mSettings.getRenamedPackageLPr(pkgName);</div><div class="line">        if (renamedPackage != null) &#123;</div><div class="line">            // A package with the same name is already installed, though</div><div class="line">            // it has been renamed to an older name.  The package we</div><div class="line">            // are trying to install should be installed as an update to</div><div class="line">            // the existing one, but that has not been requested, so bail.</div><div class="line">            res.setError(INSTALL_FAILED_ALREADY_EXISTS, &quot;Attempt to re-install &quot; + pkgName</div><div class="line">                    + &quot; without first uninstalling package running as &quot;</div><div class="line">                    + renamedPackage);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        if (mPackages.containsKey(pkgName)) &#123;</div><div class="line">            // Don&apos;t allow installation over an existing package with the same name.</div><div class="line">            res.setError(INSTALL_FAILED_ALREADY_EXISTS, &quot;Attempt to re-install &quot; + pkgName</div><div class="line">                    + &quot; without first uninstalling.&quot;);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    try &#123;</div><div class="line">        PackageParser.Package newPackage = scanPackageTracedLI(pkg, policyFlags, scanFlags,</div><div class="line">                System.currentTimeMillis(), user);  //调用到scanPackageLI(scanFile, parseFlags, scanFlags, currentTime, user);</div><div class="line"></div><div class="line">        updateSettingsLI(newPackage, installerPackageName, null, res, user, installReason);</div><div class="line"></div><div class="line">        if (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</div><div class="line">            prepareAppDataAfterInstallLIF(newPackage);</div><div class="line"></div><div class="line">        &#125; else &#123;</div><div class="line">            // Remove package from internal structures, but keep around any</div><div class="line">            // data that might have already existed</div><div class="line">            deletePackageLIF(pkgName, UserHandle.ALL, false, null,</div><div class="line">                    PackageManager.DELETE_KEEP_DATA, res.removedInfo, true, null);</div><div class="line">        &#125;</div><div class="line">    &#125; catch (PackageManagerException e) &#123;</div><div class="line">        res.setError(&quot;Package couldn&apos;t be installed in &quot; + pkg.codePath, e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>scanPackageTracedLI调用到参数为5且首为package的scanPackageLI。<br>scanPackageLI负责安装,而updateSettingLI则是完成安装后的设置信息更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">private PackageParser.Package scanPackageTracedLI(PackageParser.Package pkg,</div><div class="line">        final int policyFlags, int scanFlags, long currentTime, @Nullable UserHandle user)</div><div class="line">                throws PackageManagerException &#123;</div><div class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, &quot;scanPackage&quot;);</div><div class="line">    // If the package has children and this is the first dive in the function</div><div class="line">    // we recursively scan the package with the SCAN_CHECK_ONLY flag set to see</div><div class="line">    // whether all packages (parent and children) would be successfully scanned</div><div class="line">    // before the actual scan since scanning mutates internal state and we want</div><div class="line">    // to atomically install the package and its children.</div><div class="line">    if ((scanFlags &amp; SCAN_CHECK_ONLY) == 0) &#123;</div><div class="line">        if (pkg.childPackages != null &amp;&amp; pkg.childPackages.size() &gt; 0) &#123;</div><div class="line">            scanFlags |= SCAN_CHECK_ONLY;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        scanFlags &amp;= ~SCAN_CHECK_ONLY;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    final PackageParser.Package scannedPkg;</div><div class="line">    try &#123;</div><div class="line">        // Scan the parent</div><div class="line">        scannedPkg = scanPackageLI(pkg, policyFlags, scanFlags, currentTime, user);</div><div class="line">        // Scan the children</div><div class="line">        final int childCount = (pkg.childPackages != null) ? pkg.childPackages.size() : 0;</div><div class="line">        for (int i = 0; i &lt; childCount; i++) &#123;</div><div class="line">            PackageParser.Package childPkg = pkg.childPackages.get(i);</div><div class="line">            scanPackageLI(childPkg, policyFlags,</div><div class="line">                    scanFlags, currentTime, user);</div><div class="line">        &#125;</div><div class="line">    &#125; finally &#123;</div><div class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if ((scanFlags &amp; SCAN_CHECK_ONLY) != 0) &#123;</div><div class="line">        return scanPackageTracedLI(pkg, policyFlags, scanFlags, currentTime, user);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return scannedPkg;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里与系统安装一样了。</p>
<h3 id="13-performDexOpt"><a href="#13-performDexOpt" class="headerlink" title="13.performDexOpt"></a>13.performDexOpt</h3><p>接下来到看installPackageLI内的<br>mPackageDexOptimizer.performDexOpt()调用。这里与系统扫描时的优化相同了。<br>注意PackageDexOptimizer.performDexOpt-&gt;performDexOptLI-&gt;dexOptPath-&gt;Installer.dexopt-&gt;InstalldNativeService.dexopt-&gt;dexopt.dexopt</p>
<p>在frameworks\base\services\core\java\com\android\server\pm\PackageDexOptimizer.java类中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">   int performDexOpt(PackageParser.Package pkg, String[] sharedLibraries,</div><div class="line">           String[] instructionSets, boolean checkProfiles, String targetCompilationFilter,</div><div class="line">           CompilerStats.PackageStats packageStats, boolean isUsedByOtherApps) &#123;</div><div class="line">       if (!canOptimizePackage(pkg)) &#123;</div><div class="line">           return DEX_OPT_SKIPPED;</div><div class="line">       &#125;</div><div class="line">       synchronized (mInstallLock) &#123;</div><div class="line">           final long acquireTime = acquireWakeLockLI(pkg.applicationInfo.uid);</div><div class="line">           try &#123;</div><div class="line">               return performDexOptLI(pkg, sharedLibraries, instructionSets, checkProfiles,</div><div class="line">                       targetCompilationFilter, packageStats, isUsedByOtherApps);</div><div class="line">           &#125; finally &#123;</div><div class="line">               releaseWakeLockLI(acquireTime);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">private int performDexOptLI(PackageParser.Package pkg, String[] sharedLibraries,</div><div class="line">           String[] targetInstructionSets, boolean checkForProfileUpdates,</div><div class="line">           String targetCompilerFilter, CompilerStats.PackageStats packageStats,</div><div class="line">           boolean isUsedByOtherApps) &#123;</div><div class="line">      ......</div><div class="line">       final String[] dexCodeInstructionSets = getDexCodeInstructionSets(instructionSets);</div><div class="line">	//获取dexcode路径</div><div class="line">       final List&lt;String&gt; paths = pkg.getAllCodePaths(); </div><div class="line">       final int sharedGid = UserHandle.getSharedAppGid(pkg.applicationInfo.uid);</div><div class="line"></div><div class="line">       final String compilerFilter = getRealCompilerFilter(pkg.applicationInfo,</div><div class="line">               targetCompilerFilter, isUsedByOtherApps);</div><div class="line">       final boolean profileUpdated = checkForProfileUpdates &amp;&amp;</div><div class="line">               isProfileUpdated(pkg, sharedGid, compilerFilter);</div><div class="line"></div><div class="line">       final String sharedLibrariesPath = getSharedLibrariesPath(sharedLibraries);</div><div class="line">       // Get the dexopt flags after getRealCompilerFilter to make sure we get the correct flags.</div><div class="line">       final int dexoptFlags = getDexFlags(pkg, compilerFilter);</div><div class="line">       // Get the dependencies of each split in the package. For each code path in the package,</div><div class="line">       // this array contains the relative paths of each split it depends on, separated by colons.</div><div class="line">       String[] splitDependencies = getSplitDependencies(pkg);</div><div class="line"></div><div class="line">       int result = DEX_OPT_SKIPPED;</div><div class="line">	</div><div class="line">	//取每个路径</div><div class="line">       for (int i = 0; i &lt; paths.size(); i++) &#123;</div><div class="line">           // Skip paths that have no code.</div><div class="line">           if ((i == 0 &amp;&amp; (pkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_HAS_CODE) == 0) ||</div><div class="line">                   (i != 0 &amp;&amp; (pkg.splitFlags[i - 1] &amp; ApplicationInfo.FLAG_HAS_CODE) == 0)) &#123;</div><div class="line">               continue;</div><div class="line">           &#125;</div><div class="line">           // Append shared libraries with split dependencies for this split.</div><div class="line">           String path = paths.get(i);</div><div class="line">           String sharedLibrariesPathWithSplits;</div><div class="line">           if (sharedLibrariesPath != null &amp;&amp; splitDependencies[i] != null) &#123;</div><div class="line">               sharedLibrariesPathWithSplits = sharedLibrariesPath + &quot;:&quot; + splitDependencies[i];</div><div class="line">           &#125; else &#123;</div><div class="line">               sharedLibrariesPathWithSplits =</div><div class="line">                       splitDependencies[i] != null ? splitDependencies[i] : sharedLibrariesPath;</div><div class="line">           &#125;</div><div class="line">		</div><div class="line">		//对每个指令集</div><div class="line">           for (String dexCodeIsa : dexCodeInstructionSets) &#123;</div><div class="line">               int newResult = dexOptPath(pkg, path, dexCodeIsa, compilerFilter, profileUpdated,</div><div class="line">                       sharedLibrariesPathWithSplits, dexoptFlags, sharedGid, packageStats);</div><div class="line">               // The end result is:</div><div class="line">               //  - FAILED if any path failed,</div><div class="line">               //  - PERFORMED if at least one path needed compilation,</div><div class="line">               //  - SKIPPED when all paths are up to date</div><div class="line">               if ((result != DEX_OPT_FAILED) &amp;&amp; (newResult != DEX_OPT_SKIPPED)) &#123;</div><div class="line">                   result = newResult;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       return result;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>performDexOptLI调用dexOptPath传入每个dex文件与指令集。</p>
<h3 id="14-dexOptPath"><a href="#14-dexOptPath" class="headerlink" title="14.dexOptPath"></a>14.dexOptPath</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * Performs dexopt on the &#123;@code path&#125; belonging to the package &#123;@code pkg&#125;.</div><div class="line"> *</div><div class="line"> * @return</div><div class="line"> *      DEX_OPT_FAILED if there was any exception during dexopt</div><div class="line"> *      DEX_OPT_PERFORMED if dexopt was performed successfully on the given path.</div><div class="line"> *      DEX_OPT_SKIPPED if the path does not need to be deopt-ed.</div><div class="line"> */</div><div class="line">@GuardedBy(&quot;mInstallLock&quot;)</div><div class="line">private int dexOptPath(PackageParser.Package pkg, String path, String isa,</div><div class="line">        String compilerFilter, boolean profileUpdated, String sharedLibrariesPath,</div><div class="line">        int dexoptFlags, int uid, CompilerStats.PackageStats packageStats) &#123;</div><div class="line">    int dexoptNeeded = getDexoptNeeded(path, isa, compilerFilter, profileUpdated);</div><div class="line"></div><div class="line">    // TODO(calin): there&apos;s no need to try to create the oat dir over and over again,</div><div class="line">    //              especially since it involve an extra installd call. We should create</div><div class="line">    //              if (if supported) on the fly during the dexopt call.</div><div class="line">    String oatDir = createOatDirIfSupported(pkg, isa);</div><div class="line"></div><div class="line">    try &#123;</div><div class="line">        long startTime = System.currentTimeMillis();</div><div class="line"></div><div class="line">        mInstaller.dexopt(path, uid, pkg.packageName, isa, dexoptNeeded, oatDir, dexoptFlags,</div><div class="line">                compilerFilter, pkg.volumeUuid, sharedLibrariesPath, pkg.applicationInfo.seInfo);</div><div class="line"></div><div class="line">        if (packageStats != null) &#123;</div><div class="line">            long endTime = System.currentTimeMillis();</div><div class="line">            packageStats.setCompileTime(path, (int)(endTime - startTime));</div><div class="line">        &#125;</div><div class="line">        return DEX_OPT_PERFORMED;</div><div class="line">    &#125; catch (InstallerException e) &#123;</div><div class="line">        Slog.w(TAG, &quot;Failed to dexopt&quot;, e);</div><div class="line">        return DEX_OPT_FAILED;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用核心 mInstaller.dexopt(path, uid, pkg.packageName, isa, dexoptNeeded, oatDir, dexoptFlags,compilerFilter, pkg.volumeUuid, sharedLibrariesPath, pkg.applicationInfo.seInfo);</p>
<h3 id="15-Installer-dexopt"><a href="#15-Installer-dexopt" class="headerlink" title="15.Installer.dexopt"></a>15.Installer.dexopt</h3><p>加下来进入frameworks\base\services\core\java\com\android\server\pm\Installer.java类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public void dexopt(String apkPath, int uid, @Nullable String pkgName, String instructionSet,</div><div class="line">        int dexoptNeeded, @Nullable String outputPath, int dexFlags,</div><div class="line">        String compilerFilter, @Nullable String volumeUuid, @Nullable String sharedLibraries,</div><div class="line">        @Nullable String seInfo)</div><div class="line">        throws InstallerException &#123;</div><div class="line">    assertValidInstructionSet(instructionSet);</div><div class="line">    if (!checkBeforeRemote()) return;</div><div class="line">    try &#123;</div><div class="line">        mInstalld.dexopt(apkPath, uid, pkgName, instructionSet, dexoptNeeded, outputPath,</div><div class="line">                dexFlags, compilerFilter, volumeUuid, sharedLibraries, seInfo);</div><div class="line">    &#125; catch (Exception e) &#123;</div><div class="line">        throw InstallerException.from(e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用了mInstalld的dexopt。<br>PackageManagerServcie负责应用的安装，卸载等相关工作。但是installd才是负责干活的，通过PackageManagerService来访问的installd服务来执行程序包的安装与卸载。<br>PackageManagerService只有system权限。installd却是具有root权限，installd启动是在init进程解析init.rc时。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">service installd /system/bin/installd</div><div class="line">    class main</div></pre></td></tr></table></figure>
<p>在：<br>frameworks\native\cmds\installd\installd.cpp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">int main(const int argc, char *argv[]) &#123;</div><div class="line">    return android::installd::installd_main(argc, argv);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static int installd_main(const int argc ATTRIBUTE_UNUSED, char *argv[]) &#123;</div><div class="line">    int ret;</div><div class="line">    int selinux_enabled = (is_selinux_enabled() &gt; 0);</div><div class="line"></div><div class="line">	......</div><div class="line"></div><div class="line">    if ((ret = InstalldNativeService::start()) != android::OK) &#123;</div><div class="line">        SLOGE(&quot;Unable to start InstalldNativeService: %d&quot;, ret);</div><div class="line">        exit(1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    IPCThreadState::self()-&gt;joinThreadPool();</div><div class="line"></div><div class="line">    LOG(INFO) &lt;&lt; &quot;installd shutting down&quot;;</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>InstalldNativeService是通过binder实现的nativeserver</p>
<p>其在frameworks\native\cmds\installd\InstalldNativeService.cpp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">status_t InstalldNativeService::start() &#123;</div><div class="line">    IPCThreadState::self()-&gt;disableBackgroundScheduling(true);</div><div class="line">    status_t ret = BinderService&lt;InstalldNativeService&gt;::publish();</div><div class="line">    if (ret != android::OK) &#123;</div><div class="line">        return ret;</div><div class="line">    &#125;</div><div class="line">    sp&lt;ProcessState&gt; ps(ProcessState::self());</div><div class="line">    ps-&gt;startThreadPool();</div><div class="line">    ps-&gt;giveThreadPoolName();</div><div class="line">    return android::OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>BinderService在frameworks\native\libs\binder\include\binder\BinderService.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">   static status_t publish(bool allowIsolated = false) &#123;</div><div class="line">       sp&lt;IServiceManager&gt; sm(defaultServiceManager());</div><div class="line">       return sm-&gt;addService(</div><div class="line">               String16(SERVICE::getServiceName()),</div><div class="line">               new SERVICE(), allowIsolated);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">InstalldNativeService内：</div><div class="line">static char const* getServiceName() &#123; return &quot;installd&quot;; &#125;</div></pre></td></tr></table></figure>
<p>可见InstalldNativeService将自己注册到servicemanager。用的是BinderService的模板类方法。加入到ServiceManager中的名字正是installd。</p>
<h3 id="16-InstalldNativeService-dexopt"><a href="#16-InstalldNativeService-dexopt" class="headerlink" title="16.InstalldNativeService.dexopt"></a>16.InstalldNativeService.dexopt</h3><p>因此最后dex优化调用到：InstalldNativeService.dexopt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">binder::Status InstalldNativeService::dexopt(const std::string&amp; apkPath, int32_t uid,</div><div class="line">        const std::unique_ptr&lt;std::string&gt;&amp; packageName, const std::string&amp; instructionSet,</div><div class="line">        int32_t dexoptNeeded, const std::unique_ptr&lt;std::string&gt;&amp; outputPath, int32_t dexFlags,</div><div class="line">        const std::string&amp; compilerFilter, const std::unique_ptr&lt;std::string&gt;&amp; uuid,</div><div class="line">        const std::unique_ptr&lt;std::string&gt;&amp; sharedLibraries,</div><div class="line">        const std::unique_ptr&lt;std::string&gt;&amp; seInfo) &#123;</div><div class="line">    ENFORCE_UID(AID_SYSTEM);</div><div class="line">    CHECK_ARGUMENT_UUID(uuid);</div><div class="line">    if (packageName &amp;&amp; *packageName != &quot;*&quot;) &#123;</div><div class="line">        CHECK_ARGUMENT_PACKAGE_NAME(*packageName);</div><div class="line">    &#125;</div><div class="line">    std::lock_guard&lt;std::recursive_mutex&gt; lock(mLock);</div><div class="line"></div><div class="line">    const char* apk_path = apkPath.c_str();</div><div class="line">    const char* pkgname = packageName ? packageName-&gt;c_str() : &quot;*&quot;;</div><div class="line">    const char* instruction_set = instructionSet.c_str();</div><div class="line">    const char* oat_dir = outputPath ? outputPath-&gt;c_str() : nullptr;</div><div class="line">    const char* compiler_filter = compilerFilter.c_str();</div><div class="line">    const char* volume_uuid = uuid ? uuid-&gt;c_str() : nullptr;</div><div class="line">    const char* shared_libraries = sharedLibraries ? sharedLibraries-&gt;c_str() : nullptr;</div><div class="line">    const char* se_info = seInfo ? seInfo-&gt;c_str() : nullptr;</div><div class="line">    int res = android::installd::dexopt(apk_path, uid, pkgname, instruction_set, dexoptNeeded,</div><div class="line">            oat_dir, dexFlags, compiler_filter, volume_uuid, shared_libraries, se_info);</div><div class="line">    return res ? error(res, &quot;Failed to dexopt&quot;) : ok();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="17-dexopt"><a href="#17-dexopt" class="headerlink" title="17.dexopt"></a>17.dexopt</h3><p>android::installd::dexopt的实现在：frameworks\native\cmds\installd\dexopt.cpp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">int dexopt(const char* dex_path, uid_t uid, const char* pkgname, const char* instruction_set,</div><div class="line">        int dexopt_needed, const char* oat_dir, int dexopt_flags, const char* compiler_filter,</div><div class="line">        const char* volume_uuid, const char* shared_libraries, const char* se_info) &#123;</div><div class="line">    CHECK(pkgname != nullptr);</div><div class="line">    CHECK(pkgname[0] != 0);</div><div class="line">    if ((dexopt_flags &amp; ~DEXOPT_MASK) != 0) &#123;</div><div class="line">        LOG_FATAL(&quot;dexopt flags contains unknown fields\n&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    bool is_public = (dexopt_flags &amp; DEXOPT_PUBLIC) != 0;</div><div class="line">    bool debuggable = (dexopt_flags &amp; DEXOPT_DEBUGGABLE) != 0;</div><div class="line">    bool boot_complete = (dexopt_flags &amp; DEXOPT_BOOTCOMPLETE) != 0;</div><div class="line">    bool profile_guided = (dexopt_flags &amp; DEXOPT_PROFILE_GUIDED) != 0;</div><div class="line">    bool is_secondary_dex = (dexopt_flags &amp; DEXOPT_SECONDARY_DEX) != 0;</div><div class="line"></div><div class="line">    // Check if we&apos;re dealing with a secondary dex file and if we need to compile it.</div><div class="line">    std::string oat_dir_str;</div><div class="line">    std::string dex_real_path;</div><div class="line"></div><div class="line">	......</div><div class="line">	</div><div class="line">    // Open the input file.</div><div class="line">	//打开dex输入文件</div><div class="line">    unique_fd input_fd(open(dex_path, O_RDONLY, 0));</div><div class="line">    if (input_fd.get() &lt; 0) &#123;</div><div class="line">        ALOGE(&quot;installd cannot open &apos;%s&apos; for input during dexopt\n&quot;, dex_path);</div><div class="line">        return -1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Create the output OAT file.</div><div class="line">	//创建输出的oat文件</div><div class="line">    char out_oat_path[PKG_PATH_MAX];</div><div class="line">    Dex2oatFileWrapper out_oat_fd = open_oat_out_file(dex_path, oat_dir, is_public, uid,</div><div class="line">            instruction_set, is_secondary_dex, out_oat_path);</div><div class="line">    if (out_oat_fd.get() &lt; 0) &#123;</div><div class="line">        return -1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Open vdex files.</div><div class="line">	//创建vdex文件</div><div class="line">    Dex2oatFileWrapper in_vdex_fd;</div><div class="line">    Dex2oatFileWrapper out_vdex_fd;</div><div class="line">    if (!open_vdex_files(dex_path, out_oat_path, dexopt_needed, instruction_set, is_public, uid,</div><div class="line">            is_secondary_dex, profile_guided, &amp;in_vdex_fd, &amp;out_vdex_fd)) &#123;</div><div class="line">        return -1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Ensure that the oat dir and the compiler artifacts of secondary dex files have the correct</div><div class="line">    // selinux context (we generate them on the fly during the dexopt invocation and they don&apos;t</div><div class="line">    // fully inherit their parent context).</div><div class="line">    // Note that for primary apk the oat files are created before, in a separate installd</div><div class="line">    // call which also does the restorecon. TODO(calin): unify the paths.</div><div class="line">    if (is_secondary_dex) &#123;</div><div class="line">        if (selinux_android_restorecon_pkgdir(oat_dir, se_info, uid,</div><div class="line">                SELINUX_ANDROID_RESTORECON_RECURSE)) &#123;</div><div class="line">            LOG(ERROR) &lt;&lt; &quot;Failed to restorecon &quot; &lt;&lt; oat_dir;</div><div class="line">            return -1;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Create a swap file if necessary.</div><div class="line">    unique_fd swap_fd = maybe_open_dexopt_swap_file(out_oat_path);</div><div class="line"></div><div class="line">    // Create the app image file if needed.</div><div class="line">    Dex2oatFileWrapper image_fd =</div><div class="line">            maybe_open_app_image(out_oat_path, profile_guided, is_public, uid, is_secondary_dex);</div><div class="line"></div><div class="line">    // Open the reference profile if needed.</div><div class="line">    Dex2oatFileWrapper reference_profile_fd = maybe_open_reference_profile(</div><div class="line">            pkgname, dex_path, profile_guided, is_public, uid, is_secondary_dex);</div><div class="line"></div><div class="line">    ALOGV(&quot;DexInv: --- BEGIN &apos;%s&apos; ---\n&quot;, dex_path);</div><div class="line"></div><div class="line">    pid_t pid = fork();</div><div class="line">    if (pid == 0) &#123;</div><div class="line">        /* child -- drop privileges before continuing */</div><div class="line">        drop_capabilities(uid);</div><div class="line"></div><div class="line">        SetDex2OatScheduling(boot_complete);</div><div class="line">        if (flock(out_oat_fd.get(), LOCK_EX | LOCK_NB) != 0) &#123;</div><div class="line">            ALOGE(&quot;flock(%s) failed: %s\n&quot;, out_oat_path, strerror(errno));</div><div class="line">            _exit(67);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        run_dex2oat(input_fd.get(),</div><div class="line">                    out_oat_fd.get(),</div><div class="line">                    in_vdex_fd.get(),</div><div class="line">                    out_vdex_fd.get(),</div><div class="line">                    image_fd.get(),</div><div class="line">                    dex_path,</div><div class="line">                    out_oat_path,</div><div class="line">                    swap_fd.get(),</div><div class="line">                    instruction_set,</div><div class="line">                    compiler_filter,</div><div class="line">                    debuggable,</div><div class="line">                    boot_complete,</div><div class="line">                    reference_profile_fd.get(),</div><div class="line">                    shared_libraries);</div><div class="line">        _exit(68);   /* only get here on exec failure */</div><div class="line">    &#125; else &#123;</div><div class="line">        int res = wait_child(pid);</div><div class="line">        if (res == 0) &#123;</div><div class="line">            ALOGV(&quot;DexInv: --- END &apos;%s&apos; (success) ---\n&quot;, dex_path);</div><div class="line">        &#125; else &#123;</div><div class="line">            ALOGE(&quot;DexInv: --- END &apos;%s&apos; --- status=0x%04x, process failed\n&quot;, dex_path, res);</div><div class="line">            return res;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    update_out_oat_access_times(dex_path, out_oat_path);</div><div class="line"></div><div class="line">    // We&apos;ve been successful, don&apos;t delete output.</div><div class="line">    out_oat_fd.SetCleanup(false);</div><div class="line">    out_vdex_fd.SetCleanup(false);</div><div class="line">    image_fd.SetCleanup(false);</div><div class="line">    reference_profile_fd.SetCleanup(false);</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建输出文件，调用run_dex2oat执行优化。<br>跟踪发现第三方安装的生成位置并不在delvik-cache，该目录下仅有系统自带文件的优化。<br>自己的优化应该是放在了data/app下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">static void run_dex2oat(int zip_fd, int oat_fd, int input_vdex_fd, int output_vdex_fd, int image_fd,</div><div class="line">        const char* input_file_name, const char* output_file_name, int swap_fd,</div><div class="line">        const char* instruction_set, const char* compiler_filter,</div><div class="line">        bool debuggable, bool post_bootcomplete, int profile_fd, const char* shared_libraries) &#123;</div><div class="line">    static const unsigned int MAX_INSTRUCTION_SET_LEN = 7;</div><div class="line"></div><div class="line">    if (strlen(instruction_set) &gt;= MAX_INSTRUCTION_SET_LEN) &#123;</div><div class="line">        ALOGE(&quot;Instruction set %s longer than max length of %d&quot;,</div><div class="line">              instruction_set, MAX_INSTRUCTION_SET_LEN);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Get the relative path to the input file.</div><div class="line">    const char* relative_input_file_name = get_location_from_path(input_file_name);</div><div class="line"></div><div class="line">    char dex2oat_Xms_flag[kPropertyValueMax];</div><div class="line">    bool have_dex2oat_Xms_flag = get_property(&quot;dalvik.vm.dex2oat-Xms&quot;, dex2oat_Xms_flag, NULL) &gt; 0;</div><div class="line"></div><div class="line">    char dex2oat_Xmx_flag[kPropertyValueMax];</div><div class="line">    bool have_dex2oat_Xmx_flag = get_property(&quot;dalvik.vm.dex2oat-Xmx&quot;, dex2oat_Xmx_flag, NULL) &gt; 0;</div><div class="line"></div><div class="line">    char dex2oat_threads_buf[kPropertyValueMax];</div><div class="line">    bool have_dex2oat_threads_flag = get_property(post_bootcomplete</div><div class="line">                                                      ? &quot;dalvik.vm.dex2oat-threads&quot;</div><div class="line">                                                      : &quot;dalvik.vm.boot-dex2oat-threads&quot;,</div><div class="line">                                                  dex2oat_threads_buf,</div><div class="line">                                                  NULL) &gt; 0;</div><div class="line">    char dex2oat_threads_arg[kPropertyValueMax + 2];</div><div class="line">    if (have_dex2oat_threads_flag) &#123;</div><div class="line">        sprintf(dex2oat_threads_arg, &quot;-j%s&quot;, dex2oat_threads_buf);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    char dex2oat_isa_features_key[kPropertyKeyMax];</div><div class="line">    sprintf(dex2oat_isa_features_key, &quot;dalvik.vm.isa.%s.features&quot;, instruction_set);</div><div class="line">    char dex2oat_isa_features[kPropertyValueMax];</div><div class="line">    bool have_dex2oat_isa_features = get_property(dex2oat_isa_features_key,</div><div class="line">                                                  dex2oat_isa_features, NULL) &gt; 0;</div><div class="line"></div><div class="line">    char dex2oat_isa_variant_key[kPropertyKeyMax];</div><div class="line">    sprintf(dex2oat_isa_variant_key, &quot;dalvik.vm.isa.%s.variant&quot;, instruction_set);</div><div class="line">    char dex2oat_isa_variant[kPropertyValueMax];</div><div class="line">    bool have_dex2oat_isa_variant = get_property(dex2oat_isa_variant_key,</div><div class="line">                                                 dex2oat_isa_variant, NULL) &gt; 0;</div><div class="line"></div><div class="line">    const char *dex2oat_norelocation = &quot;-Xnorelocate&quot;;</div><div class="line">    bool have_dex2oat_relocation_skip_flag = false;</div><div class="line"></div><div class="line">    char dex2oat_flags[kPropertyValueMax];</div><div class="line">    int dex2oat_flags_count = get_property(&quot;dalvik.vm.dex2oat-flags&quot;,</div><div class="line">                                 dex2oat_flags, NULL) &lt;= 0 ? 0 : split_count(dex2oat_flags);</div><div class="line">    ALOGV(&quot;dalvik.vm.dex2oat-flags=%s\n&quot;, dex2oat_flags);</div><div class="line"></div><div class="line">    // If we are booting without the real /data, don&apos;t spend time compiling.</div><div class="line">    char vold_decrypt[kPropertyValueMax];</div><div class="line">    bool have_vold_decrypt = get_property(&quot;vold.decrypt&quot;, vold_decrypt, &quot;&quot;) &gt; 0;</div><div class="line">    bool skip_compilation = (have_vold_decrypt &amp;&amp;</div><div class="line">                             (strcmp(vold_decrypt, &quot;trigger_restart_min_framework&quot;) == 0 ||</div><div class="line">                             (strcmp(vold_decrypt, &quot;1&quot;) == 0)));</div><div class="line"></div><div class="line">    bool generate_debug_info = property_get_bool(&quot;debug.generate-debug-info&quot;, false);</div><div class="line"></div><div class="line">    char app_image_format[kPropertyValueMax];</div><div class="line">    char image_format_arg[strlen(&quot;--image-format=&quot;) + kPropertyValueMax];</div><div class="line">    bool have_app_image_format =</div><div class="line">            image_fd &gt;= 0 &amp;&amp; get_property(&quot;dalvik.vm.appimageformat&quot;, app_image_format, NULL) &gt; 0;</div><div class="line">    if (have_app_image_format) &#123;</div><div class="line">        sprintf(image_format_arg, &quot;--image-format=%s&quot;, app_image_format);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    char dex2oat_large_app_threshold[kPropertyValueMax];</div><div class="line">    bool have_dex2oat_large_app_threshold =</div><div class="line">            get_property(&quot;dalvik.vm.dex2oat-very-large&quot;, dex2oat_large_app_threshold, NULL) &gt; 0;</div><div class="line">    char dex2oat_large_app_threshold_arg[strlen(&quot;--very-large-app-threshold=&quot;) + kPropertyValueMax];</div><div class="line">    if (have_dex2oat_large_app_threshold) &#123;</div><div class="line">        sprintf(dex2oat_large_app_threshold_arg,</div><div class="line">                &quot;--very-large-app-threshold=%s&quot;,</div><div class="line">                dex2oat_large_app_threshold);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    static const char* DEX2OAT_BIN = &quot;/system/bin/dex2oat&quot;;</div><div class="line"></div><div class="line">    static const char* RUNTIME_ARG = &quot;--runtime-arg&quot;;</div><div class="line"></div><div class="line">    static const int MAX_INT_LEN = 12;      // &apos;-&apos;+10dig+&apos;\0&apos; -OR- 0x+8dig</div><div class="line"></div><div class="line">    // clang FORTIFY doesn&apos;t let us use strlen in constant array bounds, so we</div><div class="line">    // use arraysize instead.</div><div class="line">    char zip_fd_arg[arraysize(&quot;--zip-fd=&quot;) + MAX_INT_LEN];</div><div class="line">    char zip_location_arg[arraysize(&quot;--zip-location=&quot;) + PKG_PATH_MAX];</div><div class="line">    char input_vdex_fd_arg[arraysize(&quot;--input-vdex-fd=&quot;) + MAX_INT_LEN];</div><div class="line">    char output_vdex_fd_arg[arraysize(&quot;--output-vdex-fd=&quot;) + MAX_INT_LEN];</div><div class="line">    char oat_fd_arg[arraysize(&quot;--oat-fd=&quot;) + MAX_INT_LEN];</div><div class="line">    char oat_location_arg[arraysize(&quot;--oat-location=&quot;) + PKG_PATH_MAX];</div><div class="line">    char instruction_set_arg[arraysize(&quot;--instruction-set=&quot;) + MAX_INSTRUCTION_SET_LEN];</div><div class="line">    char instruction_set_variant_arg[arraysize(&quot;--instruction-set-variant=&quot;) + kPropertyValueMax];</div><div class="line">    char instruction_set_features_arg[arraysize(&quot;--instruction-set-features=&quot;) + kPropertyValueMax];</div><div class="line">    char dex2oat_Xms_arg[arraysize(&quot;-Xms&quot;) + kPropertyValueMax];</div><div class="line">    char dex2oat_Xmx_arg[arraysize(&quot;-Xmx&quot;) + kPropertyValueMax];</div><div class="line">    char dex2oat_compiler_filter_arg[arraysize(&quot;--compiler-filter=&quot;) + kPropertyValueMax];</div><div class="line">    bool have_dex2oat_swap_fd = false;</div><div class="line">    char dex2oat_swap_fd[arraysize(&quot;--swap-fd=&quot;) + MAX_INT_LEN];</div><div class="line">    bool have_dex2oat_image_fd = false;</div><div class="line">    char dex2oat_image_fd[arraysize(&quot;--app-image-fd=&quot;) + MAX_INT_LEN];</div><div class="line"></div><div class="line">    sprintf(zip_fd_arg, &quot;--zip-fd=%d&quot;, zip_fd);</div><div class="line">    sprintf(zip_location_arg, &quot;--zip-location=%s&quot;, relative_input_file_name);</div><div class="line">    sprintf(input_vdex_fd_arg, &quot;--input-vdex-fd=%d&quot;, input_vdex_fd);</div><div class="line">    sprintf(output_vdex_fd_arg, &quot;--output-vdex-fd=%d&quot;, output_vdex_fd);</div><div class="line">    sprintf(oat_fd_arg, &quot;--oat-fd=%d&quot;, oat_fd);</div><div class="line">    sprintf(oat_location_arg, &quot;--oat-location=%s&quot;, output_file_name);</div><div class="line">    sprintf(instruction_set_arg, &quot;--instruction-set=%s&quot;, instruction_set);</div><div class="line">    sprintf(instruction_set_variant_arg, &quot;--instruction-set-variant=%s&quot;, dex2oat_isa_variant);</div><div class="line">    sprintf(instruction_set_features_arg, &quot;--instruction-set-features=%s&quot;, dex2oat_isa_features);</div><div class="line">    if (swap_fd &gt;= 0) &#123;</div><div class="line">        have_dex2oat_swap_fd = true;</div><div class="line">        sprintf(dex2oat_swap_fd, &quot;--swap-fd=%d&quot;, swap_fd);</div><div class="line">    &#125;</div><div class="line">    if (image_fd &gt;= 0) &#123;</div><div class="line">        have_dex2oat_image_fd = true;</div><div class="line">        sprintf(dex2oat_image_fd, &quot;--app-image-fd=%d&quot;, image_fd);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (have_dex2oat_Xms_flag) &#123;</div><div class="line">        sprintf(dex2oat_Xms_arg, &quot;-Xms%s&quot;, dex2oat_Xms_flag);</div><div class="line">    &#125;</div><div class="line">    if (have_dex2oat_Xmx_flag) &#123;</div><div class="line">        sprintf(dex2oat_Xmx_arg, &quot;-Xmx%s&quot;, dex2oat_Xmx_flag);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Compute compiler filter.</div><div class="line"></div><div class="line">    bool have_dex2oat_compiler_filter_flag = false;</div><div class="line">    if (skip_compilation) &#123;</div><div class="line">        strcpy(dex2oat_compiler_filter_arg, &quot;--compiler-filter=extract&quot;);</div><div class="line">        have_dex2oat_compiler_filter_flag = true;</div><div class="line">        have_dex2oat_relocation_skip_flag = true;</div><div class="line">    &#125; else if (compiler_filter != nullptr) &#123;</div><div class="line">        if (strlen(compiler_filter) + strlen(&quot;--compiler-filter=&quot;) &lt;</div><div class="line">                    arraysize(dex2oat_compiler_filter_arg)) &#123;</div><div class="line">            sprintf(dex2oat_compiler_filter_arg, &quot;--compiler-filter=%s&quot;, compiler_filter);</div><div class="line">            have_dex2oat_compiler_filter_flag = true;</div><div class="line">        &#125; else &#123;</div><div class="line">            ALOGW(&quot;Compiler filter name &apos;%s&apos; is too large (max characters is %zu)&quot;,</div><div class="line">                  compiler_filter,</div><div class="line">                  kPropertyValueMax);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!have_dex2oat_compiler_filter_flag) &#123;</div><div class="line">        char dex2oat_compiler_filter_flag[kPropertyValueMax];</div><div class="line">        have_dex2oat_compiler_filter_flag = get_property(&quot;dalvik.vm.dex2oat-filter&quot;,</div><div class="line">                                                         dex2oat_compiler_filter_flag, NULL) &gt; 0;</div><div class="line">        if (have_dex2oat_compiler_filter_flag) &#123;</div><div class="line">            sprintf(dex2oat_compiler_filter_arg,</div><div class="line">                    &quot;--compiler-filter=%s&quot;,</div><div class="line">                    dex2oat_compiler_filter_flag);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Check whether all apps should be compiled debuggable.</div><div class="line">    if (!debuggable) &#123;</div><div class="line">        char prop_buf[kPropertyValueMax];</div><div class="line">        debuggable =</div><div class="line">                (get_property(&quot;dalvik.vm.always_debuggable&quot;, prop_buf, &quot;0&quot;) &gt; 0) &amp;&amp;</div><div class="line">                (prop_buf[0] == &apos;1&apos;);</div><div class="line">    &#125;</div><div class="line">    char profile_arg[strlen(&quot;--profile-file-fd=&quot;) + MAX_INT_LEN];</div><div class="line">    if (profile_fd != -1) &#123;</div><div class="line">        sprintf(profile_arg, &quot;--profile-file-fd=%d&quot;, profile_fd);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Get the directory of the apk to pass as a base classpath directory.</div><div class="line">    char base_dir[arraysize(&quot;--classpath-dir=&quot;) + PKG_PATH_MAX];</div><div class="line">    std::string apk_dir(input_file_name);</div><div class="line">    unsigned long dir_index = apk_dir.rfind(&apos;/&apos;);</div><div class="line">    bool has_base_dir = dir_index != std::string::npos;</div><div class="line">    if (has_base_dir) &#123;</div><div class="line">        apk_dir = apk_dir.substr(0, dir_index);</div><div class="line">        sprintf(base_dir, &quot;--classpath-dir=%s&quot;, apk_dir.c_str());</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    ALOGV(&quot;Running %s in=%s out=%s\n&quot;, DEX2OAT_BIN, relative_input_file_name, output_file_name);</div><div class="line"></div><div class="line">    const char* argv[9  // program name, mandatory arguments and the final NULL</div><div class="line">                     + (have_dex2oat_isa_variant ? 1 : 0)</div><div class="line">                     + (have_dex2oat_isa_features ? 1 : 0)</div><div class="line">                     + (have_dex2oat_Xms_flag ? 2 : 0)</div><div class="line">                     + (have_dex2oat_Xmx_flag ? 2 : 0)</div><div class="line">                     + (have_dex2oat_compiler_filter_flag ? 1 : 0)</div><div class="line">                     + (have_dex2oat_threads_flag ? 1 : 0)</div><div class="line">                     + (have_dex2oat_swap_fd ? 1 : 0)</div><div class="line">                     + (have_dex2oat_image_fd ? 1 : 0)</div><div class="line">                     + (have_dex2oat_relocation_skip_flag ? 2 : 0)</div><div class="line">                     + (generate_debug_info ? 1 : 0)</div><div class="line">                     + (debuggable ? 1 : 0)</div><div class="line">                     + (have_app_image_format ? 1 : 0)</div><div class="line">                     + dex2oat_flags_count</div><div class="line">                     + (profile_fd == -1 ? 0 : 1)</div><div class="line">                     + (shared_libraries != nullptr ? 4 : 0)</div><div class="line">                     + (has_base_dir ? 1 : 0)</div><div class="line">                     + (have_dex2oat_large_app_threshold ? 1 : 0)];</div><div class="line">    int i = 0;</div><div class="line">    argv[i++] = DEX2OAT_BIN;</div><div class="line">    argv[i++] = zip_fd_arg;</div><div class="line">    argv[i++] = zip_location_arg;</div><div class="line">    argv[i++] = input_vdex_fd_arg;</div><div class="line">    argv[i++] = output_vdex_fd_arg;</div><div class="line">    argv[i++] = oat_fd_arg;</div><div class="line">    argv[i++] = oat_location_arg;</div><div class="line">    argv[i++] = instruction_set_arg;</div><div class="line">    if (have_dex2oat_isa_variant) &#123;</div><div class="line">        argv[i++] = instruction_set_variant_arg;</div><div class="line">    &#125;</div><div class="line">    if (have_dex2oat_isa_features) &#123;</div><div class="line">        argv[i++] = instruction_set_features_arg;</div><div class="line">    &#125;</div><div class="line">    if (have_dex2oat_Xms_flag) &#123;</div><div class="line">        argv[i++] = RUNTIME_ARG;</div><div class="line">        argv[i++] = dex2oat_Xms_arg;</div><div class="line">    &#125;</div><div class="line">    if (have_dex2oat_Xmx_flag) &#123;</div><div class="line">        argv[i++] = RUNTIME_ARG;</div><div class="line">        argv[i++] = dex2oat_Xmx_arg;</div><div class="line">    &#125;</div><div class="line">    if (have_dex2oat_compiler_filter_flag) &#123;</div><div class="line">        argv[i++] = dex2oat_compiler_filter_arg;</div><div class="line">    &#125;</div><div class="line">    if (have_dex2oat_threads_flag) &#123;</div><div class="line">        argv[i++] = dex2oat_threads_arg;</div><div class="line">    &#125;</div><div class="line">    if (have_dex2oat_swap_fd) &#123;</div><div class="line">        argv[i++] = dex2oat_swap_fd;</div><div class="line">    &#125;</div><div class="line">    if (have_dex2oat_image_fd) &#123;</div><div class="line">        argv[i++] = dex2oat_image_fd;</div><div class="line">    &#125;</div><div class="line">    if (generate_debug_info) &#123;</div><div class="line">        argv[i++] = &quot;--generate-debug-info&quot;;</div><div class="line">    &#125;</div><div class="line">    if (debuggable) &#123;</div><div class="line">        argv[i++] = &quot;--debuggable&quot;;</div><div class="line">    &#125;</div><div class="line">    if (have_app_image_format) &#123;</div><div class="line">        argv[i++] = image_format_arg;</div><div class="line">    &#125;</div><div class="line">    if (have_dex2oat_large_app_threshold) &#123;</div><div class="line">        argv[i++] = dex2oat_large_app_threshold_arg;</div><div class="line">    &#125;</div><div class="line">    if (dex2oat_flags_count) &#123;</div><div class="line">        i += split(dex2oat_flags, argv + i);</div><div class="line">    &#125;</div><div class="line">    if (have_dex2oat_relocation_skip_flag) &#123;</div><div class="line">        argv[i++] = RUNTIME_ARG;</div><div class="line">        argv[i++] = dex2oat_norelocation;</div><div class="line">    &#125;</div><div class="line">    if (profile_fd != -1) &#123;</div><div class="line">        argv[i++] = profile_arg;</div><div class="line">    &#125;</div><div class="line">    if (shared_libraries != nullptr) &#123;</div><div class="line">        argv[i++] = RUNTIME_ARG;</div><div class="line">        argv[i++] = &quot;-classpath&quot;;</div><div class="line">        argv[i++] = RUNTIME_ARG;</div><div class="line">        argv[i++] = shared_libraries;</div><div class="line">    &#125;</div><div class="line">    if (has_base_dir) &#123;</div><div class="line">        argv[i++] = base_dir;</div><div class="line">    &#125;</div><div class="line">    // Do not add after dex2oat_flags, they should override others for debugging.</div><div class="line">    argv[i] = NULL;</div><div class="line"></div><div class="line">    execv(DEX2OAT_BIN, (char * const *)argv);</div><div class="line">    ALOGE(&quot;execv(%s) failed: %s\n&quot;, DEX2OAT_BIN, strerror(errno));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后通过execv执行/system/bin/dex2oat  完成oat</p>
<p>有关oat的具体生成研究加固时再分析。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android系统/" rel="tag"># android系统</a>
          
            <a href="/tags/apk安装/" rel="tag"># apk安装</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/05/android8-0-0源码分析-应用安装1/" rel="next" title="android8-0-0源码分析-应用安装1">
                <i class="fa fa-chevron-left"></i> android8-0-0源码分析-应用安装1
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/10/07/android应用层常见安全漏洞/" rel="prev" title="android应用层常见安全漏洞">
                android应用层常见安全漏洞 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/1.png"
               alt="imbaya" />
          <p class="site-author-name" itemprop="name">imbaya</p>
           
              <p class="site-description motion-element" itemprop="description">..........</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">120</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">105</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分析"><span class="nav-number">2.</span> <span class="nav-text">分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-触发安装部分"><span class="nav-number">2.1.</span> <span class="nav-text">1.触发安装部分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-installStage"><span class="nav-number">2.2.</span> <span class="nav-text">4.installStage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-INIT-COPY"><span class="nav-number">2.3.</span> <span class="nav-text">5.INIT_COPY</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-MCS-BOUND"><span class="nav-number">2.4.</span> <span class="nav-text">6.MCS_BOUND</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-startCopy"><span class="nav-number">2.5.</span> <span class="nav-text">7.startCopy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-handleStartCopy"><span class="nav-number">2.6.</span> <span class="nav-text">8.handleStartCopy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-handleReturnCode"><span class="nav-number">2.7.</span> <span class="nav-text">9.handleReturnCode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-processPendingInstall"><span class="nav-number">2.8.</span> <span class="nav-text">10.processPendingInstall</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-installPackageTracedLI"><span class="nav-number">2.9.</span> <span class="nav-text">11.installPackageTracedLI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-installNewPackageLIF"><span class="nav-number">2.10.</span> <span class="nav-text">12.installNewPackageLIF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-performDexOpt"><span class="nav-number">2.11.</span> <span class="nav-text">13.performDexOpt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-dexOptPath"><span class="nav-number">2.12.</span> <span class="nav-text">14.dexOptPath</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-Installer-dexopt"><span class="nav-number">2.13.</span> <span class="nav-text">15.Installer.dexopt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-InstalldNativeService-dexopt"><span class="nav-number">2.14.</span> <span class="nav-text">16.InstalldNativeService.dexopt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-dexopt"><span class="nav-number">2.15.</span> <span class="nav-text">17.dexopt</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">imbaya</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":100,"height":200,"hOffset":0,"vOffset":-50},"mobile":{"show":false},"react":{"opacityDefault":1,"opacityOnHover":1},"log":false});</script></body>
</html>
