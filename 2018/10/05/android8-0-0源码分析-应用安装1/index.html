<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android系统,apk安装," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="前言apk安装分4种方式：  系统开机应用安装，安装的是系统应用。 adb安装 应用调用系统应用安装第三方apk包 静默安装  在代码里的实现其实就是如下两种：  PMS调用scanDirLI扫描安装 直接或间接调用installPackageAsUser安装，这个8.0下其实调用的是另一个函数  apk安装后主要体现在：data/app:apk包-含优化后的oat与libdata/data:数据">
<meta name="keywords" content="android系统,apk安装">
<meta property="og:type" content="article">
<meta property="og:title" content="android8-0-0源码分析-应用安装1">
<meta property="og:url" content="http://yoursite.com/2018/10/05/android8-0-0源码分析-应用安装1/index.html">
<meta property="og:site_name" content="GGWP">
<meta property="og:description" content="前言apk安装分4种方式：  系统开机应用安装，安装的是系统应用。 adb安装 应用调用系统应用安装第三方apk包 静默安装  在代码里的实现其实就是如下两种：  PMS调用scanDirLI扫描安装 直接或间接调用installPackageAsUser安装，这个8.0下其实调用的是另一个函数  apk安装后主要体现在：data/app:apk包-含优化后的oat与libdata/data:数据">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.imgur.com/l2hfrbh.jpg">
<meta property="og:updated_time" content="2018-11-08T11:47:52.240Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android8-0-0源码分析-应用安装1">
<meta name="twitter:description" content="前言apk安装分4种方式：  系统开机应用安装，安装的是系统应用。 adb安装 应用调用系统应用安装第三方apk包 静默安装  在代码里的实现其实就是如下两种：  PMS调用scanDirLI扫描安装 直接或间接调用installPackageAsUser安装，这个8.0下其实调用的是另一个函数  apk安装后主要体现在：data/app:apk包-含优化后的oat与libdata/data:数据">
<meta name="twitter:image" content="https://i.imgur.com/l2hfrbh.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/10/05/android8-0-0源码分析-应用安装1/"/>





  <title>android8-0-0源码分析-应用安装1 | GGWP</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GGWP</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/05/android8-0-0源码分析-应用安装1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="imbaya">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GGWP">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">android8-0-0源码分析-应用安装1</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-05T19:04:30+08:00">
                2018-10-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android系统/" itemprop="url" rel="index">
                    <span itemprop="name">android系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>apk安装分4种方式：</p>
<ol>
<li>系统开机应用安装，安装的是系统应用。</li>
<li>adb安装</li>
<li>应用调用系统应用安装第三方apk包</li>
<li>静默安装</li>
</ol>
<p>在代码里的实现其实就是如下两种：</p>
<ol>
<li>PMS调用scanDirLI扫描安装</li>
<li>直接或间接调用installPackageAsUser安装，这个8.0下其实调用的是另一个函数</li>
</ol>
<p>apk安装后主要体现在：<br>data/app:apk包-含优化后的oat与lib<br>data/data:数据目录</p>
<p>在本篇我们看下第一种系统启动时的安装流程。下一篇介绍第二种</p>
<a id="more"></a>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>一张时序图：<br><img src="https://i.imgur.com/l2hfrbh.jpg" alt=""></p>
<p>介于大小问题图中执行长度不做对应。</p>
<p>dex的优化：<br>在SystemServer.java 中有mPackageManagerService.updatePackagesIfNeeded()<br>updatePackagesIfNeeded-&gt;performDexOptUpgrade-&gt;performDexOptTraced-&gt;performDexOptInternal-&gt;performDexOptInternalWithDependenciesLI-&gt;PackageDexOptimizer.performDexOpt-&gt;performDexOptLI-&gt;dexOptPath-&gt;Installer.dexopt-&gt;InstalldNativeService.dexopt-&gt;dexopt.dexopt</p>
<h3 id="1-main"><a href="#1-main" class="headerlink" title="1.main"></a>1.main</h3><p>ZygoteInit fork启动SystemServer</p>
<p>frameworks\base\services\java\com\android\server\SystemServer.java</p>
<p>SystemServer.main</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public static void main(String[] args) &#123;</div><div class="line">    new SystemServer().run();</div><div class="line">&#125;</div><div class="line"></div><div class="line">public SystemServer() &#123;</div><div class="line">    // Check for factory test mode.</div><div class="line">    mFactoryTestMode = FactoryTest.getMode();</div><div class="line">    // Remember if it&apos;s runtime restart(when sys.boot_completed is already set) or reboot</div><div class="line">    mRuntimeRestart = &quot;1&quot;.equals(SystemProperties.get(&quot;sys.boot_completed&quot;));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>构建运行其run</p>
<h3 id="2-run"><a href="#2-run" class="headerlink" title="2.run"></a>2.run</h3><p>SystemServer.run<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">  private void run() &#123;</div><div class="line"></div><div class="line">	</div><div class="line">	</div><div class="line">.......</div><div class="line"> mSystemServiceManager = new SystemServiceManager(mSystemContext);</div><div class="line"></div><div class="line">      // Start services.</div><div class="line">      try &#123;</div><div class="line">          traceBeginAndSlog(&quot;StartServices&quot;);</div><div class="line">          startBootstrapServices();</div><div class="line">          startCoreServices();</div><div class="line">          startOtherServices();</div><div class="line">          SystemServerInitThreadPool.shutdown();</div><div class="line">      &#125; catch (Throwable ex) &#123;</div><div class="line">          Slog.e(&quot;System&quot;, &quot;******************************************&quot;);</div><div class="line">          Slog.e(&quot;System&quot;, &quot;************ Failure starting system services&quot;, ex);</div><div class="line">          throw ex;</div><div class="line">      &#125; finally &#123;</div><div class="line">          traceEnd();</div><div class="line">      &#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">      // Loop forever.</div><div class="line">      Looper.loop();</div><div class="line">      throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>参数设置，启动各主要服务，启动循环处理服务。</p>
<h3 id="3-startBootstrapServices"><a href="#3-startBootstrapServices" class="headerlink" title="3.startBootstrapServices"></a>3.startBootstrapServices</h3><p>SystemServer.startBootstrapServices</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  private void startBootstrapServices() &#123;</div><div class="line"> </div><div class="line"></div><div class="line">// Wait for installd to finish starting up so that it has a chance to</div><div class="line">      // create critical directories such as /data/user with the appropriate</div><div class="line">      // permissions.  We need this to complete before we initialize other services.</div><div class="line">      traceBeginAndSlog(&quot;StartInstaller&quot;);</div><div class="line">      Installer installer = mSystemServiceManager.startService(Installer.class);</div><div class="line">      traceEnd();</div><div class="line"></div><div class="line">      ........启动ActivityManager Installer PowerManager等  Installer服务含有dex2oat优化！！！</div><div class="line"></div><div class="line"></div><div class="line">      // Start the package manager.</div><div class="line">      if (!mRuntimeRestart) &#123;</div><div class="line">          MetricsLogger.histogram(null, &quot;boot_package_manager_init_start&quot;,</div><div class="line">                  (int) SystemClock.elapsedRealtime());</div><div class="line">      &#125;</div><div class="line">      traceBeginAndSlog(&quot;StartPackageManagerService&quot;);</div><div class="line">      mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</div><div class="line">              mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</div><div class="line">      mFirstBoot = mPackageManagerService.isFirstBoot();</div><div class="line">      mPackageManager = mSystemContext.getPackageManager();</div><div class="line">      traceEnd();</div><div class="line">      if (!mRuntimeRestart &amp;&amp; !isFirstBootOrUpgrade()) &#123;</div><div class="line">          MetricsLogger.histogram(null, &quot;boot_package_manager_init_ready&quot;,</div><div class="line">                  (int) SystemClock.elapsedRealtime());</div><div class="line">      &#125;</div><div class="line">      // Manages A/B OTA dexopting. This is a bootstrap service as we need it to rename</div><div class="line">      // A/B artifacts after boot, before anything else might touch/need them.</div><div class="line">      // Note: this isn&apos;t needed during decryption (we don&apos;t have /data anyways).</div><div class="line">      if (!mOnlyCore) &#123;</div><div class="line">          boolean disableOtaDexopt = SystemProperties.getBoolean(&quot;config.disable_otadexopt&quot;,</div><div class="line">                  false);</div><div class="line">          if (!disableOtaDexopt) &#123;</div><div class="line">              traceBeginAndSlog(&quot;StartOtaDexOptService&quot;);</div><div class="line">              try &#123;</div><div class="line">                  OtaDexoptService.main(mSystemContext, mPackageManagerService);</div><div class="line">              &#125; catch (Throwable e) &#123;</div><div class="line">                  reportWtf(&quot;starting OtaDexOptService&quot;, e);</div><div class="line">              &#125; finally &#123;</div><div class="line">                  traceEnd();</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">.......</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>启动了一系列服务。其中Installer用binder与installd原生服务通话。<br>其中一个服务：PackageManagerService.main</p>
<h3 id="4-PackageManagerService-main"><a href="#4-PackageManagerService-main" class="headerlink" title="4.PackageManagerService.main"></a>4.PackageManagerService.main</h3><p>frameworks\base\services\core\java\com\android\server\pm\PackageManagerService.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public static PackageManagerService main(Context context, Installer installer,</div><div class="line">        boolean factoryTest, boolean onlyCore) &#123;</div><div class="line">    // Self-check for initial settings.</div><div class="line">    PackageManagerServiceCompilerMapping.checkProperties();</div><div class="line"></div><div class="line">    PackageManagerService m = new PackageManagerService(context, installer,</div><div class="line">            factoryTest, onlyCore);</div><div class="line">    m.enableSystemUserPackages();</div><div class="line">    ServiceManager.addService(&quot;package&quot;, m);</div><div class="line">    return m;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>构建PackageManagerService对象。添加到ServiceManager中。</p>
<h3 id="5-PackageManagerService"><a href="#5-PackageManagerService" class="headerlink" title="5.PackageManagerService"></a>5.PackageManagerService</h3><p>构建函数PackageManagerService：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  public PackageManagerService(Context context, Installer installer,</div><div class="line">          boolean factoryTest, boolean onlyCore) &#123;</div><div class="line"></div><div class="line">.......</div><div class="line"></div><div class="line">//保存了installer服务</div><div class="line">mInstaller = installer;</div><div class="line">      mPackageDexOptimizer = new PackageDexOptimizer(installer, mInstallLock, context,</div><div class="line">              &quot;*dexopt*&quot;);</div><div class="line">      mDexManager = new DexManager(this, mPackageDexOptimizer, installer, mInstallLock);</div><div class="line"></div><div class="line">      synchronized (mInstallLock) &#123;</div><div class="line">      // writer</div><div class="line">      synchronized (mPackages) &#123;</div><div class="line">          mHandlerThread = new ServiceThread(TAG,</div><div class="line">                  Process.THREAD_PRIORITY_BACKGROUND, true /*allowIo*/);</div><div class="line">          mHandlerThread.start();</div><div class="line">          mHandler = new PackageHandler(mHandlerThread.getLooper());</div><div class="line">          mProcessLoggingHandler = new ProcessLoggingHandler();</div><div class="line">          Watchdog.getInstance().addThread(mHandler, WATCHDOG_TIMEOUT);</div><div class="line"></div><div class="line">          mDefaultPermissionPolicy = new DefaultPermissionGrantPolicy(this);</div><div class="line">          mInstantAppRegistry = new InstantAppRegistry(this);</div><div class="line"></div><div class="line">          File dataDir = Environment.getDataDirectory();</div><div class="line">          mAppInstallDir = new File(dataDir, &quot;app&quot;);</div><div class="line">          mAppLib32InstallDir = new File(dataDir, &quot;app-lib&quot;);</div><div class="line">          mAsecInternalPath = new File(dataDir, &quot;app-asec&quot;).getPath();</div><div class="line">          mDrmAppPrivateInstallDir = new File(dataDir, &quot;app-private&quot;);</div><div class="line">          sUserManager = new UserManagerService(context, this,</div><div class="line">                  new UserDataPreparer(mInstaller, mInstallLock, mContext, mOnlyCore), mPackages);</div><div class="line">	</div><div class="line">	......</div><div class="line">	</div><div class="line">          File frameworkDir = new File(Environment.getRootDirectory(), &quot;framework&quot;);</div><div class="line"></div><div class="line">          final VersionInfo ver = mSettings.getInternalVersion();</div><div class="line">          mIsUpgrade = !Build.FINGERPRINT.equals(ver.fingerprint);</div><div class="line">          if (mIsUpgrade) &#123;</div><div class="line">              logCriticalInfo(Log.INFO,</div><div class="line">                      &quot;Upgrading from &quot; + ver.fingerprint + &quot; to &quot; + Build.FINGERPRINT);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          // when upgrading from pre-M, promote system app permissions from install to runtime</div><div class="line">          mPromoteSystemApps =</div><div class="line">                  mIsUpgrade &amp;&amp; ver.sdkVersion &lt;= Build.VERSION_CODES.LOLLIPOP_MR1;</div><div class="line"></div><div class="line">          // When upgrading from pre-N, we need to handle package extraction like first boot,</div><div class="line">          // as there is no profiling data available.</div><div class="line">          mIsPreNUpgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N;</div><div class="line"></div><div class="line">          mIsPreNMR1Upgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N_MR1;</div><div class="line"></div><div class="line">          // save off the names of pre-existing system packages prior to scanning; we don&apos;t</div><div class="line">          // want to automatically grant runtime permissions for new system apps</div><div class="line">          if (mPromoteSystemApps) &#123;</div><div class="line">              Iterator&lt;PackageSetting&gt; pkgSettingIter = mSettings.mPackages.values().iterator();</div><div class="line">              while (pkgSettingIter.hasNext()) &#123;</div><div class="line">                  PackageSetting ps = pkgSettingIter.next();</div><div class="line">                  if (isSystemApp(ps)) &#123;</div><div class="line">                      mExistingSystemPackages.add(ps.name);</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          mCacheDir = preparePackageParserCache(mIsUpgrade);</div><div class="line"></div><div class="line">          // Set flag to monitor and not change apk file paths when</div><div class="line">          // scanning install directories.</div><div class="line">          int scanFlags = SCAN_BOOTING | SCAN_INITIAL;</div><div class="line"></div><div class="line">          if (mIsUpgrade || mFirstBoot) &#123;</div><div class="line">              scanFlags = scanFlags | SCAN_FIRST_BOOT_OR_UPGRADE;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          // Collect vendor overlay packages. (Do this before scanning any apps.)</div><div class="line">          // For security and version matching reason, only consider</div><div class="line">          // overlay packages if they reside in the right directory.</div><div class="line">          scanDirTracedLI(new File(VENDOR_OVERLAY_DIR), mDefParseFlags</div><div class="line">                  | PackageParser.PARSE_IS_SYSTEM</div><div class="line">                  | PackageParser.PARSE_IS_SYSTEM_DIR</div><div class="line">                  | PackageParser.PARSE_TRUSTED_OVERLAY, scanFlags | SCAN_TRUSTED_OVERLAY, 0);</div><div class="line"></div><div class="line">          mParallelPackageParserCallback.findStaticOverlayPackages();</div><div class="line"></div><div class="line">          // Find base frameworks (resource packages without code).</div><div class="line">          scanDirTracedLI(frameworkDir, mDefParseFlags</div><div class="line">                  | PackageParser.PARSE_IS_SYSTEM</div><div class="line">                  | PackageParser.PARSE_IS_SYSTEM_DIR</div><div class="line">                  | PackageParser.PARSE_IS_PRIVILEGED,</div><div class="line">                  scanFlags | SCAN_NO_DEX, 0);</div><div class="line"></div><div class="line">          // Collected privileged system packages.</div><div class="line">          final File privilegedAppDir = new File(Environment.getRootDirectory(), &quot;priv-app&quot;);</div><div class="line">          scanDirTracedLI(privilegedAppDir, mDefParseFlags</div><div class="line">                  | PackageParser.PARSE_IS_SYSTEM</div><div class="line">                  | PackageParser.PARSE_IS_SYSTEM_DIR</div><div class="line">                  | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, 0);</div><div class="line"></div><div class="line">          // Collect ordinary system packages.</div><div class="line">          final File systemAppDir = new File(Environment.getRootDirectory(), &quot;app&quot;);</div><div class="line">          scanDirTracedLI(systemAppDir, mDefParseFlags</div><div class="line">                  | PackageParser.PARSE_IS_SYSTEM</div><div class="line">                  | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, 0);</div><div class="line"></div><div class="line">          // Collect all vendor packages.</div><div class="line">          File vendorAppDir = new File(&quot;/vendor/app&quot;);</div><div class="line">          try &#123;</div><div class="line">              vendorAppDir = vendorAppDir.getCanonicalFile();</div><div class="line">          &#125; catch (IOException e) &#123;</div><div class="line">              // failed to look up canonical path, continue with original one</div><div class="line">          &#125;</div><div class="line">          scanDirTracedLI(vendorAppDir, mDefParseFlags</div><div class="line">                  | PackageParser.PARSE_IS_SYSTEM</div><div class="line">                  | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, 0);</div><div class="line"></div><div class="line">          // Collect all OEM packages.</div><div class="line">          final File oemAppDir = new File(Environment.getOemDirectory(), &quot;app&quot;);</div><div class="line">          scanDirTracedLI(oemAppDir, mDefParseFlags</div><div class="line">                  | PackageParser.PARSE_IS_SYSTEM</div><div class="line">                  | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, 0);</div><div class="line">	</div><div class="line">	......</div><div class="line">	</div><div class="line">          ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr();</div><div class="line">          for (int i = 0; i &lt; deletePkgsList.size(); i++) &#123;</div><div class="line">              // Actual deletion of code and data will be handled by later</div><div class="line">              // reconciliation step</div><div class="line">              final String packageName = deletePkgsList.get(i).name;</div><div class="line">              logCriticalInfo(Log.WARN, &quot;Cleaning up incompletely installed app: &quot; + packageName);</div><div class="line">              synchronized (mPackages) &#123;</div><div class="line">                  mSettings.removePackageLPw(packageName);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          //delete tmp files</div><div class="line">          deleteTempPackageFiles();</div><div class="line"></div><div class="line">          // Remove any shared userIDs that have no associated packages</div><div class="line">          mSettings.pruneSharedUsersLPw();</div><div class="line"></div><div class="line">          if (!mOnlyCore) &#123;</div><div class="line">              EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START,</div><div class="line">                      SystemClock.uptimeMillis());</div><div class="line">              scanDirTracedLI(mAppInstallDir, 0, scanFlags | SCAN_REQUIRE_KNOWN, 0);</div><div class="line"></div><div class="line">              scanDirTracedLI(mDrmAppPrivateInstallDir, mDefParseFlags</div><div class="line">                      | PackageParser.PARSE_FORWARD_LOCK,</div><div class="line">                      scanFlags | SCAN_REQUIRE_KNOWN, 0);</div><div class="line"></div><div class="line"></div><div class="line">	......</div><div class="line">	</div><div class="line">	</div><div class="line">      &#125; // synchronized (mPackages)</div><div class="line">      &#125; // synchronized (mInstallLock)</div><div class="line"></div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>用scanDirTracedLI扫描几个目录：</p>
<ol>
<li>/system/framework</li>
<li>/system/app</li>
<li>/system/priv-app</li>
<li>/vendor/app</li>
<li>/data/app</li>
<li>/data/app-private</li>
</ol>
<h3 id="6-scanDirTracedLI"><a href="#6-scanDirTracedLI" class="headerlink" title="6.scanDirTracedLI"></a>6.scanDirTracedLI</h3><p>PackageManagerService.scanDirTracedLI:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">  private void scanDirTracedLI(File dir, final int parseFlags, int scanFlags, long currentTime) &#123;</div><div class="line">      Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, &quot;scanDir [&quot; + dir.getAbsolutePath() + &quot;]&quot;);</div><div class="line">      try &#123;</div><div class="line">          scanDirLI(dir, parseFlags, scanFlags, currentTime);</div><div class="line">      &#125; finally &#123;</div><div class="line">          Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private void scanDirLI(File dir, int parseFlags, int scanFlags, long currentTime) &#123;</div><div class="line">      final File[] files = dir.listFiles();</div><div class="line">      if (ArrayUtils.isEmpty(files)) &#123;</div><div class="line">          Log.d(TAG, &quot;No files in app dir &quot; + dir);</div><div class="line">          return;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (DEBUG_PACKAGE_SCANNING) &#123;</div><div class="line">          Log.d(TAG, &quot;Scanning app dir &quot; + dir + &quot; scanFlags=&quot; + scanFlags</div><div class="line">                  + &quot; flags=0x&quot; + Integer.toHexString(parseFlags));</div><div class="line">      &#125;</div><div class="line">//平行解析器</div><div class="line">      ParallelPackageParser parallelPackageParser = new ParallelPackageParser(</div><div class="line">              mSeparateProcesses, mOnlyCore, mMetrics, mCacheDir,</div><div class="line">              mParallelPackageParserCallback);</div><div class="line"></div><div class="line">      // Submit files for parsing in parallel</div><div class="line">      int fileCount = 0;</div><div class="line">      for (File file : files) &#123;</div><div class="line">          final boolean isPackage = (isApkFile(file) || file.isDirectory())</div><div class="line">                  &amp;&amp; !PackageInstallerService.isStageName(file.getName());</div><div class="line">          if (!isPackage) &#123;</div><div class="line">              // Ignore entries which are not packages</div><div class="line">              continue;</div><div class="line">          &#125;</div><div class="line">          parallelPackageParser.submit(file, parseFlags);  //解析为package入队列</div><div class="line">          fileCount++;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      // Process results one by one</div><div class="line">      for (; fileCount &gt; 0; fileCount--) &#123;</div><div class="line">          ParallelPackageParser.ParseResult parseResult = parallelPackageParser.take(); //从队列中取出</div><div class="line">          Throwable throwable = parseResult.throwable;</div><div class="line">          int errorCode = PackageManager.INSTALL_SUCCEEDED;</div><div class="line"></div><div class="line">          if (throwable == null) &#123;</div><div class="line">              // Static shared libraries have synthetic package names</div><div class="line">              if (parseResult.pkg.applicationInfo.isStaticSharedLibrary()) &#123;</div><div class="line">                  renameStaticSharedLibraryPackage(parseResult.pkg);</div><div class="line">              &#125;</div><div class="line">              try &#123;</div><div class="line">                  if (errorCode == PackageManager.INSTALL_SUCCEEDED) &#123;</div><div class="line">				</div><div class="line">				//解析安装，8.0下调用的是6个参数版的</div><div class="line">                      scanPackageLI(parseResult.pkg, parseResult.scanFile, parseFlags, scanFlags,</div><div class="line">                              currentTime, null);</div><div class="line">						</div><div class="line">						</div><div class="line">                  &#125;</div><div class="line">              &#125; catch (PackageManagerException e) &#123;</div><div class="line">                  errorCode = e.error;</div><div class="line">                  Slog.w(TAG, &quot;Failed to scan &quot; + parseResult.scanFile + &quot;: &quot; + e.getMessage());</div><div class="line">              &#125;</div><div class="line">          &#125; else if (throwable instanceof PackageParser.PackageParserException) &#123;</div><div class="line">              PackageParser.PackageParserException e = (PackageParser.PackageParserException)</div><div class="line">                      throwable;</div><div class="line">              errorCode = e.error;</div><div class="line">              Slog.w(TAG, &quot;Failed to parse &quot; + parseResult.scanFile + &quot;: &quot; + e.getMessage());</div><div class="line">          &#125; else &#123;</div><div class="line">              throw new IllegalStateException(&quot;Unexpected exception occurred while parsing &quot;</div><div class="line">                      + parseResult.scanFile, throwable);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          // Delete invalid userdata apps</div><div class="line">          if ((parseFlags &amp; PackageParser.PARSE_IS_SYSTEM) == 0 &amp;&amp;</div><div class="line">                  errorCode == PackageManager.INSTALL_FAILED_INVALID_APK) &#123;</div><div class="line">              logCriticalInfo(Log.WARN,</div><div class="line">                      &quot;Deleting invalid package at &quot; + parseResult.scanFile);</div><div class="line">              removeCodePathLI(parseResult.scanFile);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      parallelPackageParser.close();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>构建ParallelPackageParser对象，遍历目录文件，调用parallelPackageParser.submit解析，用scanPackageLI函数来对它进行更新解析和安装。</p>
<h3 id="8-submit"><a href="#8-submit" class="headerlink" title="8.submit"></a>8.submit</h3><p>parallelPackageParser.submit：</p>
<p>frameworks\base\services\core\java\com\android\server\pm\ParallelPackageParser.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">   public void submit(File scanFile, int parseFlags) &#123;</div><div class="line">       mService.submit(() -&gt; &#123;</div><div class="line">           ParseResult pr = new ParseResult();</div><div class="line">           Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, &quot;parallel parsePackage [&quot; + scanFile + &quot;]&quot;);</div><div class="line">           try &#123;</div><div class="line">               PackageParser pp = new PackageParser();</div><div class="line">               pp.setSeparateProcesses(mSeparateProcesses);</div><div class="line">               pp.setOnlyCoreApps(mOnlyCore);</div><div class="line">               pp.setDisplayMetrics(mMetrics);</div><div class="line">               pp.setCacheDir(mCacheDir);</div><div class="line">               pp.setCallback(mPackageParserCallback);</div><div class="line">               pr.scanFile = scanFile;</div><div class="line">               pr.pkg = parsePackage(pp, scanFile, parseFlags);</div><div class="line">           &#125; catch (Throwable e) &#123;</div><div class="line">               pr.throwable = e;</div><div class="line">           &#125; finally &#123;</div><div class="line">               Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</div><div class="line">           &#125;</div><div class="line">           try &#123;</div><div class="line">               mQueue.put(pr);</div><div class="line">           &#125; catch (InterruptedException e) &#123;</div><div class="line">               Thread.currentThread().interrupt();</div><div class="line">               // Propagate result to callers of take().</div><div class="line">               // This is helpful to prevent main thread from getting stuck waiting on</div><div class="line">               // ParallelPackageParser to finish in case of interruption</div><div class="line">               mInterruptedInThread = Thread.currentThread().getName();</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">@VisibleForTesting</div><div class="line">   protected PackageParser.Package parsePackage(PackageParser packageParser, File scanFile,</div><div class="line">           int parseFlags) throws PackageParser.PackageParserException &#123;</div><div class="line">       return packageParser.parsePackage(scanFile, parseFlags, true /* useCaches */);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>构建结果对象ParseResult pr = new ParseResult();<br>构建包解析器PackageParser pp = new PackageParser();的parsePackage方法对其解析，解析结果为PackageParser.Package存入pr.pkg将pr放入队列</p>
<h3 id="12-parsePackage"><a href="#12-parsePackage" class="headerlink" title="12.parsePackage"></a>12.parsePackage</h3><p>PackageParser.parsePackage:  此后方法都是解析器的</p>
<p>frameworks\base\core\java\android\content\pm\PackageParser.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line">   public Package parsePackage(File packageFile, int flags, boolean useCaches)</div><div class="line">           throws PackageParserException &#123;</div><div class="line">       Package parsed = useCaches ? getCachedResult(packageFile, flags) : null;   //获取缓存结果</div><div class="line">       if (parsed != null) &#123;</div><div class="line">           return parsed;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       if (packageFile.isDirectory()) &#123;</div><div class="line">           parsed = parseClusterPackage(packageFile, flags);</div><div class="line">       &#125; else &#123;</div><div class="line">           parsed = parseMonolithicPackage(packageFile, flags);  //进一步分类解析apk</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       cacheResult(packageFile, flags, parsed);  //缓存结果</div><div class="line"></div><div class="line">       return parsed;</div><div class="line">	</div><div class="line">   &#125;</div><div class="line"></div><div class="line">@Deprecated</div><div class="line">   public Package parseMonolithicPackage(File apkFile, int flags) throws PackageParserException &#123;</div><div class="line">       final AssetManager assets = newConfiguredAssetManager();</div><div class="line">       final PackageLite lite = parseMonolithicPackageLite(apkFile, flags);</div><div class="line">       if (mOnlyCoreApps) &#123;</div><div class="line">           if (!lite.coreApp) &#123;</div><div class="line">               throw new PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</div><div class="line">                       &quot;Not a coreApp: &quot; + apkFile);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       try &#123;</div><div class="line">           final Package pkg = parseBaseApk(apkFile, assets, flags);   //加assets资源解析，但assets的路径是在？之前只是new但并没具体路径</div><div class="line">           pkg.setCodePath(apkFile.getAbsolutePath());</div><div class="line">           pkg.setUse32bitAbi(lite.use32bitAbi);</div><div class="line">           return pkg;</div><div class="line">       &#125; finally &#123;</div><div class="line">           IoUtils.closeQuietly(assets);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">private Package parseBaseApk(File apkFile, AssetManager assets, int flags)</div><div class="line">           throws PackageParserException &#123;</div><div class="line">       final String apkPath = apkFile.getAbsolutePath();</div><div class="line"></div><div class="line">       String volumeUuid = null;</div><div class="line">       if (apkPath.startsWith(MNT_EXPAND)) &#123;</div><div class="line">           final int end = apkPath.indexOf(&apos;/&apos;, MNT_EXPAND.length());</div><div class="line">           volumeUuid = apkPath.substring(MNT_EXPAND.length(), end);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       mParseError = PackageManager.INSTALL_SUCCEEDED;</div><div class="line">       mArchiveSourcePath = apkFile.getAbsolutePath();</div><div class="line"></div><div class="line">       if (DEBUG_JAR) Slog.d(TAG, &quot;Scanning base APK: &quot; + apkPath);</div><div class="line"></div><div class="line">       final int cookie = loadApkIntoAssetManager(assets, apkPath, flags);</div><div class="line"></div><div class="line">       Resources res = null;</div><div class="line">       XmlResourceParser parser = null;</div><div class="line">       try &#123;</div><div class="line">           res = new Resources(assets, mMetrics, null);  //此时加入资源</div><div class="line">           parser = assets.openXmlResourceParser(cookie, ANDROID_MANIFEST_FILENAME);</div><div class="line"></div><div class="line">           final String[] outError = new String[1];</div><div class="line">		</div><div class="line">           final Package pkg = parseBaseApk(apkPath, res, parser, flags, outError);   //进一步调用parseBaseApk</div><div class="line">      </div><div class="line"></div><div class="line">           pkg.setVolumeUuid(volumeUuid);</div><div class="line">           pkg.setApplicationVolumeUuid(volumeUuid);</div><div class="line">           pkg.setBaseCodePath(apkPath);</div><div class="line">           pkg.setSignatures(null);</div><div class="line"></div><div class="line">           return pkg;</div><div class="line"></div><div class="line">       &#125; catch </div><div class="line">	......</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>构建资源res = new Resources(assets, mMetrics, null); 构建xml解析器XmlResourceParser<br>进一步分类解析apk，调用到关键函数：<br>final Package pkg = parseBaseApk(apkPath, res, parser, flags, outError);解析AndroidMainifest.xml</p>
<h3 id="16-parseBaseApk"><a href="#16-parseBaseApk" class="headerlink" title="16.parseBaseApk"></a>16.parseBaseApk</h3><p>PackageParser.parseBaseApk<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div></pre></td><td class="code"><pre><div class="line">private Package parseBaseApk(String apkPath, Resources res, XmlResourceParser parser, int flags,</div><div class="line">            String[] outError) throws XmlPullParserException, IOException &#123;</div><div class="line">        final String splitName;</div><div class="line">        final String pkgName;</div><div class="line"></div><div class="line">		......</div><div class="line"></div><div class="line">        final Package pkg = new Package(pkgName);</div><div class="line"></div><div class="line">		</div><div class="line">		</div><div class="line">		//获取AndroidManifest的数组</div><div class="line">        TypedArray sa = res.obtainAttributes(parser,</div><div class="line">                com.android.internal.R.styleable.AndroidManifest);</div><div class="line">		</div><div class="line">		</div><div class="line">		//读出版本等</div><div class="line">        pkg.mVersionCode = pkg.applicationInfo.versionCode = sa.getInteger(</div><div class="line">                com.android.internal.R.styleable.AndroidManifest_versionCode, 0);</div><div class="line">        pkg.baseRevisionCode = sa.getInteger(</div><div class="line">                com.android.internal.R.styleable.AndroidManifest_revisionCode, 0);</div><div class="line">        pkg.mVersionName = sa.getNonConfigurationString(</div><div class="line">                com.android.internal.R.styleable.AndroidManifest_versionName, 0);</div><div class="line">        if (pkg.mVersionName != null) &#123;</div><div class="line">            pkg.mVersionName = pkg.mVersionName.intern();</div><div class="line">        &#125;</div><div class="line">		</div><div class="line">		</div><div class="line">		//是否核心</div><div class="line">        pkg.coreApp = parser.getAttributeBooleanValue(null, &quot;coreApp&quot;, false);</div><div class="line">		//回收</div><div class="line">        sa.recycle();</div><div class="line"></div><div class="line">        return parseBaseApkCommon(pkg, null, res, parser, flags, outError);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">	</div><div class="line">	</div><div class="line">    /**</div><div class="line">     * This is the common parsing routing for handling parent and child</div><div class="line">     * packages in a base APK. The difference between parent and child</div><div class="line">     * parsing is that some tags are not supported by child packages as</div><div class="line">     * well as some manifest attributes are ignored. The implementation</div><div class="line">     * assumes the calling code has already handled the manifest tag if needed</div><div class="line">     * (this applies to the parent only).</div><div class="line">     *</div><div class="line">     * @param pkg The package which to populate</div><div class="line">     * @param acceptedTags Which tags to handle, null to handle all</div><div class="line">     * @param res Resources against which to resolve values</div><div class="line">     * @param parser Parser of the manifest</div><div class="line">     * @param flags Flags about how to parse</div><div class="line">     * @param outError Human readable error if parsing fails</div><div class="line">     * @return The package if parsing succeeded or null.</div><div class="line">     *</div><div class="line">     * @throws XmlPullParserException</div><div class="line">     * @throws IOException</div><div class="line">     */</div><div class="line">    private Package parseBaseApkCommon(Package pkg, Set&lt;String&gt; acceptedTags, Resources res,</div><div class="line">            XmlResourceParser parser, int flags, String[] outError) throws XmlPullParserException,</div><div class="line">            IOException &#123;</div><div class="line">        mParseInstrumentationArgs = null;</div><div class="line">        mParseActivityArgs = null;</div><div class="line">        mParseServiceArgs = null;</div><div class="line">        mParseProviderArgs = null;</div><div class="line"></div><div class="line">        int type;</div><div class="line">        boolean foundApp = false;</div><div class="line">		//AndroidManifest</div><div class="line">        TypedArray sa = res.obtainAttributes(parser,</div><div class="line">                com.android.internal.R.styleable.AndroidManifest);</div><div class="line"></div><div class="line">				</div><div class="line">        String str = sa.getNonConfigurationString(</div><div class="line">                com.android.internal.R.styleable.AndroidManifest_sharedUserId, 0);</div><div class="line">		......</div><div class="line"></div><div class="line">        // Resource boolean are -1, so 1 means we don&apos;t know the value.</div><div class="line">        int supportsSmallScreens = 1;</div><div class="line">        int supportsNormalScreens = 1;</div><div class="line">        int supportsLargeScreens = 1;</div><div class="line">        int supportsXLargeScreens = 1;</div><div class="line">        int resizeable = 1;</div><div class="line">        int anyDensity = 1;</div><div class="line"></div><div class="line">        int outerDepth = parser.getDepth();</div><div class="line">		</div><div class="line">		//解析AndroidMainifest的各个标签</div><div class="line">        while ((type = parser.next()) != XmlPullParser.END_DOCUMENT</div><div class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</div><div class="line">            if (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            String tagName = parser.getName();</div><div class="line"></div><div class="line">            if (acceptedTags != null &amp;&amp; !acceptedTags.contains(tagName)) &#123;</div><div class="line">                Slog.w(TAG, &quot;Skipping unsupported element under &lt;manifest&gt;: &quot;</div><div class="line">                        + tagName + &quot; at &quot; + mArchiveSourcePath + &quot; &quot;</div><div class="line">                        + parser.getPositionDescription());</div><div class="line">                XmlUtils.skipCurrentTag(parser);</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">			//application</div><div class="line">            if (tagName.equals(TAG_APPLICATION)) &#123;</div><div class="line">                if (foundApp) &#123;</div><div class="line">                    if (RIGID_PARSER) &#123;</div><div class="line">                        outError[0] = &quot;&lt;manifest&gt; has more than one &lt;application&gt;&quot;;</div><div class="line">                        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</div><div class="line">                        return null;</div><div class="line">                    &#125; else &#123;</div><div class="line">                        Slog.w(TAG, &quot;&lt;manifest&gt; has more than one &lt;application&gt;&quot;);</div><div class="line">                        XmlUtils.skipCurrentTag(parser);</div><div class="line">                        continue;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                foundApp = true;</div><div class="line">                if (!parseBaseApplication(pkg, res, parser, flags, outError)) &#123;</div><div class="line">                    return null;</div><div class="line">                &#125;</div><div class="line">            &#125; else if (tagName.equals(TAG_OVERLAY)) &#123;</div><div class="line">				......</div><div class="line"></div><div class="line">            &#125; else if (tagName.equals(TAG_KEY_SETS)) &#123;</div><div class="line">                if (!parseKeySets(pkg, res, parser, outError)) &#123;</div><div class="line">                    return null;</div><div class="line">                &#125;</div><div class="line">            &#125; else if (tagName.equals(TAG_PERMISSION_GROUP)) &#123;</div><div class="line">                if (!parsePermissionGroup(pkg, flags, res, parser, outError)) &#123;</div><div class="line">                    return null;</div><div class="line">                &#125;</div><div class="line">            &#125; else if (tagName.equals(TAG_PERMISSION)) &#123;</div><div class="line">                if (!parsePermission(pkg, res, parser, outError)) &#123;</div><div class="line">                    return null;</div><div class="line">                &#125;</div><div class="line">				</div><div class="line">				......</div><div class="line">				</div><div class="line">			else &#123;</div><div class="line">                Slog.w(TAG, &quot;Unknown element under &lt;manifest&gt;: &quot; + parser.getName()</div><div class="line">                        + &quot; at &quot; + mArchiveSourcePath + &quot; &quot;</div><div class="line">                        + parser.getPositionDescription());</div><div class="line">                XmlUtils.skipCurrentTag(parser);</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">		......</div><div class="line">		</div><div class="line">        return pkg;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>解析AndroidMainifest的工作主要在这里</p>
<h3 id="9-scanPackageLI"><a href="#9-scanPackageLI" class="headerlink" title="9.scanPackageLI"></a>9.scanPackageLI</h3><p>PackageManagerService.scanDirLI最后调用这个安装apk，之前是xml的解析</p>
<p>PackageManagerService.scanPackageLI<br>frameworks\base\services\core\java\com\android\server\pm\PackageManagerService.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> *  Scans a package and returns the newly parsed package.</div><div class="line"> *  @throws PackageManagerException on a parse error.</div><div class="line"> */</div><div class="line">private PackageParser.Package scanPackageLI(PackageParser.Package pkg, File scanFile,</div><div class="line">        final int policyFlags, int scanFlags, long currentTime, @Nullable UserHandle user)</div><div class="line">        throws PackageManagerException &#123;</div><div class="line">    // If the package has children and this is the first dive in the function</div><div class="line">    // we scan the package with the SCAN_CHECK_ONLY flag set to see whether all</div><div class="line">    // packages (parent and children) would be successfully scanned before the</div><div class="line">    // actual scan since scanning mutates internal state and we want to atomically</div><div class="line">    // install the package and its children.</div><div class="line">    if ((scanFlags &amp; SCAN_CHECK_ONLY) == 0) &#123;</div><div class="line">        if (pkg.childPackages != null &amp;&amp; pkg.childPackages.size() &gt; 0) &#123;</div><div class="line">            scanFlags |= SCAN_CHECK_ONLY;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        scanFlags &amp;= ~SCAN_CHECK_ONLY;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Scan the parent</div><div class="line">    PackageParser.Package scannedPkg = scanPackageInternalLI(pkg, scanFile, policyFlags,</div><div class="line">            scanFlags, currentTime, user);</div><div class="line"></div><div class="line">    // Scan the children</div><div class="line">    final int childCount = (pkg.childPackages != null) ? pkg.childPackages.size() : 0;</div><div class="line">    for (int i = 0; i &lt; childCount; i++) &#123;</div><div class="line">        PackageParser.Package childPackage = pkg.childPackages.get(i);</div><div class="line">        scanPackageInternalLI(childPackage, scanFile, policyFlags, scanFlags,</div><div class="line">                currentTime, user);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    if ((scanFlags &amp; SCAN_CHECK_ONLY) != 0) &#123;</div><div class="line">        return scanPackageLI(pkg, scanFile, policyFlags, scanFlags, currentTime, user);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return scannedPkg;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用scanPackageInternalLI更新解析包。<br>该函数扫描并返回新的解析过的包。</p>
<h3 id="11-scanPackageInternalLI"><a href="#11-scanPackageInternalLI" class="headerlink" title="11.scanPackageInternalLI"></a>11.scanPackageInternalLI</h3><p>PackageManagerService.scanPackageInternalLI<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  /**</div><div class="line">   *  Scans a package and returns the newly parsed package.</div><div class="line">   *  @throws PackageManagerException on a parse error.</div><div class="line">   */</div><div class="line">  private PackageParser.Package scanPackageInternalLI(PackageParser.Package pkg, File scanFile,</div><div class="line">          int policyFlags, int scanFlags, long currentTime, @Nullable UserHandle user)</div><div class="line">          throws PackageManagerException &#123;</div><div class="line"></div><div class="line">......各种判断更新app包pkg的操作。</div><div class="line"></div><div class="line">      // The apk is forward locked (not public) if its code and resources</div><div class="line">      // are kept in different files. (except for app in either system or</div><div class="line">      // vendor path).</div><div class="line">      // TODO grab this value from PackageSettings</div><div class="line">      if ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == 0) &#123;</div><div class="line">          if (ps != null &amp;&amp; !ps.codePath.equals(ps.resourcePath)) &#123;</div><div class="line">              policyFlags |= PackageParser.PARSE_FORWARD_LOCK;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      // TODO: extend to support forward-locked splits</div><div class="line">      String resourcePath = null;</div><div class="line">      String baseResourcePath = null;</div><div class="line">      if ((policyFlags &amp; PackageParser.PARSE_FORWARD_LOCK) != 0 &amp;&amp; !updatedPkgBetter) &#123;</div><div class="line">          if (ps != null &amp;&amp; ps.resourcePathString != null) &#123;</div><div class="line">              resourcePath = ps.resourcePathString;</div><div class="line">              baseResourcePath = ps.resourcePathString;</div><div class="line">          &#125; else &#123;</div><div class="line">              // Should not happen at all. Just log an error.</div><div class="line">              Slog.e(TAG, &quot;Resource path not set for package &quot; + pkg.packageName);</div><div class="line">          &#125;</div><div class="line">      &#125; else &#123;</div><div class="line">          resourcePath = pkg.codePath;</div><div class="line">          baseResourcePath = pkg.baseCodePath;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      // 明确app各路径</div><div class="line">      pkg.setApplicationVolumeUuid(pkg.volumeUuid);</div><div class="line">      pkg.setApplicationInfoCodePath(pkg.codePath);</div><div class="line">      pkg.setApplicationInfoBaseCodePath(pkg.baseCodePath);</div><div class="line">      pkg.setApplicationInfoSplitCodePaths(pkg.splitCodePaths);</div><div class="line">      pkg.setApplicationInfoResourcePath(resourcePath);</div><div class="line">      pkg.setApplicationInfoBaseResourcePath(baseResourcePath);</div><div class="line">      pkg.setApplicationInfoSplitResourcePaths(pkg.splitCodePaths);</div><div class="line"></div><div class="line">      final int userId = ((user == null) ? 0 : user.getIdentifier());</div><div class="line">      if (ps != null &amp;&amp; ps.getInstantApp(userId)) &#123;</div><div class="line">          scanFlags |= SCAN_AS_INSTANT_APP;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      // Note that we invoke the following method only if we are about to unpack an application</div><div class="line">//请注意，仅当我们要解压缩应用程序时，才会调用以下方法</div><div class="line">      PackageParser.Package scannedPkg = scanPackageLI(pkg, policyFlags, scanFlags</div><div class="line">              | SCAN_UPDATE_SIGNATURE, currentTime, user);</div><div class="line"></div><div class="line">      /*</div><div class="line">       * If the system app should be overridden by a previously installed</div><div class="line">       * data, hide the system app now and let the /data/app scan pick it up</div><div class="line">       * again.</div><div class="line">       */</div><div class="line">      if (shouldHideSystemApp) &#123;</div><div class="line">          synchronized (mPackages) &#123;</div><div class="line">              mSettings.disableSystemPackageLPw(pkg.packageName, true);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      return scannedPkg;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>scanPackageInternalLI方法是把扫描到的androidmainifest数据和之前在手机内扫描得到的数据做对比，然后进行pkg的进一步设置。返回新的包.<br>最后调用：</p>
<h3 id="13-scanPackageLI"><a href="#13-scanPackageLI" class="headerlink" title="13.scanPackageLI"></a>13.scanPackageLI</h3><p>参数5且首为package的scanPackageLI</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  private PackageParser.Package scanPackageLI(PackageParser.Package pkg, final int policyFlags,</div><div class="line">          int scanFlags, long currentTime, @Nullable UserHandle user)</div><div class="line">                  throws PackageManagerException &#123;</div><div class="line">      boolean success = false;</div><div class="line">      try &#123;</div><div class="line"></div><div class="line">//安装核心函数</div><div class="line">          final PackageParser.Package res = scanPackageDirtyLI(pkg, policyFlags, scanFlags,</div><div class="line">                  currentTime, user);</div><div class="line">          success = true;</div><div class="line">          return res;</div><div class="line">      &#125; finally &#123;</div><div class="line">          if (!success &amp;&amp; (scanFlags &amp; SCAN_DELETE_DATA_ON_FAILURES) != 0) &#123;</div><div class="line">              // DELETE_DATA_ON_FAILURES is only used by frozen paths</div><div class="line">              destroyAppDataLIF(pkg, UserHandle.USER_ALL,</div><div class="line">                      StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);</div><div class="line">              destroyAppProfilesLIF(pkg, UserHandle.USER_ALL);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>调用scanPackageDirtyLI(pkg, policyFlags, scanFlags,currentTime, user);安装<br>参数为：解析好的pkg安装包信息。俩个Flags。当前时间</p>
<h3 id="15-scanPackageDirtyLI"><a href="#15-scanPackageDirtyLI" class="headerlink" title="15.scanPackageDirtyLI"></a>15.scanPackageDirtyLI</h3><p>PackageManagerService.scanPackageDirtyLI：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">private PackageParser.Package scanPackageDirtyLI(PackageParser.Package pkg,</div><div class="line">        final int policyFlags, final int scanFlags, long currentTime, @Nullable UserHandle user)</div><div class="line">                throws PackageManagerException &#123;</div><div class="line">    if (DEBUG_PACKAGE_SCANNING) &#123;</div><div class="line">        if ((policyFlags &amp; PackageParser.PARSE_CHATTY) != 0)</div><div class="line">            Log.d(TAG, &quot;Scanning package &quot; + pkg.packageName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    applyPolicy(pkg, policyFlags);</div><div class="line"></div><div class="line">    assertPackageIsValid(pkg, policyFlags, scanFlags);</div><div class="line"></div><div class="line">    // 初始化资源和包目录</div><div class="line">    final File scanFile = new File(pkg.codePath);</div><div class="line">    final File destCodeFile = new File(pkg.applicationInfo.getCodePath());</div><div class="line">    final File destResourceFile = new File(pkg.applicationInfo.getResourcePath());</div><div class="line"></div><div class="line">    SharedUserSetting suid = null;</div><div class="line">    PackageSetting pkgSetting = null;</div><div class="line"></div><div class="line">    // Getting the package setting may have a side-effect, so if we</div><div class="line">    // are only checking if scan would succeed, stash a copy of the</div><div class="line">    // old setting to restore at the end.</div><div class="line">    PackageSetting nonMutatedPs = null;</div><div class="line"></div><div class="line">    // We keep references to the derived CPU Abis from settings in oder to reuse</div><div class="line">    // them in the case where we&apos;re not upgrading or booting for the first time.</div><div class="line">    String primaryCpuAbiFromSettings = null;</div><div class="line">    String secondaryCpuAbiFromSettings = null;</div><div class="line"></div><div class="line">    // writer</div><div class="line">    synchronized (mPackages) &#123;</div><div class="line">        if (pkg.mSharedUserId != null) &#123;</div><div class="line">            // SIDE EFFECTS; may potentially allocate a new shared user</div><div class="line">            suid = mSettings.getSharedUserLPw(</div><div class="line">                    pkg.mSharedUserId, 0 /*pkgFlags*/, 0 /*pkgPrivateFlags*/, true /*create*/);</div><div class="line">            if (DEBUG_PACKAGE_SCANNING) &#123;</div><div class="line">                if ((policyFlags &amp; PackageParser.PARSE_CHATTY) != 0)</div><div class="line">                    Log.d(TAG, &quot;Shared UserID &quot; + pkg.mSharedUserId + &quot; (uid=&quot; + suid.userId</div><div class="line">                            + &quot;): packages=&quot; + suid.packages);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Check if we are renaming from an original package name.</div><div class="line">        PackageSetting origPackage = null;</div><div class="line">        String realName = null;</div><div class="line">        if (pkg.mOriginalPackages != null) &#123;</div><div class="line">            // This package may need to be renamed to a previously</div><div class="line">            // installed name.  Let&apos;s check on that...</div><div class="line">            final String renamed = mSettings.getRenamedPackageLPr(pkg.mRealPackage);</div><div class="line">            if (pkg.mOriginalPackages.contains(renamed)) &#123;</div><div class="line">                // This package had originally been installed as the</div><div class="line">                // original name, and we have already taken care of</div><div class="line">                // transitioning to the new one.  Just update the new</div><div class="line">                // one to continue using the old name.</div><div class="line">                realName = pkg.mRealPackage;</div><div class="line">                if (!pkg.packageName.equals(renamed)) &#123;</div><div class="line">                    // Callers into this function may have already taken</div><div class="line">                    // care of renaming the package; only do it here if</div><div class="line">                    // it is not already done.</div><div class="line">                    pkg.setPackageName(renamed);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                for (int i=pkg.mOriginalPackages.size()-1; i&gt;=0; i--) &#123;</div><div class="line">                    if ((origPackage = mSettings.getPackageLPr(</div><div class="line">                            pkg.mOriginalPackages.get(i))) != null) &#123;</div><div class="line">                        // We do have the package already installed under its</div><div class="line">                        // original name...  should we use it?</div><div class="line">                        if (!verifyPackageUpdateLPr(origPackage, pkg)) &#123;</div><div class="line">                            // New package is not compatible with original.</div><div class="line">                            origPackage = null;</div><div class="line">                            continue;</div><div class="line">                        &#125; else if (origPackage.sharedUser != null) &#123;</div><div class="line">                            // Make sure uid is compatible between packages.</div><div class="line">                            if (!origPackage.sharedUser.name.equals(pkg.mSharedUserId)) &#123;</div><div class="line">                                Slog.w(TAG, &quot;Unable to migrate data from &quot; + origPackage.name</div><div class="line">                                        + &quot; to &quot; + pkg.packageName + &quot;: old uid &quot;</div><div class="line">                                        + origPackage.sharedUser.name</div><div class="line">                                        + &quot; differs from &quot; + pkg.mSharedUserId);</div><div class="line">                                origPackage = null;</div><div class="line">                                continue;</div><div class="line">                            &#125;</div><div class="line">                            // TODO: Add case when shared user id is added [b/28144775]</div><div class="line">                        &#125; else &#123;</div><div class="line">                            if (DEBUG_UPGRADE) Log.v(TAG, &quot;Renaming new package &quot;</div><div class="line">                                    + pkg.packageName + &quot; to old name &quot; + origPackage.name);</div><div class="line">                        &#125;</div><div class="line">                        break;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (mTransferedPackages.contains(pkg.packageName)) &#123;</div><div class="line">            Slog.w(TAG, &quot;Package &quot; + pkg.packageName</div><div class="line">                    + &quot; was transferred to another, but its .apk remains&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // See comments in nonMutatedPs declaration</div><div class="line">        if ((scanFlags &amp; SCAN_CHECK_ONLY) != 0) &#123;</div><div class="line">            PackageSetting foundPs = mSettings.getPackageLPr(pkg.packageName);</div><div class="line">            if (foundPs != null) &#123;</div><div class="line">                nonMutatedPs = new PackageSetting(foundPs);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if ((scanFlags &amp; SCAN_FIRST_BOOT_OR_UPGRADE) == 0) &#123;</div><div class="line">            PackageSetting foundPs = mSettings.getPackageLPr(pkg.packageName);</div><div class="line">            if (foundPs != null) &#123;</div><div class="line">                primaryCpuAbiFromSettings = foundPs.primaryCpuAbiString;</div><div class="line">                secondaryCpuAbiFromSettings = foundPs.secondaryCpuAbiString;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        pkgSetting = mSettings.getPackageLPr(pkg.packageName);</div><div class="line">        if (pkgSetting != null &amp;&amp; pkgSetting.sharedUser != suid) &#123;</div><div class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</div><div class="line">                    &quot;Package &quot; + pkg.packageName + &quot; shared user changed from &quot;</div><div class="line">                            + (pkgSetting.sharedUser != null</div><div class="line">                                    ? pkgSetting.sharedUser.name : &quot;&lt;nothing&gt;&quot;)</div><div class="line">                            + &quot; to &quot;</div><div class="line">                            + (suid != null ? suid.name : &quot;&lt;nothing&gt;&quot;)</div><div class="line">                            + &quot;; replacing with new&quot;);</div><div class="line">            pkgSetting = null;</div><div class="line">        &#125;</div><div class="line">        final PackageSetting oldPkgSetting =</div><div class="line">                pkgSetting == null ? null : new PackageSetting(pkgSetting);</div><div class="line">        final PackageSetting disabledPkgSetting =</div><div class="line">                mSettings.getDisabledSystemPkgLPr(pkg.packageName);</div><div class="line"></div><div class="line">        String[] usesStaticLibraries = null;</div><div class="line">        if (pkg.usesStaticLibraries != null) &#123;</div><div class="line">            usesStaticLibraries = new String[pkg.usesStaticLibraries.size()];</div><div class="line">            pkg.usesStaticLibraries.toArray(usesStaticLibraries);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (pkgSetting == null) &#123;</div><div class="line">            final String parentPackageName = (pkg.parentPackage != null)</div><div class="line">                    ? pkg.parentPackage.packageName : null;</div><div class="line">            final boolean instantApp = (scanFlags &amp; SCAN_AS_INSTANT_APP) != 0;</div><div class="line">            // REMOVE SharedUserSetting from method; update in a separate call</div><div class="line">            pkgSetting = Settings.createNewSetting(pkg.packageName, origPackage,</div><div class="line">                    disabledPkgSetting, realName, suid, destCodeFile, destResourceFile,</div><div class="line">                    pkg.applicationInfo.nativeLibraryRootDir, pkg.applicationInfo.primaryCpuAbi,</div><div class="line">                    pkg.applicationInfo.secondaryCpuAbi, pkg.mVersionCode,</div><div class="line">                    pkg.applicationInfo.flags, pkg.applicationInfo.privateFlags, user,</div><div class="line">                    true /*allowInstall*/, instantApp, parentPackageName,</div><div class="line">                    pkg.getChildPackageNames(), UserManagerService.getInstance(),</div><div class="line">                    usesStaticLibraries, pkg.usesStaticLibrariesVersions);</div><div class="line">            // SIDE EFFECTS; updates system state; move elsewhere</div><div class="line">            if (origPackage != null) &#123;</div><div class="line">                mSettings.addRenamedPackageLPw(pkg.packageName, origPackage.name);</div><div class="line">            &#125;</div><div class="line">            mSettings.addUserToSettingLPw(pkgSetting);</div><div class="line">        &#125; else &#123;</div><div class="line">            // REMOVE SharedUserSetting from method; update in a separate call.</div><div class="line">            //</div><div class="line">            // TODO(narayan): This update is bogus. nativeLibraryDir &amp; primaryCpuAbi,</div><div class="line">            // secondaryCpuAbi are not known at this point so we always update them</div><div class="line">            // to null here, only to reset them at a later point.</div><div class="line">            Settings.updatePackageSetting(pkgSetting, disabledPkgSetting, suid, destCodeFile,</div><div class="line">                    pkg.applicationInfo.nativeLibraryDir, pkg.applicationInfo.primaryCpuAbi,</div><div class="line">                    pkg.applicationInfo.secondaryCpuAbi, pkg.applicationInfo.flags,</div><div class="line">                    pkg.applicationInfo.privateFlags, pkg.getChildPackageNames(),</div><div class="line">                    UserManagerService.getInstance(), usesStaticLibraries,</div><div class="line">                    pkg.usesStaticLibrariesVersions);</div><div class="line">        &#125;</div><div class="line">        // SIDE EFFECTS; persists system state to files on disk; move elsewhere</div><div class="line">        mSettings.writeUserRestrictionsLPw(pkgSetting, oldPkgSetting);</div><div class="line"></div><div class="line">        // SIDE EFFECTS; modifies system state; move elsewhere</div><div class="line">        if (pkgSetting.origPackage != null) &#123;</div><div class="line">            // If we are first transitioning from an original package,</div><div class="line">            // fix up the new package&apos;s name now.  We need to do this after</div><div class="line">            // looking up the package under its new name, so getPackageLP</div><div class="line">            // can take care of fiddling things correctly.</div><div class="line">            pkg.setPackageName(origPackage.name);</div><div class="line"></div><div class="line">            // File a report about this.</div><div class="line">            String msg = &quot;New package &quot; + pkgSetting.realName</div><div class="line">                    + &quot; renamed to replace old package &quot; + pkgSetting.name;</div><div class="line">            reportSettingsProblem(Log.WARN, msg);</div><div class="line"></div><div class="line">            // Make a note of it.</div><div class="line">            if ((scanFlags &amp; SCAN_CHECK_ONLY) == 0) &#123;</div><div class="line">                mTransferedPackages.add(origPackage.name);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // No longer need to retain this.</div><div class="line">            pkgSetting.origPackage = null;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // SIDE EFFECTS; modifies system state; move elsewhere</div><div class="line">        if ((scanFlags &amp; SCAN_CHECK_ONLY) == 0 &amp;&amp; realName != null) &#123;</div><div class="line">            // Make a note of it.</div><div class="line">            mTransferedPackages.add(pkg.packageName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (mSettings.isDisabledSystemPackageLPr(pkg.packageName)) &#123;</div><div class="line">            pkg.applicationInfo.flags |= ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if ((scanFlags &amp; SCAN_BOOTING) == 0</div><div class="line">                &amp;&amp; (policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == 0) &#123;</div><div class="line">            // Check all shared libraries and map to their actual file path.</div><div class="line">            // We only do this here for apps not on a system dir, because those</div><div class="line">            // are the only ones that can fail an install due to this.  We</div><div class="line">            // will take care of the system apps by updating all of their</div><div class="line">            // library paths after the scan is done. Also during the initial</div><div class="line">            // scan don&apos;t update any libs as we do this wholesale after all</div><div class="line">            // apps are scanned to avoid dependency based scanning.</div><div class="line">            updateSharedLibrariesLPr(pkg, null);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (mFoundPolicyFile) &#123;</div><div class="line">            SELinuxMMAC.assignSeInfoValue(pkg);</div><div class="line">        &#125;</div><div class="line">        pkg.applicationInfo.uid = pkgSetting.appId;</div><div class="line">        pkg.mExtras = pkgSetting;</div><div class="line"></div><div class="line"></div><div class="line">        // Static shared libs have same package with different versions where</div><div class="line">        // we internally use a synthetic package name to allow multiple versions</div><div class="line">        // of the same package, therefore we need to compare signatures against</div><div class="line">        // the package setting for the latest library version.</div><div class="line">        PackageSetting signatureCheckPs = pkgSetting;</div><div class="line">        if (pkg.applicationInfo.isStaticSharedLibrary()) &#123;</div><div class="line">            SharedLibraryEntry libraryEntry = getLatestSharedLibraVersionLPr(pkg);</div><div class="line">            if (libraryEntry != null) &#123;</div><div class="line">                signatureCheckPs = mSettings.getPackageLPr(libraryEntry.apk);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (shouldCheckUpgradeKeySetLP(signatureCheckPs, scanFlags)) &#123;</div><div class="line">            if (checkUpgradeKeySetLP(signatureCheckPs, pkg)) &#123;</div><div class="line">                // We just determined the app is signed correctly, so bring</div><div class="line">                // over the latest parsed certs.</div><div class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</div><div class="line">            &#125; else &#123;</div><div class="line">                if ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == 0) &#123;</div><div class="line">                    throw new PackageManagerException(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</div><div class="line">                            &quot;Package &quot; + pkg.packageName + &quot; upgrade keys do not match the &quot;</div><div class="line">                            + &quot;previously installed version&quot;);</div><div class="line">                &#125; else &#123;</div><div class="line">                    pkgSetting.signatures.mSignatures = pkg.mSignatures;</div><div class="line">                    String msg = &quot;System package &quot; + pkg.packageName</div><div class="line">                            + &quot; signature changed; retaining data.&quot;;</div><div class="line">                    reportSettingsProblem(Log.WARN, msg);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            try &#123;</div><div class="line">                // SIDE EFFECTS; compareSignaturesCompat() changes KeysetManagerService</div><div class="line">                verifySignaturesLP(signatureCheckPs, pkg);</div><div class="line">                // We just determined the app is signed correctly, so bring</div><div class="line">                // over the latest parsed certs.</div><div class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</div><div class="line">            &#125; catch (PackageManagerException e) &#123;</div><div class="line">                if ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == 0) &#123;</div><div class="line">                    throw e;</div><div class="line">                &#125;</div><div class="line">                // The signature has changed, but this package is in the system</div><div class="line">                // image...  let&apos;s recover!</div><div class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</div><div class="line">                // However...  if this package is part of a shared user, but it</div><div class="line">                // doesn&apos;t match the signature of the shared user, let&apos;s fail.</div><div class="line">                // What this means is that you can&apos;t change the signatures</div><div class="line">                // associated with an overall shared user, which doesn&apos;t seem all</div><div class="line">                // that unreasonable.</div><div class="line">                if (signatureCheckPs.sharedUser != null) &#123;</div><div class="line">                    if (compareSignatures(signatureCheckPs.sharedUser.signatures.mSignatures,</div><div class="line">                            pkg.mSignatures) != PackageManager.SIGNATURE_MATCH) &#123;</div><div class="line">                        throw new PackageManagerException(</div><div class="line">                                INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES,</div><div class="line">                                &quot;Signature mismatch for shared user: &quot;</div><div class="line">                                        + pkgSetting.sharedUser);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                // File a report about this.</div><div class="line">                String msg = &quot;System package &quot; + pkg.packageName</div><div class="line">                        + &quot; signature changed; retaining data.&quot;;</div><div class="line">                reportSettingsProblem(Log.WARN, msg);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if ((scanFlags &amp; SCAN_CHECK_ONLY) == 0 &amp;&amp; pkg.mAdoptPermissions != null) &#123;</div><div class="line">            // This package wants to adopt ownership of permissions from</div><div class="line">            // another package.</div><div class="line">            for (int i = pkg.mAdoptPermissions.size() - 1; i &gt;= 0; i--) &#123;</div><div class="line">                final String origName = pkg.mAdoptPermissions.get(i);</div><div class="line">                final PackageSetting orig = mSettings.getPackageLPr(origName);</div><div class="line">                if (orig != null) &#123;</div><div class="line">                    if (verifyPackageUpdateLPr(orig, pkg)) &#123;</div><div class="line">                        Slog.i(TAG, &quot;Adopting permissions from &quot; + origName + &quot; to &quot;</div><div class="line">                                + pkg.packageName);</div><div class="line">                        // SIDE EFFECTS; updates permissions system state; move elsewhere</div><div class="line">                        mSettings.transferPermissionsLPw(origName, pkg.packageName);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    pkg.applicationInfo.processName = fixProcessName(</div><div class="line">            pkg.applicationInfo.packageName,</div><div class="line">            pkg.applicationInfo.processName);</div><div class="line"></div><div class="line">    if (pkg != mPlatformPackage) &#123;</div><div class="line">        // Get all of our default paths setup</div><div class="line">        pkg.applicationInfo.initForUser(UserHandle.USER_SYSTEM);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    final String cpuAbiOverride = deriveAbiOverride(pkg.cpuAbiOverride, pkgSetting);</div><div class="line"></div><div class="line">    if ((scanFlags &amp; SCAN_NEW_INSTALL) == 0) &#123;</div><div class="line">        if ((scanFlags &amp; SCAN_FIRST_BOOT_OR_UPGRADE) != 0) &#123;</div><div class="line">            Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, &quot;derivePackageAbi&quot;);</div><div class="line">            final boolean extractNativeLibs = !pkg.isLibrary();</div><div class="line">            derivePackageAbi(pkg, scanFile, cpuAbiOverride, extractNativeLibs,</div><div class="line">                    mAppLib32InstallDir);</div><div class="line">            Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</div><div class="line"></div><div class="line">            // Some system apps still use directory structure for native libraries</div><div class="line">            // in which case we might end up not detecting abi solely based on apk</div><div class="line">            // structure. Try to detect abi based on directory structure.</div><div class="line">            if (isSystemApp(pkg) &amp;&amp; !pkg.isUpdatedSystemApp() &amp;&amp;</div><div class="line">                    pkg.applicationInfo.primaryCpuAbi == null) &#123;</div><div class="line">                setBundledAppAbisAndRoots(pkg, pkgSetting);</div><div class="line">                setNativeLibraryPaths(pkg, mAppLib32InstallDir);</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            // This is not a first boot or an upgrade, don&apos;t bother deriving the</div><div class="line">            // ABI during the scan. Instead, trust the value that was stored in the</div><div class="line">            // package setting.</div><div class="line">            pkg.applicationInfo.primaryCpuAbi = primaryCpuAbiFromSettings;</div><div class="line">            pkg.applicationInfo.secondaryCpuAbi = secondaryCpuAbiFromSettings;</div><div class="line"></div><div class="line">            setNativeLibraryPaths(pkg, mAppLib32InstallDir);</div><div class="line"></div><div class="line">            if (DEBUG_ABI_SELECTION) &#123;</div><div class="line">                Slog.i(TAG, &quot;Using ABIS and native lib paths from settings : &quot; +</div><div class="line">                    pkg.packageName + &quot; &quot; + pkg.applicationInfo.primaryCpuAbi + &quot;, &quot; +</div><div class="line">                    pkg.applicationInfo.secondaryCpuAbi);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        if ((scanFlags &amp; SCAN_MOVE) != 0) &#123;</div><div class="line">            // We haven&apos;t run dex-opt for this move (since we&apos;ve moved the compiled output too)</div><div class="line">            // but we already have this packages package info in the PackageSetting. We just</div><div class="line">            // use that and derive the native library path based on the new codepath.</div><div class="line">            pkg.applicationInfo.primaryCpuAbi = pkgSetting.primaryCpuAbiString;</div><div class="line">            pkg.applicationInfo.secondaryCpuAbi = pkgSetting.secondaryCpuAbiString;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Set native library paths again. For moves, the path will be updated based on the</div><div class="line">        // ABIs we&apos;ve determined above. For non-moves, the path will be updated based on the</div><div class="line">        // ABIs we determined during compilation, but the path will depend on the final</div><div class="line">        // package path (after the rename away from the stage path).</div><div class="line">        setNativeLibraryPaths(pkg, mAppLib32InstallDir);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // This is a special case for the &quot;system&quot; package, where the ABI is</div><div class="line">    // dictated by the zygote configuration (and init.rc). We should keep track</div><div class="line">    // of this ABI so that we can deal with &quot;normal&quot; applications that run under</div><div class="line">    // the same UID correctly.</div><div class="line">    if (mPlatformPackage == pkg) &#123;</div><div class="line">        pkg.applicationInfo.primaryCpuAbi = VMRuntime.getRuntime().is64Bit() ?</div><div class="line">                Build.SUPPORTED_64_BIT_ABIS[0] : Build.SUPPORTED_32_BIT_ABIS[0];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // If there&apos;s a mismatch between the abi-override in the package setting</div><div class="line">    // and the abiOverride specified for the install. Warn about this because we</div><div class="line">    // would&apos;ve already compiled the app without taking the package setting into</div><div class="line">    // account.</div><div class="line">    if ((scanFlags &amp; SCAN_NO_DEX) == 0 &amp;&amp; (scanFlags &amp; SCAN_NEW_INSTALL) != 0) &#123;</div><div class="line">        if (cpuAbiOverride == null &amp;&amp; pkgSetting.cpuAbiOverrideString != null) &#123;</div><div class="line">            Slog.w(TAG, &quot;Ignoring persisted ABI override &quot; + cpuAbiOverride +</div><div class="line">                    &quot; for package &quot; + pkg.packageName);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    pkgSetting.primaryCpuAbiString = pkg.applicationInfo.primaryCpuAbi;</div><div class="line">    pkgSetting.secondaryCpuAbiString = pkg.applicationInfo.secondaryCpuAbi;</div><div class="line">    pkgSetting.cpuAbiOverrideString = cpuAbiOverride;</div><div class="line"></div><div class="line">    // Copy the derived override back to the parsed package, so that we can</div><div class="line">    // update the package settings accordingly.</div><div class="line">    pkg.cpuAbiOverride = cpuAbiOverride;</div><div class="line"></div><div class="line">    if (DEBUG_ABI_SELECTION) &#123;</div><div class="line">        Slog.d(TAG, &quot;Resolved nativeLibraryRoot for &quot; + pkg.applicationInfo.packageName</div><div class="line">                + &quot; to root=&quot; + pkg.applicationInfo.nativeLibraryRootDir + &quot;, isa=&quot;</div><div class="line">                + pkg.applicationInfo.nativeLibraryRootRequiresIsa);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Push the derived path down into PackageSettings so we know what to</div><div class="line">    // clean up at uninstall time.</div><div class="line">    pkgSetting.legacyNativeLibraryPathString = pkg.applicationInfo.nativeLibraryRootDir;</div><div class="line"></div><div class="line">    if (DEBUG_ABI_SELECTION) &#123;</div><div class="line">        Log.d(TAG, &quot;Abis for package[&quot; + pkg.packageName + &quot;] are&quot; +</div><div class="line">                &quot; primary=&quot; + pkg.applicationInfo.primaryCpuAbi +</div><div class="line">                &quot; secondary=&quot; + pkg.applicationInfo.secondaryCpuAbi);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // SIDE EFFECTS; removes DEX files from disk; move elsewhere</div><div class="line">    if ((scanFlags &amp; SCAN_BOOTING) == 0 &amp;&amp; pkgSetting.sharedUser != null) &#123;</div><div class="line">        // We don&apos;t do this here during boot because we can do it all</div><div class="line">        // at once after scanning all existing packages.</div><div class="line">        //</div><div class="line">        // We also do this *before* we perform dexopt on this package, so that</div><div class="line">        // we can avoid redundant dexopts, and also to make sure we&apos;ve got the</div><div class="line">        // code and package path correct.</div><div class="line">        adjustCpuAbisForSharedUserLPw(pkgSetting.sharedUser.packages, pkg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (mFactoryTest &amp;&amp; pkg.requestedPermissions.contains(</div><div class="line">            android.Manifest.permission.FACTORY_TEST)) &#123;</div><div class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_FACTORY_TEST;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (isSystemApp(pkg)) &#123;</div><div class="line">        pkgSetting.isOrphaned = true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Take care of first install / last update times.</div><div class="line">    final long scanFileTime = getLastModifiedTime(pkg, scanFile);</div><div class="line">    if (currentTime != 0) &#123;</div><div class="line">        if (pkgSetting.firstInstallTime == 0) &#123;</div><div class="line">            pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = currentTime;</div><div class="line">        &#125; else if ((scanFlags &amp; SCAN_UPDATE_TIME) != 0) &#123;</div><div class="line">            pkgSetting.lastUpdateTime = currentTime;</div><div class="line">        &#125;</div><div class="line">    &#125; else if (pkgSetting.firstInstallTime == 0) &#123;</div><div class="line">        // We need *something*.  Take time time stamp of the file.</div><div class="line">        pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = scanFileTime;</div><div class="line">    &#125; else if ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) != 0) &#123;</div><div class="line">        if (scanFileTime != pkgSetting.timeStamp) &#123;</div><div class="line">            // A package on the system image has changed; consider this</div><div class="line">            // to be an update.</div><div class="line">            pkgSetting.lastUpdateTime = scanFileTime;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    pkgSetting.setTimeStamp(scanFileTime);</div><div class="line"></div><div class="line">    if ((scanFlags &amp; SCAN_CHECK_ONLY) != 0) &#123;</div><div class="line">        if (nonMutatedPs != null) &#123;</div><div class="line">            synchronized (mPackages) &#123;</div><div class="line">                mSettings.mPackages.put(nonMutatedPs.name, nonMutatedPs);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        final int userId = user == null ? 0 : user.getIdentifier();</div><div class="line">        // Modify state for the given package setting</div><div class="line">        commitPackageSettings(pkg, pkgSetting, user, scanFlags,</div><div class="line">                (policyFlags &amp; PackageParser.PARSE_CHATTY) != 0 /*chatty*/);</div><div class="line">        if (pkgSetting.getInstantApp(userId)) &#123;</div><div class="line">            mInstantAppRegistry.addInstantAppLPw(userId, pkgSetting.appId);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return pkg;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不论是开机扫描安装APK，还是通过adb命令安装APK，最终都会调用scanPackageDirtyLI函数进行APK安装。</p>
<ol>
<li>初始化Package的数据目录和资源目录；</li>
<li>如果需要则更新已有的Package的共享代码库；</li>
<li>如果安装时传递了签名信息，则验证签名信息的合法性；</li>
<li>验证新安装的APK中的Provider是否与系统中现有的Provider有冲突，并进行相应的处理；</li>
<li>如果新安装APK需要使用其他Package的权限，则进行相应处理；</li>
<li>调用createDataDirsLI()安装APK；</li>
<li>设置本地lib路径；</li>
<li>安装成功之后将Package信息更新到PMS和Setting相应的数据结构中；</li>
<li>设置APK安装时间；</li>
<li>设置APK的Provider信息，将Provider添加到相应的数据结构中；</li>
<li>设置权限组和权限信息；</li>
<li>该函数的主要工作便是将安装的APK的信息添加到PMS中，比如讲Provider、Activity、Service、Receiver等组件信息添加到相应的数据结构中，以便其他函数能够查询到</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android系统/" rel="tag"># android系统</a>
          
            <a href="/tags/apk安装/" rel="tag"># apk安装</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/28/ddctf-Android第一题-RSA/" rel="next" title="ddctf-Android第一题-RSA">
                <i class="fa fa-chevron-left"></i> ddctf-Android第一题-RSA
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/10/05/android8-0-0源码分析-应用安装2/" rel="prev" title="android8-0-0源码分析-应用安装2">
                android8-0-0源码分析-应用安装2 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/1.png"
               alt="imbaya" />
          <p class="site-author-name" itemprop="name">imbaya</p>
           
              <p class="site-description motion-element" itemprop="description">..........</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">93</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">76</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分析"><span class="nav-number">2.</span> <span class="nav-text">分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-main"><span class="nav-number">2.1.</span> <span class="nav-text">1.main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-run"><span class="nav-number">2.2.</span> <span class="nav-text">2.run</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-startBootstrapServices"><span class="nav-number">2.3.</span> <span class="nav-text">3.startBootstrapServices</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-PackageManagerService-main"><span class="nav-number">2.4.</span> <span class="nav-text">4.PackageManagerService.main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-PackageManagerService"><span class="nav-number">2.5.</span> <span class="nav-text">5.PackageManagerService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-scanDirTracedLI"><span class="nav-number">2.6.</span> <span class="nav-text">6.scanDirTracedLI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-submit"><span class="nav-number">2.7.</span> <span class="nav-text">8.submit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-parsePackage"><span class="nav-number">2.8.</span> <span class="nav-text">12.parsePackage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-parseBaseApk"><span class="nav-number">2.9.</span> <span class="nav-text">16.parseBaseApk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-scanPackageLI"><span class="nav-number">2.10.</span> <span class="nav-text">9.scanPackageLI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-scanPackageInternalLI"><span class="nav-number">2.11.</span> <span class="nav-text">11.scanPackageInternalLI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-scanPackageLI"><span class="nav-number">2.12.</span> <span class="nav-text">13.scanPackageLI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-scanPackageDirtyLI"><span class="nav-number">2.13.</span> <span class="nav-text">15.scanPackageDirtyLI</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">imbaya</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":100,"height":200,"hOffset":0,"vOffset":-50},"mobile":{"show":false},"react":{"opacityDefault":1,"opacityOnHover":1},"log":false});</script></body>
</html>
